<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zele Serve</title>
    <meta name="application-name" content="Zele Serve">
    <meta name="apple-mobile-web-app-title" content="Zele Serve">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#151b29">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://github.com/escalaserver/zele/blob/main/Volunteers%20logo.png?raw=true">
    <link rel="icon" type="image/png" href="https://github.com/escalaserver/zele/blob/main/Volunteers%20logo.png?raw=true">
    
    <!-- Meta tags adicionais para Windows/Desktop PWA -->
    <meta name="msapplication-TileColor" content="#151b29">
    <meta name="msapplication-TileImage" content="https://github.com/escalaserver/zele/blob/main/Volunteers%20logo.png?raw=true">
    <meta name="msapplication-config" content="none">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- Chart.js para Dashboards -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, orderBy, addDoc, updateDoc, limit, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        console.log('🔥 Firebase imports carregados - versão com orderBy, addDoc, updateDoc e Storage');
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlMfqUkpQQrLHD13Hq3UJ43D4N1U1JviE",
            authDomain: "zele-teste.firebaseapp.com",
            projectId: "zele-teste",
            storageBucket: "zele-teste.firebasestorage.app",
            messagingSenderId: "758471959826",
            appId: "1:758471959826:web:374288feffb10f31fc7fcb"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();
        
        // Forçar seleção de conta ao fazer login
        provider.setCustomParameters({
            prompt: 'select_account'
        });
        
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseProvider = provider;
        window.firebaseAuthMethods = { signInWithPopup, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile };
        window.firestoreMethods = { doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, orderBy, addDoc, updateDoc, limit, Timestamp };
        window.firebaseStorageMethods = { ref, uploadBytes, getDownloadURL };
        
        console.log('✅ Firebase inicializado e exportado para window');
        window.firebaseReady = true;
        
        // ═══════════════════════════════════════════════════════════════════
        // CAPTURAR RESULTADO DO REDIRECT DE LOGIN DO GOOGLE
        // Este código DEVE rodar imediatamente na inicialização
        // ═══════════════════════════════════════════════════════════════════
        
        console.log('🔍 Verificando redirect result...');
        
        getRedirectResult(auth)
            .then((result) => {
                if (result) {
                    // Usuário fez login via redirect
                    const user = result.user;
                    const credential = result.credential;
                    
                    console.log('✅ Login do Google bem-sucedido via redirect!');
                    console.log('👤 Usuário:', user.displayName);
                    console.log('📧 Email:', user.email);
                    console.log('🆔 UID:', user.uid);
                    
                    // Mostrar mensagem de sucesso
                    // TODO: Replace with toast/snackbar for better UX in production
                    alert(`Bem-vindo, ${user.displayName}!`);
                    
                    // O onAuthStateChanged vai detectar automaticamente
                    // e fazer o processamento necessário
                } else {
                    console.log('ℹ️ Nenhum redirect result pendente');
                }
            })
            .catch((error) => {
                console.error('❌ Erro ao processar redirect result:', error);
                console.error('Código do erro:', error.code);
                console.error('Mensagem:', error.message);
                
                // Tratamento de erros específicos
                let mensagemErro = 'Erro ao fazer login com Google.';
                
                switch(error.code) {
                    case 'auth/account-exists-with-different-credential':
                        mensagemErro = 'Esta conta já existe com outro método de login. Use o método original.';
                        break;
                    case 'auth/popup-blocked':
                        mensagemErro = 'Popup foi bloqueado pelo navegador.';
                        break;
                    case 'auth/popup-closed-by-user':
                        mensagemErro = 'Você fechou a janela de login.';
                        break;
                    case 'auth/unauthorized-domain':
                        mensagemErro = 'Este domínio não está autorizado. Entre em contato com o administrador.';
                        console.error('⚠️ AÇÃO NECESSÁRIA: Adicione este domínio aos domínios autorizados no Firebase Console!');
                        break;
                    case 'auth/operation-not-allowed':
                        mensagemErro = 'Login com Google não está habilitado. Entre em contato com o administrador.';
                        break;
                }
                
                // TODO: Replace alert with toast/snackbar for better UX in production
                // Technical details should only be shown in development/debug mode
                alert(mensagemErro + '\n\nDetalhes técnicos: ' + error.message);
            });
    </script>
    
    <!-- TODO: Migrar para Tailwind CLI ou PostCSS para produção -->
    <!-- Aviso: cdn.tailwindcss.com não deve ser usado em produção -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #cdc8c0; }
        .zele-primary { background-color: #151b29; }
        .zele-secondary { background-color: #151b29; }
        .zele-secondary-hover:hover { background-color: #1f2937; }
        .zele-tertiary { background-color: #cdc8c0; }
        .zele-btn {
            background-color: #151b29;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
            border: 1px solid #e5e5e5;
            transition: all 0.2s ease;
        }
        .zele-btn:hover {
            background-color: #1f2937;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        .zele-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .card-float {
            background-color: white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border: 2px solid #e5e5e5;
        }
        .modal-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 9999; 
            align-items: center; 
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .menu-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }
        .menu-overlay.show { display: block; }
        .menu-drawer {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        .menu-drawer.show { right: 0; }
        .team-btn {
            background-color: #151b29;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
            border: 1px solid #e5e5e5;
            transition: all 0.2s ease;
            padding: 0;
            overflow: hidden;
        }
        .team-btn:hover {
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        .team-btn.selected {
            background-color: #377db8;
            border-color: #377db8;
            box-shadow: 0 0 0 3px rgba(55, 125, 184, 0.3);
        }
        .team-btn img {
            width: 100%;
            height: auto;
            display: block;
        }
        .team-btn .team-name-fallback {
            display: none;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            text-align: center;
            padding: 2rem 1rem;
            background-color: #151b29;
        }
        .team-btn img.error + .team-name-fallback {
            display: block;
        }
        @keyframes blink-border {
            0%, 100% { 
                box-shadow: 0 0 0 0px #377db8;
                border-color: #d1d5db;
            }
            50% { 
                box-shadow: 0 0 0 4px #377db8;
                border-color: #377db8;
            }
        }
        @-webkit-keyframes blink-border {
            0%, 100% { 
                box-shadow: 0 0 0 0px #377db8;
                border-color: #d1d5db;
            }
            50% { 
                box-shadow: 0 0 0 4px #377db8;
                border-color: #377db8;
            }
        }
        .blink-border {
            animation: blink-border 0.2s ease-in-out 4;
            -webkit-animation: blink-border 0.2s ease-in-out 4;
        }
        @keyframes pulse-team {
            0%, 100% { border: 1px solid #e5e5e5; }
            50% { border: 10px solid #cdc8c0; }
        }
        @-webkit-keyframes pulse-team {
            0%, 100% { border: 1px solid #e5e5e5; }
            50% { border: 10px solid #cdc8c0; }
        }
        .pulse-team {
            animation: pulse-team 0.8s ease-in-out 1;
            -webkit-animation: pulse-team 0.8s ease-in-out 1;
        }
        @keyframes pulse-save {
            0%, 100% { border: 2px solid transparent; }
            50% { border: 5px solid #cdc8c0; }
        }
        @-webkit-keyframes pulse-save {
            0%, 100% { border: 2px solid transparent; }
            50% { border: 5px solid #cdc8c0; }
        }
        .pulse-save {
            animation: pulse-save 0.5s ease-in-out 2;
            -webkit-animation: pulse-save 0.5s ease-in-out 2;
        }
        /* Onboarding Styles */
        .onboarding-team-btn {
            transition: all 0.3s ease;
        }
        .onboarding-team-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .day-toggle-btn {
            transition: all 0.2s ease;
        }
        .period-btn {
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        .period-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body style="background-color: #cdc8c0;">
    
    <!-- Tela de Loading -->
    <div id="loading-screen" class="fixed inset-0 zele-primary flex items-center justify-center z-50">
        <div class="text-center text-white">
            <img src="Volunteers logo.png" alt="Zele Serve" class="w-32 h-32 mx-auto mb-4 object-contain">
            <h1 class="text-5xl font-bold mb-4">Zele Serve</h1>
            <p class="text-xl mb-8">Sistema de Escalas</p>
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-white mx-auto"></div>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="auth-screen" class="fixed inset-0 zele-primary flex items-center justify-center p-4 hidden">
        <div class="card-float rounded-2xl p-8 max-w-md w-full text-center">
            <img src="Volunteers logo.png" alt="Zele Serve" class="w-24 h-24 mx-auto mb-4 object-contain">
            <h1 class="text-4xl font-bold mb-2" style="color: #151b29;">Zele Serve</h1>
            <p class="text-gray-600 mb-8">Sistema de Escalas</p>
            
            <!-- Login com Google -->
            <button id="google-login-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-3">
                <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Entrar com Google
            </button>
            
            <!-- Link para login com email -->
            <button id="show-email-login" class="text-sm text-gray-600 hover:text-gray-800 mt-4 underline">
                Se não tem Google, clique aqui
            </button>
        </div>
    </div>

    <!-- Modal de Login com Email -->
    <div id="email-login-modal" class="modal-overlay">
        <div class="card-float rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold" style="color: #151b29;">Login com Email</h2>
                <button id="close-email-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Formulário de Login -->
            <div id="login-form">
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Email</label>
                    <input type="email" id="login-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="seu@email.com">
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Senha</label>
                    <input type="password" id="login-password" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="••••••••">
                </div>
                <button id="email-login-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg mb-3">
                    Entrar
                </button>
                <div class="text-center space-y-2">
                    <button id="show-register-form" class="text-sm text-gray-600 hover:text-gray-800 underline">
                        Não tem conta? Cadastre-se
                    </button>
                    <br>
                    <button id="show-reset-password" class="text-sm text-gray-600 hover:text-gray-800 underline">
                        Esqueci minha senha
                    </button>
                </div>
            </div>
            
            <!-- Formulário de Cadastro -->
            <div id="register-form" style="display: none;">
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Nome</label>
                    <input type="text" id="register-name" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="Nome">
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Sobrenome</label>
                    <input type="text" id="register-lastname" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="Sobrenome">
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Email</label>
                    <input type="email" id="register-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="seu@email.com">
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Senha</label>
                    <div class="relative">
                        <input type="password" id="register-password" class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-12 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="Mínimo 6 caracteres">
                        <button type="button" id="toggle-register-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <svg id="eye-icon-register" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Confirmar Senha</label>
                    <div class="relative">
                        <input type="password" id="register-password-confirm" class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-12 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="Digite a senha novamente">
                        <button type="button" id="toggle-register-password-confirm" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <svg id="eye-icon-register-confirm" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <button id="email-register-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg mb-3">
                    Cadastrar
                </button>
                <div class="text-center">
                    <button id="show-login-form" class="text-sm text-gray-600 hover:text-gray-800 underline">
                        Já tem conta? Faça login
                    </button>
                </div>
            </div>
            
            <!-- Formulário de Recuperação de Senha -->
            <div id="reset-password-form" style="display: none;">
                <p class="text-sm text-gray-600 mb-4 text-left">Digite seu email para receber o link de recuperação de senha.</p>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Email</label>
                    <input type="email" id="reset-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="seu@email.com">
                </div>
                <button id="send-reset-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg mb-3">
                    Enviar Link de Recuperação
                </button>
                <div class="text-center">
                    <button id="back-to-login" class="text-sm text-gray-600 hover:text-gray-800 underline">
                        Voltar para login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Zele Serve</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-semibold" id="user-name">Usuário</p>
                            <p class="text-xs opacity-90" id="user-email">email@example.com</p>
                        </div>
                        <button id="user-photo-btn" class="relative cursor-pointer" style="background: none; border: none; padding: 0;">
                            <img id="user-photo" src="" alt="Foto" class="w-10 h-10 rounded-full border-2 border-white">
                            <span id="header-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center" style="box-shadow: 0 2px 4px rgba(0,0,0,0.3);">0</span>
                        </button>
                        <button id="menu-btn" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="container mx-auto px-4 py-8 max-w-6xl">
            
            <!-- Criar Nova Escala -->
            <div class="card-float rounded-xl p-6 mb-8">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1" style="color: #151b29;">Escolha seu dia de servir</h2>
                    <p class="text-sm text-gray-600 mb-3"><strong>1º - Comece escolhendo o dia na lista</strong></p>
                    <select id="culto-select" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 text-base" style="--tw-ring-color: #151b29; border-color: #e5e5e5;">
                        <option value="">Escolha uma data...</option>
                        <!-- Datas serão carregadas dinamicamente pelo admin -->
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2" style="color: #151b29;">2º - Em qual equipe você vai servir nesta data?</label>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <button class="team-btn rounded-lg" data-team="welcome" 
                                data-img-normal="Logo Welcome horizontal.png"
                                data-img-selected="Welcome azul claro.png">
                            <img src="Logo Welcome horizontal.png" alt="Welcome" onerror="this.classList.add('error');this.style.display='none';">
                            <div class="team-name-fallback">WELCOME</div>
                        </button>
                        <button class="team-btn rounded-lg" data-team="backstage"
                                data-img-normal="Logo Backstage horizontal.png"
                                data-img-selected="Backstage azul claro.png">
                            <img src="Logo Backstage horizontal.png" alt="Backstage" onerror="this.classList.add('error');this.style.display='none';">
                            <div class="team-name-fallback">BACKSTAGE</div>
                        </button>
                        <button class="team-btn rounded-lg" data-team="parking"
                                data-img-normal="Logo Parking horizontal.png"
                                data-img-selected="Parking azul claro.png">
                            <img src="Logo Parking horizontal.png" alt="Parking" onerror="this.classList.add('error');this.style.display='none';">
                            <div class="team-name-fallback">PARKING</div>
                        </button>
                        <button class="team-btn rounded-lg" data-team="kids"
                                data-img-normal="Logo Kids horizontal.png"
                                data-img-selected="Kids azul claro.png">
                            <img src="Logo Kids horizontal.png" alt="Kids" onerror="this.classList.add('error');this.style.display='none';">
                            <div class="team-name-fallback">KIDS</div>
                        </button>
                        <button class="team-btn rounded-lg" data-team="comunicacao"
                                data-img-normal="https://raw.githubusercontent.com/escalaserver/zele/main/Logo%20Comunicação%20horizontal.png"
                                data-img-selected="https://raw.githubusercontent.com/escalaserver/zele/main/Comunicação%20azul%20claro.png">
                            <img src="https://raw.githubusercontent.com/escalaserver/zele/main/Logo%20Comunicação%20horizontal.png" alt="Comunicação" onerror="this.classList.add('error');this.style.display='none';">
                            <div class="team-name-fallback">COMUNICAÇÃO</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendário/Lista de Escalas -->
            <div class="card-float rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold" style="color: #151b29;">📅 Minhas Escalas</h2>
                    <select id="filter-minhas-escalas" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" style="border-color: #e5e5e5;">
                        <option value="">Todas as datas</option>
                    </select>
                </div>
                <div id="escalas-list" class="space-y-4">
                    <!-- Escalas serão inseridas aqui -->
                </div>
            </div>

            <!-- Visão Geral (Admin) -->
            <div class="card-float rounded-xl p-6 mt-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold" style="color: #151b29;">👥 Visão Geral dos Times</h2>
                    <select id="filter-visao-geral" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" style="border-color: #e5e5e5;">
                        <option value="">Todas as datas</option>
                    </select>
                </div>
                <div id="admin-view" class="space-y-4">
                    <!-- Visão geral será inserida aqui -->
                </div>
            </div>

        </main>
    </div>

    <!-- Página de Administração (apenas para admins) - Tela separada -->
    <div id="admin-page" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="back-from-admin" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Datas dos Eventos</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo da página de Admin -->
        <main class="container mx-auto px-4 py-8 max-w-6xl">
            <div class="card-float rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-6" style="color: #151b29;">⚙️ Gerenciar Sistema</h2>
                <!-- Adicionar Nova Data -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border-2" style="border-color: #377db8;">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">➕ Adicionar Nova Data</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-semibold mb-1" style="color: #151b29;">Data</label>
                            <input type="date" id="admin-new-date" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <span id="date-error" class="text-xs text-red-600 hidden mt-1"></span>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1" style="color: #151b29;">Horário</label>
                            <input type="time" id="admin-new-time" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <span id="time-error" class="text-xs text-red-600 hidden mt-1"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-semibold mb-1" style="color: #151b29;">Nome do Evento (opcional)</label>
                        <input type="text" id="admin-new-event" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Culto de Domingo, Quinta do Encontro, etc.">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-semibold mb-2" style="color: #151b29;">Limite de Voluntários por Time</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">👋 Welcome</label>
                                <input type="number" id="admin-limit-welcome" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="4" min="1" max="20" value="4">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">🤝 Backstage</label>
                                <input type="number" id="admin-limit-backstage" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="4" min="1" max="20" value="4">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">🚗 Parking</label>
                                <input type="number" id="admin-limit-parking" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="4" min="1" max="20" value="4">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">👶 Kids</label>
                                <input type="number" id="admin-limit-kids" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="4" min="1" max="20" value="4">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">📢 Comunicação</label>
                                <input type="number" id="admin-limit-comunicacao" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="4" min="1" max="20" value="4">
                            </div>
                        </div>
                        <span id="limit-error" class="text-xs text-red-600 hidden mt-1"></span>
                        <p class="text-xs text-gray-500 mt-2">Número máximo de voluntários por time para este evento</p>
                    </div>
                    <button id="admin-add-date-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg">
                        ➕ Adicionar Data
                    </button>
                </div>

                <!-- Gerenciar Datas Existentes -->
                <div class="p-4 bg-gray-50 rounded-lg border-2 border-gray-300">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">📋 Gerenciar Datas Cadastradas</h3>
                    <div id="admin-dates-list" class="space-y-2">
                        <!-- Lista de datas será inserida aqui -->
                    </div>
                </div>

                <!-- Backups de Escalas Deletadas -->
                <div class="p-4 bg-blue-50 rounded-lg border-2 border-blue-300">
                    <h3 class="font-bold text-lg mb-4 text-blue-800">💾 Backups de Escalas Deletadas</h3>
                    <p class="text-sm text-blue-700 mb-4">Quando uma data é removida, as escalas são automaticamente salvas em backup e podem ser restauradas.</p>
                    <div id="admin-backups-list" class="space-y-2">
                        <p class="text-gray-500 text-sm">Carregando backups...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Página de Gerenciar Administradores -->
    <div id="manage-admins-page" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="back-from-manage-admins" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Gerenciar Acesso</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo -->
        <main class="container mx-auto px-4 py-8 max-w-4xl">
            <div class="card-float rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4" style="color: #151b29;">👥 Usuários do Sistema</h2>
                <p class="text-sm text-gray-600 mb-6">Gerencie permissões, bloqueie acesso ou exclua usuários do sistema.</p>
                
                <!-- Lista de Usuários -->
                <div id="users-list" class="space-y-3">
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: #377db8;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Página de Logs de Auditoria -->
    <div id="audit-logs-page" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="back-from-audit-logs" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Logs de Auditoria</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo -->
        <main class="container mx-auto px-4 py-8 max-w-6xl">
            <div class="card-float rounded-xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold" style="color: #151b29;">📋 Histórico de Ações</h2>
                    <button id="refresh-audit-logs" class="zele-btn text-white font-bold py-2 px-4 rounded-lg text-sm">
                        🔄 Atualizar
                    </button>
                </div>
                
                <p class="text-sm text-gray-600 mb-6">Registro completo de aprovações, negações, exclusões e mudanças de time.</p>
                
                <!-- Filtros -->
                <div class="flex flex-wrap gap-3 mb-6 pb-6 border-b border-gray-200">
                    <select id="audit-log-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="all">Todas as ações</option>
                        <option value="APPROVE_PENDING">✅ Aprovações</option>
                        <option value="DENY_PENDING">❌ Negações</option>
                        <option value="DELETE_ESCALA">🗑️ Exclusões de Escalas</option>
                        <option value="DELETE_BLOCKED_ATTEMPT">🔓 Remoções de Bloqueios</option>
                        <option value="LEADER_UPDATE_FUNCTION">💼 Ações do Líder - Função</option>
                        <option value="LEADER_CHANGE_TEAM">🔄 Ações do Líder - Mudar Time</option>
                        <option value="LEADER_DELETE_VOLUNTEER">🗑️ Ações do Líder - Excluir</option>
                    </select>
                    
                    <select id="audit-log-period" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="7">Últimos 7 dias</option>
                        <option value="30" selected>Últimos 30 dias</option>
                        <option value="90">Últimos 3 meses</option>
                        <option value="all">Todo o período</option>
                    </select>
                </div>
                
                <!-- Lista de Logs -->
                <div id="audit-logs-list" class="space-y-3">
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: #377db8;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Página de Escalar Voluntários Manualmente (Super Admin) -->
    <div id="manual-scale-page" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="back-from-manual-scale" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Escalar Voluntários</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo -->
        <main class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- Seção 1: Selecionar Voluntário -->
            <div id="manual-scale-step-1" class="card-float rounded-xl p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4" style="color: #151b29;">👥 Selecione um Voluntário</h2>
                
                <div class="mb-4">
                    <input 
                        type="text" 
                        id="manual-scale-volunteer-search" 
                        placeholder="🔍 Procurar por nome ou email..." 
                        class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                </div>
                
                <div id="manual-scale-volunteers-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">Carregando voluntários...</p>
                </div>
            </div>

            <!-- Seção 2: Selecionar Evento -->
            <div id="manual-scale-step-2" class="card-float rounded-xl p-6 mb-6 hidden">
                <h2 class="text-2xl font-bold mb-4" style="color: #151b29;">📅 Selecione um Evento</h2>
                
                <div id="manual-scale-selected-volunteer" class="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500">
                    <p class="text-sm text-gray-600">Voluntário selecionado:</p>
                    <p id="manual-scale-volunteer-name" class="text-xl font-bold text-blue-900">-</p>
                </div>
                
                <div id="manual-scale-events-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-8">Carregando eventos...</p>
                </div>
            </div>

            <!-- Seção 3: Selecionar Time -->
            <div id="manual-scale-step-3" class="card-float rounded-xl p-6 mb-6 hidden">
                <h2 class="text-2xl font-bold mb-4" style="color: #151b29;">👔 Selecione um Time</h2>
                
                <div id="manual-scale-selected-event" class="bg-green-50 p-4 rounded-lg mb-6 border-l-4 border-green-500">
                    <p class="text-sm text-gray-600">Evento selecionado:</p>
                    <p id="manual-scale-event-name" class="text-xl font-bold text-green-900">-</p>
                </div>
                
                <div id="manual-scale-teams-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Times serão inseridos aqui -->
                </div>
                
                <div class="flex gap-3 mt-6 pt-6 border-t border-gray-200">
                    <button id="manual-scale-back-to-event" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition">
                        ◀ Voltar
                    </button>
                    <button id="manual-scale-confirm-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition" disabled>
                        ✅ Confirmar Escala
                    </button>
                </div>
            </div>

            <!-- Botões de Navegação -->
            <div class="flex gap-3 mt-6 pt-6 border-t border-gray-200">
                <button id="manual-scale-back-to-volunteer" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition hidden">
                    ◀ Voltar
                </button>
            </div>
        </main>
    </div>

    <!-- Página de Dashboard -->

    <div id="dashboard-page" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="back-from-dashboard" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Dashboard</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo -->
        <main class="container mx-auto px-4 py-6 max-w-7xl">
            <!-- Filtros -->
            <div class="card-float rounded-xl p-4 mb-6">
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between">
                    <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center flex-1">
                        <label class="font-semibold text-gray-700 text-sm">📅 Período:</label>
                        <select id="dashboard-period" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="-7">Últimos 7 dias</option>
                            <option value="-30">Últimos 30 dias</option>
                            <option value="30" selected>Próximos 30 dias</option>
                            <option value="-90">Últimos 3 meses</option>
                            <option value="-180">Últimos 6 meses</option>
                            <option value="-365">Último ano</option>
                            <option value="all">Todo o período</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        
                        <div id="custom-date-range" class="hidden flex gap-2 items-center">
                            <input type="date" id="date-from" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-500">até</span>
                            <input type="date" id="date-to" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <button id="refresh-dashboard" class="zele-btn text-white font-bold py-2 px-6 rounded-lg text-sm whitespace-nowrap">
                        🔄 Atualizar
                    </button>
                </div>
            </div>

            <!-- Grid de Gráficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Card de Voluntários e Líderes (Estatísticas Principais) -->
                <div class="card-float rounded-xl p-6 lg:col-span-2">
                    <h3 class="font-bold text-lg mb-6" style="color: #151b29;">👥 Estatísticas de Voluntários</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Card: Total de Voluntários -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6 border-l-4 border-blue-500 cursor-pointer hover:shadow-lg transition-all" onclick="openTotalVolunteersModal()">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Total de Voluntários</p>
                                    <p class="text-3xl font-bold text-blue-600 mt-2" id="stat-total-volunteers">-</p>
                                </div>
                                <span class="text-4xl opacity-50">📋</span>
                            </div>
                            
                            <!-- Seção de Onboarding Consolidado com Grid -->
                            <div id="onboarding-stats-container" style="display: none;">
                                <p class="text-xs font-semibold text-gray-700 mb-3 mt-4 pt-4 border-t border-blue-200">Disponibilidade por Time:</p>
                                <div class="grid grid-cols-2 gap-2" id="onboarding-stats-content">
                                    <!-- Conteúdo será inserido dinamicamente -->
                                </div>
                            </div>
                        </div>

                        <!-- Card: Total de Líderes de Time -->
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border-l-4 border-purple-500 cursor-pointer hover:shadow-lg transition-all" onclick="openTotalLeadersModal()">
                            <div class="flex items-end justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Líderes de Time</p>
                                    <p class="text-3xl font-bold text-purple-600 mt-2" id="stat-total-leaders">-</p>
                                </div>
                                <span class="text-4xl opacity-50">👑</span>
                            </div>
                        </div>

                        <!-- Card: Voluntários Únicos (com escalas) -->
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border-l-4 border-green-500 cursor-pointer hover:shadow-lg transition-all" onclick="openActiveVolunteersModal()">
                            <div class="flex items-end justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Escalados Este Mês</p>
                                    <p class="text-3xl font-bold text-green-600 mt-2" id="stat-active-volunteers">-</p>
                                </div>
                                <span class="text-4xl opacity-50">✅</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-4 text-center">Última atualização: <span id="stat-update-time">-</span></p>
                </div>

                <!-- Card de Engajamento (Voluntários com/sem Escalas) -->
                <div class="card-float rounded-xl p-6 lg:col-span-2">
                    <h3 class="font-bold text-lg mb-6" style="color: #151b29;">📊 Engajamento de Voluntários</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Card: Voluntários com Escalas -->
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-4 border-l-4 border-emerald-500 cursor-pointer hover:shadow-lg transition-all" onclick="openVolunteersWithEscalasModal()">
                            <div class="flex items-end justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Voluntários Ativos</p>
                                    <p class="text-sm text-gray-500 mb-2">(Já fizeram escalas)</p>
                                    <p class="text-3xl font-bold text-emerald-600 mt-2" id="stat-volunteers-with-escalas">-</p>
                                </div>
                                <span class="text-4xl opacity-50">✅</span>
                            </div>
                        </div>

                        <!-- Card: Voluntários sem Escalas -->
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-lg p-4 border-l-4 border-slate-500 cursor-pointer hover:shadow-lg transition-all" onclick="openVolunteersWithoutEscalasModal()">
                            <div class="flex items-end justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Voluntários Inativos</p>
                                    <p class="text-sm text-gray-500 mb-2">(Só acessaram o app)</p>
                                    <p class="text-3xl font-bold text-slate-600 mt-2" id="stat-volunteers-without-escalas">-</p>
                                </div>
                                <span class="text-4xl opacity-50">🔍</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-4 text-center">Mostra o histórico total de escalas</p>
                </div>

                <!-- Gráfico 1: Times com Menos de 5 Voluntários (ALERTA) -->
                <div class="card-float rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg" style="color: #151b29;">🚨 Times com Menos de 5 Voluntários</h3>
                        <div class="flex gap-2">
                            <button id="chart4-prev" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm" title="Anterior">←</button>
                            <button id="chart4-next" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm" title="Próximo">→</button>
                        </div>
                    </div>
                    <div class="h-64 cursor-pointer" title="Clique nas barras para ver detalhes">
                        <canvas id="chart-empty-teams"></canvas>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">
                        <span class="inline-block w-3 h-3 rounded mr-1" style="background-color: rgba(254, 240, 138, 0.8);"></span> 1 time
                        <span class="inline-block w-3 h-3 rounded mr-1 ml-3" style="background-color: rgba(234, 179, 8, 0.8);"></span> 2 times
                        <span class="inline-block w-3 h-3 rounded mr-1 ml-3" style="background-color: rgba(249, 115, 22, 0.8);"></span> 3 times
                        <span class="inline-block w-3 h-3 rounded mr-1 ml-3" style="background-color: rgba(239, 68, 68, 0.8);"></span> 4 times
                    </p>
                    <p class="text-xs text-gray-400 mt-2 text-center">← Use as setas para navegar →</p>
                </div>

                <!-- Gráfico 2: Quantidade de Voluntários por Dia -->
                <div class="card-float rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg" style="color: #151b29;">📆 Quantidade de Voluntários por Dia</h3>
                        <div class="flex gap-2">
                            <button id="chart3-prev" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm" title="Anterior">←</button>
                            <button id="chart3-next" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm" title="Próximo">→</button>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="chart-events"></canvas>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-center">← Use as setas para navegar →</p>
                </div>

                <!-- Gráfico 3: Voluntários Únicos por Time -->
                <div class="card-float rounded-xl p-6">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">📊 Voluntários Únicos por Time</h3>
                    <div class="h-64">
                        <canvas id="chart-teams"></canvas>
                    </div>
                </div>

                <!-- Gráfico 4: Ranking de Voluntários com mais Escalas -->
                <div class="card-float rounded-xl p-6">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">📈 Ranking de Voluntários com mais Escalas</h3>
                    <div class="h-64">
                        <canvas id="chart-volunteers"></canvas>
                    </div>
                </div>

                <!-- Gráfico 5: Presença vs Ausência por Time -->
                <div class="card-float rounded-xl p-6">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">✅ Presença vs Ausência por Time</h3>
                    <div class="h-64">
                        <canvas id="chart-attendance"></canvas>
                    </div>
                </div>

                <!-- Gráfico 6: Ranking de Voluntários - Check-in vs Ausência -->
                <div class="card-float rounded-xl p-6">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">📊 Ranking de Check-in - Presença vs Ausência</h3>
                    <div class="h-64">
                        <canvas id="chart-checkin-ranking"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Popup de Detalhes do Evento (Gráfico 4) -->
    <div id="chart4-popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
            <button id="chart4-popup-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <h3 class="text-xl font-bold mb-2" style="color: #151b29;" id="chart4-popup-title">Detalhes do Evento</h3>
            <p class="text-sm text-gray-600 mb-4" id="chart4-popup-date"></p>
            
            <div class="space-y-3" id="chart4-popup-teams">
                <!-- Times serão inseridos aqui -->
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500 text-center">
                    💡 Times com menos de 5 voluntários podem precisar de atenção
                </p>
            </div>
        </div>
    </div>

    <!-- Popup de Detalhes do Evento com Voluntários (Gráfico 3) - Formato 9:16 -->
    <div id="chart3-popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm relative" style="max-height: 90vh; aspect-ratio: 9/16; overflow-y: auto;">
            <button id="chart3-popup-close" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-xl font-bold mb-2" style="color: #151b29;" id="chart3-popup-title">Voluntários Escalados</h3>
                <p class="text-sm text-gray-600 mb-1" id="chart3-popup-date"></p>
                <p class="text-sm font-semibold text-blue-600 mb-4" id="chart3-popup-total"></p>
                
                <div class="space-y-4" id="chart3-popup-teams">
                    <!-- Times com voluntários serão inseridos aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Popup de Voluntários Únicos por Time (Gráfico 1) - Formato 9:16 -->
    <div id="chart1-popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm relative" style="max-height: 90vh; aspect-ratio: 9/16; overflow-y: auto;">
            <button id="chart1-popup-close" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-xl font-bold mb-2" style="color: #151b29;" id="chart1-popup-title">Voluntários do Time</h3>
                <p class="text-sm font-semibold text-blue-600 mb-4" id="chart1-popup-total"></p>
                
                <div class="space-y-2" id="chart1-popup-volunteers">
                    <!-- Voluntários serão inseridos aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gerenciar Liderança de Times -->
    <div id="team-leader-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" style="color: #151b29;">🏆 Gerenciar Liderança</h2>
                <button id="close-team-leader-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">Voluntário: <strong id="leader-user-name"></strong></p>
                <p class="text-xs text-gray-500 mb-4">Selecione os times que esta pessoa irá liderar:</p>
            </div>
            
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                    <input type="checkbox" class="leader-team-checkbox w-5 h-5 text-blue-600" data-team="welcome">
                    <span class="text-2xl">👋</span>
                    <span class="font-semibold text-gray-800">Welcome</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                    <input type="checkbox" class="leader-team-checkbox w-5 h-5 text-gray-600" data-team="backstage">
                    <span class="text-2xl">🤝</span>
                    <span class="font-semibold text-gray-800">Backstage</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-red-50 transition">
                    <input type="checkbox" class="leader-team-checkbox w-5 h-5 text-red-600" data-team="parking">
                    <span class="text-2xl">🚗</span>
                    <span class="font-semibold text-gray-800">Parking</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-yellow-50 transition">
                    <input type="checkbox" class="leader-team-checkbox w-5 h-5 text-yellow-600" data-team="kids">
                    <span class="text-2xl">👶</span>
                    <span class="font-semibold text-gray-800">Kids</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                    <input type="checkbox" class="leader-team-checkbox w-5 h-5 text-purple-600" data-team="comunicacao">
                    <span class="text-2xl">📢</span>
                    <span class="font-semibold text-gray-800">Comunicação</span>
                </label>
            </div>
            
            <button id="save-team-leader-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg">
                💾 Salvar Liderança
            </button>
        </div>
    </div>

    <!-- Modal de Transferir Voluntário entre Times -->
    <div id="transfer-volunteer-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" style="color: #151b29;">🔁 Transferir Voluntário</h2>
                <button id="close-transfer-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-1">Voluntário: <strong id="transfer-volunteer-name"></strong></p>
                <p class="text-sm text-gray-600 mb-4">Time atual: <strong id="transfer-current-team"></strong></p>
                <p class="text-xs text-gray-500 mb-4">Selecione o novo time:</p>
            </div>
            
            <div class="space-y-3 mb-6" id="transfer-teams-options">
                <!-- Opções de times serão inseridas dinamicamente -->
            </div>
            
            <button id="confirm-transfer-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg">
                ✅ Confirmar Transferência
            </button>
        </div>
    </div>

    <!-- Popup de Presenças/Ausências (Gráfico 5) - Formato 9:16 -->
    <div id="chart5-popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm relative" style="max-height: 90vh; aspect-ratio: 9/16; overflow-y: auto;">
            <button id="chart5-popup-close" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-xl font-bold mb-2" style="color: #151b29;" id="chart5-popup-title">Voluntários</h3>
                <p class="text-sm font-semibold mb-4" id="chart5-popup-subtitle"></p>
                
                <div class="space-y-3" id="chart5-popup-list">
                    <!-- Lista de voluntários será inserida aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Total de Voluntários -->
    <div id="stat-total-volunteers-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl relative" style="max-height: 90vh; overflow-y: auto;">
            <button id="stat-total-volunteers-modal-close" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-2" style="color: #151b29;">📋 Total de Voluntários</h3>
                <p class="text-sm text-gray-600 mb-4">Todos os voluntários cadastrados no sistema</p>
                
                <div class="mb-4">
                    <input type="text" id="stat-total-volunteers-search" placeholder="Buscar voluntário..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <div class="space-y-2" id="stat-total-volunteers-list">
                    <!-- Lista será inserida aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Total de Líderes -->
    <div id="stat-total-leaders-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl relative" style="max-height: 90vh; overflow-y: auto;">
            <button id="stat-total-leaders-modal-close" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-2" style="color: #151b29;">👑 Líderes de Time</h3>
                <p class="text-sm text-gray-600 mb-4">Usuários que lideram times</p>
                
                <div class="mb-4">
                    <input type="text" id="stat-total-leaders-search" placeholder="Buscar líder..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <div class="space-y-2" id="stat-total-leaders-list">
                    <!-- Lista será inserida aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Voluntários com Escalas -->
    <div id="stat-volunteers-with-escalas-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl relative" style="max-height: 90vh; overflow-y: auto;">
            <button id="stat-volunteers-with-escalas-modal-close" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-2" style="color: #151b29;">✅ Voluntários Ativos</h3>
                <p class="text-sm text-gray-600 mb-4">Voluntários que já fizeram escalas no histórico</p>
                
                <div class="mb-4">
                    <input type="text" id="stat-volunteers-with-escalas-search" placeholder="Buscar voluntário..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <div class="space-y-2" id="stat-volunteers-with-escalas-list">
                    <!-- Lista será inserida aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Voluntários sem Escalas -->
    <div id="stat-volunteers-without-escalas-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl relative" style="max-height: 90vh; overflow-y: auto;">
            <button id="stat-volunteers-without-escalas-modal-close" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-2" style="color: #151b29;">🔍 Voluntários Inativos</h3>
                <p class="text-sm text-gray-600 mb-4">Voluntários que acessaram mas nunca fizeram escalas</p>
                
                <div class="mb-4">
                    <input type="text" id="stat-volunteers-without-escalas-search" placeholder="Buscar voluntário..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <div class="space-y-2" id="stat-volunteers-without-escalas-list">
                    <!-- Lista será inserida aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Escalados Este Mês -->
    <div id="stat-active-volunteers-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl relative" style="max-height: 90vh; overflow-y: auto;">
            <button id="stat-active-volunteers-modal-close" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-2" style="color: #151b29;">✅ Escalados Este Mês</h3>
                <p class="text-sm text-gray-600 mb-4">Voluntários com escalas aprovadas neste período</p>
                
                <div class="mb-4">
                    <input type="text" id="stat-active-volunteers-search" placeholder="Buscar voluntário..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
                </div>
                
                <div class="space-y-2" id="stat-active-volunteers-list">
                    <!-- Lista será inserida aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Onboarding - Primeiro Acesso -->
    <div id="onboarding-modal" class="modal-overlay" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold mb-2" style="color: #151b29;">👋 Bem-vindo(a)!</h2>
                <p class="text-gray-600">Vamos conhecer suas preferências para servir</p>
            </div>
            
            <!-- Escolha de Time -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3" style="color: #151b29;">🎯 Qual time você gostaria de servir?</h3>
                <p class="text-sm text-gray-600 mb-3">(Ainda não é para uma escala, escolha o time de sua preferência para servir nos cultos)</p>
                <div class="grid grid-cols-2 gap-3">
                    <button class="onboarding-team-btn p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition" data-team="welcome">
                        <div class="text-3xl mb-2">👋</div>
                        <div class="font-semibold text-blue-600">Welcome</div>
                    </button>
                    <button class="onboarding-team-btn p-4 border-2 border-gray-300 rounded-lg hover:border-gray-600 transition" data-team="backstage">
                        <div class="text-3xl mb-2">🤝</div>
                        <div class="font-semibold text-gray-600">Backstage</div>
                    </button>
                    <button class="onboarding-team-btn p-4 border-2 border-gray-300 rounded-lg hover:border-red-500 transition" data-team="parking">
                        <div class="text-3xl mb-2">🚗</div>
                        <div class="font-semibold text-red-600">Parking</div>
                    </button>
                    <button class="onboarding-team-btn p-4 border-2 border-gray-300 rounded-lg hover:border-yellow-500 transition" data-team="kids">
                        <div class="text-3xl mb-2">👶</div>
                        <div class="font-semibold text-yellow-600">Kids</div>
                    </button>
                    <button class="onboarding-team-btn p-4 border-2 border-gray-300 rounded-lg hover:border-purple-500 transition" data-team="comunicacao">
                        <div class="text-3xl mb-2">📢</div>
                        <div class="font-semibold text-purple-600">Comunicação</div>
                    </button>
                </div>
            </div>
            
            <!-- Disponibilidade Semanal -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3" style="color: #151b29;">📅 Quando você tem disponibilidade?</h3>
                <p class="text-sm text-gray-600 mb-3">(Escolha o(s) dia(s) da semana e período que normalmente tem livre para servir)</p>
                <p class="text-sm text-gray-600 mb-3">Selecione os dias e períodos que você pode servir:</p>
                
                <div class="space-y-3" id="availability-days">
                    <!-- Quinta -->
                    <div class="border border-gray-300 rounded-lg p-3">
                        <button class="day-toggle-btn w-full flex items-center justify-between p-2 rounded hover:bg-gray-50 transition" data-day="thursday">
                            <span class="font-semibold text-gray-700">Quinta-feira</span>
                            <span class="toggle-indicator text-gray-400">○</span>
                        </button>
                        <div class="period-options hidden mt-2 flex gap-2 justify-center" data-day="thursday">
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="night">🌙 Noite</button>
                        </div>
                    </div>
                    
                    <!-- Domingo -->
                    <div class="border border-gray-300 rounded-lg p-3">
                        <button class="day-toggle-btn w-full flex items-center justify-between p-2 rounded hover:bg-gray-50 transition" data-day="sunday">
                            <span class="font-semibold text-gray-700">Domingo</span>
                            <span class="toggle-indicator text-gray-400">○</span>
                        </button>
                        <div class="period-options hidden mt-2 flex gap-2 justify-center" data-day="sunday">
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="morning">☀️ Manhã</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="night">🌙 Noite</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="confirm-onboarding-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                ✅ Continuar
            </button>
        </div>
    </div>

    <!-- Modal de Confirmação de Onboarding -->
    <div id="onboarding-confirm-modal" class="modal-overlay" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="text-center mb-4">
                <div class="text-4xl mb-3">✅</div>
                <h2 class="text-xl font-bold mb-2" style="color: #151b29;">Confirme suas informações</h2>
            </div>
            
            <div class="space-y-4 mb-6" id="onboarding-summary">
                <!-- Resumo será inserido aqui -->
            </div>
            
            <div class="flex gap-3">
                <button id="edit-onboarding-btn" class="flex-1 bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition">
                    ✏️ Editar
                </button>
                <button id="save-onboarding-btn" class="flex-1 zele-btn text-white font-bold py-3 px-6 rounded-lg">
                    💾 Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Menu Lateral -->
    <div id="menu-overlay" class="menu-overlay"></div>
    <div id="menu-drawer" class="menu-drawer">
        <div class="p-6">
            <!-- Header do Menu -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <img src="Volunteers logo.png" alt="Logo" class="w-12 h-12 object-contain">
                    <h2 class="text-xl font-bold" style="color: #151b29;">Menu</h2>
                </div>
                <button id="menu-close-btn" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- User Info -->
            <div class="mb-6 pb-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <img id="menu-user-photo" src="" alt="Foto" class="w-16 h-16 rounded-full">
                    <div>
                        <p class="font-semibold text-gray-800" id="menu-user-name">Usuário</p>
                        <p class="text-sm text-gray-600" id="menu-user-email">email@example.com</p>
                    </div>
                </div>
            </div>

            <!-- Menu Items -->
            <div class="space-y-2">
                <!-- Grupo 1: Meu Menu -->
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <button id="toggle-my-menu" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition">
                        <span class="font-semibold text-gray-800">👤 Meu Menu</span>
                        <svg class="w-5 h-5 transform transition-transform" id="my-menu-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <div id="my-menu-items" class="hidden bg-white">
                        <button id="menu-upcoming-events-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left relative border-b border-gray-100">
                            <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                            </svg>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">Próximos Eventos</p>
                                <p class="text-xs text-gray-600">Suas escalas próximas</p>
                            </div>
                            <span id="upcoming-badge" class="hidden absolute top-3 right-3 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span>
                        </button>

                        <button id="menu-edit-onboarding-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Minha Disponibilidade</p>
                                <p class="text-xs text-gray-600">Ver e editar times e horários</p>
                            </div>
                        </button>

                        <button id="menu-block-dates-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3M5 21h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2zm0 0h14M7 11h10M7 15h6"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Bloqueio de Datas</p>
                                <p class="text-xs text-gray-600">Marque quando não pode servir</p>
                            </div>
                        </button>

                        <button id="install-app-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100" style="display: none;">
                            <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Instalar App</p>
                                <p class="text-xs text-gray-600">Adicionar à tela inicial</p>
                            </div>
                        </button>

                        <button id="menu-change-photo-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left">
                            <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Alterar Foto</p>
                                <p class="text-xs text-gray-600">Escolher foto de perfil</p>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Grupo 2: Menu da Liderança -->
                <div id="leadership-menu-group" class="border border-gray-200 rounded-lg overflow-hidden" style="display: none;">
                    <button id="toggle-leadership-menu" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition">
                        <span class="font-semibold text-gray-800">👑 Menu da Liderança</span>
                        <svg class="w-5 h-5 transform transition-transform" id="leadership-menu-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <div id="leadership-menu-items" class="hidden bg-white">
                        <button id="menu-upcoming-services-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Próximos Cultos</p>
                                <p class="text-xs text-gray-600">Ver e gerenciar escalas do seu time</p>
                            </div>
                        </button>

                        <button id="menu-dashboard-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100">
                            <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Dashboard</p>
                                <p class="text-xs text-gray-600">Estatísticas e gráficos</p>
                            </div>
                        </button>

                        <button id="menu-checkin-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Check-in de Voluntários</p>
                                <p class="text-xs text-gray-600">Marcar presença/ausência</p>
                            </div>
                        </button>

                        <button id="menu-blocked-attempts-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left relative border-b border-gray-100">
                            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">Tentativas Bloqueadas</p>
                                <p class="text-xs text-gray-600">Ver deleções bloqueadas</p>
                            </div>
                            <span id="blocked-attempts-badge" class="hidden absolute top-2 right-2 bg-red-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span>
                        </button>

                        <button id="menu-pending-escalas-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left relative border-b border-gray-100">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">Pendentes para servir</p>
                                <p class="text-xs text-gray-600">Aprovar ou negar escalas</p>
                            </div>
                            <span id="pending-escalas-badge" class="hidden absolute top-2 right-2 bg-red-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span>
                        </button>

                        <button id="menu-manual-scale-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100">
                            <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Escalar Voluntários</p>
                                <p class="text-xs text-gray-600">Adicionar escalas manualmente</p>
                            </div>
                        </button>

                        <button id="menu-admin-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100">
                            <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Datas dos Eventos</p>
                                <p class="text-xs text-gray-600">Gerenciar datas disponíveis</p>
                            </div>
                        </button>

                        <button id="menu-manage-roles-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Gerenciar Funções</p>
                                <p class="text-xs text-gray-600">Configurar funções por time</p>
                            </div>
                        </button>

                        <!-- Menu Análise com IA - DESABILITADO -->
                        <!-- <button id="menu-ai-analysis-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left">
                            <svg class="w-6 h-6" style="color: #10a37f;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5.36 4.364l-.707.707M9 12a3 3 0 11 6 0 3 3 0 01-6 0z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Análise com IA 🤖</p>
                                <p class="text-xs text-gray-600">Faça perguntas sobre os dados</p>
                            </div>
                        </button> -->
                    </div>
                </div>

                <!-- Grupo 3: Menu Administrativo -->
                <div id="admin-menu-group" class="border border-gray-200 rounded-lg overflow-hidden" style="display: none;">
                    <button id="toggle-admin-menu" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition">
                        <span class="font-semibold text-gray-800">🔧 Menu Administrativo</span>
                        <svg class="w-5 h-5 transform transition-transform" id="admin-menu-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                    <div id="admin-menu-items" class="hidden bg-white">
                        <button id="menu-manage-admins-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left border-b border-gray-100">
                            <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Gerenciar Acesso</p>
                                <p class="text-xs text-gray-600">Gerenciar usuários e permissões</p>
                            </div>
                        </button>
                        
                        <button id="menu-audit-logs-btn" class="w-full flex items-center gap-3 p-4 hover:bg-gray-50 transition text-left">
                            <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <div>
                                <p class="font-semibold text-gray-800">Logs de Auditoria</p>
                                <p class="text-xs text-gray-600">Histórico de ações</p>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Botão Sair (fora dos grupos) -->
                <button id="menu-logout-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left border border-gray-200">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Sair</p>
                        <p class="text-xs text-gray-600">Fazer logout</p>
                    </div>
                </button>
            </div>

            <!-- Input oculto para upload de foto -->
            <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">

            <!-- Versão -->
            <div class="mt-8 pt-6 border-t border-gray-200 text-center text-xs text-gray-500">
                <p>Zele Serve v2.4</p>
                <p class="mt-1">Servir é a linguagem do céu</p>
            </div>
        </div>
    </div>

    <!-- Modal: Seleção de Evento para Check-in -->
    <div id="checkin-event-selector-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md relative" style="max-height: 90vh; overflow-y: auto;">
            <button id="close-event-selector-modal" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-xl font-bold mb-3" style="color: #151b29;">📋 Selecione o Evento</h3>
                <p class="text-sm text-gray-600 mb-4">Escolha o evento para fazer check-in (últimos 30 dias):</p>
                
                <div id="event-selector-list" class="space-y-2 mb-4">
                    <!-- Lista de eventos será inserida aqui -->
                </div>
                
                <button id="close-event-selector-btn" class="w-full py-3 px-6 text-white font-bold rounded-lg transition hover:opacity-90" style="background-color: #151b29;">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Check-in de Voluntários -->
    <!-- Modal: Check-in de Voluntários -->
    <div id="checkin-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm relative" style="max-height: 90vh; aspect-ratio: 9/16; overflow-y: auto;">
            <button id="close-checkin-modal" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-xl font-bold mb-3" style="color: #151b29;">✅ Check-in de Voluntários</h3>
                <div id="checkin-event-info" class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded text-sm mb-4"></div>
                <p class="text-sm text-gray-600 mb-4">Marque a presença dos voluntários:</p>
                
                <div id="checkin-teams-list" class="space-y-4 mb-6">
                    <!-- Times com voluntários serão inseridos aqui -->
                </div>
                
                <!-- Botão Fechar no final -->
                <button id="close-checkin-btn" class="w-full py-3 px-6 text-white font-bold rounded-lg transition hover:opacity-90" style="background-color: #151b29;">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Bloqueio de Datas -->
    <div id="blocked-dates-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
            <!-- Header fixo -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-bold text-gray-800">🚫 Bloqueio de Datas</h2>
                    <button id="close-blocked-dates-modal" class="text-gray-600 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mb-4">Marque as datas e períodos do dia em que você <strong>não pode</strong> servir.</p>
                
                <!-- Campos de entrada fixos -->
                <div class="grid grid-cols-1 gap-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-700">Data</label>
                            <input type="date" id="block-date-input" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1 text-gray-700">Período</label>
                            <select id="block-period-select" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                <option value="all">Dia inteiro</option>
                                <option value="morning">Manhã</option>
                                <option value="afternoon">Tarde</option>
                                <option value="night">Noite</option>
                            </select>
                        </div>
                    </div>
                    <button id="add-blocked-date-btn" class="w-full zele-btn text-white font-bold py-2 px-4 rounded-lg">➕ Adicionar</button>
                </div>
            </div>

            <!-- Lista com scroll -->
            <div class="p-6 max-h-[50vh] overflow-y-auto">
                <h3 class="font-semibold mb-3 text-gray-800">Suas datas bloqueadas</h3>
                <div id="blocked-dates-list" class="space-y-2"></div>
            </div>

            <!-- Footer fixo -->
            <div class="p-6 border-t border-gray-200">
                <button id="close-blocked-dates-btn" class="w-full zele-btn-secondary px-4 py-2 rounded-lg font-semibold">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div id="success-modal" class="modal-overlay">
        <div class="card-float rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="mb-4 text-6xl">✅</div>
            <h2 class="text-2xl font-bold mb-2" style="color: #151b29;">Volunteers</h2>
            <p class="text-gray-600 mb-6" id="modal-message">Escala salva com sucesso!</p>
            <div id="modal-buttons" class="flex gap-3">
                <button id="modal-close-btn" class="flex-1 zele-btn text-white font-bold py-3 px-6 rounded-lg">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Incluir Novo Voluntário -->
    <div id="add-volunteer-modal" class="modal-overlay">
        <div class="card-float rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold" style="color: #151b29;">➕ Incluir Novo Voluntário</h2>
                <button id="close-add-volunteer-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">
                Este voluntário será adicionado ao sistema e estará disponível para escalação imediatamente.
            </p>
            
            <div class="mb-4">
                <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Nome Completo *</label>
                <input type="text" id="new-volunteer-name" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: João Silva">
            </div>
            
            <div class="mb-4">
                <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Email *</label>
                <input type="email" id="new-volunteer-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: joao@email.com">
                <p class="text-xs text-gray-500 mt-1">O voluntário receberá um convite para acessar o sistema.</p>
            </div>
            
            <div class="bg-blue-50 p-3 rounded-lg mb-4 border-l-4 border-blue-500">
                <p class="text-xs text-blue-900">
                    <strong>Status:</strong> Este voluntário será marcado como "pré-cadastrado" até que faça o primeiro login.
                </p>
            </div>
            
            <div class="flex gap-3">
                <button id="cancel-add-volunteer-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition">
                    Cancelar
                </button>
                <button id="confirm-add-volunteer-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition">
                    ✅ Incluir
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Instruções iOS -->
    <div id="ios-install-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">📱 Instalar App no iPhone</h2>
            <p class="text-sm text-gray-600 mb-4">Para adicionar o Zele Serve à sua tela inicial:</p>
            <ol class="text-sm text-gray-700 space-y-3 mb-6">
                <li class="flex items-start">
                    <span class="font-bold mr-2">1.</span>
                    <span>Toque no botão <strong>Compartilhar</strong> <svg class="inline w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg> (na barra inferior do Safari)</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold mr-2">2.</span>
                    <span>Role para baixo e toque em <strong>"Adicionar à Tela de Início"</strong> <svg class="inline w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold mr-2">3.</span>
                    <span>Toque em <strong>"Adicionar"</strong> no canto superior direito</span>
                </li>
            </ol>
            <button id="close-ios-modal" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold">
                Entendi
            </button>
        </div>
    </div>

    <!-- Modal de Tentativas Bloqueadas -->
    <div id="blocked-attempts-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">⚠️ Tentativas Bloqueadas</h2>
                <button id="close-blocked-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Voluntários que tentaram deletar escalas dentro do período de 48 horas:</p>
            <div id="blocked-attempts-list" class="space-y-3">
                <!-- Lista será preenchida dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Escalas Pendentes (Admin) -->
    <div id="pending-escalas-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">⏰ Pendentes para servir</h2>
                <button id="close-pending-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Escalas solicitadas com menos de 24h de antecedência:</p>
            <div id="pending-escalas-list" class="space-y-4">
                <!-- Lista será preenchida dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Seleção de Time para Aprovação -->
    <div id="approve-team-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">✅ Selecionar Time</h2>
                <button id="close-approve-team-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Selecione o time para aprovar a escala:</p>
            <div class="space-y-3" id="approve-team-options">
                <!-- Opções de times serão inseridas aqui -->
            </div>
        </div>
    </div>

    <!-- Modal: Próximos Cultos do Líder -->
    <div id="leader-upcoming-services-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-indigo-600 to-indigo-800 text-white p-4 flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold">Próximos Cultos</h2>
                </div>
                <button id="close-leader-services-modal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <div id="leader-services-list"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Voluntário -->
    <div id="edit-volunteer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md">
            <div class="bg-gradient-to-r from-purple-600 to-purple-800 text-white p-4 flex items-center justify-between">
                <h2 class="text-xl font-bold">✏️ Editar Voluntário</h2>
                <button id="close-edit-volunteer-modal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">Voluntário:</p>
                    <p id="edit-volunteer-name" class="font-semibold text-lg text-gray-800"></p>
                </div>
                
                <div class="space-y-3">
                    <button id="edit-volunteer-function-btn" class="w-full flex items-center gap-3 p-3 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-lg transition">
                        <span class="text-2xl">💼</span>
                        <div class="text-left">
                            <p class="font-semibold text-gray-800">Incluir/Editar Função</p>
                            <p class="text-xs text-gray-600">Atribuir função específica</p>
                        </div>
                    </button>
                    
                    <button id="edit-volunteer-team-btn" class="w-full flex items-center gap-3 p-3 bg-yellow-50 hover:bg-yellow-100 border-2 border-yellow-200 rounded-lg transition">
                        <span class="text-2xl">🔄</span>
                        <div class="text-left">
                            <p class="font-semibold text-gray-800">Mudar de Time</p>
                            <p class="text-xs text-gray-600">Transferir para outro time</p>
                        </div>
                    </button>
                    
                    <button id="edit-volunteer-delete-btn" class="w-full flex items-center gap-3 p-3 bg-red-50 hover:bg-red-100 border-2 border-red-200 rounded-lg transition">
                        <span class="text-2xl">🗑️</span>
                        <div class="text-left">
                            <p class="font-semibold text-gray-800">Excluir da Escala</p>
                            <p class="text-xs text-gray-600">Remover deste evento</p>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Gerenciar Funções por Time -->
    <div id="manage-roles-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl relative" style="max-height: 90vh; overflow-y: auto;">
            <button id="close-manage-roles-modal" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-2xl font-bold mb-2" style="color: #151b29;">💼 Gerenciar Funções</h3>
                <p class="text-sm text-gray-600 mb-6">Configure as funções disponíveis para cada time</p>
                
                <!-- Seletor de Time -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Selecione o Time:</label>
                    <select id="roles-team-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">-- Escolha um time --</option>
                        <option value="welcome">� Welcome</option>
                        <option value="backstage">🤝 Backstage</option>
                        <option value="parking">🚗 Parking</option>
                        <option value="kids">👶 Kids</option>
                        <option value="comunicacao">📢 Comunicação</option>
                    </select>
                </div>

                <!-- Adicionar Nova Função -->
                <div id="add-role-section" class="mb-6 hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Adicionar Nova Função:</label>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="new-role-input" 
                            placeholder="Ex: Recepção, Louvor, Estacionamento..."
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <button id="add-role-btn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar
                        </button>
                    </div>
                </div>

                <!-- Lista de Funções -->
                <div id="roles-list-section" class="hidden">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Funções Cadastradas:</h4>
                    <div id="roles-list" class="space-y-2 mb-4">
                        <!-- Lista será inserida aqui -->
                    </div>
                </div>

                <!-- Mensagem quando nenhum time está selecionado -->
                <div id="no-team-selected-msg" class="text-center py-8 text-gray-500">
                    <svg class="w-16 h-16 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <p>Selecione um time para gerenciar suas funções</p>
                </div>

                <!-- Botão Fechar -->
                <button id="close-roles-modal-btn" class="w-full mt-6 py-3 px-6 text-white font-bold rounded-lg transition hover:opacity-90" style="background-color: #151b29;">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Análise com IA 🤖 -->
    <div id="ai-analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl relative" style="max-height: 90vh; overflow-y: auto;">
            <button id="close-ai-modal" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">🤖</span>
                    <div>
                        <h3 class="text-2xl font-bold" style="color: #151b29;">Análise com IA</h3>
                        <p class="text-sm text-gray-600">Faça perguntas sobre voluntários e escalas</p>
                    </div>
                </div>

                <!-- Aviso de Configuração (caso não tenha configurado a chave no código) -->
                <div id="ai-config-warning" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded hidden">
                    <p class="text-sm text-yellow-800 mb-2"><strong>⚠️ Configuração Necessária</strong></p>
                    <p class="text-xs text-yellow-700">A chave da API Claude não foi configurada no código. Entre em contato com o administrador do sistema para configurá-la.</p>
                </div>

                <!-- Área de Chat -->
                <div id="ai-chat-area">
                    <div id="ai-messages" class="bg-gray-50 rounded-lg p-4 mb-4 space-y-3 min-h-[300px] max-h-[400px] overflow-y-auto border border-gray-200">
                        <div class="flex gap-3">
                            <span class="text-2xl flex-shrink-0">🤖</span>
                            <div class="bg-white p-3 rounded-lg rounded-tl-none">
                                <p class="text-sm text-gray-800">Olá! Sou a IA do Zele Serve. Posso ajudar com perguntas sobre voluntários e escalas. Tente perguntar:</p>
                                <ul class="text-xs text-gray-600 mt-2 space-y-1">
                                    <li>• "Quais voluntários têm preferência no Welcome mas nunca se escalaram?"</li>
                                    <li>• "Quem não foi escalado nos últimos 30 dias?"</li>
                                    <li>• "Quem é o voluntário mais ativo no Kids?"</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="ai-question-input" 
                            placeholder="Faça uma pergunta sobre os voluntários e escalas..."
                            class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                        />
                        <button id="ai-send-btn" class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-semibold hover:shadow-lg transition">
                            Enviar
                        </button>
                    </div>

                    <p class="text-xs text-gray-500 mt-3">
                        💡 A IA analisa dados reais do sistema para responder suas perguntas de forma precisa.
                    </p>
                </div>

                <!-- Botão Fechar -->
                <button id="close-ai-modal-btn" class="w-full mt-6 py-3 px-6 text-white font-bold rounded-lg transition hover:opacity-90" style="background-color: #151b29;">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        // 🔧 CONFIGURAÇÕES DO SISTEMA
        const CONFIG = {
            DEBUG_MODE: false, // Desativado para produção
            SCHEMA_VERSION: '2.4.0',
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000, // ms
            BACKUP_ENABLED: true,
            // EmailJS - Configure em https://www.emailjs.com/
            EMAILJS_PUBLIC_KEY: 'wtigfazeluf0vyzGp', // Trocar pela sua chave
            EMAILJS_SERVICE_ID: 'service_a6x08k6', // Trocar pelo seu service
            EMAILJS_TEMPLATE_ID: 'template_jvfnmsp' // Trocar pelo seu template
        };
        
            // Sistema de logging condicional
            const logger = {
                log: (...args) => CONFIG.DEBUG_MODE && console.log(...args),
                info: (...args) => CONFIG.DEBUG_MODE && console.info(...args),
                warn: (...args) => console.warn(...args), // Sempre mostrar warnings
                error: (...args) => console.error(...args), // Sempre mostrar erros
                success: (...args) => CONFIG.DEBUG_MODE && console.log('✅', ...args)
            };
            
            // Inicializar EmailJS
            if (typeof emailjs !== 'undefined' && CONFIG.EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
                emailjs.init(CONFIG.EMAILJS_PUBLIC_KEY);
                console.log('📧 EmailJS inicializado');
            }

        // ========================================
        // 📊 FUNÇÕES DE ESTATÍSTICAS E MODAIS (GLOBAL)
        // ========================================
        
        async function getVolunteerStats(escalas) {
            try {
                const { collection, getDocs, query, orderBy } = window.firestoreMethods;
                
                // 1. Contar total de voluntários no sistema
                const usersRef = collection(window.firebaseDb, 'users');
                const usersSnapshot = await getDocs(usersRef);
                const totalVolunteers = usersSnapshot.size;
                
                // 2. Contar líderes de times (usuários com teamLeader array não vazio)
                let totalLeaders = 0;
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.teamLeader && Array.isArray(data.teamLeader) && data.teamLeader.length > 0) {
                        totalLeaders++;
                    }
                });
                
                // 3. Contar voluntários únicos com escalas aprovadas neste mês
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                
                // Formatar datas como strings YYYY-MM-DD para comparação
                const firstDayStr = firstDayOfMonth.toISOString().split('T')[0];
                const lastDayStr = lastDayOfMonth.toISOString().split('T')[0];
                
                console.log('📅 Buscando escalas entre:', firstDayStr, 'e', lastDayStr);
                
                // Buscar TODAS as escalas do Firestore para calcular corretamente
                const allEscalasForMonthRef = collection(window.firebaseDb, 'escalas');
                const allEscalasForMonthSnapshot = await getDocs(allEscalasForMonthRef);
                
                console.log('📊 Total de escalas no Firestore:', allEscalasForMonthSnapshot.size);
                
                const escalasThisMonth = [];
                let escalasWithoutDate = 0;
                let escalasOutsideMonth = 0;
                
                allEscalasForMonthSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Verificar se tem o campo date (formato: YYYY-MM-DD)
                    if (!data.date) {
                        escalasWithoutDate++;
                        return;
                    }
                    
                    if (data.status === 'approved' || !data.status) {
                        // Comparar strings de data (YYYY-MM-DD)
                        if (data.date >= firstDayStr && data.date <= lastDayStr) {
                            escalasThisMonth.push(data);
                        } else {
                            escalasOutsideMonth++;
                        }
                    }
                });
                
                console.log('📊 Escalas encontradas neste mês:', escalasThisMonth.length);
                console.log('⚠️ Escalas SEM campo date:', escalasWithoutDate);
                console.log('📅 Escalas FORA do mês:', escalasOutsideMonth);
                
                // Debug: mostrar exemplo das primeiras 3 escalas
                if (escalasThisMonth.length > 0) {
                    console.log('📋 Exemplos de escalas do mês:', escalasThisMonth.slice(0, 3).map(e => ({
                        userId: e.userId,
                        volunteerName: e.volunteerName,
                        date: e.date,
                        team: e.team
                    })));
                }
                
                // Contar usuários únicos com escalas
                const uniqueVolunteersWithEscalas = new Set(escalasThisMonth.map(e => e.userId).filter(id => id));
                const activeVolunteers = uniqueVolunteersWithEscalas.size;
                
                console.log('👥 Voluntários únicos escalados:', activeVolunteers);
                console.log('📋 IDs dos voluntários:', Array.from(uniqueVolunteersWithEscalas));
                
                // 4. Contar voluntários com escalas no histórico total (ANY escalas, não apenas este mês)
                const allEscalasRef = collection(window.firebaseDb, 'escalas');
                const allEscalasSnapshot = await getDocs(allEscalasRef);
                const usersWithAnyEscalas = new Set();
                
                allEscalasSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId && (data.status === 'approved' || !data.status)) {
                        usersWithAnyEscalas.add(data.userId);
                    }
                });
                
                // Contar voluntários sem escalas (total - com escalas)
                const volunteersWithEscalas = usersWithAnyEscalas.size;
                const volunteersWithoutEscalas = Math.max(0, totalVolunteers - volunteersWithEscalas);
                
                // Atualizar o card com as estatísticas
                document.getElementById('stat-total-volunteers').textContent = totalVolunteers;
                document.getElementById('stat-total-leaders').textContent = totalLeaders;
                document.getElementById('stat-active-volunteers').textContent = activeVolunteers;
                document.getElementById('stat-volunteers-with-escalas').textContent = volunteersWithEscalas;
                document.getElementById('stat-volunteers-without-escalas').textContent = volunteersWithoutEscalas;
                
                // Atualizar timestamp
                const now_formatted = new Date();
                const timeStr = now_formatted.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('stat-update-time').textContent = timeStr;
                
                // Calcular estatísticas de onboarding (disponibilidade por time)
                await calculateOnboardingStats(usersSnapshot);
                
                console.log('📊 Estatísticas atualizadas:', {
                    totalVolunteers,
                    totalLeaders,
                    activeVolunteers,
                    volunteersWithEscalas,
                    volunteersWithoutEscalas
                });
                
            } catch (error) {
                console.error('❌ Erro ao carregar estatísticas:', error);
                document.getElementById('stat-total-volunteers').textContent = '?';
                document.getElementById('stat-total-leaders').textContent = '?';
                document.getElementById('stat-active-volunteers').textContent = '?';
                document.getElementById('stat-volunteers-with-escalas').textContent = '?';
                document.getElementById('stat-volunteers-without-escalas').textContent = '?';
            }
        }

        async function calculateOnboardingStats(usersSnapshot) {
            try {
                const teams = ['welcome', 'backstage', 'parking', 'kids', 'comunicacao'];
                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };
                
                const teamStats = {};
                
                teams.forEach(team => {
                    teamStats[team] = {
                        total: 0,
                        thursdayOnly: 0,
                        sundayOnly: 0,
                        both: 0
                    };
                });
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Verificar se tem onboarding completo
                    if (!data.preferredTeam || !data.availability || data.onboardingComplete !== true) {
                        return;
                    }
                    
                    const team = data.preferredTeam;
                    if (!teamStats[team]) return;
                    
                    const availability = data.availability || {};
                    
                    // Verificar quinta à noite
                    const hasThursdayNight = availability.thursday && 
                                           Array.isArray(availability.thursday) && 
                                           availability.thursday.includes('night');
                    
                    // Verificar domingo de manhã
                    const hasSundayMorning = availability.sunday && 
                                            Array.isArray(availability.sunday) && 
                                            availability.sunday.includes('morning');
                    
                    // Contar apenas quinta à noite ou domingo de manhã (ignorar sábado)
                    if (hasThursdayNight || hasSundayMorning) {
                        teamStats[team].total++;
                        
                        if (hasThursdayNight && hasSundayMorning) {
                            teamStats[team].both++;
                        } else if (hasThursdayNight) {
                            teamStats[team].thursdayOnly++;
                        } else if (hasSundayMorning) {
                            teamStats[team].sundayOnly++;
                        }
                    }
                });
                
                // Montar HTML com as estatísticas em grid 2x2
                let html = '';
                let hasData = false;
                
                // Processar times em ordem, separando comunicação para o final
                const teamsToDisplay = teams.filter(t => t !== 'comunicacao');
                const comunicacaoData = teamStats['comunicacao'];
                
                // Renderizar times (2 em 2)
                teamsToDisplay.forEach((team, index) => {
                    const stats = teamStats[team];
                    if (stats.total > 0) {
                        hasData = true;
                        const teamEmojis = {
                            welcome: '👋',
                            backstage: '🤝',
                            parking: '🚗',
                            kids: '👶'
                        };
                        html += `
                            <div class="border-2 border-blue-300 rounded-lg p-3 bg-white hover:shadow-md transition">
                                <p class="font-bold text-gray-800 text-sm mb-2">${teamEmojis[team]} ${team.charAt(0).toUpperCase() + team.slice(1)}</p>
                                <div class="text-xs text-gray-600 space-y-1">
                                    <p class="text-sm font-semibold text-blue-600">${stats.total}</p>
                                    <p>Só Quinta: <span class="font-semibold">${stats.thursdayOnly}</span></p>
                                    <p>Só Domingo: <span class="font-semibold">${stats.sundayOnly}</span></p>
                                    <p>Qui e Dom: <span class="font-semibold">${stats.both}</span></p>
                                </div>
                            </div>
                        `;
                    }
                });
                
                // Adicionar comunicação em coluna própria (sem col-span)
                if (comunicacaoData && comunicacaoData.total > 0) {
                    hasData = true;
                    html += `
                        <div class="border-2 border-purple-300 rounded-lg p-3 bg-white hover:shadow-md transition">
                            <p class="font-bold text-gray-800 text-sm mb-2">📢 Comunicação</p>
                            <div class="text-xs text-gray-600 space-y-1">
                                <p class="text-sm font-semibold text-purple-600">${comunicacaoData.total}</p>
                                <p>Só Quinta: <span class="font-semibold">${comunicacaoData.thursdayOnly}</span></p>
                                <p>Só Domingo: <span class="font-semibold">${comunicacaoData.sundayOnly}</span></p>
                                <p>Qui e Dom: <span class="font-semibold">${comunicacaoData.both}</span></p>
                            </div>
                        </div>
                    `;
                }
                
                // Exibir ou ocultar a seção
                const container = document.getElementById('onboarding-stats-container');
                const content = document.getElementById('onboarding-stats-content');
                
                if (hasData && container && content) {
                    content.innerHTML = html;
                    container.style.display = 'block';
                } else if (container) {
                    container.style.display = 'none';
                }
                
                console.log('📊 Estatísticas de onboarding calculadas:', teamStats);
                
            } catch (error) {
                console.error('❌ Erro ao calcular estatísticas de onboarding:', error);
            }
        }

        async function openTotalVolunteersModal() {
            console.log('🔵 openTotalVolunteersModal chamada');
            const { collection, getDocs, query, orderBy } = window.firestoreMethods;
            const usersRef = collection(window.firebaseDb, 'users');
            const q = query(usersRef, orderBy('email', 'asc'));
            const snapshot = await getDocs(q);
            
            const users = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                users.push({
                    id: doc.id,
                    email: data.email || 'Sem email',
                    displayName: data.displayName || data.email?.split('@')[0] || 'Sem nome',
                    lastLoginFormatted: data.lastLoginFormatted || '🔴 Nunca acessou'
                });
            });
            
            const listElement = document.getElementById('stat-total-volunteers-list');
            const searchInput = document.getElementById('stat-total-volunteers-search');
            
            function renderList(filtered) {
                listElement.innerHTML = filtered.map(user => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${user.displayName}</p>
                                <p class="text-sm text-gray-600">${user.email}</p>
                                <p class="text-xs text-gray-500 mt-2">🕐 Último acesso: ${user.lastLoginFormatted}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            renderList(users);
            
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = users.filter(u => 
                    u.displayName.toLowerCase().includes(term) || 
                    u.email.toLowerCase().includes(term)
                );
                renderList(filtered);
            });
            
            // Abrir modal
            const modal = document.getElementById('stat-total-volunteers-modal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // Fechar ao clicar no X
                const closeBtn = document.getElementById('stat-total-volunteers-modal-close');
                if (closeBtn) {
                    closeBtn.onclick = () => modal.classList.add('hidden');
                }
                
                // Fechar ao clicar fora do modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                };
                
                console.log('✅ Modal aberto');
            } else {
                console.error('❌ Modal não encontrado');
            }
        }

        async function openTotalLeadersModal() {
            console.log('👑 openTotalLeadersModal chamada');
            const { collection, getDocs, query, orderBy } = window.firestoreMethods;
            const usersRef = collection(window.firebaseDb, 'users');
            const q = query(usersRef, orderBy('email', 'asc'));
            const snapshot = await getDocs(q);
            
            const leaders = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.teamLeader && Array.isArray(data.teamLeader) && data.teamLeader.length > 0) {
                    const teamEmojis = {
                        welcome: '👋',
                        backstage: '🤝',
                        parking: '🚗',
                        kids: '👶',
                        comunicacao: '📢'
                    };
                    leaders.push({
                        id: doc.id,
                        email: data.email || 'Sem email',
                        displayName: data.displayName || data.email?.split('@')[0] || 'Sem nome',
                        lastLoginFormatted: data.lastLoginFormatted || '🔴 Nunca acessou',
                        teams: data.teamLeader.map(t => `${teamEmojis[t] || ''} ${t}`).join(', ')
                    });
                }
            });
            
            const listElement = document.getElementById('stat-total-leaders-list');
            const searchInput = document.getElementById('stat-total-leaders-search');
            
            function renderList(filtered) {
                listElement.innerHTML = filtered.map(leader => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${leader.displayName}</p>
                                <p class="text-sm text-gray-600">${leader.email}</p>
                                <p class="text-xs text-purple-600 font-medium mt-1">Líder de: ${leader.teams}</p>
                                <p class="text-xs text-gray-500 mt-2">🕐 Último acesso: ${leader.lastLoginFormatted}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            renderList(leaders);
            
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = leaders.filter(u => 
                    u.displayName.toLowerCase().includes(term) || 
                    u.email.toLowerCase().includes(term)
                );
                renderList(filtered);
            });
            
            // Abrir modal
            const modal = document.getElementById('stat-total-leaders-modal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // Fechar ao clicar no X
                const closeBtn = document.getElementById('stat-total-leaders-modal-close');
                if (closeBtn) {
                    closeBtn.onclick = () => modal.classList.add('hidden');
                }
                
                // Fechar ao clicar fora do modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                };
                
                console.log('✅ Modal de líderes aberto');
            } else {
                console.error('❌ Modal de líderes não encontrado');
            }
        }

        async function openVolunteersWithEscalasModal() {
            console.log('✅ openVolunteersWithEscalasModal chamada');
            const { collection, getDocs } = window.firestoreMethods;
            
            // Buscar usuários primeiro para ter os nomes corretos
            const usersRef = collection(window.firebaseDb, 'users');
            const usersSnapshot = await getDocs(usersRef);
            const userMap = new Map();
            usersSnapshot.forEach(doc => {
                userMap.set(doc.id, doc.data());
            });
            
            // Buscar escalas e contar por usuário
            const escalasRef = collection(window.firebaseDb, 'escalas');
            const snapshot = await getDocs(escalasRef);
            
            const usersWithEscalas = new Map();
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.userId && (data.status === 'approved' || !data.status)) {
                    if (!usersWithEscalas.has(data.userId)) {
                        const userData = userMap.get(data.userId);
                        usersWithEscalas.set(data.userId, {
                            userId: data.userId,
                            email: userData?.email || data.userEmail || 'Sem email',
                            displayName: userData?.displayName || data.volunteerName || 'Sem nome',
                            lastLogin: userData?.lastLoginFormatted || '🔴 Nunca acessou',
                            count: 0
                        });
                    }
                    usersWithEscalas.get(data.userId).count++;
                }
            });
            
            const users = Array.from(usersWithEscalas.values()).sort((a, b) => b.count - a.count);
            
            const listElement = document.getElementById('stat-volunteers-with-escalas-list');
            const searchInput = document.getElementById('stat-volunteers-with-escalas-search');
            
            function renderList(filtered) {
                listElement.innerHTML = filtered.map(user => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${user.displayName}</p>
                                <p class="text-sm text-gray-600">${user.email}</p>
                                <p class="text-xs text-emerald-600 font-medium mt-1">📊 ${user.count} escala(s)</p>
                                <p class="text-xs text-gray-500 mt-2">🕐 Último acesso: ${user.lastLogin}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            renderList(users);
            
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = users.filter(u => 
                    u.displayName.toLowerCase().includes(term) || 
                    u.email.toLowerCase().includes(term)
                );
                renderList(filtered);
            });
            
            // Abrir modal
            const modal = document.getElementById('stat-volunteers-with-escalas-modal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // Fechar ao clicar no X
                const closeBtn = document.getElementById('stat-volunteers-with-escalas-modal-close');
                if (closeBtn) {
                    closeBtn.onclick = () => modal.classList.add('hidden');
                }
                
                // Fechar ao clicar fora do modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                };
                
                console.log('✅ Modal de voluntários com escalas aberto');
            } else {
                console.error('❌ Modal não encontrado');
            }
        }

        async function openActiveVolunteersModal() {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            
            // Formatar datas como strings YYYY-MM-DD para comparação
            const firstDayStr = firstDayOfMonth.toISOString().split('T')[0];
            const lastDayStr = lastDayOfMonth.toISOString().split('T')[0];
            
            const { collection, getDocs } = window.firestoreMethods;
            
            // Buscar usuários primeiro para ter os nomes corretos
            const usersRef = collection(window.firebaseDb, 'users');
            const usersSnapshot = await getDocs(usersRef);
            const userMap = new Map();
            usersSnapshot.forEach(doc => {
                userMap.set(doc.id, doc.data());
            });
            
            // Buscar todas as escalas deste mês
            const escalasRef = collection(window.firebaseDb, 'escalas');
            const escalasSnapshot = await getDocs(escalasRef);
            
            const usersEscalas = new Map();
            escalasSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.userId && (data.status === 'approved' || !data.status) && data.date) {
                    // Comparar strings de data (YYYY-MM-DD)
                    if (data.date >= firstDayStr && data.date <= lastDayStr) {
                        if (!usersEscalas.has(data.userId)) {
                            const userData = userMap.get(data.userId);
                            usersEscalas.set(data.userId, {
                                userId: data.userId,
                                email: userData?.email || data.userEmail || 'Sem email',
                                displayName: userData?.displayName || data.volunteerName || 'Sem nome',
                                lastLogin: userData?.lastLoginFormatted || '🔴 Nunca acessou',
                                count: 0
                            });
                        }
                        usersEscalas.get(data.userId).count++;
                    }
                }
            });
            
            const users = Array.from(usersEscalas.values()).sort((a, b) => b.count - a.count);
            
            const listElement = document.getElementById('stat-active-volunteers-list');
            const searchInput = document.getElementById('stat-active-volunteers-search');
            
            function renderList(filtered) {
                if (filtered.length === 0) {
                    listElement.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum voluntário escalado neste mês</p>';
                    return;
                }
                listElement.innerHTML = filtered.map(user => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${user.displayName}</p>
                                <p class="text-sm text-gray-600">${user.email}</p>
                                <p class="text-xs text-green-600 font-medium mt-1">📊 ${user.count} escala(s) este mês</p>
                                <p class="text-xs text-gray-500 mt-2">🕐 Último acesso: ${user.lastLogin}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            renderList(users);
            
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = users.filter(u => 
                    u.displayName.toLowerCase().includes(term) || 
                    u.email.toLowerCase().includes(term)
                );
                renderList(filtered);
            });
            
            // Abrir modal
            const modal = document.getElementById('stat-active-volunteers-modal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // Fechar ao clicar no X
                const closeBtn = document.getElementById('stat-active-volunteers-modal-close');
                if (closeBtn) {
                    closeBtn.onclick = () => modal.classList.add('hidden');
                }
                
                // Fechar ao clicar fora do modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                };
                
                console.log('✅ Modal de escalados este mês aberto');
            } else {
                console.error('❌ Modal não encontrado');
            }
        }

        async function openVolunteersWithoutEscalasModal() {
            const { collection, getDocs, query, orderBy } = window.firestoreMethods;
            const usersRef = collection(window.firebaseDb, 'users');
            const q = query(usersRef, orderBy('email', 'asc'));
            const usersSnapshot = await getDocs(q);
            
            // Buscar todos os usuários com escalas
            const escalasRef = collection(window.firebaseDb, 'escalas');
            const escalasSnapshot = await getDocs(escalasRef);
            const usersWithEscalas = new Set();
            
            escalasSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.userId && (data.status === 'approved' || !data.status)) {
                    usersWithEscalas.add(data.userId);
                }
            });
            
            // Filtrar usuários sem escalas
            const users = [];
            usersSnapshot.forEach(doc => {
                const data = doc.data();
                if (!usersWithEscalas.has(doc.id)) {
                    users.push({
                        id: doc.id,
                        email: data.email || 'Sem email',
                        displayName: data.displayName || data.email?.split('@')[0] || 'Sem nome',
                        lastLoginFormatted: data.lastLoginFormatted || '🔴 Nunca acessou'
                    });
                }
            });
            
            const listElement = document.getElementById('stat-volunteers-without-escalas-list');
            const searchInput = document.getElementById('stat-volunteers-without-escalas-search');
            
            function renderList(filtered) {
                listElement.innerHTML = filtered.map(user => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${user.displayName}</p>
                                <p class="text-sm text-gray-600">${user.email}</p>
                                <p class="text-xs text-slate-600 font-medium mt-1">❌ Sem escalas</p>
                                <p class="text-xs text-gray-500 mt-2">🕐 Último acesso: ${user.lastLoginFormatted}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            renderList(users);
            
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = users.filter(u => 
                    u.displayName.toLowerCase().includes(term) || 
                    u.email.toLowerCase().includes(term)
                );
                renderList(filtered);
            });
            
            // Abrir modal
            const modal = document.getElementById('stat-volunteers-without-escalas-modal');
            if (modal) {
                modal.classList.remove('hidden');
                
                // Fechar ao clicar no X
                const closeBtn = document.getElementById('stat-volunteers-without-escalas-modal-close');
                if (closeBtn) {
                    closeBtn.onclick = () => modal.classList.add('hidden');
                }
                
                // Fechar ao clicar fora do modal
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                };
                
                console.log('✅ Modal de voluntários sem escalas aberto');
            } else {
                console.error('❌ Modal não encontrado');
            }
        }

        // ========================================
        // 🚀 INICIALIZAÇÃO DO APP - v2.4.0
        // ========================================
        // Aguardar Firebase estar pronto
        function initApp() {
            console.log('═══════════════════════════════════════════');
            console.log('🚀 Zele Serve v' + CONFIG.SCHEMA_VERSION);
            console.log('📋 DEBUG MODE:', CONFIG.DEBUG_MODE ? 'ATIVADO ⚠️' : 'DESATIVADO');
            console.log('═══════════════════════════════════════════');
            
            logger.log('🚀 App iniciando... v' + CONFIG.SCHEMA_VERSION);
            
            // Verificar se Firebase foi inicializado
            if (!window.firebaseAuth || !window.firebaseDb) {
                logger.error('❌ Firebase não inicializado, tentando novamente...');
                setTimeout(initApp, 100);
                return;
            }
            
            // Função de retry para operações Firestore
            async function firestoreRetry(operation, operationName = 'Operação') {
                let lastError;
                for (let attempt = 1; attempt <= CONFIG.MAX_RETRIES; attempt++) {
                    try {
                        logger.log(`🔄 ${operationName} - Tentativa ${attempt}/${CONFIG.MAX_RETRIES}`);
                        const result = await operation();
                        logger.success(`${operationName} - Sucesso`);
                        return result;
                    } catch (error) {
                        lastError = error;
                        console.error(`🔍 DEBUG - Erro na tentativa ${attempt}:`, {
                            name: error.name,
                            message: error.message,
                            code: error.code,
                            stack: error.stack
                        });
                        logger.warn(`⚠️ ${operationName} - Falha na tentativa ${attempt}:`, error.message);
                        if (attempt < CONFIG.MAX_RETRIES) {
                            await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * attempt));
                        }
                    }
                }
                console.error(`🔍 DEBUG - Erro final após todas tentativas:`, lastError);
                logger.error(`❌ ${operationName} - Todas as tentativas falharam`);
                throw lastError;
            }
            
            // Sistema de backup automático
            async function backupData(action, data) {
                if (!CONFIG.BACKUP_ENABLED) return;
                
                try {
                    const { collection, addDoc } = window.firestoreMethods;
                    await addDoc(collection(window.firebaseDb, 'backups'), {
                        action: action,
                        data: data,
                        user: currentUser?.email || 'unknown',
                        timestamp: new Date().toISOString(),
                        schemaVersion: CONFIG.SCHEMA_VERSION
                    });
                    logger.log('💾 Backup criado:', action);
                } catch (error) {
                    logger.error('❌ Erro ao criar backup:', error);
                    // Não bloquear operação se backup falhar
                }
            }
            
            logger.success('Firebase Auth:', window.firebaseAuth ? 'OK' : 'Falha');
            logger.success('Firebase DB:', window.firebaseDb ? 'OK' : 'Falha');
            logger.success('Firebase Provider:', window.firebaseProvider ? 'OK' : 'Falha');
            
            let currentUser = null;
            let selectedTeam = null;
            let isAdmin = false;
            let isSuperAdmin = false;
            let isTeamLeader = false;
            let userTeamLeadership = [];
            let userBlockedDates = {}; // {'YYYY-MM-DD': ['all'] | ['morning','afternoon','night']}
            let availableDates = [];
            let deferredPrompt = null;
            let isIOS = false;
            let onboardingCompleted = false; // Flag para evitar reabertura do modal após salvar
            
            // Verificar e atualizar badge de próximos eventos
            function updateUpcomingEventsBadge(escalas) {
                const now = new Date();
                const next48h = new Date(now.getTime() + (48 * 60 * 60 * 1000)); // 48 horas
                
                const upcomingEvents = escalas.filter(escala => {
                    const eventDateTime = new Date(escala.date + 'T' + escala.time);
                    return eventDateTime > now && eventDateTime <= next48h;
                });
                
                // Atualizar badge do menu
                const badge = document.getElementById('upcoming-badge');
                if (badge) {
                    if (upcomingEvents.length > 0) {
                        badge.textContent = upcomingEvents.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
                
                // Atualizar badge do header (foto do usuário)
                const headerBadge = document.getElementById('header-badge');
                if (headerBadge) {
                    if (upcomingEvents.length > 0) {
                        headerBadge.textContent = upcomingEvents.length;
                        headerBadge.classList.remove('hidden');
                        console.log(`🔔 ${upcomingEvents.length} evento(s) nas próximas 48h`);
                    } else {
                        headerBadge.classList.add('hidden');
                    }
                }
                
                return upcomingEvents;
            }
            
            // Enviar email de lembrete 24h antes do evento
            async function sendReminderEmail(escalaData) {
                // Verificar se EmailJS está configurado
                if (CONFIG.EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                    console.log('⚠️ EmailJS não configurado. Pule o envio de email.');
                    return;
                }
                
                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };
                
                const eventDate = new Date(escalaData.date + 'T' + escalaData.time);
                const formattedDate = eventDate.toLocaleDateString('pt-BR', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                const formattedTime = escalaData.time === '00:00' ? 'Horário a definir' : escalaData.time;
                
                const templateParams = {
                    to_email: currentUser.email,
                    to_name: currentUser.displayName || currentUser.email,
                    event_date: formattedDate,
                    event_time: formattedTime,
                    event_name: escalaData.eventName || '',
                    team_name: teamNames[escalaData.team] || escalaData.team
                };
                
                try {
                    await emailjs.send(
                        CONFIG.EMAILJS_SERVICE_ID,
                        CONFIG.EMAILJS_TEMPLATE_ID,
                        templateParams
                    );
                    console.log('📧 Email de lembrete enviado para:', currentUser.email);
                } catch (error) {
                    console.error('❌ Erro ao enviar email:', error);
                }
            }
            
            // Verificar eventos que precisam de lembrete (24h antes)
            async function checkAndSendReminders(escalas) {
                const now = new Date();
                const in24h = new Date(now.getTime() + (24 * 60 * 60 * 1000));
                const in25h = new Date(now.getTime() + (25 * 60 * 60 * 1000));
                
                for (const escala of escalas) {
                    const eventDateTime = new Date(escala.date + 'T' + escala.time);
                    
                    // Se o evento está entre 24h e 25h no futuro
                    if (eventDateTime > in24h && eventDateTime <= in25h) {
                        // Verificar se já enviou lembrete (evitar duplicatas)
                        const reminderSentKey = `reminder_sent_${escala.id}`;
                        const alreadySent = localStorage.getItem(reminderSentKey);
                        
                        if (!alreadySent) {
                            await sendReminderEmail(escala);
                            localStorage.setItem(reminderSentKey, 'true');
                        }
                    }
                }
            }
            
            // Pré-carregar todas as imagens dos times
            const preloadedImages = {};
            function preloadTeamImages() {
                const imageUrls = [
                    'https://github.com/escalaserver/zele/blob/main/Logo%20Welcome%20horizontal.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Welcome%20azul%20claro.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Logo%20Backstage%20horizontal.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Backstage%20azul%20claro.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Logo%20Parking%20horizontal.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Parking%20azul%20claro.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Logo%20Kids%20horizontal.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Kids%20azul%20claro.png?raw=true',
                    'https://raw.githubusercontent.com/escalaserver/zele/main/Logo%20Comunicação%20horizontal.png',
                    'https://raw.githubusercontent.com/escalaserver/zele/main/Comunicação%20azul%20claro.png'
                ];
                
                imageUrls.forEach(url => {
                    const img = new Image();
                    img.src = url;
                    preloadedImages[url] = img;
                });
                
                console.log('✅ Imagens dos times pré-carregadas');
            }
            
            // Chamar pré-carregamento assim que o app iniciar
            preloadTeamImages();
            
            // Elementos DOM
            const elements = {
                loadingScreen: document.getElementById('loading-screen'),
                authScreen: document.getElementById('auth-screen'),
                appContainer: document.getElementById('app-container'),
                googleLoginBtn: document.getElementById('google-login-btn'),
                menuBtn: document.getElementById('menu-btn'),
                menuOverlay: document.getElementById('menu-overlay'),
                menuDrawer: document.getElementById('menu-drawer'),
                menuCloseBtn: document.getElementById('menu-close-btn'),
                menuLogoutBtn: document.getElementById('menu-logout-btn'),
                installAppBtn: document.getElementById('install-app-btn'),
                menuUserName: document.getElementById('menu-user-name'),
                menuUserEmail: document.getElementById('menu-user-email'),
                menuUserPhoto: document.getElementById('menu-user-photo'),
                userName: document.getElementById('user-name'),
                userEmail: document.getElementById('user-email'),
                userPhoto: document.getElementById('user-photo'),
                cultoSelect: document.getElementById('culto-select'),
                escalasList: document.getElementById('escalas-list'),
                adminView: document.getElementById('admin-view'),
                teamBtns: document.querySelectorAll('.team-btn'),
                successModal: document.getElementById('success-modal'),
                modalMessage: document.getElementById('modal-message'),
                modalButtons: document.getElementById('modal-buttons'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                filterMinhasEscalas: document.getElementById('filter-minhas-escalas'),
                filterVisaoGeral: document.getElementById('filter-visao-geral')
            };
            
            // Variáveis para armazenar dados completos
            let allUserEscalas = [];
            let allEscalasGrouped = {};

            // Modal functions
            function showModal(message, showYesNo = false, onYes = null, isWarning = false, onClose = null, customEmoji = null) {
                console.log('🔔 showModal chamado:', { showYesNo, hasOnYes: !!onYes, message: message.substring(0, 50) });
                
                // Usar innerHTML para suportar formatação HTML
                elements.modalMessage.innerHTML = message;
                
                // Mudar emoji baseado no tipo de modal
                const emojiDiv = elements.successModal.querySelector('.mb-4');
                if (customEmoji) {
                    emojiDiv.textContent = customEmoji;
                } else if (isWarning) {
                    emojiDiv.textContent = '⚠️';
                } else {
                    emojiDiv.textContent = '✅';
                }
                
                if (showYesNo && onYes) {
                    console.log('🔔 Modal Sim/Não criado');
                    // Modal com Sim/Não
                    elements.modalButtons.innerHTML = `
                        <button id="modal-no-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">
                            Não
                        </button>
                        <button id="modal-yes-btn" class="flex-1 zele-btn text-white font-bold py-3 px-6 rounded-lg">
                            Sim
                        </button>
                    `;
                    
                    document.getElementById('modal-yes-btn').addEventListener('click', () => {
                        console.log('🔔 Botão SIM clicado');
                        closeModal();
                        onYes();
                    });
                    
                    document.getElementById('modal-no-btn').addEventListener('click', () => {
                        console.log('🔔 Botão NÃO clicado');
                        closeModal();
                        if (onClose) onClose();
                    });
                } else {
                    console.log('🔔 Modal OK criado');
                    // Modal apenas com OK
                    elements.modalButtons.innerHTML = `
                        <button id="modal-close-btn" class="flex-1 zele-btn text-white font-bold py-3 px-6 rounded-lg">
                            OK
                        </button>
                    `;
                    
                    document.getElementById('modal-close-btn').addEventListener('click', () => {
                        console.log('🔔 Botão OK clicado');
                        closeModal();
                        if (onClose) onClose();
                    });
                }
                
                elements.successModal.classList.add('show');
            }

            function closeModal() {
                elements.successModal.classList.remove('show');
            }

            elements.successModal.addEventListener('click', (e) => {
                if (e.target === elements.successModal) {
                    closeModal();
                }
            });

            // Modal com input personalizado
            function showModalWithInput(title, htmlContent, confirmButtonText = 'Confirmar', defaultValue = '') {
                return new Promise((resolve) => {
                    const modalHtml = `
                        ${htmlContent}
                        <div class="mt-4">
                            <input type="text" id="custom-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                                   placeholder="Digite aqui..." value="${defaultValue}">
                        </div>
                    `;

                    elements.modalMessage.innerHTML = `<h3 class="text-lg font-bold mb-4">${title}</h3>${modalHtml}`;
                    
                    const emojiDiv = elements.successModal.querySelector('.mb-4');
                    emojiDiv.textContent = '📝';

                    elements.modalButtons.innerHTML = `
                        <button id="modal-cancel-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">
                            Cancelar
                        </button>
                        <button id="modal-confirm-btn" class="flex-1 zele-btn text-white font-bold py-3 px-6 rounded-lg">
                            ${confirmButtonText}
                        </button>
                    `;

                    const inputEl = document.getElementById('custom-input');
                    
                    document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                        const value = inputEl?.value || '';
                        closeModal();
                        resolve(value);
                    });

                    document.getElementById('modal-cancel-btn').addEventListener('click', () => {
                        closeModal();
                        resolve(null);
                    });

                    elements.successModal.classList.add('show');
                    
                    // Focar no input após um pequeno delay
                    setTimeout(() => inputEl?.focus(), 100);
                });
            }

            // Menu functions
            function openMenu() {
                elements.menuOverlay.classList.add('show');
                elements.menuDrawer.classList.add('show');
            }

            function closeMenu() {
                elements.menuOverlay.classList.remove('show');
                elements.menuDrawer.classList.remove('show');
            }

            elements.menuBtn.addEventListener('click', openMenu);
            elements.menuCloseBtn.addEventListener('click', closeMenu);
            elements.menuOverlay.addEventListener('click', closeMenu);
            elements.menuLogoutBtn.addEventListener('click', () => {
                closeMenu();
                logout();
            });

            // Navegação para página de próximos cultos do líder
            const menuUpcomingServicesBtn = document.getElementById('menu-upcoming-services-btn');
            if (menuUpcomingServicesBtn) {
                menuUpcomingServicesBtn.addEventListener('click', () => {
                    closeMenu();
                    showLeaderUpcomingServices();
                });
            }

            // Navegação para página de admin
            const menuAdminBtn = document.getElementById('menu-admin-btn');
            const backFromAdminBtn = document.getElementById('back-from-admin');
            const appContainer = document.getElementById('app-container');
            const adminPage = document.getElementById('admin-page');

            if (menuAdminBtn) {
                menuAdminBtn.addEventListener('click', () => {
                    closeMenu();
                    appContainer.classList.add('hidden');
                    adminPage.classList.remove('hidden');
                    renderAdminDatesList(); // Atualizar lista de datas
                });
            }

            if (backFromAdminBtn) {
                backFromAdminBtn.addEventListener('click', () => {
                    adminPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                });
            }

            // Navegação para página de gerenciar admins
            const menuManageAdminsBtn = document.getElementById('menu-manage-admins-btn');
            const backFromManageAdminsBtn = document.getElementById('back-from-manage-admins');
            const manageAdminsPage = document.getElementById('manage-admins-page');

            if (menuManageAdminsBtn) {
                menuManageAdminsBtn.addEventListener('click', () => {
                    closeMenu();
                    appContainer.classList.add('hidden');
                    manageAdminsPage.classList.remove('hidden');
                    loadUsersList(); // Carregar lista de usuários
                });
            }

            if (backFromManageAdminsBtn) {
                backFromManageAdminsBtn.addEventListener('click', () => {
                    manageAdminsPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                });
            }

            // Navegação para Modal de Gerenciar Funções
            const menuManageRolesBtn = document.getElementById('menu-manage-roles-btn');
            const manageRolesModal = document.getElementById('manage-roles-modal');
            const closeManageRolesModal = document.getElementById('close-manage-roles-modal');
            const closeRolesModalBtn = document.getElementById('close-roles-modal-btn');

            if (menuManageRolesBtn) {
                menuManageRolesBtn.addEventListener('click', async () => {
                    closeMenu();
                    manageRolesModal.classList.remove('hidden');
                    
                    // Resetar estado do modal
                    document.getElementById('roles-team-select').value = '';
                    document.getElementById('add-role-section').classList.add('hidden');
                    document.getElementById('roles-list-section').classList.add('hidden');
                    document.getElementById('no-team-selected-msg').classList.remove('hidden');
                    document.getElementById('new-role-input').value = '';
                    
                    // Carregar configurações de funções
                    await loadTeamRoles();
                });
            }

            if (closeManageRolesModal) {
                closeManageRolesModal.addEventListener('click', () => {
                    manageRolesModal.classList.add('hidden');
                });
            }

            if (closeRolesModalBtn) {
                closeRolesModalBtn.addEventListener('click', () => {
                    manageRolesModal.classList.add('hidden');
                });
            }

            // Fechar modal ao clicar fora
            manageRolesModal?.addEventListener('click', (e) => {
                if (e.target === manageRolesModal) {
                    manageRolesModal.classList.add('hidden');
                }
            });

            // Navegação para página de Escalar Voluntários Manualmente
            const menuManualScaleBtn = document.getElementById('menu-manual-scale-btn');
            const backFromManualScaleBtn = document.getElementById('back-from-manual-scale');
            const manualScalePage = document.getElementById('manual-scale-page');

            if (menuManualScaleBtn) {
                menuManualScaleBtn.addEventListener('click', () => {
                    closeMenu();
                    appContainer.classList.add('hidden');
                    manualScalePage.classList.remove('hidden');
                    initManualScalePanel(); // Inicializar painel de escala manual
                });
            }

            if (backFromManualScaleBtn) {
                backFromManualScaleBtn.addEventListener('click', () => {
                    manualScalePage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    resetManualScalePanel(); // Resetar formulário
                });
            }

            // Navegação para página de Logs de Auditoria
            const menuAuditLogsBtn = document.getElementById('menu-audit-logs-btn');
            const backFromAuditLogsBtn = document.getElementById('back-from-audit-logs');
            const auditLogsPage = document.getElementById('audit-logs-page');
            const refreshAuditLogsBtn = document.getElementById('refresh-audit-logs');
            const auditLogFilter = document.getElementById('audit-log-filter');
            const auditLogPeriod = document.getElementById('audit-log-period');

            if (menuAuditLogsBtn) {
                menuAuditLogsBtn.addEventListener('click', () => {
                    closeMenu();
                    appContainer.classList.add('hidden');
                    auditLogsPage.classList.remove('hidden');
                    loadAuditLogs();
                });
            }

            if (backFromAuditLogsBtn) {
                backFromAuditLogsBtn.addEventListener('click', () => {
                    auditLogsPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                });
            }

            if (refreshAuditLogsBtn) {
                refreshAuditLogsBtn.addEventListener('click', () => loadAuditLogs());
            }

            if (auditLogFilter) {
                auditLogFilter.addEventListener('change', () => loadAuditLogs());
            }

            if (auditLogPeriod) {
                auditLogPeriod.addEventListener('change', () => loadAuditLogs());
            }

            // Navegação para página de Dashboard
            const menuDashboardBtn = document.getElementById('menu-dashboard-btn');
            const backFromDashboardBtn = document.getElementById('back-from-dashboard');
            const dashboardPage = document.getElementById('dashboard-page');

            if (menuDashboardBtn) {
                menuDashboardBtn.addEventListener('click', () => {
                    closeMenu();
                    appContainer.classList.add('hidden');
                    dashboardPage.classList.remove('hidden');
                    loadDashboard(); // Carregar dashboard
                });
            }

            if (backFromDashboardBtn) {
                backFromDashboardBtn.addEventListener('click', () => {
                    dashboardPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                });
            }

            // Navegação para Próximos Eventos (volta para app-container)
            const menuUpcomingEventsBtn = document.getElementById('menu-upcoming-events-btn');
            if (menuUpcomingEventsBtn) {
                menuUpcomingEventsBtn.addEventListener('click', () => {
                    closeMenu();
                    // Fechar todas as outras páginas e mostrar o app principal
                    adminPage.classList.add('hidden');
                    manageAdminsPage.classList.add('hidden');
                    dashboardPage.classList.add('hidden');
                    const blockedAttemptsPage = document.getElementById('blocked-attempts-page');
                    if (blockedAttemptsPage) blockedAttemptsPage.classList.add('hidden');
                    const pendingEscalasPage = document.getElementById('pending-escalas-page');
                    if (pendingEscalasPage) pendingEscalasPage.classList.add('hidden');
                    const checkinPage = document.getElementById('checkin-page');
                    if (checkinPage) checkinPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    // Scroll até as escalas
                    const escalasList = document.getElementById('escalas-list');
                    if (escalasList) {
                        setTimeout(() => {
                            escalasList.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                });
            }

            // Navegação para Bloqueio de Datas (volta para app-container e foca no bloqueio)
            const menuBlockDatesBtn = document.getElementById('menu-block-dates-btn');
            if (menuBlockDatesBtn) {
                menuBlockDatesBtn.addEventListener('click', () => {
                    closeMenu();
                    // Fechar todas as outras páginas e mostrar o app principal
                    adminPage.classList.add('hidden');
                    manageAdminsPage.classList.add('hidden');
                    dashboardPage.classList.add('hidden');
                    const blockedAttemptsPage = document.getElementById('blocked-attempts-page');
                    if (blockedAttemptsPage) blockedAttemptsPage.classList.add('hidden');
                    const pendingEscalasPage = document.getElementById('pending-escalas-page');
                    if (pendingEscalasPage) pendingEscalasPage.classList.add('hidden');
                    const checkinPage = document.getElementById('checkin-page');
                    if (checkinPage) checkinPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    // Aqui poderia abrir um modal de bloqueio de datas se existir
                });
            }

            // ===================================
            // CONTROLE DOS GRUPOS EXPANSÍVEIS DO MENU
            // ===================================

            // Grupo 1: Meu Menu
            const toggleMyMenu = document.getElementById('toggle-my-menu');
            const myMenuItems = document.getElementById('my-menu-items');
            const myMenuArrow = document.getElementById('my-menu-arrow');

            // Grupo 2: Menu da Liderança
            const toggleLeadershipMenu = document.getElementById('toggle-leadership-menu');
            const leadershipMenuItems = document.getElementById('leadership-menu-items');
            const leadershipMenuArrow = document.getElementById('leadership-menu-arrow');

            // Grupo 3: Menu Administrativo
            const toggleAdminMenu = document.getElementById('toggle-admin-menu');
            const adminMenuItems = document.getElementById('admin-menu-items');
            const adminMenuArrow = document.getElementById('admin-menu-arrow');

            if (toggleMyMenu) {
                toggleMyMenu.addEventListener('click', () => {
                    const isExpanding = myMenuItems.classList.contains('hidden');
                    
                    // Se estiver expandindo o grupo 1, retrair os outros
                    if (isExpanding) {
                        if (leadershipMenuItems) {
                            leadershipMenuItems.classList.add('hidden');
                            leadershipMenuArrow.classList.remove('rotate-90');
                        }
                        if (adminMenuItems) {
                            adminMenuItems.classList.add('hidden');
                            adminMenuArrow.classList.remove('rotate-90');
                        }
                    }
                    
                    myMenuItems.classList.toggle('hidden');
                    myMenuArrow.classList.toggle('rotate-90');
                });
            }

            if (toggleLeadershipMenu) {
                toggleLeadershipMenu.addEventListener('click', () => {
                    const isExpanding = leadershipMenuItems.classList.contains('hidden');
                    
                    // Se estiver expandindo o grupo 2, retrair os outros
                    if (isExpanding) {
                        if (myMenuItems) {
                            myMenuItems.classList.add('hidden');
                            myMenuArrow.classList.remove('rotate-90');
                        }
                        if (adminMenuItems) {
                            adminMenuItems.classList.add('hidden');
                            adminMenuArrow.classList.remove('rotate-90');
                        }
                    }
                    
                    leadershipMenuItems.classList.toggle('hidden');
                    leadershipMenuArrow.classList.toggle('rotate-90');
                });
            }

            if (toggleAdminMenu) {
                toggleAdminMenu.addEventListener('click', () => {
                    const isExpanding = adminMenuItems.classList.contains('hidden');
                    
                    // Se estiver expandindo o grupo 3, retrair os outros
                    if (isExpanding) {
                        if (myMenuItems) {
                            myMenuItems.classList.add('hidden');
                            myMenuArrow.classList.remove('rotate-90');
                        }
                        if (leadershipMenuItems) {
                            leadershipMenuItems.classList.add('hidden');
                            leadershipMenuArrow.classList.remove('rotate-90');
                        }
                    }
                    
                    adminMenuItems.classList.toggle('hidden');
                    adminMenuArrow.classList.toggle('rotate-90');
                });
            }

            // ===================================
            // DETECÇÃO E INSTALAÇÃO PWA
            // ===================================

            // Detectar se é iOS
            function detectIOS() {
                const userAgent = window.navigator.userAgent.toLowerCase();
                return /iphone|ipad|ipod/.test(userAgent);
            }

            // Detectar se já está instalado como PWA
            function isInStandaloneMode() {
                return (window.matchMedia('(display-mode: standalone)').matches) || 
                       (window.navigator.standalone) || 
                       document.referrer.includes('android-app://');
            }

            // Capturar evento beforeinstallprompt GLOBALMENTE (antes do login)
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('📱 beforeinstallprompt disparado (Android/Windows/Desktop)');
                e.preventDefault();
                deferredPrompt = e;
                console.log('✅ Prompt de instalação capturado e salvo');
                
                // Se o botão já existe, mostrar imediatamente
                const installBtn = document.getElementById('install-app-btn');
                if (installBtn && !isInStandaloneMode()) {
                    installBtn.style.display = 'block';
                    console.log('🔄 Botão de instalação ativado após captura do evento');
                }
            });

            // Configurar botão de instalação
            function setupInstallButton() {
                isIOS = detectIOS();
                const installBtn = elements.installAppBtn;
                
                if (!installBtn) {
                    console.error('❌ Botão de instalação não encontrado');
                    return;
                }
                
                // Não mostrar se já estiver instalado
                if (isInStandaloneMode()) {
                    console.log('✅ App já está instalado');
                    installBtn.style.display = 'none';
                    return;
                }

                // Remover event listeners antigos (se existirem)
                const newBtn = installBtn.cloneNode(true);
                installBtn.parentNode.replaceChild(newBtn, installBtn);
                
                if (isIOS) {
                    // iOS: Mostrar botão com instruções manuais
                    console.log('📱 iOS detectado - mostrando instruções manuais');
                    newBtn.style.display = 'block';
                    newBtn.addEventListener('click', () => {
                        closeMenu();
                        document.getElementById('ios-install-modal').classList.remove('hidden');
                    });
                } else {
                    // Android/Desktop/Windows
                    console.log('💻 Desktop/Android detectado');
                    console.log('🔍 deferredPrompt disponível?', !!deferredPrompt);
                    
                    // Sempre mostrar botão (mesmo sem deferredPrompt)
                    newBtn.style.display = 'block';

                    newBtn.addEventListener('click', async () => {
                        console.log('🖱️ Botão de instalação clicado');
                        if (!deferredPrompt) {
                            console.log('❌ Prompt de instalação não disponível - mostrando instruções manuais');
                            // Instruções manuais para Android/Chrome
                            showModal('Para instalar no <strong>Android</strong>:<br><br>1. Abra o <strong>Menu</strong> do navegador (⋮)<br>2. Toque em <strong>"Adicionar à tela inicial"</strong> ou <strong>"Instalar app"</strong><br><br>Para <strong>Desktop</strong>:<br>• Chrome: Menu (⋮) → Instalar Zele Serve<br>• Edge: Menu (⋯) → Apps → Instalar', false, null, false, null, '📱');
                            return;
                        }

                        try {
                            console.log('🚀 Iniciando instalação automática...');
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            console.log(`👤 Usuário escolheu: ${outcome}`);
                            
                            if (outcome === 'accepted') {
                                showModal('✅ App instalado com sucesso!');
                                newBtn.style.display = 'none';
                            } else {
                                showModal('Instalação cancelada. Você pode tentar novamente pelo menu do navegador.');
                            }
                        } catch (error) {
                            console.error('❌ Erro na instalação:', error);
                            showModal('Erro ao instalar. Tente pelo menu do navegador: Menu (⋮) → Instalar app');
                        }
                        
                        deferredPrompt = null;
                        closeMenu();
                    });
                }

                // Listener quando o app é instalado
                window.addEventListener('appinstalled', () => {
                    console.log('✅ PWA instalado com sucesso');
                    const btn = document.getElementById('install-app-btn');
                    if (btn) btn.style.display = 'none';
                    deferredPrompt = null;
                }, { once: true });
            }

            // Fechar modal iOS
            document.getElementById('close-ios-modal')?.addEventListener('click', () => {
                document.getElementById('ios-install-modal').classList.add('hidden');
            });

            // Fechar modal clicando fora
            document.getElementById('ios-install-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'ios-install-modal') {
                    document.getElementById('ios-install-modal').classList.add('hidden');
                }
            });

            // Botão de próximos eventos no menu
            document.getElementById('menu-upcoming-events-btn')?.addEventListener('click', () => {
                closeMenu();
                showUpcomingEventsModal();
            });
            
            // Clicar na foto do usuário abre modal de próximos eventos
            document.getElementById('user-photo-btn')?.addEventListener('click', () => {
                showUpcomingEventsModal();
            });
            
            // Botão de tentativas bloqueadas
            document.getElementById('menu-blocked-attempts-btn')?.addEventListener('click', () => {
                closeMenu();
                loadBlockedAttempts();
                document.getElementById('blocked-attempts-modal').classList.remove('hidden');
            });

            // Fechar modal de tentativas bloqueadas
            document.getElementById('close-blocked-modal')?.addEventListener('click', () => {
                document.getElementById('blocked-attempts-modal').classList.add('hidden');
                // Cancelar listener quando fechar o modal
                if (blockedAttemptsUnsubscribe) {
                    blockedAttemptsUnsubscribe();
                    blockedAttemptsUnsubscribe = null;
                    console.log('👂 Listener de tentativas bloqueadas cancelado');
                }
            });

            // Fechar modal clicando fora
            document.getElementById('blocked-attempts-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'blocked-attempts-modal') {
                    document.getElementById('blocked-attempts-modal').classList.add('hidden');
                    // Cancelar listener quando fechar o modal
                    if (blockedAttemptsUnsubscribe) {
                        blockedAttemptsUnsubscribe();
                        blockedAttemptsUnsubscribe = null;
                        console.log('👂 Listener de tentativas bloqueadas cancelado');
                    }
                }
            });

            // Botão de escalas pendentes
            document.getElementById('menu-pending-escalas-btn')?.addEventListener('click', () => {
                closeMenu();
                loadPendingEscalas();
                document.getElementById('pending-escalas-modal').classList.remove('hidden');
            });

            // Fechar modal de escalas pendentes
            document.getElementById('close-pending-modal')?.addEventListener('click', () => {
                document.getElementById('pending-escalas-modal').classList.add('hidden');
            });

            // Fechar modal clicando fora
            document.getElementById('pending-escalas-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'pending-escalas-modal') {
                    document.getElementById('pending-escalas-modal').classList.add('hidden');
                }
            });

            // Fechar modal de seleção de time
            document.getElementById('close-approve-team-modal')?.addEventListener('click', () => {
                document.getElementById('approve-team-modal').classList.add('hidden');
            });

            // Fechar modal iOS
            document.getElementById('close-ios-modal')?.addEventListener('click', () => {
                document.getElementById('ios-install-modal').classList.add('hidden');
            });

            // Botão de alterar foto no menu
            document.getElementById('menu-change-photo-btn')?.addEventListener('click', () => {
                closeMenu();
                document.getElementById('photo-upload-input').click();
            });

            // Upload de foto de perfil (usando Base64 no Firestore - Grátis)
            document.getElementById('photo-upload-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validar tipo de arquivo
                if (!file.type.startsWith('image/')) {
                    showModal('❌ Por favor, selecione uma imagem válida.');
                    e.target.value = '';
                    return;
                }
                
                // Validar tamanho (máximo 200KB para Base64 otimizado)
                if (file.size > 200 * 1024) {
                    showModal('❌ A imagem deve ter no máximo 200KB.<br><br>💡 Dica: Use um compressor online gratuito:<br>• <a href="https://tinypng.com" target="_blank" style="color: #377db8;">tinypng.com</a><br>• <a href="https://compressor.io" target="_blank" style="color: #377db8;">compressor.io</a>');
                    e.target.value = '';
                    return;
                }
                
                try {
                    showLoading();
                    console.log('📸 Processando foto...');
                    
                    // Converter imagem para Base64
                    const photoBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    
                    console.log('✅ Foto convertida para Base64 (' + Math.round(photoBase64.length / 1024) + 'KB)');
                    
                    // Salvar apenas no Firestore (Firebase Auth tem limite de tamanho)
                    console.log('💾 Salvando no Firestore...');
                    const { doc, updateDoc } = window.firestoreMethods;
                    await updateDoc(doc(window.firebaseDb, 'users', currentUser.uid), {
                        photoURL: photoBase64,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Atualizar currentUser em memória
                    currentUser.photoURL = photoBase64;
                    
                    console.log('✅ Foto de perfil atualizada com sucesso');
                    
                    // Fechar loading e recarregar app após modal ser fechado
                    showModal('✅ Foto de perfil atualizada com sucesso!', false, null, false, () => {
                        hideLoading();
                        window.location.reload();
                    });
                    
                } catch (error) {
                    console.error('❌ Erro ao fazer upload da foto:', error);
                    console.error('Stack:', error.stack);
                    hideLoading();
                    showModal(`❌ Erro ao atualizar foto: ${error.message}`);
                }
                
                // Limpar input
                e.target.value = '';
            });

            // Seleção de time
            elements.teamBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Verificar se uma data foi selecionada
                    if (!elements.cultoSelect.value) {
                        // Mostrar modal de alerta com callback para piscar após fechar
                        showModal(
                            'Escolha o dia para depois selecionar a equipe que vai servir', 
                            false, 
                            null, 
                            true,
                            () => {
                                // Piscar a borda do select após fechar o modal
                                // Delay maior para iOS e forçar reflow do DOM
                                setTimeout(() => {
                                    // Remover classe se já existir (para garantir nova animação)
                                    elements.cultoSelect.classList.remove('blink-border');
                                    
                                    // Forçar reflow do DOM (crítico para iOS)
                                    void elements.cultoSelect.offsetWidth;
                                    
                                    // Adicionar classe de animação
                                    elements.cultoSelect.classList.add('blink-border');
                                    
                                    // Remover após animação completar
                                    setTimeout(() => {
                                        elements.cultoSelect.classList.remove('blink-border');
                                    }, 1500); // 3 piscadas x 0.5s = 1.5s
                                }, 100); // Delay para iOS processar fechamento do modal
                            }
                        );
                        
                        return;
                    }
                    
                    // Resetar todos os botões para imagem normal
                    elements.teamBtns.forEach(b => {
                        b.classList.remove('selected');
                        const img = b.querySelector('img');
                        const normalImg = b.dataset.imgNormal;
                        if (img && normalImg) {
                            img.src = normalImg;
                        }
                    });
                    
                    // Marcar botão clicado como selecionado e trocar imagem
                    btn.classList.add('selected');
                    const img = btn.querySelector('img');
                    const selectedImg = btn.dataset.imgSelected;
                    if (img && selectedImg) {
                        img.src = selectedImg;
                    }
                    
                    selectedTeam = btn.dataset.team;
                    
                    // Chamar saveEscala diretamente após selecionar o time
                    saveEscala();
                });
            });

            // Resetar seleção de time quando trocar o culto
            elements.cultoSelect.addEventListener('change', () => {
                if (selectedTeam) {
                    // Resetar todos os botões para imagem normal
                    elements.teamBtns.forEach(btn => {
                        btn.classList.remove('selected');
                        const img = btn.querySelector('img');
                        const normalImg = btn.dataset.imgNormal;
                        if (img && normalImg) {
                            img.src = normalImg;
                        }
                    });
                    selectedTeam = null;
                }
                
                // Se uma data foi selecionada, animar os botões dos times em sequência
                if (elements.cultoSelect.value) {
                    animateTeamButtonsSequence();
                }
            });
            
            // Função para animar botões dos times em sequência (horário)
            function animateTeamButtonsSequence() {
                const teamOrder = ['welcome', 'backstage', 'parking', 'kids', 'comunicacao'];
                const delay = 350; // tempo entre cada animação
                
                teamOrder.forEach((teamName, index) => {
                    setTimeout(() => {
                        const btn = document.querySelector(`[data-team="${teamName}"]`);
                        if (btn) {
                            btn.classList.add('pulse-team');
                            setTimeout(() => {
                                btn.classList.remove('pulse-team');
                            }, 600); // duração da animação
                        }
                    }, index * delay);
                });
            }

            // Login com Google
            async function loginWithGoogle() {
                try {
                    showLoading(); // Mostrar loading durante o login
                    console.log('🔐 Iniciando login com Google via redirect...');
                    console.log('Auth:', window.firebaseAuth);
                    console.log('Provider:', window.firebaseProvider);
                    
                    // Adicionar escopos necessários (opcional)
                    window.firebaseProvider.addScope('profile');
                    window.firebaseProvider.addScope('email');
                    
                    // Usar signInWithRedirect ao invés de signInWithPopup
                    await window.firebaseAuthMethods.signInWithRedirect(window.firebaseAuth, window.firebaseProvider);
                    
                    console.log('🔄 Redirecionando para Google...');
                    // Após esta linha, o usuário será redirecionado
                    // O resultado será capturado pelo getRedirectResult() quando voltar
                } catch (error) {
                    console.error('❌ Erro ao iniciar redirect:', error);
                    console.error('Código do erro:', error.code);
                    console.error('Mensagem:', error.message);
                    showLogin(); // Voltar para login em caso de erro
                    alert('Erro ao tentar fazer login. Por favor, tente novamente.');
                }
            }

            // Logout
            async function logout() {
                try {
                    await window.firebaseAuthMethods.signOut(window.firebaseAuth);
                    console.log('👋 Logout realizado');
                    // Recarregar a página para limpar o estado e voltar para tela de login
                    window.location.reload();
                } catch (error) {
                    console.error('❌ Erro no logout:', error);
                }
            }

            // Salvar dados do usuário no Firestore
            async function saveUserToFirestore(user) {
                try {
                    const { doc, setDoc, getDoc } = window.firestoreMethods;
                    const userDocRef = doc(window.firebaseDb, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    // Preparar dados do usuário
                    const userData = {
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        lastLogin: new Date().toISOString(),
                        lastLoginFormatted: new Date().toLocaleString('pt-BR')
                    };
                    
                    if (userDoc.exists()) {
                        // Atualizar apenas dados do perfil, mantendo role, blocked, photoURL e onboarding
                        const existingData = userDoc.data();
                        
                        // Se existe photoURL no Firestore, usar ele (Base64)
                        // Se não, usar do Firebase Auth (Google login)
                        if (existingData.photoURL) {
                            user.photoURL = existingData.photoURL;
                        }
                        
                        // Usar merge: true para preservar TODOS os campos existentes (incluindo onboarding)
                        await setDoc(userDocRef, {
                            ...userData,
                            photoURL: existingData.photoURL || user.photoURL || '',
                            role: existingData.role || 'user', // Preservar role existente
                            blocked: existingData.blocked || false, // Preservar status de bloqueio
                            onboardingComplete: existingData.onboardingComplete || false, // Preservar onboarding
                            onboardingDate: existingData.onboardingDate || null, // Preservar data do onboarding
                            preferredTeam: existingData.preferredTeam || null, // Preservar time preferido
                            availability: existingData.availability || null, // Preservar disponibilidade
                            teamLeader: existingData.teamLeader || [], // Preservar liderança
                            createdAt: existingData.createdAt || new Date().toISOString()
                        }, { merge: true });
                        logger.log('✅ Dados do usuário atualizados');
                    } else {
                        // Criar novo documento com role padrão
                        await setDoc(userDocRef, {
                            ...userData,
                            photoURL: user.photoURL || '',
                            role: 'user',
                            blocked: false,
                            createdAt: new Date().toISOString()
                        });
                        logger.log('✅ Novo usuário criado no Firestore');
                    }
                } catch (error) {
                    console.error('❌ Erro ao salvar usuário:', error);
                }
            }

            // Verificar se usuário é admin ou superadmin
            async function checkAdminStatus(user) {
                if (!user) {
                    console.log('⚠️ Nenhum usuário para verificar admin');
                    return false;
                }
                
                // Verificar se usuário está bloqueado
                try {
                    const { doc, getDoc } = window.firestoreMethods;
                    const userDoc = await getDoc(doc(window.firebaseDb, 'users', user.uid));
                    
                    if (userDoc.exists() && userDoc.data().blocked === true) {
                        console.log('🚫 Usuário bloqueado. Fazendo logout...');
                        showModal('Seu acesso está temporariamente bloqueado neste aplicativo. Por favor, fale com o Líder do time que está servindo para maiores informações.', false, null, false, async () => {
                            await window.firebaseAuthMethods.signOut(window.firebaseAuth);
                            window.location.reload();
                        }, '🚫');
                        return false;
                    }
                } catch (error) {
                    console.error('❌ Erro ao verificar bloqueio:', error);
                }
                
                // Salvar/atualizar dados do usuário
                await saveUserToFirestore(user);
                
                console.log('🔍 Verificando status de admin para:', user.email);
                console.log('🔍 UID do usuário:', user.uid);
                
                try {
                    const { doc, getDoc, setDoc } = window.firestoreMethods;
                    const userDoc = await getDoc(doc(window.firebaseDb, 'users', user.uid));
                    
                    console.log('📄 Documento existe?', userDoc.exists());
                    
                    // Verificar liderança de times e carregar bloqueios
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        console.log('📄 Dados completos do usuário:', userData);
                        console.log('📄 Campo teamLeader:', userData.teamLeader);
                        console.log('📄 Tipo do campo teamLeader:', typeof userData.teamLeader);
                        userTeamLeadership = userData.teamLeader || [];
                        isTeamLeader = userTeamLeadership.length > 0;
                        console.log('🏆 Líder de times:', userTeamLeadership);
                        console.log('🏆 isTeamLeader:', isTeamLeader);
                        
                        // Mostrar botão de check-in para líderes
                        const checkinBtn = document.getElementById('menu-checkin-btn');
                        if (checkinBtn) {
                            checkinBtn.style.display = isTeamLeader ? 'block' : 'none';
                        }
                        
                        // Bloqueios de data do usuário
                        userBlockedDates = userData.blockedDates || {};
                        console.log('🗓️ Bloqueios carregados:', userBlockedDates);
                        
                        // Atualizar UI após carregar liderança
                        updateUserUI(user);
                    }
                    
                    // Super Admin hardcoded (primeiro super admin)
                    const SUPER_ADMIN_ID = 'HiCC8lYwRBgWJ0ATRYOV2rtc1ND2';
                    const SUPER_ADMIN_EMAIL = 'leandroalves.facilities@gmail.com';
                    
                    if (user.uid === SUPER_ADMIN_ID || user.email === SUPER_ADMIN_EMAIL) {
                        console.log('👑👑 SUPER ADMINISTRADOR detectado!');
                        // Garantir que está como superadmin no Firestore
                        if (userDoc.exists()) {
                            const data = userDoc.data();
                            if (data.role !== 'superadmin') {
                                await setDoc(doc(window.firebaseDb, 'users', user.uid), {
                                    ...data,
                                    role: 'superadmin'
                                });
                                console.log('✅ Role atualizado para superadmin');
                            }
                        }
                        isAdmin = true;
                        isSuperAdmin = true;
                        // Mostrar grupo de liderança e menu administrativo
                        const leadershipGroup = document.getElementById('leadership-menu-group');
                        const adminGroup = document.getElementById('admin-menu-group');
                        if (leadershipGroup) leadershipGroup.style.display = 'block';
                        if (adminGroup) adminGroup.style.display = 'block';
                        // Itens individuais dentro do grupo de liderança
                        const menuAdminBtn = document.getElementById('menu-admin-btn');
                        const menuDashboardBtn = document.getElementById('menu-dashboard-btn');
                        const menuBlockedBtn = document.getElementById('menu-blocked-attempts-btn');
                        const menuPendingBtn = document.getElementById('menu-pending-escalas-btn');
                        const menuCheckinBtn = document.getElementById('menu-checkin-btn');
                        if (menuAdminBtn) menuAdminBtn.style.display = 'block';
                        if (menuDashboardBtn) menuDashboardBtn.style.display = 'block';
                        if (menuBlockedBtn) menuBlockedBtn.style.display = 'block';
                        if (menuPendingBtn) menuPendingBtn.style.display = 'block';
                        if (menuCheckinBtn) menuCheckinBtn.style.display = 'block';
                        updateBlockedAttemptsBadge(); // Atualizar badge
                        updatePendingEscalasBadge(); // Atualizar badge
                        console.log('✅ Usuário É SUPER ADMINISTRADOR');
                        return true;
                    }
                    
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        console.log('📄 Dados do documento:', data);
                        console.log('📄 Valor do campo role:', data.role);
                        
                        if (data.role === 'superadmin') {
                            isAdmin = true;
                            isSuperAdmin = true;
                            // Mostrar grupo de liderança e menu administrativo
                            const leadershipGroup = document.getElementById('leadership-menu-group');
                            const adminGroup = document.getElementById('admin-menu-group');
                            if (leadershipGroup) leadershipGroup.style.display = 'block';
                            if (adminGroup) adminGroup.style.display = 'block';
                            // Itens individuais dentro do grupo de liderança
                            const menuAdminBtn = document.getElementById('menu-admin-btn');
                            const menuDashboardBtn = document.getElementById('menu-dashboard-btn');
                            const menuBlockedBtn = document.getElementById('menu-blocked-attempts-btn');
                            const menuPendingBtn = document.getElementById('menu-pending-escalas-btn');
                            const menuCheckinBtn = document.getElementById('menu-checkin-btn');
                            if (menuAdminBtn) menuAdminBtn.style.display = 'block';
                            if (menuDashboardBtn) menuDashboardBtn.style.display = 'block';
                            if (menuBlockedBtn) menuBlockedBtn.style.display = 'block';
                            if (menuPendingBtn) menuPendingBtn.style.display = 'block';
                            if (menuCheckinBtn) menuCheckinBtn.style.display = 'block';
                            updateBlockedAttemptsBadge(); // Atualizar badge
                            updatePendingEscalasBadge(); // Atualizar badge
                            console.log('✅ Usuário É SUPER ADMINISTRADOR');
                            return true;
                        } else if (data.role === 'admin') {
                            isAdmin = true;
                            isSuperAdmin = false;
                            // Mostrar apenas grupo de liderança
                            const leadershipGroup = document.getElementById('leadership-menu-group');
                            const adminGroup = document.getElementById('admin-menu-group');
                            if (leadershipGroup) leadershipGroup.style.display = 'block';
                            if (adminGroup) adminGroup.style.display = 'none';
                            // Itens individuais dentro do grupo de liderança
                            const menuAdminBtn = document.getElementById('menu-admin-btn');
                            const menuDashboardBtn = document.getElementById('menu-dashboard-btn');
                            if (menuAdminBtn) menuAdminBtn.style.display = 'block';
                            if (menuDashboardBtn) menuDashboardBtn.style.display = 'block';
                            document.getElementById('menu-blocked-attempts-btn').style.display = 'block';
                            document.getElementById('menu-pending-escalas-btn').style.display = 'block';
                            document.getElementById('menu-checkin-btn').style.display = 'block';
                            updateBlockedAttemptsBadge(); // Atualizar badge
                            updatePendingEscalasBadge(); // Atualizar badge
                            console.log('✅ Usuário É ADMINISTRADOR');
                            return true;
                        } else {
                            console.log('❌ Usuário NÃO é admin. Role =', data.role);
                        }
                    } else {
                        console.log('❌ Documento não encontrado em users/' + user.uid);
                    }
                    
                    isAdmin = false;
                    isSuperAdmin = false;
                    // Ocultar grupos de admin
                    const leadershipGroup = document.getElementById('leadership-menu-group');
                    const adminGroup = document.getElementById('admin-menu-group');
                    if (leadershipGroup) leadershipGroup.style.display = 'none';
                    if (adminGroup) adminGroup.style.display = 'none';
                    // Ocultar itens individuais do grupo de liderança
                    const menuAdminBtn = document.getElementById('menu-admin-btn');
                    const menuDashboardBtn = document.getElementById('menu-dashboard-btn');
                    if (menuAdminBtn) menuAdminBtn.style.display = 'none';
                    if (menuDashboardBtn) menuDashboardBtn.style.display = 'none';
                    // Mostrar botão de tentativas bloqueadas e check-in para líderes
                    const blockedAttemptsBtn = document.getElementById('menu-blocked-attempts-btn');
                    const pendingBtn = document.getElementById('menu-pending-escalas-btn');
                    const checkinBtn = document.getElementById('menu-checkin-btn');
                    if (blockedAttemptsBtn) blockedAttemptsBtn.style.display = isTeamLeader ? 'block' : 'none';
                    if (pendingBtn) pendingBtn.style.display = 'none';
                    if (checkinBtn) checkinBtn.style.display = isTeamLeader ? 'block' : 'none';
                    return false;
                } catch (error) {
                    console.error('❌ Erro ao verificar admin:', error);
                    isAdmin = false;
                    isSuperAdmin = false;
                    return false;
                }
            }

            // Atualizar UI do usuário
            function updateUserUI(user) {
                if (user) {
                    const displayName = user.displayName || 'Usuário';
                    const defaultPhoto = 'https://github.com/escalaserver/zele/blob/main/Zele%20logo.png?raw=true';
                    const badge = isSuperAdmin ? ' 👑👑' : (isAdmin ? ' 👑' : '');
                    elements.userName.textContent = displayName + badge;
                    elements.userEmail.textContent = user.email;
                    elements.userPhoto.src = user.photoURL || defaultPhoto;
                    elements.menuUserName.textContent = displayName + badge;
                    elements.menuUserEmail.textContent = user.email;
                    elements.menuUserPhoto.src = user.photoURL || defaultPhoto;

                    // Mostrar times que o admin/líder lidera abaixo do email no menu
                    const leadershipBadge = (userTeamLeadership && userTeamLeadership.length > 0)
                        ? `Líder de: ${userTeamLeadership.map(t => {
                            const map = { welcome: '👋 Welcome', backstage: '🤝 Backstage', parking: '🚗 Parking', kids: '👶 Kids' };
                            return map[t] || t;
                          }).join(' • ')}`
                        : '';
                    const leadershipEl = document.getElementById('menu-leadership-info');
                    if (leadershipEl) {
                        leadershipEl.textContent = leadershipBadge;
                        leadershipEl.style.display = leadershipBadge ? 'block' : 'none';
                    } else if (elements && elements.menuUserEmail) {
                        const newInfo = document.createElement('div');
                        newInfo.id = 'menu-leadership-info';
                        newInfo.className = 'text-xs text-gray-500 mt-1';
                        newInfo.textContent = leadershipBadge;
                        newInfo.style.display = leadershipBadge ? 'block' : 'none';
                        elements.menuUserEmail.parentElement?.insertBefore(newInfo, elements.menuUserEmail.nextSibling);
                    }

                    // Replicar exibição na barra superior abaixo do email
                    const topLeadershipEl = document.getElementById('top-leadership-info');
                    if (topLeadershipEl) {
                        topLeadershipEl.textContent = leadershipBadge;
                        topLeadershipEl.style.display = leadershipBadge ? 'inline-block' : 'none';
                    } else if (elements && elements.userEmail) {
                        const topInfo = document.createElement('div');
                        topInfo.id = 'top-leadership-info';
                        topInfo.className = 'text-xs text-gray-500';
                        topInfo.textContent = leadershipBadge;
                        topInfo.style.display = leadershipBadge ? 'inline-block' : 'none';
                        elements.userEmail.parentElement?.insertBefore(topInfo, elements.userEmail.nextSibling);
                    }
                }
            }

            // Mostrar app
            function showApp() {
                elements.loadingScreen.style.display = 'none';
                elements.authScreen.style.display = 'none';
                elements.appContainer.classList.remove('hidden');
            }

            // Mostrar tela de login
            function showLogin() {
                elements.loadingScreen.style.display = 'none';
                elements.authScreen.classList.remove('hidden');
                elements.appContainer.classList.add('hidden');
            }

            // Mostrar tela de loading
            function showLoading() {
                elements.loadingScreen.style.display = 'flex';
                elements.authScreen.style.display = 'none';
                elements.appContainer.classList.add('hidden');
            }

            function hideLoading() {
                elements.loadingScreen.style.display = 'none';
            }

            // Verificar limite de voluntários no time (máximo 4 por time por evento)
            async function checkTeamLimit(date, time, team, eventValue = null, excludeUserId = null) {
                try {
                    // Buscar o evento específico
                    let eventKey;
                    if (eventValue) {
                        // Se temos eventValue, usar ele para buscar o evento exato
                        eventKey = availableDates.find(d => d.value === eventValue);
                    } else {
                        // Fallback: buscar por date e time (retrocompatibilidade)
                        eventKey = availableDates.find(d => {
                            const [eventDate, eventTime] = d.value.split('|');
                            return eventDate === date && eventTime === time;
                        });
                    }
                    
                    // Obter limite específico do time (novo formato) ou padrão 4
                    let maxVolunteers = 4;
                    if (eventKey?.teamLimits && eventKey.teamLimits[team]) {
                        maxVolunteers = eventKey.teamLimits[team];
                    } else if (eventKey?.maxVolunteers) {
                        // Retrocompatibilidade com formato antigo
                        maxVolunteers = eventKey.maxVolunteers;
                    }
                    
                    const { collection, query, where, getDocs } = window.firestoreMethods;
                    
                    // Buscar escalas - se temos eventValue, filtrar por ele também
                    let q;
                    if (eventValue) {
                        q = query(
                            collection(window.firebaseDb, 'escalas'),
                            where('eventValue', '==', eventValue),
                            where('team', '==', team),
                            where('status', 'in', ['approved', 'pending'])
                        );
                    } else {
                        // Fallback: usar date e time (retrocompatibilidade)
                        q = query(
                            collection(window.firebaseDb, 'escalas'),
                            where('date', '==', date),
                            where('time', '==', time),
                            where('team', '==', team)
                        );
                    }
                    
                    const querySnapshot = await getDocs(q);
                    
                    // Filtrar manualmente para excluir o próprio usuário (ao mudar de time)
                    let count = 0;
                    querySnapshot.forEach((doc) => {
                        if (!excludeUserId || doc.data().userId !== excludeUserId) {
                            count++;
                        }
                    });
                    
                    logger.log(`📊 Time ${team} no evento ${eventValue || date + ' ' + time}: ${count}/${maxVolunteers} voluntários${excludeUserId ? ' (excluindo usuário atual)' : ''}`);
                    
                    return {
                        count: count,
                        isFull: count >= maxVolunteers,
                        remaining: Math.max(0, maxVolunteers - count),
                        maxVolunteers: maxVolunteers
                    };
                } catch (error) {
                    console.error('❌ Erro ao verificar limite do time:', error);
                    return { count: 0, isFull: false, remaining: 4, maxVolunteers: 4 };
                }
            }

            // Salvar escala
            async function saveEscala() {
                if (!currentUser) {
                    showModal('Você precisa estar logado!');
                    return;
                }

                const cultoData = elements.cultoSelect.value;
                const team = selectedTeam;

                if (!cultoData || !team) {
                    showModal('Por favor, selecione um culto e um time!');
                    return;
                }

                // Parsear os dados do culto (formato: "2024-11-20|19:00|Quinta - Nome Evento")
                // Extrair as 3 primeiras partes, mantendo o eventName completo
                const parts = cultoData.split('|');
                const date = parts[0];
                const time = parts[1];
                const eventName = parts.slice(2).join('|'); // Juntar de volta caso tenha mais pipes no nome

                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };

                try {
                    // Bloqueio de datas: impedir se usuário marcou indisponibilidade
                    function getPeriodFromTime(t) {
                        if (!t || t === '00:00') return 'unknown';
                        const [hh, mm] = t.split(':').map(x => parseInt(x, 10));
                        const h = isNaN(hh) ? 0 : hh;
                        if (h < 12) return 'morning';
                        if (h < 18) return 'afternoon';
                        return 'night';
                    }
                    const period = getPeriodFromTime(time);
                    const blocks = userBlockedDates?.[date] || [];
                    const isBlocked = Array.isArray(blocks) && (blocks.includes('all') || (period !== 'unknown' && blocks.includes(period)) || (period === 'unknown' && blocks.includes('all')));
                    if (isBlocked) {
                        const periodLabel = period === 'morning' ? 'manhã' : period === 'afternoon' ? 'tarde' : period === 'night' ? 'noite' : 'dia';
                        showModal(`⛔ Você marcou indisponibilidade para ${period === 'unknown' ? 'este dia' : `a ${periodLabel}`} (${new Date(date+ 'T12:00:00').toLocaleDateString('pt-BR')}).<br><br>Remova o bloqueio em Menu → Bloqueio de Datas para prosseguir.`, false, null, false, null, '⛔');
                        return;
                    }

                    // Verificar se falta menos de 24h para o evento OU se é time KIDS
                    // Permitir inscrição até 2h APÓS o início do evento (para última hora)
                    const eventDateTime = new Date(`${date}T${time}:00`);
                    const eventEndTime = new Date(eventDateTime.getTime() + (2 * 60 * 60 * 1000)); // 2h após início
                    const now = new Date();
                    const hoursUntilEvent = (eventDateTime - now) / (1000 * 60 * 60);
                    const hoursUntilEventEnd = (eventEndTime - now) / (1000 * 60 * 60);
                    
                    console.log('⏰ Verificação 24h (com janela de 2h após início):');
                    console.log('  Data/Hora evento:', eventDateTime);
                    console.log('  Data/Hora fim (evento + 2h):', eventEndTime);
                    console.log('  Data/Hora atual:', now);
                    console.log('  Horas até evento:', hoursUntilEvent);
                    console.log('  Horas até fim da janela:', hoursUntilEventEnd);
                    console.log('  Time selecionado:', team);
                    
                    // Determinar se é pending
                    // - Kids SEMPRE vai para PENDING (mesmo dentro da janela rápida)
                    // - Se falta < 24h e ainda não começou → PENDING
                    // - Se evento já começou e está dentro da janela de 2h → CONFIRMADO (entrada rápida) exceto Kids
                    const isDuringQuickEntryWindow = hoursUntilEvent < 0 && hoursUntilEventEnd > 0; // Evento iniciado, dentro de 2h
                    const isPending = team === 'kids' || ((hoursUntilEvent < 24 && hoursUntilEvent > 0) && !isDuringQuickEntryWindow);
                    console.log('  Está na janela de entrada rápida (2h após início)?', isDuringQuickEntryWindow);
                    console.log('  É pendente (<24h ou Kids)?', isPending);
                    
                    // Verificar se já existe escala deste usuário para este evento específico
                    // Usar cultoData completo para garantir unicidade entre eventos no mesmo dia/horário
                    const escalaId = `${currentUser.uid}_${cultoData.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    const { doc, getDoc, setDoc } = window.firestoreMethods;
                    
                    // Buscar escala existente
                    const docRef = doc(window.firebaseDb, 'escalas', escalaId);
                    const docSnap = await getDoc(docRef);
                    
                    // Se usuário já está escalado neste evento
                    const userAlreadyInEvent = docSnap.exists();
                    const existingData = userAlreadyInEvent ? docSnap.data() : null;
                    const existingStatus = existingData?.status || null;
                    const isChangingTeam = userAlreadyInEvent && existingData.team !== team;
                    
                    console.log('🔍 Verificação de escala existente:');
                    console.log('  Usuário já está no evento?', userAlreadyInEvent);
                    console.log('  Status existente:', existingStatus);
                    console.log('  Time existente:', existingData?.team);
                    console.log('  Novo time:', team);
                    console.log('  Está mudando de time?', isChangingTeam);
                    
                    // Verificar limite de voluntários no time para este evento específico
                    // Se está mudando de time, excluir a contagem do próprio usuário
                    const teamLimit = await checkTeamLimit(date, time, team, cultoData, isChangingTeam ? currentUser.uid : null);
                    
                    console.log('🔍 Verificação de escala existente:');
                    console.log('  Usuário já está no evento?', userAlreadyInEvent);
                    console.log('  Status existente:', existingStatus);
                    console.log('  Time existente:', existingData?.team);
                    console.log('  Novo time:', team);
                    console.log('  Está mudando de time?', isChangingTeam);
                    
                    // Se time está cheio E usuário não está mudando de time (nova entrada)
                    if (teamLimit.isFull && !isChangingTeam) {
                        // Formatar data e horário para exibir
                        const dateObj = new Date(date + 'T' + time);
                        const dateStr = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        const timeStr = time;
                        const eventDisplay = eventName ? ` - ${eventName}` : '';
                        
                        // Criar escala como pendente para aprovação do líder
                        await saveEscalaToFirestore(escalaId, date, time, team, eventName, cultoData, false, 'pending');
                        
                        // Criar elemento de mensagem com HTML
                        const message = document.createElement('div');
                        message.innerHTML = `
                            <p>Obrigado pela sua disponibilidade! 😊</p>
                            <p>O time <strong>${teamNames[team]}</strong> já está com a escala completa para:</p>
                            <p class="mt-2 mb-2"><strong>${dateStr}${eventDisplay} às ${timeStr}</strong></p>
                            <p class="mt-2">⛔ Sua solicitação foi enviada para o líder para aprovação ou remanejamento de time.</p>
                        `;
                        
                        showModal(
                            message.innerHTML,
                            false,
                            null,
                            false,
                            null,
                            '⛔'
                        );
                        return;
                    }
                    
                    if (docSnap.exists()) {
                        const existingTeam = docSnap.data().team;
                        
                        // Se for o mesmo time, apenas atualiza
                        if (existingTeam === team) {
                            // Mostrar confirmação antes de salvar
                            if (isPending) {
                                console.log('⛔ PENDENTE: Salvando como pending (mesmo time, <24h ou Kids)');
                                // Salvar automaticamente sem botões SIM/NÃO
                                await saveEscalaToFirestore(escalaId, date, time, team, eventName, cultoData, true, 'pending');
                                
                                // Mensagem específica para Kids
                                if (team === 'kids') {
                                    showModal(
                                        `Recebemos sua disponibilidade! Como o time do Kids requer um planejamento especial, a líder vai confirmar sua escala em breve. Fique de olho no app na parte das suas escalas`,
                                        false,
                                        null,
                                        false,
                                        null,
                                        '👶'
                                    );
                                } else {
                                    showModal(
                                        `⛔ Atenção: faltam menos de 24 horas para o evento. Sua solicitação foi enviada para aprovação do líder do time.`,
                                        false,
                                        null,
                                        false,
                                        null,
                                        '⛔'
                                    );
                                }
                                return;
                            } else {
                                console.log('✅ Normal: Confirmação padrão (mesmo time, >24h)');
                                showModal(
                                    `Confirmar escala no time ${teamNames[team]}?`,
                                    true,
                                    async () => {
                                        await saveEscalaToFirestore(escalaId, date, time, team, eventName, cultoData, true, 'approved');
                                    }
                                );
                            }
                        } else {
                            // Times diferentes - pedir confirmação
                            if (isPending) {
                                console.log('⛔ PENDENTE: Salvando como pending (mudança de time, <24h ou Kids)');
                                // Salvar automaticamente sem botões SIM/NÃO
                                await saveEscalaToFirestore(escalaId, date, time, team, eventName, cultoData, false, 'pending');
                                
                                // Mensagem específica para Kids
                                if (team === 'kids') {
                                    showModal(
                                        `Recebemos sua disponibilidade! Como o time do Kids requer um planejamento especial, a líder vai confirmar sua escala em breve. Fique de olho no app na parte das suas escalas`,
                                        false,
                                        null,
                                        false,
                                        null,
                                        '👶'
                                    );
                                } else {
                                    showModal(
                                        `⛔ Você já está escalado no time ${teamNames[existingTeam]}. Como faltam menos de 24 horas para o evento, sua mudança para o time ${teamNames[team]} foi enviada para aprovação.`,
                                        false,
                                        null,
                                        false,
                                        null,
                                        '⛔'
                                    );
                                }
                                return;
                            } else {
                                console.log('✅ Normal: Confirmação mudança de time (>24h)');
                                showModal(
                                    `Você já escolheu servir no time ${teamNames[existingTeam]}. Deseja confirmar a mudança para o time ${teamNames[team]} nesta escala?`,
                                    true,
                                    async () => {
                                        await saveEscalaToFirestore(escalaId, date, time, team, eventName, cultoData, false, 'approved');
                                    }
                                );
                            }
                        }
                    } else {
                        // Nova escala - verificar se é pendente ou aprovada
                        if (isPending) {
                            console.log('⛔ PENDENTE: Salvando nova escala como pending (<24h ou Kids)');
                            // Escala pendente (menos de 24h ou Kids) - salvar automaticamente
                            await saveEscalaToFirestore(escalaId, date, time, team, eventName, cultoData, false, 'pending');
                            
                            // Mensagem específica para Kids
                            if (team === 'kids') {
                                showModal(
                                    `Recebemos sua disponibilidade! Como o time do Kids requer um planejamento especial, a líder vai confirmar sua escala em breve. Fique de olho no app na parte das suas escalas`,
                                    false,
                                    null,
                                    false,
                                    null,
                                    '👶'
                                );
                            } else {
                                showModal(
                                    `⛔ Atenção: faltam menos de 24 horas para o evento. Sua solicitação foi enviada para aprovação do líder do time.`,
                                    false,
                                    null,
                                    false,
                                    null,
                                    '⛔'
                                );
                            }
                            return;
                        } else {
                            console.log('✅ Normal: Nova escala normal (>24h)');
                            // Escala normal - mostrar confirmação
                            showModal(
                                `Confirmar escala no time ${teamNames[team]}?`,
                                true,
                                async () => {
                                    await saveEscalaToFirestore(escalaId, date, time, team, eventName, cultoData, false, 'approved');
                                }
                            );
                        }
                    }
                    
                } catch (error) {
                    console.error('❌ Erro ao salvar escala:', error);
                    showModal('Erro ao salvar escala. Tente novamente.');
                }
            }

            // Função auxiliar para salvar no Firestore
            async function saveEscalaToFirestore(escalaId, date, time, team, eventName, eventValue, skipCalendarPrompt, status = 'approved') {
                try {
                    console.log('💾 saveEscalaToFirestore chamada:');
                    console.log('  escalaId:', escalaId);
                    console.log('  status:', status);
                    console.log('  team:', team);
                    console.log('  date/time:', date, time);
                    console.log('  eventValue:', eventValue);
                    
                    // IMPORTANTE: Verificar se já existe outra escala deste usuário neste evento
                    const { doc, setDoc, Timestamp, collection, query, where, getDocs, deleteDoc } = window.firestoreMethods;
                    
                    // Buscar escalas duplicadas (mesmo userId e eventValue, mas IDs diferentes)
                    const duplicateCheckQuery = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('userId', '==', currentUser.uid),
                        where('eventValue', '==', eventValue)
                    );
                    
                    const duplicateSnapshot = await getDocs(duplicateCheckQuery);
                    console.log('🔍 Verificação de duplicatas:', duplicateSnapshot.size, 'documentos encontrados');
                    
                    // Deletar todas as escalas existentes deste usuário neste evento (exceto a que vamos salvar)
                    const deletePromises = [];
                    duplicateSnapshot.forEach((docSnap) => {
                        if (docSnap.id !== escalaId) {
                            console.log('🗑️ Deletando escala duplicada:', docSnap.id);
                            deletePromises.push(deleteDoc(doc(window.firebaseDb, 'escalas', docSnap.id)));
                        }
                    });
                    
                    if (deletePromises.length > 0) {
                        await Promise.all(deletePromises);
                        console.log('✅ Removidas', deletePromises.length, 'escalas duplicadas');
                    }
                    
                    // Converter date (YYYY-MM-DD) e time (HH:MM) para Timestamp do Firestore
                    const eventDateTime = new Date(`${date}T${time}:00`);
                    
                    const escalaData = {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        userEmail: currentUser.email,
                        userPhoto: currentUser.photoURL,
                        date: date,
                        time: time,
                        team: team,
                        eventName: eventName || '',
                        eventValue: eventValue || `${date}|${time}`, // Valor completo do evento para identificação única
                        createdAt: new Date().toISOString(),
                        status: status,
                        requestedTeam: team,
                        requestTimestamp: new Date().toISOString(),
                        eventTimestamp: Timestamp.fromDate(eventDateTime)
                    };
                    
                    console.log('💾 Dados da escala:', escalaData);
                    
                    // Se for escala negada, adicionar razão
                    if (status === 'denied') {
                        escalaData.deniedReason = 'Escala não aprovada pelo líder';
                    }
                    
                    await setDoc(doc(window.firebaseDb, 'escalas', escalaId), escalaData);

                    console.log('✅ Escala salva com sucesso! Status:', status);
                    
                    // Limpar seleção e resetar imagens
                    selectedTeam = null;
                    elements.teamBtns.forEach(btn => {
                        btn.classList.remove('selected');
                        const img = btn.querySelector('img');
                        const normalImg = btn.dataset.imgNormal;
                        if (img && normalImg) {
                            img.src = normalImg;
                        }
                    });
                    elements.cultoSelect.value = '';
                    
                    // Recarregar escalas e atualizar dropdown
                    loadUserEscalas();
                    loadAllEscalas();
                    
                    // Mostrar confirmação de sucesso
                    if (status === 'pending') {
                        showModal('✅ Solicitação enviada! Aguarde aprovação do líder do time.');
                    } else {
                        showModal('Escala salva com sucesso!');
                    }
                    
                } catch (error) {
                    console.error('❌ Erro ao salvar escala:', error);
                    showModal('Erro ao salvar escala. Tente novamente.');
                    throw error;
                }
            }

            // Exportar para Google Calendar
            function exportToGoogleCalendar(date, time, team, eventName) {
                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };

                const startDateTime = `${date}T${time}:00`;
                const endDate = new Date(`${date}T${time}:00`);
                endDate.setHours(endDate.getHours() + 2);
                const endDateTime = endDate.toISOString().slice(0, 16).replace('T', ' ').replace(' ', 'T');

                const title = `Z'ele Church - ${teamNames[team]}${eventName ? ' - ' + eventName : ''}`;
                const description = `Escala voluntária no time ${teamNames[team]}${eventName ? '\\nEvento: ' + eventName : ''}`;
                const location = 'Z\'ele Church - Av. Jacu Pêssego, 7639';

                const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDateTime.replace(/[-:]/g, '')}/${endDateTime.replace(/[-:]/g, '')}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
                
                window.open(googleCalendarUrl, '_blank');
            }

            // Formatar data para ICS (formato: YYYYMMDDTHHmmss)
            function formatICSDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}${month}${day}T${hours}${minutes}${seconds}`;
            }

            // Carregar escalas do usuário
            async function loadUserEscalas() {
                if (!currentUser) return;

                try {
                    // Limpar escalas de eventos passados (DESATIVADO - mantém histórico)
                    await cleanPastEscalas();
                    
                    const { collection, query, where, getDocs } = window.firestoreMethods;
                    const q = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('userId', '==', currentUser.uid)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    const allEscalas = [];
                    
                    querySnapshot.forEach((doc) => {
                        allEscalas.push({ id: doc.id, ...doc.data() });
                    });

                    // Filtrar eventos visíveis (até 2h após início)
                    const now = new Date();
                    
                    const escalas = allEscalas.filter(escala => {
                        const eventDateTime = new Date(escala.date + 'T' + escala.time);
                        const eventEndTime = new Date(eventDateTime.getTime() + (2 * 60 * 60 * 1000)); // 2h após início
                        return eventEndTime > now; // Mostra até 2h após início
                    });

                    // Ordenar por data e horário (ordem crescente)
                    escalas.sort((a, b) => {
                        const dateTimeA = new Date(a.date + 'T' + a.time);
                        const dateTimeB = new Date(b.date + 'T' + b.time);
                        return dateTimeA - dateTimeB;
                    });

                    // Armazenar todas as escalas
                    allUserEscalas = escalas;
                    
                    // Atualizar filtro com datas disponíveis
                    updateMinhasEscalasFilter(escalas);
                    
                    renderUserEscalas(escalas);
                    updateCultoDropdown(escalas);
                    updateUpcomingEventsBadge(escalas);
                    checkAndSendReminders(escalas);
                } catch (error) {
                    console.error('❌ Erro ao carregar escalas:', error);
                }
            }
            
            // Listener em tempo real para escalas do usuário
            let unsubscribeUserEscalas = null;
            function setupUserEscalasListener() {
                if (!currentUser) return;
                
                try {
                    const { collection, query, where, onSnapshot } = window.firestoreMethods;
                    
                    // Desinscrever de listener anterior se existir
                    if (unsubscribeUserEscalas) {
                        unsubscribeUserEscalas();
                    }
                    
                    const q = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('userId', '==', currentUser.uid)
                    );
                    
                    unsubscribeUserEscalas = onSnapshot(q, (snapshot) => {
                        const allEscalas = [];
                        snapshot.forEach((doc) => {
                            allEscalas.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Filtrar eventos visíveis
                        const now = new Date();
                        const escalas = allEscalas.filter(escala => {
                            const eventDateTime = new Date(escala.date + 'T' + escala.time);
                            const eventEndTime = new Date(eventDateTime.getTime() + (2 * 60 * 60 * 1000));
                            return eventEndTime > now;
                        });
                        
                        // Ordenar por data e horário
                        escalas.sort((a, b) => {
                            const dateTimeA = new Date(a.date + 'T' + a.time);
                            const dateTimeB = new Date(b.date + 'T' + b.time);
                            return dateTimeA - dateTimeB;
                        });
                        
                        // Atualizar dados
                        allUserEscalas = escalas;
                        
                        // Atualizar filtro e renderização
                        updateMinhasEscalasFilter(escalas);
                        renderUserEscalas(escalas);
                        updateCultoDropdown(escalas);
                        updateUpcomingEventsBadge(escalas);
                        
                        console.log('🔄 Escalas atualizadas em tempo real:', escalas.length);
                    }, (error) => {
                        console.error('❌ Erro no listener de escalas:', error);
                    });
                    
                    console.log('✅ Listener de escalas configurado');
                } catch (error) {
                    console.error('❌ Erro ao configurar listener:', error);
                }
            }
            
            // Atualizar filtro de Minhas Escalas
            function updateMinhasEscalasFilter(escalas) {
                const filter = elements.filterMinhasEscalas;
                const uniqueDates = [...new Set(escalas.map(e => e.date))].sort();
                
                filter.innerHTML = '<option value="">Todas as datas</option>';
                
                uniqueDates.forEach(date => {
                    const dateObj = new Date(date + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = dateStr;
                    filter.appendChild(option);
                });
            }
            
            // Event listener para filtro de Minhas Escalas
            elements.filterMinhasEscalas.addEventListener('change', () => {
                const selectedDate = elements.filterMinhasEscalas.value;
                if (selectedDate) {
                    const filtered = allUserEscalas.filter(e => e.date === selectedDate);
                    renderUserEscalas(filtered);
                } else {
                    renderUserEscalas(allUserEscalas);
                }
            });
            
            // Mostrar modal de próximos eventos
            function showUpcomingEventsModal() {
                const upcomingEvents = updateUpcomingEventsBadge(allUserEscalas);
                
                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };
                
                if (upcomingEvents.length === 0) {
                    showModal('✅ Você não tem eventos nas próximas 48 horas!', false, null, false, null, '📅');
                    return;
                }
                
                const eventsList = upcomingEvents.map(event => {
                    const eventDate = new Date(event.date + 'T' + event.time);
                    const formattedDate = eventDate.toLocaleDateString('pt-BR', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short' 
                    });
                    const formattedTime = event.time === '00:00' ? '(horário a definir)' : event.time;
                    const hoursUntil = Math.round((eventDate - new Date()) / (1000 * 60 * 60));
                    
                    return `<div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-2 rounded">
                        <div class="font-bold text-gray-800">${teamNames[event.team]}</div>
                        <div class="text-sm text-gray-700">📅 ${formattedDate} ${event.eventName ? '- ' + event.eventName : ''}</div>
                        <div class="text-sm text-gray-700">🕐 ${formattedTime}</div>
                        <div class="text-xs text-yellow-700 font-semibold mt-1">⏰ Faltam ${hoursUntil}h</div>
                    </div>`;
                }).join('');
                
                showModal(
                    `<div class="text-left">
                        <div class="mb-4 text-center">
                            <h3 class="text-lg font-bold text-gray-800">🔔 Seus Próximos Eventos</h3>
                            <p class="text-sm text-gray-600">Você tem ${upcomingEvents.length} evento(s) nas próximas 48h</p>
                        </div>
                        ${eventsList}
                    </div>`,
                    false,
                    null,
                    false,
                    null,
                    null
                );
            }

            // Limpar escalas de eventos passados - DESATIVADO para manter histórico
            async function cleanPastEscalas() {
                // FUNÇÃO DESATIVADA: Não deletar escalas passadas para manter dados históricos nos charts
                console.log('ℹ️ cleanPastEscalas: Função desativada - mantendo dados históricos');
                return;
                
                /* CÓDIGO ORIGINAL (DESATIVADO)
                try {
                    const { collection, query, where, getDocs, deleteDoc, doc } = window.firestoreMethods;
                    const now = new Date();
                    
                    // Buscar todas as escalas
                    const q = query(collection(window.firebaseDb, 'escalas'));
                    const querySnapshot = await getDocs(q);
                    
                    let deletedCount = 0;
                    const deletePromises = [];
                    
                    querySnapshot.forEach((docSnapshot) => {
                        const escala = docSnapshot.data();
                        const eventDateTime = new Date(escala.date + 'T' + escala.time);
                        const status = escala.status || 'approved';
                        
                        // Se o evento já passou, deletar apenas escalas aprovadas OU negadas
                        // Escalas pendentes não devem ser deletadas automaticamente (admin decide)
                        if (eventDateTime < now && (status === 'approved' || status === 'denied')) {
                            deletePromises.push(
                                deleteDoc(doc(window.firebaseDb, 'escalas', docSnapshot.id))
                            );
                            deletedCount++;
                        }
                    });
                    
                    if (deletePromises.length > 0) {
                        await Promise.all(deletePromises);
                        console.log(`🧹 ${deletedCount} escala(s) de eventos passados foram removidas`);
                    }
                } catch (error) {
                    console.error('❌ Erro ao limpar escalas passadas:', error);
                }
                */
            }

            // Carregar datas disponíveis do Firestore
            async function loadAvailableDates() {
                try {
                    console.log('🔄 Carregando datas disponíveis...');
                    const { doc, getDoc } = window.firestoreMethods;
                    const datesDoc = await getDoc(doc(window.firebaseDb, 'config', 'availableDates'));
                    
                    console.log('🔍 DEBUG - Documento existe?', datesDoc.exists());
                    console.log('🔍 DEBUG - Dados do documento:', datesDoc.data());
                    
                    if (datesDoc.exists()) {
                        availableDates = datesDoc.data().dates || [];
                        console.log('📦 Datas encontradas no Firestore:', availableDates.length);
                        console.log('🔍 DEBUG - TODAS as datas do Firestore:', availableDates.map(d => d.value));
                        console.log('🔍 DEBUG - Primeira data (exemplo):', availableDates[0]);
                        
                        // Adicionar teamLimits padrão se não existir (retrocompatibilidade)
                        availableDates = availableDates.map(date => {
                            if (!date.teamLimits) {
                                // Se tem maxVolunteers antigo, usar para todos os times
                                const defaultLimit = date.maxVolunteers || 4;
                                return {
                                    ...date,
                                    teamLimits: {
                                        welcome: defaultLimit,
                                        backstage: defaultLimit,
                                        parking: defaultLimit,
                                        kids: defaultLimit
                                    }
                                };
                            }
                            return date;
                        });
                        
                        // Filtrar apenas eventos futuros (até 1h após o início)
                        const now = new Date();
                        console.log('🔍 DEBUG - Data/hora atual:', now.toISOString());
                        const initialCount = availableDates.length;
                        availableDates = availableDates.filter(d => {
                            const [date, time] = d.value.split('|');
                            const eventDateTime = new Date(date + 'T' + time);
                            const eventEndTime = new Date(eventDateTime.getTime() + (2 * 60 * 60 * 1000)); // 2h após início
                            const isVisible = eventEndTime > now; // Visível até 2h após início
                            console.log(`🔍 DEBUG - Evento: ${d.text} (${d.value}) → ${eventDateTime.toISOString()} → Fim janela: ${eventEndTime.toISOString()} → Visível? ${isVisible}`);
                            return isVisible;
                        });
                        
                        console.log(`🧹 Filtrado: ${initialCount} → ${availableDates.length} eventos futuros`);
                    } else {
                        // Documento não existe - lista vazia (admin deve adicionar)
                        availableDates = [];
                        console.log('📭 Nenhuma data cadastrada. Admin deve adicionar datas.');
                        
                        // Criar documento vazio no Firestore
                        const { setDoc } = window.firestoreMethods;
                        await setDoc(doc(window.firebaseDb, 'config', 'availableDates'), { dates: [] });
                        console.log('✅ Documento availableDates criado');
                    }
                    
                    console.log('✅ Datas disponíveis carregadas:', availableDates.length);
                    
                    // Renderizar lista de datas para admin
                    if (isAdmin) {
                        renderAdminDatesList();
                    }
                } catch (error) {
                    console.error('❌ Erro ao carregar datas:', error);
                    availableDates = [];
                }
            }

            // Atualizar dropdown removendo datas já escaladas
            function updateCultoDropdown(escalas) {
                const select = elements.cultoSelect;
                
                console.log('🔍 updateCultoDropdown chamado');
                console.log('🔍 Datas disponíveis:', availableDates.length);
                console.log('🔍 Escalas do usuário:', escalas.length);
                console.log('🔍 Escalas detalhes:', escalas.map(e => `${e.date}_${e.time} (${e.team})`));

                // Criar set com data+hora já escaladas (formato: date_time)
                const escaladasDateTimes = new Set(escalas.map(e => `${e.date}_${e.time}`));
                console.log('🔍 Datas já escaladas:', Array.from(escaladasDateTimes));
                
                // Data/hora atual
                const now = new Date();

                // Limpar select
                select.innerHTML = '';

                // Adicionar opção padrão
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Escolha uma data...';
                select.appendChild(defaultOption);

                // Filtrar eventos visíveis (até 1h após o início) e ordenar por data
                const sortedDates = [...availableDates]
                    .filter(option => {
                        const [date, time] = option.value.split('|');
                        const eventDateTime = new Date(date + 'T' + time);
                        const eventEndTime = new Date(eventDateTime.getTime() + (1 * 60 * 60 * 1000)); // 1h após início
                        return eventEndTime > now; // Visível até 1h após início
                    })
                    .sort((a, b) => {
                        const dateA = a.value.split('|')[0];
                        const dateB = b.value.split('|')[0];
                        return dateA.localeCompare(dateB);
                    });

                // Adicionar apenas opções não escaladas e futuras (já ordenadas)
                sortedDates.forEach(option => {
                    const [date, time] = option.value.split('|');
                    const dateTimeKey = `${date}_${time}`;
                    console.log(`🔍 Verificando ${dateTimeKey}: já escalado? ${escaladasDateTimes.has(dateTimeKey)}`);
                    if (!escaladasDateTimes.has(dateTimeKey)) {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        select.appendChild(optionElement);
                    }
                });

                // Se não houver mais datas disponíveis
                if (select.options.length === 1) {
                    select.innerHTML = '<option value="">Todas as datas já estão escaladas</option>';
                    select.disabled = true;
                } else {
                    select.disabled = false;
                }
                
                console.log('✅ Dropdown atualizado. Total de opções:', select.options.length);
            }

            // Renderizar escalas do usuário
            function renderUserEscalas(escalas) {
                const teamConfig = {
                    welcome: { name: 'Welcome', icon: '👋', color: 'border-[#377db8]', bg: 'bg-blue-50' },
                    backstage: { name: 'Backstage', icon: '🤝', color: 'border-[#0a0e1a]', bg: 'bg-gray-50' },
                    parking: { name: 'Parking', icon: '🚗', color: 'border-[#f87171]', bg: 'bg-red-50' },
                    kids: { name: 'Kids', icon: '👶', color: 'border-[#fbbf24]', bg: 'bg-yellow-50' },
                    comunicacao: { name: 'Comunicação', icon: '📢', color: 'border-[#9333ea]', bg: 'bg-purple-50' }
                };

                if (escalas.length === 0) {
                    elements.escalasList.innerHTML = '<p class="text-gray-500 text-center py-8">Você ainda não tem escalas agendadas.</p>';
                    return;
                }

                const html = escalas.map(escala => {
                    const status = escala.status || 'approved';
                    const config = teamConfig[escala.team];
                    const dateObj = new Date(escala.date + 'T' + escala.time);
                    const dateStr = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const timeStr = escala.time;
                    const eventNameDisplay = escala.eventName ? ` - ${escala.eventName}` : '';
                    
                    // Mostrar botão de deletar apenas se for a própria escala do usuário e estiver aprovada
                    const canDelete = escala.userId === currentUser.uid && status === 'approved';
                    
                    // Estilos diferentes por status
                    let cardStyles = {
                        icon: config.icon,
                        teamName: config.name,
                        borderColor: config.color,
                        bgColor: config.bg,
                        textStyle: '',
                        teamDisplay: config.name
                    };
                    
                    if (status === 'pending') {
                        cardStyles = {
                            icon: '⛔',
                            teamName: 'PENDENTE',
                            borderColor: 'border-red-500',
                            bgColor: 'bg-white',
                            textStyle: 'text-red-600 italic',
                            teamDisplay: 'PENDENTE'
                        };
                    } else if (status === 'denied') {
                        cardStyles = {
                            icon: '🙏',
                            teamName: 'Obrigado',
                            borderColor: 'border-gray-300',
                            bgColor: 'bg-white',
                            textStyle: 'text-black',
                            teamDisplay: 'Obrigado, mas não será necessário servir neste culto'
                        };
                    } else if (status === 'approved' && escala.requestedTeam && escala.requestedTeam !== escala.team) {
                        // Aprovado mas time mudou - mostrar em verde
                        cardStyles.textStyle = 'text-green-600';
                    } else if (status === 'approved') {
                        // Aprovado normal
                        cardStyles.textStyle = '';
                    }

                    return `
                        <div class="border-l-4 ${cardStyles.borderColor} ${cardStyles.bgColor} p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="text-3xl">${cardStyles.icon}</div>
                                    <div>
                                        <h3 class="font-bold text-lg ${cardStyles.textStyle}">${cardStyles.teamDisplay}${eventNameDisplay}</h3>
                                        <p class="text-sm text-gray-600">📅 ${dateStr}</p>
                                        <p class="text-sm text-gray-600">🕐 ${timeStr}</p>
                                        ${escala.role ? `<p class="text-sm text-indigo-700 font-semibold mt-1">💼 Função: ${escala.role}</p>` : ''}
                                        ${escala.teamChangeNotice ? `<p class="text-sm text-red-600 font-semibold mt-1">⚠️ ${escala.teamChangeNotice}</p>` : ''}
                                        ${escala.leaderModification ? `<p class="text-sm text-red-600 font-semibold mt-1 bg-red-50 p-2 rounded border border-red-200">⚠️ ${escala.leaderModification}</p>` : ''}
                                    </div>
                                </div>
                                ${canDelete ? `
                                <button class="delete-escala-btn text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition" data-escala-id="${escala.id}" data-escala-date="${escala.date}" title="Deletar escala">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                elements.escalasList.innerHTML = html;

                // Event listeners para deletar (apenas escalas próprias)
                document.querySelectorAll('.delete-escala-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        const escalaDate = e.currentTarget.dataset.escalaDate;
                        
                        // Buscar dados completos da escala
                        const escala = escalas.find(esc => esc.id === escalaId);
                        
                        // Verificar se pode deletar (não pode deletar na véspera ou no dia)
                        if (!canDeleteEscala(escalaDate)) {
                            // Registrar tentativa bloqueada
                            if (escala) {
                                logBlockedAttempt(escala);
                            }
                            
                            showModal(
                                'Por aqui, não é possível deletar escala na véspera ou no dia do evento. Entre em contato com o líder para solicitar a exclusão.',
                                false,
                                null,
                                false,
                                null,
                                '⛔'
                            );
                            return;
                        }
                        
                        showModal(
                            'Tem certeza que deseja remover esta escala?',
                            true,
                            () => deleteEscala(escalaId),
                            true
                        );
                    });
                });
            }

            // Carregar todas as escalas (visão admin)
            async function loadAllEscalas() {
                try {
                    const { collection, getDocs } = window.firestoreMethods;
                    const querySnapshot = await getDocs(collection(window.firebaseDb, 'escalas'));
                    const escalas = [];
                    
                    querySnapshot.forEach((doc) => {
                        escalas.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Filtrar apenas escalas aprovadas para a visão geral
                    const approvedEscalas = escalas.filter(e => {
                        const status = e.status || 'approved'; // Default é approved se não tiver status
                        return status === 'approved';
                    });

                    // Agrupar por data e time (apenas aprovadas)
                    const grouped = {};
                    approvedEscalas.forEach(escala => {
                        const key = `${escala.date}_${escala.time}`;
                        if (!grouped[key]) {
                            grouped[key] = {
                                date: escala.date,
                                time: escala.time,
                                eventName: escala.eventName || '',
                                welcome: [],
                                backstage: [],
                                parking: [],
                                kids: [],
                                comunicacao: []
                            };
                        }
                        grouped[key][escala.team].push(escala);
                    });

                    // Garantir que eventos futuros sem inscrições também apareçam na visão admin
                    const nowForAvailable = new Date();
                    availableDates.forEach(dateObj => {
                        const [date, time] = dateObj.value.split('|');
                        const eventDateTime = new Date(date + 'T' + time);
                        const eventEndTime = new Date(eventDateTime.getTime() + (1 * 60 * 60 * 1000));
                        const isVisible = eventEndTime > nowForAvailable; // segue a regra de 1h após início
                        const key = `${date}_${time}`;
                        if (isVisible && !grouped[key]) {
                            grouped[key] = {
                                date,
                                time,
                                eventName: dateObj.text || '',
                                welcome: [],
                                backstage: [],
                                parking: [],
                                kids: [],
                                comunicacao: []
                            };
                        }
                    });

                    // Filtrar eventos visíveis (até 1h após início) ANTES de armazenar
                    const now = new Date();
                    const filteredGrouped = {};
                    
                    Object.keys(grouped).forEach(key => {
                        const data = grouped[key];
                        const eventDateTime = new Date(data.date + 'T' + data.time);
                        const eventEndTime = new Date(eventDateTime.getTime() + (1 * 60 * 60 * 1000)); // 1h após início
                        const isVisible = eventEndTime > now;
                        
                        // Incluir eventos até 1h após o início
                        if (isVisible) {
                            filteredGrouped[key] = data;
                        }
                    });
                    
                    // Armazenar apenas eventos futuros
                    allEscalasGrouped = filteredGrouped;
                    
                    // Atualizar filtro apenas com eventos futuros
                    updateVisaoGeralFilter(filteredGrouped);
                    
                    renderAdminView(filteredGrouped);
                } catch (error) {
                    console.error('❌ Erro ao carregar visão geral:', error);
                }
            }
            
            // Atualizar filtro de Visão Geral
            function updateVisaoGeralFilter(grouped) {
                const filter = elements.filterVisaoGeral;
                // Ordenar chaves por data e hora
                const dates = Object.keys(grouped).sort((a, b) => {
                    const [dateA, timeA] = a.split('_');
                    const [dateB, timeB] = b.split('_');
                    const dateTimeA = new Date(dateA + 'T' + timeA);
                    const dateTimeB = new Date(dateB + 'T' + timeB);
                    return dateTimeA - dateTimeB;
                });
                
                filter.innerHTML = '<option value="">Todas as datas</option>';
                
                // Agrupar por data única (sem hora)
                const uniqueDates = new Map();
                dates.forEach(key => {
                    const data = grouped[key];
                    const dateOnly = data.date; // Apenas YYYY-MM-DD
                    if (!uniqueDates.has(dateOnly)) {
                        uniqueDates.set(dateOnly, []);
                    }
                    uniqueDates.get(dateOnly).push(key);
                });
                
                // Criar opções por data única
                uniqueDates.forEach((keys, dateOnly) => {
                    const dateObj = new Date(dateOnly + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const option = document.createElement('option');
                    option.value = keys.join(','); // Múltiplas chaves separadas por vírgula
                    option.textContent = dateStr;
                    filter.appendChild(option);
                });
            }
            
            // Event listener para filtro de Visão Geral
            elements.filterVisaoGeral.addEventListener('change', () => {
                const selectedValue = elements.filterVisaoGeral.value;
                if (selectedValue) {
                    // Pode ter múltiplas chaves (eventos no mesmo dia)
                    const keys = selectedValue.split(',');
                    const filtered = {};
                    keys.forEach(key => {
                        if (allEscalasGrouped[key]) {
                            filtered[key] = allEscalasGrouped[key];
                        }
                    });
                    renderAdminView(filtered);
                } else {
                    renderAdminView(allEscalasGrouped);
                }
            });

            // Salvar tentativa bloqueada de deleção no Firestore
            async function logBlockedAttempt(escalaData) {
                try {
                    const { collection, addDoc } = window.firestoreMethods;
                    await addDoc(collection(window.firebaseDb, 'blockedAttempts'), {
                        userId: currentUser.uid,
                        userName: currentUser.displayName || currentUser.email,
                        userEmail: currentUser.email,
                        escalaDate: escalaData.date,
                        escalaTime: escalaData.time,
                        escalaTeam: escalaData.team,
                        escalaEventName: escalaData.eventName || '',
                        attemptDate: new Date().toISOString(),
                        attemptDateFormatted: new Date().toLocaleString('pt-BR'),
                        timestamp: Date.now()
                    });
                    console.log('📋 Tentativa bloqueada registrada');
                } catch (error) {
                    console.error('❌ Erro ao registrar tentativa bloqueada:', error);
                }
            }

            // Mostrar modal de próximos eventos
            function showUpcomingEventsModal() {
                const upcomingEvents = updateUpcomingEventsBadge(allUserEscalas);
                
                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };
                
                if (upcomingEvents.length === 0) {
                    showModal('✅ Você não tem eventos nas próximas 48 horas!', false, null, false, null, '📅');
                    return;
                }
                
                const eventsList = upcomingEvents.map(event => {
                    const eventDate = new Date(event.date + 'T' + event.time);
                    const formattedDate = eventDate.toLocaleDateString('pt-BR', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short' 
                    });
                    const formattedTime = event.time === '00:00' ? '(horário a definir)' : event.time;
                    const hoursUntil = Math.round((eventDate - new Date()) / (1000 * 60 * 60));
                    
                    return `<div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-2 rounded">
                        <div class="font-bold text-gray-800">${teamNames[event.team]}</div>
                        <div class="text-sm text-gray-700">📅 ${formattedDate} ${event.eventName ? '- ' + event.eventName : ''}</div>
                        <div class="text-sm text-gray-700">🕐 ${formattedTime}</div>
                        <div class="text-xs text-yellow-700 font-semibold mt-1">⏰ Faltam ${hoursUntil}h</div>
                    </div>`;
                }).join('');
                
                showModal(
                    `<div class="text-left">
                        <div class="mb-4 text-center">
                            <h3 class="text-lg font-bold text-gray-800">🔔 Seus Próximos Eventos</h3>
                            <p class="text-sm text-gray-600">Você tem ${upcomingEvents.length} evento(s) nas próximas 48h</p>
                        </div>
                        ${eventsList}
                    </div>`,
                    false,
                    null,
                    false,
                    null,
                    null
                );
            }
            
            // Atualizar badge de tentativas bloqueadas no menu
            async function updateBlockedAttemptsBadge() {
                if (!isSuperAdmin && !isAdmin) return;
                
                try {
                    const { collection, getDocs } = window.firestoreMethods || {};
                    if (!collection || !getDocs) return;
                    
                    const querySnapshot = await getDocs(collection(window.firebaseDb, 'blockedAttempts'));
                    const count = querySnapshot.size;
                    
                    const badge = document.getElementById('blocked-attempts-badge');
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('❌ Erro ao atualizar badge de tentativas bloqueadas:', error);
                }
            }
            
            // Atualizar badge de escalas pendentes no menu
            async function updatePendingEscalasBadge() {
                if (!isAdmin && !isSuperAdmin) return;
                
                try {
                    const { collection, query, where, getDocs } = window.firestoreMethods || {};
                    if (!collection || !query || !where || !getDocs) return;
                    
                    const q = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('status', '==', 'pending')
                    );
                    
                    const querySnapshot = await getDocs(q);
                    const count = querySnapshot.size;
                    
                    const badge = document.getElementById('pending-escalas-badge');
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('❌ Erro ao atualizar badge de escalas pendentes:', error);
                }
            }
            
            // Carregar tentativas bloqueadas (superadmin, admin e líderes)
            let blockedAttemptsUnsubscribe = null; // Guardar referência do listener
            
            async function loadBlockedAttempts() {
                // Superadmin, admin e líderes podem ver tentativas bloqueadas
                if (!isSuperAdmin && !isAdmin && !isTeamLeader) {
                    console.log('⚠️ Usuário não tem permissão. Acesso negado.');
                    const listEl = document.getElementById('blocked-attempts-list');
                    if (listEl) {
                        listEl.innerHTML = '<p class="text-red-500 text-center py-8">⚠️ Apenas Administradores e Líderes de Time podem acessar esta área.</p>';
                    }
                    return;
                }
                
                const listEl = document.getElementById('blocked-attempts-list');
                if (!listEl) {
                    console.error('❌ Elemento blocked-attempts-list não encontrado');
                    return;
                }
                
                // Mostrar loading
                listEl.innerHTML = '<p class="text-gray-500 text-center py-8">Carregando...</p>';
                
                // Cancelar listener anterior se existir
                if (blockedAttemptsUnsubscribe) {
                    blockedAttemptsUnsubscribe();
                    blockedAttemptsUnsubscribe = null;
                }
                
                try {
                    console.log('🔍 Verificando métodos disponíveis:', Object.keys(window.firestoreMethods || {}));
                    
                    const { collection, query, orderBy, onSnapshot, getDocs } = window.firestoreMethods || {};
                    
                    if (!collection) {
                        throw new Error('Métodos do Firestore não disponíveis. Recarregue a página.');
                    }
                    
                    // Criar query com ordenação
                    let q;
                    if (query && orderBy) {
                        q = query(
                            collection(window.firebaseDb, 'blockedAttempts'),
                            orderBy('timestamp', 'desc')
                        );
                    } else {
                        console.warn('⚠️ orderBy não disponível');
                        q = collection(window.firebaseDb, 'blockedAttempts');
                    }
                    
                    // Listener em tempo real
                    if (onSnapshot) {
                        console.log('👂 Configurando listener em tempo real...');
                        blockedAttemptsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                            const attempts = [];
                            querySnapshot.forEach((doc) => {
                                attempts.push({ id: doc.id, ...doc.data() });
                            });
                            
                            // Ordenar manualmente se orderBy não estiver disponível
                            if (!orderBy) {
                                attempts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                            }
                            
                            console.log('📋 Tentativas bloqueadas atualizadas em tempo real:', attempts.length);
                            renderBlockedAttempts(attempts);
                        }, (error) => {
                            console.error('❌ Erro no listener:', error);
                            console.error('❌ Código do erro:', error.code);
                            console.error('❌ Mensagem:', error.message);
                            
                            // Erro de permissão
                            if (error.code === 'permission-denied') {
                                listEl.innerHTML = `
                                    <div class="text-center py-8">
                                        <p class="text-red-500 font-bold mb-2">🔒 Permissão Negada</p>
                                        <p class="text-sm text-gray-600 mb-4">Você não tem permissão para acessar tentativas bloqueadas.</p>
                                        <p class="text-xs text-gray-500">Configure as regras do Firestore para permitir leitura da coleção 'blockedAttempts' para super admins.</p>
                                        <code class="text-xs bg-gray-100 p-3 rounded block text-left mt-4">
                                            match /blockedAttempts/{document} {<br>
                                            &nbsp;&nbsp;allow read: if request.auth != null;<br>
                                            &nbsp;&nbsp;allow write: if request.auth != null;<br>
                                            }
                                        </code>
                                    </div>
                                `;
                            } else {
                                listEl.innerHTML = `<p class="text-red-500 text-center py-8">❌ Erro ao monitorar dados: ${error.message}</p>`;
                            }
                        });
                    } else if (getDocs) {
                        // Fallback: usar getDocs (sem tempo real)
                        console.warn('⚠️ onSnapshot não disponível, usando getDocs');
                        const querySnapshot = await getDocs(q);
                        const attempts = [];
                        querySnapshot.forEach((doc) => {
                            attempts.push({ id: doc.id, ...doc.data() });
                        });
                        
                        if (!orderBy) {
                            attempts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        }
                        
                        console.log('📋 Tentativas bloqueadas carregadas:', attempts.length);
                        renderBlockedAttempts(attempts);
                    }
                } catch (error) {
                    console.error('❌ Erro ao carregar tentativas bloqueadas:', error);
                    console.error('❌ Detalhes do erro:', error.message);
                    console.error('❌ Código:', error.code);
                    
                    if (error.code === 'permission-denied') {
                        listEl.innerHTML = `
                            <div class="text-center py-8">
                                <p class="text-red-500 font-bold mb-2">🔒 Permissão Negada</p>
                                <p class="text-sm text-gray-600 mb-4">Você não tem permissão para acessar tentativas bloqueadas.</p>
                                <p class="text-xs text-gray-500 mb-4">Configure as regras do Firestore:</p>
                                <code class="text-xs bg-gray-100 p-3 rounded block text-left">
                                    match /blockedAttempts/{document} {<br>
                                    &nbsp;&nbsp;allow read: if request.auth != null;<br>
                                    &nbsp;&nbsp;allow write: if request.auth != null;<br>
                                    }
                                </code>
                            </div>
                        `;
                    } else {
                        listEl.innerHTML = `<p class="text-red-500 text-center py-8">❌ ${error.message || 'Erro ao carregar dados.'}<br><small class="text-xs">Tente recarregar a página (Ctrl+Shift+R)</small></p>`;
                    }
                }
            }

            // Renderizar lista de tentativas bloqueadas
            function renderBlockedAttempts(attempts) {
                const listEl = document.getElementById('blocked-attempts-list');
                
                if (!listEl) {
                    console.error('❌ Elemento blocked-attempts-list não encontrado no render');
                    return;
                }
                
                // Atualizar badge do menu
                const badge = document.getElementById('blocked-attempts-badge');
                if (badge) {
                    if (attempts.length > 0) {
                        badge.textContent = attempts.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
                
                if (attempts.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-8">✅ Nenhuma tentativa bloqueada registrada.</p>';
                    return;
                }
                
                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };
                
                const html = attempts.map(attempt => {
                    const eventDate = new Date(attempt.escalaDate + 'T' + attempt.escalaTime);
                    const eventDateStr = eventDate.toLocaleDateString('pt-BR', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    const eventNameDisplay = attempt.escalaEventName ? ` - ${attempt.escalaEventName}` : '';
                    
                    return `
                        <div class="border-l-4 border-orange-500 bg-orange-50 p-4 rounded-lg mb-3">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="font-bold text-gray-800">${attempt.userName}</span>
                                        <span class="text-xs text-gray-500">${attempt.userEmail}</span>
                                    </div>
                                    <div class="space-y-1 text-sm text-gray-700">
                                        <p><strong>📅 Evento:</strong> ${eventDateStr}${eventNameDisplay}</p>
                                        <p><strong>🕑 Horário:</strong> ${attempt.escalaTime}</p>
                                        <p><strong>👥 Equipe:</strong> ${teamNames[attempt.escalaTeam] || attempt.escalaTeam}</p>
                                        <p class="text-xs text-gray-500 mt-2"><strong>⏰ Tentativa em:</strong> ${attempt.attemptDateFormatted}</p>
                                    </div>
                                </div>
                                <button 
                                    class="delete-attempt-btn flex-shrink-0 p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition"
                                    data-attempt-id="${attempt.id}"
                                    title="Excluir tentativa">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                listEl.innerHTML = html;
                
                // Adicionar event listeners aos botões de deletar
                document.querySelectorAll('.delete-attempt-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const attemptId = e.currentTarget.dataset.attemptId;
                        deleteBlockedAttempt(attemptId);
                    });
                });
            }
            
            // Deletar tentativa bloqueada
            async function deleteBlockedAttempt(attemptId) {
                console.log('🗑️ deleteBlockedAttempt chamada. ID:', attemptId);
                showModal(
                    'Tem certeza que deseja excluir esta tentativa de bloqueio?',
                    true,
                    async () => {
                        try {
                            console.log('🔵 Confirmação recebida. Iniciando exclusão...');
                            console.log('🔍 attemptId:', attemptId);
                            console.log('🔍 firebaseDb existe?', !!window.firebaseDb);
                            console.log('🔍 firestoreMethods existe?', !!window.firestoreMethods);
                            
                            const { doc, deleteDoc, getDoc } = window.firestoreMethods;
                            
                            if (!doc || !deleteDoc || !getDoc) {
                                throw new Error('Métodos Firestore não disponíveis');
                            }
                            
                            console.log('🔵 Criando referência do documento...');
                            const docRef = doc(window.firebaseDb, 'blockedAttempts', attemptId);
                            console.log('🔵 Referência criada:', docRef);
                            
                            // Buscar dados da tentativa antes de deletar (para o log)
                            console.log('🔵 Buscando dados da tentativa bloqueada...');
                            const attemptDoc = await getDoc(docRef);
                            
                            if (!attemptDoc.exists()) {
                                throw new Error('Tentativa bloqueada não encontrada');
                            }
                            
                            const attemptData = attemptDoc.data();
                            console.log('🔵 Dados da tentativa:', attemptData);
                            
                            console.log('🔵 Executando deleteDoc...');
                            await deleteDoc(docRef);
                            
                            // Registrar log de auditoria
                            await logAudit('DELETE_BLOCKED_ATTEMPT', {
                                attemptId: attemptId,
                                userName: attemptData.userName || attemptData.userEmail,
                                userId: attemptData.userId,
                                date: attemptData.date,
                                time: attemptData.time,
                                eventName: attemptData.eventName,
                                team: attemptData.team,
                                reason: attemptData.reason || 'Não especificado'
                            });
                            
                            console.log('✅ Tentativa excluída com sucesso!');
                            showModal('✅ Tentativa excluída com sucesso!');
                            // A lista será atualizada automaticamente pelo listener em tempo real
                        } catch (error) {
                            console.error('❌ ERRO DETALHADO ao deletar tentativa:', error);
                            console.error('❌ Tipo:', error.name);
                            console.error('❌ Mensagem:', error.message);
                            console.error('❌ Code:', error.code);
                            console.error('❌ Stack:', error.stack);
                            showModal(`❌ Erro ao excluir tentativa: ${error.message || error.code}`);
                        }
                    },
                    true
                );
            }

            // Verificar se pode deletar escala (impede deleção na véspera e no dia)
            
            // ========================================
            // ESCALAS PENDENTES (Admin)
            // ========================================
            
            let currentPendingEscalaId = null;
            
            // Carregar escalas pendentes (apenas admin)
            async function loadPendingEscalas() {
                if (!isAdmin && !isSuperAdmin) {
                    console.log('⚠️ Usuário não é admin. Acesso negado.');
                    return;
                }
                
                const listEl = document.getElementById('pending-escalas-list');
                if (!listEl) {
                    console.error('❌ Elemento pending-escalas-list não encontrado');
                    return;
                }
                
                listEl.innerHTML = '<p class="text-gray-500 text-center py-8">Carregando...</p>';
                
                try {
                    const { collection, query, where, getDocs } = window.firestoreMethods;
                    
                    if (!collection) {
                        throw new Error('Métodos do Firestore não disponíveis. Recarregue a página.');
                    }
                    
                    // Buscar escalas com status pending
                    const q = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('status', '==', 'pending')
                    );
                    
                    const querySnapshot = await getDocs(q);
                    const allPendingEscalas = [];
                    
                    querySnapshot.forEach((doc) => {
                        allPendingEscalas.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Filtrar apenas eventos futuros ou do dia atual
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    
                    const pendingEscalas = allPendingEscalas.filter(escala => {
                        const eventDate = new Date(escala.date + 'T00:00:00');
                        return eventDate >= today; // Mostra apenas de hoje em diante
                    });
                    
                    // Ordenar por timestamp de solicitação
                    pendingEscalas.sort((a, b) => {
                        const timeA = new Date(a.requestTimestamp || a.createdAt).getTime();
                        const timeB = new Date(b.requestTimestamp || b.createdAt).getTime();
                        return timeB - timeA; // Mais recentes primeiro
                    });
                    
                    console.log('📋 Escalas pendentes carregadas:', pendingEscalas.length);
                    renderPendingEscalas(pendingEscalas);
                    
                } catch (error) {
                    console.error('❌ Erro ao carregar escalas pendentes:', error);
                    listEl.innerHTML = `<p class="text-red-500 text-center py-8">❌ ${error.message || 'Erro ao carregar dados.'}</p>`;
                }
            }
            
            // Renderizar lista de escalas pendentes
            function renderPendingEscalas(escalas) {
                const listEl = document.getElementById('pending-escalas-list');
                
                // Atualizar badge do menu
                const badge = document.getElementById('pending-escalas-badge');
                if (badge) {
                    if (escalas.length > 0) {
                        badge.textContent = escalas.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
                
                if (escalas.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-8">✅ Não há escalas pendentes no momento.</p>';
                    return;
                }
                
                const teamNames = {
                    welcome: 'Welcome 👋',
                    backstage: 'Backstage 🤝',
                    parking: 'Parking 🚗',
                    kids: 'Kids 👶',
                    comunicacao: 'Comunicação 📢'
                };
                
                const html = escalas.map(escala => {
                    const eventDate = new Date(escala.date + 'T' + escala.time);
                    const eventDateStr = eventDate.toLocaleDateString('pt-BR', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    const requestDate = new Date(escala.requestTimestamp || escala.createdAt);
                    const requestDateStr = requestDate.toLocaleString('pt-BR');
                    const eventNameDisplay = escala.eventName ? ` - ${escala.eventName}` : '';
                    const hoursUntilEvent = Math.round((eventDate - new Date()) / (1000 * 60 * 60));
                    
                    return `
                        <div class="border-l-4 border-blue-500 bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <img src="${escala.userPhoto || 'https://via.placeholder.com/40'}" alt="${escala.userName}" class="w-10 h-10 rounded-full">
                                        <div>
                                            <p class="font-bold text-gray-800">${escala.userName}</p>
                                            <p class="text-xs text-gray-500">${escala.userEmail}</p>
                                        </div>
                                    </div>
                                    <div class="space-y-1 text-sm text-gray-700 mt-3">
                                        <p><strong>📅 Evento:</strong> ${eventDateStr}${eventNameDisplay}</p>
                                        <p><strong>🕑 Horário:</strong> ${escala.time}</p>
                                        <p><strong>👥 Time solicitado:</strong> ${teamNames[escala.requestedTeam] || escala.requestedTeam}</p>
                                        <p class="text-xs text-gray-500 mt-2"><strong>⏰ Solicitado em:</strong> ${requestDateStr}</p>
                                        <p class="text-xs ${hoursUntilEvent < 12 ? 'text-red-600 font-bold' : 'text-orange-600'}">⚠️ Faltam ${hoursUntilEvent}h para o evento</p>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button 
                                        class="approve-escala-btn px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition text-sm font-semibold"
                                        data-escala-id="${escala.id}"
                                        data-escala-team="${escala.requestedTeam}"
                                        title="Aprovar escala">
                                        ✅ Aprovar
                                    </button>
                                    <button 
                                        class="deny-escala-btn px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition text-sm font-semibold"
                                        data-escala-id="${escala.id}"
                                        title="Negar escala">
                                        ❌ Negar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                listEl.innerHTML = html;
                
                // Event listeners para aprovar
                document.querySelectorAll('.approve-escala-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        const requestedTeam = e.currentTarget.dataset.escalaTeam;
                        openApproveTeamModal(escalaId, requestedTeam);
                    });
                });
                
                // Event listeners para negar
                document.querySelectorAll('.deny-escala-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        denyPendingEscala(escalaId);
                    });
                });
            }
            
            // Abrir modal de seleção de time para aprovar
            function openApproveTeamModal(escalaId, requestedTeam) {
                currentPendingEscalaId = escalaId;
                
                const teamOptions = [
                    { key: 'welcome', name: 'Welcome', icon: '👋', color: 'bg-blue-100 hover:bg-blue-200 border-blue-500' },
                    { key: 'backstage', name: 'Backstage', icon: '🤝', color: 'bg-gray-100 hover:bg-gray-200 border-gray-500' },
                    { key: 'parking', name: 'Parking', icon: '🚗', color: 'bg-red-100 hover:bg-red-200 border-red-500' },
                    { key: 'kids', name: 'Kids', icon: '👶', color: 'bg-yellow-100 hover:bg-yellow-200 border-yellow-500' },
                    { key: 'comunicacao', name: 'Comunicação', icon: '📢', color: 'bg-purple-100 hover:bg-purple-200 border-purple-500' }
                ];
                
                const html = teamOptions.map(team => {
                    const isRequested = team.key === requestedTeam;
                    return `
                        <button 
                            class="approve-team-option w-full flex items-center gap-3 p-3 rounded-lg border-2 ${team.color} transition"
                            data-team="${team.key}">
                            <span class="text-2xl">${team.icon}</span>
                            <span class="font-semibold text-gray-800">${team.name}</span>
                            ${isRequested ? '<span class="ml-auto text-xs bg-blue-500 text-white px-2 py-1 rounded">Solicitado</span>' : ''}
                        </button>
                    `;
                }).join('');
                
                document.getElementById('approve-team-options').innerHTML = html;
                
                // Event listeners para seleção de time
                document.querySelectorAll('.approve-team-option').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const selectedTeam = e.currentTarget.dataset.team;
                        approvePendingEscala(currentPendingEscalaId, selectedTeam, requestedTeam);
                    });
                });
                
                document.getElementById('approve-team-modal').classList.remove('hidden');
            }
            
            // Aprovar escala pendente
            async function approvePendingEscala(escalaId, selectedTeam, requestedTeam) {
                try {
                    const { doc, updateDoc, getDoc } = window.firestoreMethods;
                    
                    // Fechar modal de seleção de time
                    document.getElementById('approve-team-modal').classList.add('hidden');
                    
                    // Buscar dados completos da escala
                    const escalaRef = doc(window.firebaseDb, 'escalas', escalaId);
                    const escalaDoc = await getDoc(escalaRef);
                    
                    if (!escalaDoc.exists()) {
                        throw new Error('Escala não encontrada');
                    }
                    
                    const escalaData = escalaDoc.data();
                    
                    // Determinar se houve mudança de time
                    const teamChanged = selectedTeam !== requestedTeam;
                    const updateData = {
                        status: 'approved',
                        team: selectedTeam,
                        approvedAt: new Date().toISOString(),
                        approvedBy: currentUser.uid
                    };
                    
                    // Se mudou de time, adicionar aviso
                    if (teamChanged) {
                        const teamNames = {
                            welcome: '👋 Welcome',
                            backstage: '🤝 Backstage',
                            parking: '🚗 Parking',
                            kids: '👶 Kids',
                            comunicacao: '📢 Comunicação'
                        };
                        updateData.teamChangeNotice = `Foi necessário mudar sua escolha do time ${teamNames[requestedTeam]} para ${teamNames[selectedTeam]} para uma melhor organização dos times.`;
                    }
                    
                    // Atualizar escala
                    await updateDoc(escalaRef, updateData);
                    
                    // Registrar log de auditoria
                    await logAudit('APPROVE_PENDING', {
                        escalaId: escalaId,
                        volunteerName: escalaData.userName || escalaData.userEmail,
                        volunteerId: escalaData.userId,
                        date: escalaData.date,
                        time: escalaData.time,
                        eventName: escalaData.eventName,
                        requestedTeam: requestedTeam,
                        approvedTeam: selectedTeam,
                        teamChanged: teamChanged
                    });
                    
                    console.log('✅ Escala aprovada com sucesso!');
                    showModal(`✅ Escala aprovada! ${teamChanged ? 'Time ajustado para melhor organização.' : ''}`);
                    
                    // Recarregar lista
                    loadPendingEscalas();
                    
                } catch (error) {
                    console.error('❌ Erro ao aprovar escala:', error);
                    showModal(`❌ Erro ao aprovar escala: ${error.message}`);
                }
            }
            
            // Registrar log de auditoria
            async function logAudit(action, details) {
                try {
                    console.log('🔍 DEBUG - Tentando criar log de auditoria...');
                    console.log('🔍 DEBUG - Action:', action);
                    console.log('🔍 DEBUG - Details antes de limpar:', details);
                    console.log('🔍 DEBUG - currentUser:', currentUser);
                    
                    const { collection, addDoc } = window.firestoreMethods;
                    
                    // Limpar campos undefined do details
                    const cleanedDetails = {};
                    for (const key in details) {
                        if (details[key] !== undefined && details[key] !== null && details[key] !== '') {
                            cleanedDetails[key] = details[key];
                        }
                    }
                    
                    console.log('🔍 DEBUG - Details após limpar:', cleanedDetails);
                    
                    const logData = {
                        action: action,
                        userId: currentUser.uid,
                        userEmail: currentUser.email,
                        userName: currentUser.displayName || currentUser.email,
                        timestamp: new Date().toISOString(),
                        details: cleanedDetails
                    };
                    
                    console.log('🔍 DEBUG - Log data a ser salvo:', logData);
                    const docRef = await addDoc(collection(window.firebaseDb, 'audit_logs'), logData);
                    console.log('✅ Log de auditoria registrado com ID:', docRef.id);
                    console.log('📋 Log de auditoria registrado:', action);
                } catch (error) {
                    console.error('❌ Erro ao registrar log:', error);
                    console.error('❌ Stack trace:', error.stack);
                }
            }

            // Carregar logs de auditoria (apenas superadmin)
            async function loadAuditLogs() {
                if (!isSuperAdmin) {
                    document.getElementById('audit-logs-list').innerHTML = 
                        '<p class="text-center text-red-500 py-8">⚠️ Acesso negado. Apenas Super Administradores podem visualizar logs.</p>';
                    return;
                }
                
                try {
                    console.log('🔍 DEBUG - Carregando logs de auditoria...');
                    console.log('🔍 DEBUG - isSuperAdmin:', isSuperAdmin);
                    
                    const { collection, getDocs, query, orderBy: orderByField, limit } = window.firestoreMethods;
                    const logsList = document.getElementById('audit-logs-list');
                    const filterValue = document.getElementById('audit-log-filter').value;
                    const periodValue = document.getElementById('audit-log-period').value;
                    
                    console.log('🔍 DEBUG - Filtro:', filterValue, 'Período:', periodValue);
                    
                    logsList.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 mx-auto"></div><p class="text-gray-600 mt-4">Carregando logs...</p></div>';
                    
                    const logsRef = collection(window.firebaseDb, 'audit_logs');
                    // Buscar todos os logs ordenados, sem filtro de action (para evitar índice composto)
                    const q = query(logsRef, orderByField('timestamp', 'desc'), limit(200));
                    
                    console.log('🔍 DEBUG - Executando query...');
                    const logsSnapshot = await getDocs(q);
                    console.log('🔍 DEBUG - Logs encontrados:', logsSnapshot.size);
                    
                    if (logsSnapshot.empty) {
                        logsList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum log encontrado.</p>';
                        return;
                    }
                    
                    const logs = [];
                    const now = new Date();
                    const periodDays = periodValue === 'all' ? null : parseInt(periodValue);
                    
                    logsSnapshot.forEach(doc => {
                        const data = doc.data();
                        const logDate = new Date(data.timestamp);
                        
                        // Filtrar por período
                        if (periodDays) {
                            const diffDays = (now - logDate) / (1000 * 60 * 60 * 24);
                            if (diffDays > periodDays) {
                                return;
                            }
                        }
                        
                        // Filtrar por ação (client-side)
                        if (filterValue !== 'all' && data.action !== filterValue) {
                            return;
                        }
                        
                        logs.push({ id: doc.id, ...data });
                    });
                    
                    if (logs.length === 0) {
                        logsList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum log encontrado no período selecionado.</p>';
                        return;
                    }
                    
                    // Renderizar logs
                    const actionIcons = {
                        'APPROVE_PENDING': '✅',
                        'DENY_PENDING': '❌',
                        'DELETE_ESCALA': '🗑️',
                        'DELETE_BLOCKED_ATTEMPT': '🔓',
                        'LEADER_UPDATE_FUNCTION': '💼',
                        'LEADER_CHANGE_TEAM': '🔄',
                        'LEADER_DELETE_VOLUNTEER': '🗑️'
                    };
                    
                    const actionLabels = {
                        'APPROVE_PENDING': 'Aprovação',
                        'DENY_PENDING': 'Negação',
                        'DELETE_ESCALA': 'Exclusão',
                        'DELETE_BLOCKED_ATTEMPT': 'Remoção de Bloqueio',
                        'LEADER_UPDATE_FUNCTION': 'Líder - Atualizar Função',
                        'LEADER_CHANGE_TEAM': 'Líder - Mudar Time',
                        'LEADER_DELETE_VOLUNTEER': 'Líder - Excluir Voluntário'
                    };
                    
                    const teamNames = {
                        welcome: '👋 Welcome',
                        backstage: '🤝 Backstage',
                        parking: '🚗 Parking',
                        kids: '👶 Kids',
                        comunicacao: '📢 Comunicação'
                    };
                    
                    logsList.innerHTML = logs.map(log => {
                        const logDate = new Date(log.timestamp);
                        const formattedDate = logDate.toLocaleDateString('pt-BR', { 
                            day: '2-digit', 
                            month: '2-digit', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const icon = actionIcons[log.action] || '📋';
                        const label = actionLabels[log.action] || log.action;
                        
                        let detailsHtml = '';
                        if (log.action === 'APPROVE_PENDING') {
                            const teamChanged = log.details.teamChanged ? 
                                `<span class="text-orange-600 font-semibold">mudou ${teamNames[log.details.requestedTeam]} → ${teamNames[log.details.approvedTeam]}</span>` : 
                                `manteve ${teamNames[log.details.approvedTeam]}`;
                            detailsHtml = `
                                <p class="text-sm"><strong>Voluntário:</strong> ${log.details.volunteerName}</p>
                                <p class="text-sm"><strong>Evento:</strong> ${log.details.eventName || 'Sem nome'} - ${new Date(log.details.date).toLocaleDateString('pt-BR')} às ${log.details.time}</p>
                                <p class="text-sm"><strong>Time:</strong> ${teamChanged}</p>
                            `;
                        } else if (log.action === 'DENY_PENDING') {
                            detailsHtml = `
                                <p class="text-sm"><strong>Voluntário:</strong> ${log.details.volunteerName}</p>
                                <p class="text-sm"><strong>Evento:</strong> ${log.details.eventName || 'Sem nome'} - ${new Date(log.details.date).toLocaleDateString('pt-BR')} às ${log.details.time}</p>
                                <p class="text-sm"><strong>Time solicitado:</strong> ${teamNames[log.details.requestedTeam]}</p>
                            `;
                        } else if (log.action === 'DELETE_ESCALA') {
                            detailsHtml = `
                                <p class="text-sm"><strong>Voluntário:</strong> ${log.details.volunteerName}</p>
                                <p class="text-sm"><strong>Evento:</strong> ${log.details.eventName || 'Sem nome'} - ${new Date(log.details.date).toLocaleDateString('pt-BR')} às ${log.details.time}</p>
                                <p class="text-sm"><strong>Time:</strong> ${teamNames[log.details.team]}</p>
                                <p class="text-sm"><strong>Status:</strong> ${log.details.status}</p>
                            `;
                        } else if (log.action === 'DELETE_BLOCKED_ATTEMPT') {
                            detailsHtml = `
                                <p class="text-sm"><strong>Usuário:</strong> ${log.details.userName}</p>
                                <p class="text-sm"><strong>Evento:</strong> ${log.details.eventName || 'Sem nome'} - ${new Date(log.details.date).toLocaleDateString('pt-BR')} às ${log.details.time}</p>
                                <p class="text-sm"><strong>Time:</strong> ${teamNames[log.details.team]}</p>
                                <p class="text-sm"><strong>Motivo do bloqueio:</strong> ${log.details.reason}</p>
                            `;
                        } else if (log.action === 'LEADER_UPDATE_FUNCTION') {
                            detailsHtml = `
                                <p class="text-sm"><strong>Voluntário:</strong> ${log.details.volunteerName}</p>
                                <p class="text-sm"><strong>Nova Função:</strong> ${log.details.newRole}</p>
                                <p class="text-sm"><strong>Evento:</strong> ${new Date(log.details.eventDate).toLocaleDateString('pt-BR')} às ${log.details.eventTime}</p>
                                <p class="text-sm"><strong>Líder:</strong> ${log.details.leaderName}</p>
                            `;
                        } else if (log.action === 'LEADER_CHANGE_TEAM') {
                            detailsHtml = `
                                <p class="text-sm"><strong>Voluntário:</strong> ${log.details.volunteerName}</p>
                                <p class="text-sm"><strong>Mudança:</strong> <span class="text-orange-600 font-semibold">${teamNames[log.details.oldTeam]} → ${teamNames[log.details.newTeam]}</span></p>
                                <p class="text-sm"><strong>Evento:</strong> ${new Date(log.details.eventDate).toLocaleDateString('pt-BR')} às ${log.details.eventTime}</p>
                                <p class="text-sm"><strong>Líder:</strong> ${log.details.leaderName}</p>
                            `;
                        } else if (log.action === 'LEADER_DELETE_VOLUNTEER') {
                            detailsHtml = `
                                <p class="text-sm"><strong>Voluntário:</strong> ${log.details.volunteerName} (${log.details.volunteerEmail})</p>
                                <p class="text-sm"><strong>Time:</strong> ${teamNames[log.details.team]}</p>
                                <p class="text-sm"><strong>Evento:</strong> ${new Date(log.details.eventDate).toLocaleDateString('pt-BR')} às ${log.details.eventTime}</p>
                                <p class="text-sm"><strong>Líder:</strong> ${log.details.leaderName}</p>
                            `;
                        }
                        
                        return `
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">${icon}</span>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-2">
                                            <h3 class="font-bold text-gray-800">${label}</h3>
                                            <span class="text-xs text-gray-500">${formattedDate}</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-2"><strong>Por:</strong> ${log.userName} (${log.userEmail})</p>
                                        <div class="bg-gray-50 rounded p-2 text-gray-700">
                                            ${detailsHtml}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                } catch (error) {
                    console.error('❌ Erro ao carregar logs:', error);
                    document.getElementById('audit-logs-list').innerHTML = 
                        `<p class="text-center text-red-500 py-8">❌ Erro ao carregar logs: ${error.message}</p>`;
                }
            }

            // Negar escala pendente
            async function denyPendingEscala(escalaId) {
                showModal(
                    'Tem certeza que deseja NEGAR esta escala?',
                    true,
                    async () => {
                        try {
                            const { doc, updateDoc, getDoc } = window.firestoreMethods;
                            
                            // Buscar dados da escala
                            const escalaRef = doc(window.firebaseDb, 'escalas', escalaId);
                            const escalaDoc = await getDoc(escalaRef);
                            const escalaData = escalaDoc.exists() ? escalaDoc.data() : {};
                            
                            // Atualizar status para denied
                            await updateDoc(escalaRef, {
                                status: 'denied',
                                deniedAt: new Date().toISOString(),
                                deniedBy: currentUser.uid,
                                deniedReason: 'Escala não aprovada pelo administrador'
                            });
                            
                            // Registrar log de auditoria
                            await logAudit('DENY_PENDING', {
                                escalaId: escalaId,
                                volunteerName: escalaData.userName || escalaData.userEmail,
                                volunteerId: escalaData.userId,
                                date: escalaData.date,
                                time: escalaData.time,
                                eventName: escalaData.eventName,
                                requestedTeam: escalaData.team
                            });
                            
                            console.log('✅ Escala negada com sucesso!');
                            showModal('✅ Escala negada. O voluntário será notificado.');
                            
                            // Recarregar lista
                            loadPendingEscalas();
                            
                        } catch (error) {
                            console.error('❌ Erro ao negar escala:', error);
                            showModal(`❌ Erro ao negar escala: ${error.message}`);
                        }
                    },
                    true
                );
            }

            // Verificar se pode deletar escala (impede deleção na véspera e no dia)
            function canDeleteEscala(escalaDate) {
                // Admin sempre pode deletar
                if (isAdmin) {
                    return true;
                }
                
                // Pegar data atual (apenas dia, sem hora)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Pegar data do evento (apenas dia, sem hora)
                const eventDate = new Date(escalaDate + 'T00:00:00');
                eventDate.setHours(0, 0, 0, 0);
                
                // Calcular diferença em dias
                const diffTime = eventDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Pode deletar se faltar mais de 1 dia (ou seja, pelo menos 2 dias)
                return diffDays >= 2;
            }

            // Deletar escala
            async function deleteEscala(escalaId) {
                try {
                    const { doc, deleteDoc, getDoc } = window.firestoreMethods;
                    
                    // Buscar dados da escala antes de deletar
                    const escalaRef = doc(window.firebaseDb, 'escalas', escalaId);
                    const escalaDoc = await getDoc(escalaRef);
                    const escalaData = escalaDoc.exists() ? escalaDoc.data() : {};
                    
                    await deleteDoc(escalaRef);
                    
                    // Registrar log de auditoria
                    await logAudit('DELETE_ESCALA', {
                        escalaId: escalaId,
                        volunteerName: escalaData.userName || escalaData.userEmail,
                        volunteerId: escalaData.userId,
                        date: escalaData.date,
                        time: escalaData.time,
                        eventName: escalaData.eventName,
                        team: escalaData.team,
                        status: escalaData.status
                    });
                    
                    console.log('✅ Escala deletada com sucesso!');
                    showModal('Escala removida com sucesso!');
                    
                    // Recarregar escalas e atualizar dropdown
                    loadUserEscalas();
                    loadAllEscalas();
                } catch (error) {
                    console.error('❌ Erro ao deletar escala:', error);
                    showModal('Erro ao remover escala. Tente novamente.');
                }
            }

            // Renderizar lista de datas para admin
            function renderAdminDatesList() {
                const datesList = document.getElementById('admin-dates-list');
                
                if (availableDates.length === 0) {
                    datesList.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma data cadastrada.</p>';
                    return;
                }
                
                // Ordenar datas por data (ordem crescente) COM MAPEAMENTO DE ÍNDICES
                const sortedDates = [...availableDates].sort((a, b) => {
                    const dateA = a.value.split('|')[0];
                    const dateB = b.value.split('|')[0];
                    return dateA.localeCompare(dateB);
                });
                
                // CORREÇÃO: Criar mapa que conecta cada item ordenado ao seu índice original
                const dateIndexMap = new Map();
                sortedDates.forEach((sortedDate, sortedIndex) => {
                    const originalIndex = availableDates.findIndex(d => 
                        d.value === sortedDate.value && d.text === sortedDate.text
                    );
                    dateIndexMap.set(sortedIndex, originalIndex);
                    console.log(`🔍 [DEBUG] sortedIndex: ${sortedIndex} → originalIndex: ${originalIndex} | Data: ${sortedDate.text}`);
                });
                
                const html = sortedDates.map((date, sortedIndex) => {
                    // Usar o mapa para obter o índice correto no array original
                    const realIndex = dateIndexMap.get(sortedIndex);
                    return `
                        <div class="bg-white p-3 rounded border border-gray-200 space-y-2">
                            <!-- Linha 1: Descrição do evento -->
                            <div class="text-sm font-medium text-gray-800">
                                ${date.text}
                            </div>
                            
                            <!-- Linha 2: Botões de ação -->
                            <div class="flex gap-2 pt-1">
                                <button class="admin-edit-date flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded text-sm transition border border-blue-200" data-index="${realIndex}" data-date="${date.text}">
                                    ✏️ Editar
                                </button>
                                ${isSuperAdmin ? `<button class="admin-delete-date flex-1 bg-red-50 hover:bg-red-100 text-red-700 font-semibold py-2 px-4 rounded text-sm transition border border-red-200" data-index="${realIndex}" data-date="${date.text}">
                                    🗑️ Remover
                                </button>` : `<button class="flex-1 bg-gray-100 text-gray-500 font-semibold py-2 px-4 rounded text-sm cursor-not-allowed border border-gray-300" disabled title="Apenas Super Admin pode deletar">
                                    🔒 Remover
                                </button>`}
                            </div>
                        </div>
                    `;
                }).join('');
                
                datesList.innerHTML = html;
                
                // Event listeners para editar data
                document.querySelectorAll('.admin-edit-date').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        const dateText = e.currentTarget.dataset.date;
                        console.log(`📝 [DEBUG] Editando: ${dateText} com índice: ${index}`);
                        editDate(index);
                    });
                });
                
                // Event listeners para deletar data
                document.querySelectorAll('.admin-delete-date').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        const dateText = e.currentTarget.dataset.date;
                        const date = availableDates[index];
                        console.log(`🗑️ [DEBUG] Deletando: ${dateText} com índice: ${index} | Confirmado: ${date.text}`);
                        showModal(
                            `Tem certeza que deseja remover a data "<strong>${date.text}</strong>"?<br><br>⚠️ <span class="text-red-600 font-bold">ATENÇÃO: Todas as ${availableDates.length > 1 ? 'escalas' : 'escala'} desta data serão deletadas permanentemente!</span>`,
                            true,
                            () => deleteDate(index),
                            true
                        );
                    });
                });
                
                // Carregar backups
                loadBackups();
            }

            // Validar campos do formulário admin com feedback visual
            function validateAdminFields() {
                let isValid = true;
                
                // Validar data
                const dateInput = document.getElementById('admin-new-date');
                const dateError = document.getElementById('date-error');
                if (!dateInput.value) {
                    dateInput.classList.add('border-red-500');
                    dateError.textContent = 'Data é obrigatória';
                    dateError.classList.remove('hidden');
                    isValid = false;
                } else {
                    const now = new Date();
                    const eventDateTime = new Date(dateInput.value + 'T' + (document.getElementById('admin-new-time').value || '00:00'));
                    
                    // Permitir qualquer data/hora futura, bloqueando apenas passado
                    if (eventDateTime < now) {
                        dateInput.classList.add('border-red-500');
                        dateError.textContent = 'Data não pode ser no passado';
                        dateError.classList.remove('hidden');
                        isValid = false;
                    } else {
                        dateInput.classList.remove('border-red-500');
                        dateError.classList.add('hidden');
                    }
                }
                
                // Validar limite de voluntários (4 times)
                const limitInputs = {
                    welcome: document.getElementById('admin-limit-welcome'),
                    backstage: document.getElementById('admin-limit-backstage'),
                    parking: document.getElementById('admin-limit-parking'),
                    kids: document.getElementById('admin-limit-kids')
                };
                const limitError = document.getElementById('limit-error');
                
                let hasInvalidLimit = false;
                Object.entries(limitInputs).forEach(([team, input]) => {
                    const limit = parseInt(input.value);
                    if (!limit || limit < 1 || limit > 20) {
                        input.classList.add('border-red-500');
                        hasInvalidLimit = true;
                    } else {
                        input.classList.remove('border-red-500');
                    }
                });
                
                if (hasInvalidLimit) {
                    limitError.textContent = 'Limites devem estar entre 1 e 20';
                    limitError.classList.remove('hidden');
                    isValid = false;
                } else {
                    limitError.classList.add('hidden');
                }
                
                return isValid;
            }

            // ═══════════════════════════════════════════════════════════════
            // ESCALA MANUAL DE VOLUNTÁRIOS (SUPER ADMIN)
            // ═══════════════════════════════════════════════════════════════
            
            let manualScaleState = {
                selectedVolunteer: null,
                selectedEvent: null,
                selectedTeam: null,
                allVolunteers: [],
                allEvents: []
            };

            // Inicializar painel de escala manual
            async function initManualScalePanel() {
                try {
                    console.log('🚀 Inicializando painel de escala manual...');
                    resetManualScalePanel();
                    await loadVolunteersForManualScale();
                    
                    // Event listeners
                    setupManualScaleListeners();
                    setupAddVolunteerModalListeners();
                } catch (error) {
                    console.error('❌ Erro ao inicializar painel:', error);
                    showModal('❌ Erro ao carregar painel');
                }
            }

            // Resetar estado do painel
            function resetManualScalePanel() {
                manualScaleState = {
                    selectedVolunteer: null,
                    selectedEvent: null,
                    selectedTeam: null,
                    allVolunteers: [],
                    allEvents: []
                };
                
                // Esconder seções
                document.getElementById('manual-scale-step-1').classList.remove('hidden');
                document.getElementById('manual-scale-step-2').classList.add('hidden');
                document.getElementById('manual-scale-step-3').classList.add('hidden');
                document.getElementById('manual-scale-back-to-volunteer').classList.add('hidden');
                
                // Limpar inputs
                document.getElementById('manual-scale-volunteer-search').value = '';
                document.getElementById('manual-scale-volunteer-search').focus();
                
                // Recarregar lista de voluntários
                loadVolunteersForManualScale();
            }

            // Carregar voluntários para escala manual
            async function loadVolunteersForManualScale() {
                try {
                    console.log('📋 Carregando voluntários...');
                    
                    const { collection, getDocs } = window.firestoreMethods;
                    const querySnapshot = await getDocs(collection(window.firebaseDb, 'users'));
                    
                    const volunteers = [];
                    querySnapshot.forEach((doc) => {
                        const userData = doc.data();
                        // Incluir todos os usuários (admins, super admins e voluntários)
                        volunteers.push({
                            id: doc.id,
                            name: userData.displayName || userData.email,
                            email: userData.email,
                            role: userData.role
                        });
                    });
                    
                    // Ordenar por nome
                    volunteers.sort((a, b) => a.name.localeCompare(b.name));
                    
                    manualScaleState.allVolunteers = volunteers;
                    console.log('✅ Voluntários carregados:', volunteers.length);
                    
                    displayVolunteersForManualScale(volunteers);
                } catch (error) {
                    console.error('❌ Erro ao carregar voluntários:', error);
                    showModal('❌ Erro ao carregar voluntários');
                }
            }

            // Exibir voluntários
            function displayVolunteersForManualScale(volunteers) {
                const list = document.getElementById('manual-scale-volunteers-list');
                
                if (!list) return;
                
                if (volunteers.length === 0) {
                    const searchInput = document.getElementById('manual-scale-volunteer-search');
                    const searchQuery = searchInput ? searchInput.value.trim() : '';
                    
                    if (searchQuery) {
                        // Mostrar botão para incluir novo voluntário
                        list.innerHTML = `
                            <div class="text-center py-8">
                                <p class="text-gray-500 mb-4">Nenhum voluntário encontrado com "${searchQuery}"</p>
                                <button id="add-new-volunteer-btn" class="zele-btn text-white font-bold py-3 px-6 rounded-lg">
                                    ➕ Incluir Novo Voluntário
                                </button>
                            </div>
                        `;
                        
                        // Event listener para o botão de incluir
                        const addBtn = document.getElementById('add-new-volunteer-btn');
                        if (addBtn) {
                            addBtn.addEventListener('click', () => {
                                openAddNewVolunteerModal(searchQuery);
                            });
                        }
                    } else {
                        list.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum voluntário encontrado</p>';
                    }
                    return;
                }
                
                list.innerHTML = volunteers.map((volunteer) => `
                    <button class="manual-scale-volunteer-btn w-full text-left p-4 rounded-lg border border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition" data-volunteer-id="${volunteer.id}">
                        <p class="font-semibold text-gray-800">${volunteer.name}</p>
                        <p class="text-sm text-gray-600">${volunteer.email}</p>
                    </button>
                `).join('');
                
                // Event listeners
                document.querySelectorAll('.manual-scale-volunteer-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const volunteerId = e.currentTarget.dataset.volunteerId;
                        selectVolunteerForManualScale(volunteerId);
                    });
                });
            }

            // Selecionar voluntário
            async function selectVolunteerForManualScale(volunteerId) {
                try {
                    const volunteer = manualScaleState.allVolunteers.find(v => v.id === volunteerId);
                    
                    console.log('👤 Voluntário selecionado:', volunteer.name);
                    
                    manualScaleState.selectedVolunteer = volunteer;
                    manualScaleState.selectedEvent = null;
                    manualScaleState.selectedTeam = null;
                    
                    // Mostrar step 2
                    document.getElementById('manual-scale-step-1').classList.add('hidden');
                    document.getElementById('manual-scale-step-2').classList.remove('hidden');
                    document.getElementById('manual-scale-back-to-volunteer').classList.remove('hidden');
                    document.getElementById('manual-scale-volunteer-name').textContent = volunteer.name;
                    
                    // Carregar eventos
                    await loadEventsForManualScale();
                    
                } catch (error) {
                    console.error('❌ Erro ao selecionar voluntário:', error);
                }
            }

            // Carregar eventos
            async function loadEventsForManualScale() {
                try {
                    console.log('📅 Carregando eventos...');
                    
                    const events = [];
                    
                    // Carregar datas disponíveis
                    availableDates.forEach((date) => {
                        const dateParts = date.value.split('|');
                        events.push({
                            value: date.value, // Usar value completo para unicidade
                            date: dateParts[0], // Data YYYY-MM-DD
                            time: dateParts[1], // Horário HH:MM
                            text: date.text,
                            eventName: dateParts.length > 2 ? dateParts.slice(2).join('|') : ''
                        });
                    });
                    
                    manualScaleState.allEvents = events;
                    console.log('✅ Eventos carregados:', events.length);
                    
                    displayEventsForManualScale(events);
                } catch (error) {
                    console.error('❌ Erro ao carregar eventos:', error);
                    showModal('❌ Erro ao carregar eventos');
                }
            }

            // Exibir eventos
            function displayEventsForManualScale(events) {
                const list = document.getElementById('manual-scale-events-list');
                
                if (events.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum evento disponível</p>';
                    return;
                }
                
                list.innerHTML = events.map((event) => `
                    <button class="manual-scale-event-btn w-full text-left p-4 rounded-lg border border-gray-200 hover:border-green-500 hover:bg-green-50 transition" data-event-value="${event.value}" data-event-time="${event.time}">
                        <p class="font-semibold text-gray-800">${event.text}</p>
                        <p class="text-sm text-gray-600">⏰ ${event.time}</p>
                    </button>
                `).join('');
                
                // Event listeners
                document.querySelectorAll('.manual-scale-event-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const eventValue = e.currentTarget.dataset.eventValue;
                        const eventTime = e.currentTarget.dataset.eventTime;
                        selectEventForManualScale(eventValue, eventTime);
                    });
                });
            }

            // Selecionar evento
            function selectEventForManualScale(eventValue, eventTime) {
                try {
                    const event = manualScaleState.allEvents.find(e => e.value === eventValue);
                    
                    console.log('📅 Evento selecionado:', event.text);
                    
                    manualScaleState.selectedEvent = event;
                    manualScaleState.selectedTeam = null;
                    
                    // Mostrar step 3
                    document.getElementById('manual-scale-step-2').classList.add('hidden');
                    document.getElementById('manual-scale-step-3').classList.remove('hidden');
                    document.getElementById('manual-scale-event-name').textContent = event.text;
                    
                    // Carregar times
                    loadTeamsForManualScale();
                    
                } catch (error) {
                    console.error('❌ Erro ao selecionar evento:', error);
                }
            }

            // Carregar times disponíveis
            function loadTeamsForManualScale() {
                const teamsList = document.getElementById('manual-scale-teams-list');
                const teams = [
                    { id: 'welcome', name: '👋 Welcome', emoji: '👋' },
                    { id: 'backstage', name: '🎬 Backstage', emoji: '🎬' },
                    { id: 'parking', name: '🚗 Parking', emoji: '🚗' },
                    { id: 'kids', name: '👶 Kids', emoji: '👶' },
                    { id: 'comunicacao', name: '📢 Comunicação', emoji: '📢' }
                ];
                
                teamsList.innerHTML = teams.map((team) => `
                    <button class="manual-scale-team-btn p-4 rounded-lg border-2 border-gray-200 hover:border-purple-500 hover:bg-purple-50 transition text-center" data-team-id="${team.id}">
                        <p class="text-3xl">${team.emoji}</p>
                        <p class="font-semibold text-gray-800">${team.name}</p>
                    </button>
                `).join('');
                
                // Event listeners
                document.querySelectorAll('.manual-scale-team-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Remover seleção anterior
                        document.querySelectorAll('.manual-scale-team-btn').forEach(b => {
                            b.classList.remove('border-purple-500', 'bg-purple-50');
                            b.classList.add('border-gray-200');
                        });
                        
                        // Adicionar seleção atual
                        e.currentTarget.classList.remove('border-gray-200');
                        e.currentTarget.classList.add('border-purple-500', 'bg-purple-50');
                        
                        const teamId = e.currentTarget.dataset.teamId;
                        manualScaleState.selectedTeam = teamId;
                        
                        // Habilitar botão de confirmação
                        document.getElementById('manual-scale-confirm-btn').disabled = false;
                        console.log('✅ Time selecionado:', teamId);
                    });
                });
            }

            // Setup dos event listeners
            function setupManualScaleListeners() {
                // Buscar voluntários
                const searchInput = document.getElementById('manual-scale-volunteer-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const query = e.target.value.toLowerCase();
                        const filtered = manualScaleState.allVolunteers.filter(v => 
                            v.name.toLowerCase().includes(query) || v.email.toLowerCase().includes(query)
                        );
                        displayVolunteersForManualScale(filtered);
                    });
                }
                
                // Voltar de evento
                const backToEventBtn = document.getElementById('manual-scale-back-to-event');
                if (backToEventBtn) {
                    backToEventBtn.addEventListener('click', () => {
                        document.getElementById('manual-scale-step-3').classList.add('hidden');
                        document.getElementById('manual-scale-step-2').classList.remove('hidden');
                        manualScaleState.selectedTeam = null;
                        document.getElementById('manual-scale-confirm-btn').disabled = true;
                    });
                }
                
                // Voltar de voluntário
                const backToVolunteerBtn = document.getElementById('manual-scale-back-to-volunteer');
                if (backToVolunteerBtn) {
                    backToVolunteerBtn.addEventListener('click', () => {
                        document.getElementById('manual-scale-step-2').classList.add('hidden');
                        document.getElementById('manual-scale-step-1').classList.remove('hidden');
                        document.getElementById('manual-scale-back-to-volunteer').classList.add('hidden');
                        manualScaleState.selectedVolunteer = null;
                        document.getElementById('manual-scale-volunteer-search').focus();
                    });
                }
                
                // Confirmar escala
                const confirmBtn = document.getElementById('manual-scale-confirm-btn');
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', async () => {
                        await confirmManualScale();
                    });
                }
            }

            // Confirmar e salvar escala
            async function confirmManualScale() {
                try {
                    const { selectedVolunteer, selectedEvent, selectedTeam } = manualScaleState;
                    
                    if (!selectedVolunteer || !selectedEvent || !selectedTeam) {
                        showModal('❌ Selecione voluntário, evento e time');
                        return;
                    }
                    
                    console.log('💾 Salvando escala manual...');
                    console.log('  Voluntário:', selectedVolunteer.name);
                    console.log('  Evento:', selectedEvent.text);
                    console.log('  Time:', selectedTeam);
                    
                    const { doc, setDoc, Timestamp } = window.firestoreMethods;
                    
                    // Gerar ID da escala usando value completo para unicidade
                    const escalaId = `${selectedVolunteer.id}_${selectedEvent.value.replace(/[^a-zA-Z0-9]/g, '_')}_${selectedTeam}`;
                    
                    // Converter data/hora para Timestamp
                    const eventDateTime = new Date(`${selectedEvent.date}T${selectedEvent.time}:00`);
                    
                    // Criar documento da escala
                    const escalaData = {
                        userId: selectedVolunteer.id,
                        userName: selectedVolunteer.name,
                        userEmail: selectedVolunteer.email,
                        date: selectedEvent.date,
                        time: selectedEvent.time,
                        team: selectedTeam,
                        eventName: selectedEvent.eventName || '',
                        eventValue: selectedEvent.value, // Valor completo do evento para identificação única
                        status: 'approved', // Escala manual é automaticamente aprovada
                        createdAt: new Date().toISOString(),
                        createdByAdmin: currentUser.uid,
                        createdByAdminEmail: currentUser.email,
                        createdByAdminName: currentUser.displayName,
                        isManualScale: true, // Flag para indicar que é escala manual
                        eventTimestamp: Timestamp.fromDate(eventDateTime)
                    };
                    
                    // Salvar escala
                    await setDoc(doc(window.firebaseDb, 'escalas', escalaId), escalaData);
                    console.log('✅ Escala salva com sucesso!');
                    
                    // Log de auditoria
                    await logAudit('MANUAL_SCALE', {
                        volunteerName: selectedVolunteer.name,
                        volunteerId: selectedVolunteer.id,
                        event: selectedEvent.text,
                        eventDate: selectedEvent.value,
                        team: selectedTeam,
                        createdBy: currentUser.displayName
                    });
                    
                    showModal(
                        `✅ Escala criada com sucesso!<br><br>Voluntário: <strong>${selectedVolunteer.name}</strong><br>Evento: <strong>${selectedEvent.text}</strong><br>Time: <strong>${selectedTeam}</strong>`,
                        false,
                        null,
                        false,
                        () => {
                            // Callback ao fechar o modal - recarregar lista
                            resetManualScalePanel();
                        }
                    );
                    
                    // Recarregar dados
                    await loadUserEscalas();
                    await loadAllEscalas();
                    
                } catch (error) {
                    console.error('❌ Erro ao salvar escala:', error);
                    showModal('❌ Erro ao criar escala: ' + error.message);
                }
            }

            // Abrir modal de adicionar novo voluntário
            function openAddNewVolunteerModal(suggestedName = '') {
                const modal = document.getElementById('add-volunteer-modal');
                const nameInput = document.getElementById('new-volunteer-name');
                const emailInput = document.getElementById('new-volunteer-email');
                
                if (!modal || !nameInput || !emailInput) return;
                
                // Preencher sugestão de nome se disponível
                nameInput.value = suggestedName;
                emailInput.value = '';
                
                // Mostrar modal
                modal.classList.add('show');
                
                // Focar no campo apropriado
                if (suggestedName) {
                    emailInput.focus();
                } else {
                    nameInput.focus();
                }
            }
            
            // Fechar modal de adicionar voluntário
            function closeAddNewVolunteerModal() {
                const modal = document.getElementById('add-volunteer-modal');
                if (modal) {
                    modal.classList.remove('show');
                }
            }
            
            // Salvar novo voluntário no Firestore
            async function saveNewVolunteer() {
                try {
                    const nameInput = document.getElementById('new-volunteer-name');
                    const emailInput = document.getElementById('new-volunteer-email');
                    
                    if (!nameInput || !emailInput) return;
                    
                    const name = nameInput.value.trim();
                    const email = emailInput.value.trim().toLowerCase();
                    
                    // Validar campos obrigatórios
                    if (!name) {
                        showModal('❌ Por favor, informe o nome do voluntário');
                        nameInput.focus();
                        return;
                    }
                    
                    if (!email) {
                        showModal('❌ Por favor, informe o email do voluntário');
                        emailInput.focus();
                        return;
                    }
                    
                    // Validar formato de email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        showModal('❌ Por favor, informe um email válido');
                        emailInput.focus();
                        return;
                    }
                    
                    // Verificar se email já existe (buscar todos os usuários e comparar case-insensitive)
                    const { collection, getDocs, doc, setDoc } = window.firestoreMethods;
                    const usersRef = collection(window.firebaseDb, 'users');
                    const allUsersSnapshot = await getDocs(usersRef);
                    
                    // Verificar se já existe um email igual (case-insensitive)
                    let emailExists = false;
                    allUsersSnapshot.forEach((doc) => {
                        const userData = doc.data();
                        if (userData.email && userData.email.toLowerCase() === email) {
                            emailExists = true;
                        }
                    });
                    
                    if (emailExists) {
                        showModal('❌ Já existe um voluntário cadastrado com este email');
                        emailInput.focus();
                        return;
                    }
                    
                    console.log('💾 Salvando novo voluntário...');
                    
                    // Verificar se currentUser está disponível
                    if (!currentUser || !currentUser.uid) {
                        showModal('❌ Erro: sessão de usuário não encontrada. Por favor, faça login novamente.');
                        return;
                    }
                    
                    // Gerar ID único para o voluntário usando Firestore auto-generated ID
                    const newVolunteerRef = doc(collection(window.firebaseDb, 'users'));
                    const volunteerId = newVolunteerRef.id;
                    
                    // Criar documento do voluntário
                    const volunteerData = {
                        displayName: name,
                        email: email,
                        role: 'volunteer',
                        status: 'pre_registered', // Status especial para voluntários pré-cadastrados
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.uid,
                        createdByEmail: currentUser.email,
                        createdByName: currentUser.displayName
                    };
                    
                    // Salvar no Firestore
                    await setDoc(docFunction(window.firebaseDb, 'users', volunteerId), volunteerData);
                    
                    console.log('✅ Novo voluntário salvo com sucesso!');
                    
                    // Log de auditoria
                    await logAudit('NEW_VOLUNTEER_ADDED', {
                        volunteerName: name,
                        volunteerEmail: email,
                        volunteerId: volunteerId,
                        addedBy: currentUser.displayName
                    });
                    
                    // Fechar modal
                    closeAddNewVolunteerModal();
                    
                    // Mostrar mensagem de sucesso
                    showModal(
                        `✅ Voluntário incluído com sucesso!<br><br><strong>${name}</strong> foi adicionado ao sistema e já pode ser escalado.`,
                        false,
                        null,
                        false,
                        async () => {
                            // Recarregar lista de voluntários
                            await loadVolunteersForManualScale();
                            
                            // Selecionar automaticamente o voluntário recém-criado
                            selectVolunteerForManualScale(volunteerId);
                        }
                    );
                    
                } catch (error) {
                    console.error('❌ Erro ao salvar voluntário:', error);
                    showModal('❌ Erro ao incluir voluntário: ' + error.message);
                }
            }
            
            // Setup dos event listeners para o modal de adicionar voluntário
            function setupAddVolunteerModalListeners() {
                const closeBtn = document.getElementById('close-add-volunteer-modal');
                const cancelBtn = document.getElementById('cancel-add-volunteer-btn');
                const confirmBtn = document.getElementById('confirm-add-volunteer-btn');
                const modal = document.getElementById('add-volunteer-modal');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeAddNewVolunteerModal);
                }
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', closeAddNewVolunteerModal);
                }
                
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', saveNewVolunteer);
                }
                
                // Fechar modal ao clicar fora
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeAddNewVolunteerModal();
                        }
                    });
                }
                
                // Permitir Enter no email para salvar
                const emailInput = document.getElementById('new-volunteer-email');
                if (emailInput) {
                    emailInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            saveNewVolunteer();
                        }
                    });
                }
            }

            // Carregar backups de escalas deletadas
            async function loadBackups() {
                try {
                    const backupsList = document.getElementById('admin-backups-list');
                    if (!backupsList) return;
                    
                    const { collection, getDocs } = window.firestoreMethods;
                    const querySnapshot = await getDocs(collection(window.firebaseDb, 'escalas_backups'));
                    
                    if (querySnapshot.empty) {
                        backupsList.innerHTML = '<p class="text-gray-500 text-sm">Nenhum backup disponível.</p>';
                        return;
                    }
                    
                    const backups = [];
                    querySnapshot.forEach((doc) => {
                        backups.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordenar por data de deleção (mais recentes primeiro)
                    backups.sort((a, b) => new Date(b.deletedAt) - new Date(a.deletedAt));
                    
                    const html = backups.map((backup) => {
                        const deletedDate = new Date(backup.deletedAt);
                        const dateStr = deletedDate.toLocaleString('pt-BR');
                        
                        return `
                            <div class="bg-white p-4 rounded border-l-4 border-blue-500 space-y-3">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-bold text-blue-900">${backup.eventName || backup.dateDeleted}</h4>
                                        <p class="text-sm text-gray-600">
                                            📅 Deletado em: ${dateStr}
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            👤 Por: ${backup.deletedByName || backup.deletedByEmail}
                                        </p>
                                        <p class="text-sm font-medium text-blue-700">
                                            📊 ${backup.escalasCount} escala(s) no backup
                                        </p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="backup-view-btn flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded text-sm transition border border-blue-200" data-backup-id="${backup.id}">
                                        👁️ Visualizar
                                    </button>
                                    <button class="backup-restore-btn flex-1 bg-green-50 hover:bg-green-100 text-green-700 font-semibold py-2 px-4 rounded text-sm transition border border-green-200" data-backup-id="${backup.id}">
                                        ↩️ Restaurar
                                    </button>
                                    <button class="backup-delete-btn flex-1 bg-red-50 hover:bg-red-100 text-red-700 font-semibold py-2 px-4 rounded text-sm transition border border-red-200" data-backup-id="${backup.id}">
                                        🗑️ Deletar
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    backupsList.innerHTML = html;
                    
                    // Event listeners
                    document.querySelectorAll('.backup-view-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const backupId = e.currentTarget.dataset.backupId;
                            viewBackup(backupId);
                        });
                    });
                    
                    document.querySelectorAll('.backup-restore-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const backupId = e.currentTarget.dataset.backupId;
                            const backup = backups.find(b => b.id === backupId);
                            showModal(
                                `⚠️ Tem certeza que deseja <strong>restaurar</strong> o backup de <strong>${backup.eventName || backup.dateDeleted}</strong>?<br><br>Serão restauradas <strong>${backup.escalasCount} escala(s)</strong>.`,
                                true,
                                () => restoreBackup(backupId),
                                true
                            );
                        });
                    });
                    
                    document.querySelectorAll('.backup-delete-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const backupId = e.currentTarget.dataset.backupId;
                            const backup = backups.find(b => b.id === backupId);
                            showModal(
                                `Tem certeza que deseja <strong>deletar permanentemente</strong> este backup?<br><br>Evento: ${backup.eventName || backup.dateDeleted}`,
                                true,
                                () => deleteBackup(backupId),
                                true
                            );
                        });
                    });
                    
                } catch (error) {
                    console.error('❌ Erro ao carregar backups:', error);
                }
            }

            // Visualizar escalas no backup
            async function viewBackup(backupId) {
                try {
                    const { doc, getDoc } = window.firestoreMethods;
                    const backupDoc = await getDoc(doc(window.firebaseDb, 'escalas_backups', backupId));
                    
                    if (!backupDoc.exists()) {
                        showModal('❌ Backup não encontrado');
                        return;
                    }
                    
                    const backup = backupDoc.data();
                    let escalasHtml = '';
                    
                    backup.escalas.forEach((escala) => {
                        escalasHtml += `
                            <div class="text-left border-b border-gray-200 pb-2 mb-2">
                                <p><strong>${escala.userName || escala.userEmail}</strong></p>
                                <p class="text-sm text-gray-600">
                                    Time: <strong>${escala.team}</strong> | 
                                    Horário: <strong>${escala.time}</strong> | 
                                    Status: <strong>${escala.status || 'Aprovado'}</strong>
                                </p>
                            </div>
                        `;
                    });
                    
                    showModal(`
                        <div class="text-left max-h-96 overflow-y-auto">
                            <h3 class="font-bold mb-3">${backup.eventName || backup.dateDeleted}</h3>
                            <p class="text-sm text-gray-600 mb-4">Total: <strong>${backup.escalasCount} escala(s)</strong></p>
                            ${escalasHtml || '<p class="text-gray-500">Nenhuma escala neste backup</p>'}
                        </div>
                    `, false);
                    
                } catch (error) {
                    console.error('❌ Erro ao visualizar backup:', error);
                    showModal('❌ Erro ao visualizar backup');
                }
            }

            // Restaurar escalas do backup
            async function restoreBackup(backupId) {
                try {
                    console.log('🔄 [RESTORE] Iniciando restauração do backup:', backupId);
                    
                    const { doc, getDoc, setDoc, collection } = window.firestoreMethods;
                    const backupDoc = await getDoc(doc(window.firebaseDb, 'escalas_backups', backupId));
                    
                    if (!backupDoc.exists()) {
                        throw new Error('Backup não encontrado');
                    }
                    
                    const backup = backupDoc.data();
                    console.log('💾 Backup encontrado com', backup.escalasCount, 'escalas');
                    
                    // Restaurar cada escala
                    let restauradas = 0;
                    for (const escala of backup.escalas) {
                        try {
                            const escalaRef = doc(window.firebaseDb, 'escalas', escala.id);
                            await setDoc(escalaRef, {
                                ...escala,
                                restoredFrom: backupId,
                                restoredAt: new Date().toISOString()
                            });
                            restauradas++;
                            console.log(`  ✅ Escala restaurada: ${escala.userName || escala.userEmail}`);
                        } catch (e) {
                            console.error(`  ❌ Erro ao restaurar escala ${escala.id}:`, e);
                        }
                    }
                    
                    console.log('✅ [RESTORE] Restauração concluída:', restauradas, '/', backup.escalasCount);
                    
                    // Log de auditoria
                    await logAudit('RESTORE_BACKUP', {
                        backupId: backupId,
                        eventName: backup.eventName,
                        escalasRestored: restauradas
                    });
                    
                    showModal(`✅ Backup restaurado com sucesso!<br><br>${restauradas} de ${backup.escalasCount} escala(s) foram restauradas.`);
                    
                    // Recarregar dados
                    await loadUserEscalas();
                    await loadAllEscalas();
                    await loadBackups();
                    
                } catch (error) {
                    console.error('❌ Erro ao restaurar backup:', error);
                    showModal('❌ Erro ao restaurar backup: ' + error.message);
                }
            }

            // Deletar backup permanentemente
            async function deleteBackup(backupId) {
                try {
                    console.log('🗑️ Deletando backup:', backupId);
                    
                    const { doc, deleteDoc } = window.firestoreMethods;
                    await deleteDoc(doc(window.firebaseDb, 'escalas_backups', backupId));
                    
                    console.log('✅ Backup deletado');
                    showModal('✅ Backup deletado com sucesso');
                    await loadBackups();
                    
                } catch (error) {
                    console.error('❌ Erro ao deletar backup:', error);
                    showModal('❌ Erro ao deletar backup');
                }
            }
            
            // Limpar erros de validação ao digitar
            document.getElementById('admin-new-date')?.addEventListener('input', () => {
                document.getElementById('admin-new-date').classList.remove('border-red-500');
                document.getElementById('date-error').classList.add('hidden');
            });
            
            document.getElementById('admin-max-volunteers')?.addEventListener('input', () => {
                document.getElementById('admin-max-volunteers').classList.remove('border-red-500');
                document.getElementById('limit-error').classList.add('hidden');
            });
            
            // Limpar erros dos limites individuais
            ['welcome', 'backstage', 'parking', 'kids', 'comunicacao'].forEach(team => {
                document.getElementById(`admin-limit-${team}`)?.addEventListener('input', () => {
                    document.getElementById(`admin-limit-${team}`).classList.remove('border-red-500');
                    document.getElementById('limit-error').classList.add('hidden');
                });
            });

            // Adicionar nova data (apenas admin)
            async function addNewDate() {
                console.log('🔵 addNewDate() chamada');
                
                // Validar campos com feedback visual
                if (!validateAdminFields()) {
                    console.log('❌ Validação falhou');
                    return;
                }
                
                console.log('✅ Validação passou');
                
                const dateInput = document.getElementById('admin-new-date').value;
                const timeInput = document.getElementById('admin-new-time').value;
                const eventInput = document.getElementById('admin-new-event').value.trim();
                const teamLimits = {
                    welcome: parseInt(document.getElementById('admin-limit-welcome').value) || 4,
                    backstage: parseInt(document.getElementById('admin-limit-backstage').value) || 4,
                    parking: parseInt(document.getElementById('admin-limit-parking').value) || 4,
                    kids: parseInt(document.getElementById('admin-limit-kids').value) || 4,
                    comunicacao: parseInt(document.getElementById('admin-limit-comunicacao').value) || 4
                };
                
                console.log('📝 Dados coletados:', { dateInput, timeInput, eventInput, teamLimits });
                
                // Formatar data para exibição (dd/mm)
                const dateObj = new Date(dateInput + 'T12:00:00');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const weekday = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
                const weekdayCapitalized = weekday.charAt(0).toUpperCase() + weekday.slice(1, 3);
                
                // Usar horário 00:00 se não foi definido
                const finalTime = timeInput || '00:00';
                
                // Montar valor e texto
                const eventSuffix = eventInput ? ` - ${eventInput}` : '';
                const value = `${dateInput}|${finalTime}|${weekdayCapitalized}${eventSuffix}`;
                const timeDisplay = timeInput ? `(chegar ${timeInput})` : '(horário a definir)';
                const text = `${day}/${month} ${weekdayCapitalized}${eventInput ? ' | ' + eventInput : ''} ${timeDisplay}`;
                
                console.log('📅 Evento formatado:', { value, text });
                
                // Verificar se já existe
                const exists = availableDates.some(d => d.value === value);
                if (exists) {
                    console.log('⚠️ Data já existe');
                    showModal('Esta data já está cadastrada!');
                    return;
                }
                
                // Confirmação antes de adicionar
                showModal(
                    `Confirmar criação do evento?<br><br><strong>${text}</strong><br><br>Limites por time:<br>Welcome: ${teamLimits.welcome} | Backstage: ${teamLimits.backstage}<br>Parking: ${teamLimits.parking} | Kids: ${teamLimits.kids}<br>Comunicação: ${teamLimits.comunicacao}`,
                    true,
                    async () => {
                        try {
                            console.log('💾 Salvando evento...');
                            
                            // Adicionar à lista com teamLimits e schema version
                            availableDates.push({ 
                                value, 
                                text, 
                                teamLimits: teamLimits,
                                schemaVersion: CONFIG.SCHEMA_VERSION,
                                createdAt: new Date().toISOString(),
                                createdBy: currentUser?.email || 'unknown'
                            });
                            
                            console.log('📦 Array atualizado. Total:', availableDates.length);
                            console.log('🔍 DEBUG - Array completo:', JSON.stringify(availableDates, null, 2));
                            
                            // Verificar se está autenticado
                            console.log('🔍 DEBUG - Usuário atual:', currentUser?.email);
                            console.log('🔍 DEBUG - É admin?', isAdmin);
                            console.log('🔍 DEBUG - firebaseDb existe?', !!window.firebaseDb);
                            console.log('🔍 DEBUG - firestoreMethods existe?', !!window.firestoreMethods);
                            
                            if (!currentUser) {
                                throw new Error('Usuário não autenticado');
                            }
                            
                            if (!isAdmin) {
                                throw new Error('Usuário não é administrador');
                            }
                            
                            // Salvar no Firestore com retry
                            console.log('🔍 DEBUG - Iniciando salvamento no Firestore...');
                            await firestoreRetry(async () => {
                                const { doc, setDoc } = window.firestoreMethods;
                                
                                if (!doc || !setDoc) {
                                    throw new Error('Métodos Firestore não disponíveis');
                                }
                                
                                const dataToSave = { 
                                    dates: availableDates,
                                    lastUpdated: new Date().toISOString(),
                                    version: CONFIG.SCHEMA_VERSION
                                };
                                console.log('🔍 DEBUG - Dados a salvar:', JSON.stringify(dataToSave, null, 2));
                                
                                const docRef = doc(window.firebaseDb, 'config', 'availableDates');
                                console.log('🔍 DEBUG - Referência do documento criada');
                                
                                await setDoc(docRef, dataToSave);
                                console.log('🔍 DEBUG - setDoc completado');
                            }, 'Salvar evento');
                            
                            console.log('✅ Salvo no Firestore');
                            
                            // Backup se habilitado
                            if (CONFIG.BACKUP_ENABLED) {
                                await backupData('eventCreated', { value, text, teamLimits });
                            }
                            
                            showModal('Data adicionada com sucesso!');
                            
                            // Limpar campos
                            document.getElementById('admin-new-date').value = '';
                            document.getElementById('admin-new-time').value = '';
                            document.getElementById('admin-new-event').value = '';
                            document.getElementById('admin-limit-welcome').value = '4';
                            document.getElementById('admin-limit-backstage').value = '4';
                            document.getElementById('admin-limit-parking').value = '4';
                            document.getElementById('admin-limit-kids').value = '4';
                            
                            console.log('🔄 Atualizando listas...');
                            
                            // Atualizar lista
                            renderAdminDatesList();
                            await loadUserEscalas();
                            await loadAllEscalas();
                            
                            console.log('✅ Evento adicionado com sucesso!');
                            
                        } catch (error) {
                            console.error('❌ ERRO DETALHADO ao salvar data:', error);
                            console.error('❌ Tipo do erro:', error.name);
                            console.error('❌ Mensagem:', error.message);
                            console.error('❌ Code:', error.code);
                            console.error('❌ Stack:', error.stack);
                            logger.error('❌ Erro ao salvar data:', error);
                            showModal(`Erro ao adicionar data: ${error.message || error.code || 'Desconhecido'}. Verifique o console (F12) para mais detalhes.`, false, null, false, null, '❌');
                        }
                    },
                    false,
                    null,
                    '❓'
                );
            }

            // Sistema de backup automático
            async function backupData(action, data) {
                if (!CONFIG.BACKUP_ENABLED) return;
                
                try {
                    const { collection, addDoc } = window.firestoreMethods;
                    await addDoc(collection(window.firebaseDb, 'backups'), {
                        action: action,
                        data: data,
                        user: currentUser?.email || 'unknown',
                        timestamp: new Date().toISOString(),
                        schemaVersion: CONFIG.SCHEMA_VERSION
                    });
                    logger.log('💾 Backup criado:', action);
                } catch (error) {
                    logger.error('❌ Erro ao criar backup:', error);
                    // Não bloquear operação se backup falhar
                }
            }

            // Editar data/horário/evento (apenas admin)
            async function editDate(index) {
                try {
                    const dateToEdit = availableDates[index];
                    const [currentDate, currentTime, ...eventParts] = dateToEdit.value.split('|');
                    const currentEvent = eventParts.join('|'); // Nome do evento pode conter |
                    
                    // Obter limites atuais por time
                    const currentLimits = dateToEdit.teamLimits || {
                        welcome: 4,
                        backstage: 4,
                        parking: 4,
                        kids: 4,
                        comunicacao: 4
                    };
                    
                    // Criar modal customizado para edição
                    const modalHtml = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">🗓️ Nova Data:</label>
                                <input type="date" id="edit-date-input" value="${currentDate}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">🕐 Novo Horário:</label>
                                <input type="time" id="edit-time-input" value="${currentTime}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">📝 Novo Nome do Evento:</label>
                                <input type="text" id="edit-event-input" value="${currentEvent}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="Ex: Culto de Domingo">
                            </div>
                            
                            <div class="border-t border-gray-300 pt-4">
                                <label class="block text-sm font-semibold mb-3">👥 Limite de Voluntários por Time:</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-gray-600">👋 Welcome</label>
                                        <input type="number" id="limit-welcome" value="${currentLimits.welcome}" min="1" max="20" class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600">🤝 Backstage</label>
                                        <input type="number" id="limit-backstage" value="${currentLimits.backstage}" min="1" max="20" class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600">🚗 Parking</label>
                                        <input type="number" id="limit-parking" value="${currentLimits.parking}" min="1" max="20" class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600">👶 Kids</label>
                                        <input type="number" id="limit-kids" value="${currentLimits.kids}" min="1" max="20" class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="text-xs text-gray-600">📢 Comunicação</label>
                                        <input type="number" id="limit-comunicacao" value="${currentLimits.comunicacao}" min="1" max="20" class="w-full border border-gray-300 rounded-lg px-2 py-2 text-sm">
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-xs text-gray-500">⚠️ As escalas existentes serão mantidas e atualizadas automaticamente.</p>
                        </div>
                    `;
                    
                    // Mostrar modal com formulário
                    showModal(
                        `<div class="text-left"><h3 class="font-bold text-lg mb-4">✏️ Editar Evento</h3>${modalHtml}</div>`,
                        true,
                        async () => {
                            const newDate = document.getElementById('edit-date-input').value;
                            const newTime = document.getElementById('edit-time-input').value;
                            const newEvent = document.getElementById('edit-event-input').value.trim();
                            
                            // Obter novos limites
                            const newTeamLimits = {
                                welcome: parseInt(document.getElementById('limit-welcome').value) || 4,
                                backstage: parseInt(document.getElementById('limit-backstage').value) || 4,
                                parking: parseInt(document.getElementById('limit-parking').value) || 4,
                                kids: parseInt(document.getElementById('limit-kids').value) || 4,
                                comunicacao: parseInt(document.getElementById('limit-comunicacao').value) || 4
                            };
                            
                            if (!newDate || !newTime) {
                                showModal('❌ Data e horário são obrigatórios!', false, null, true);
                                return;
                            }
                            
                            // Validar data futura
                            const now = new Date();
                            const eventDateTime = new Date(newDate + 'T' + newTime);
                            const oneHourFromNow = new Date(now.getTime() + (60 * 60 * 1000));
                            
                            if (eventDateTime < oneHourFromNow) {
                                showModal('❌ A data deve ser futura (mínimo 1 hora a partir de agora)!', false, null, true);
                                return;
                            }
                            
                            // Atualizar o evento
                            const oldValue = dateToEdit.value;
                            const oldDate = oldValue.split('|')[0];
                            
                            // Criar novo value
                            const newValue = `${newDate}|${newTime}|${newEvent}`;
                            
                            // Formatar texto para exibição
                            const dateObj = new Date(newDate + 'T' + newTime);
                            const day = dateObj.getDate().toString().padStart(2, '0');
                            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                            const weekday = dateObj.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
                            const weekdayCapitalized = weekday.charAt(0).toUpperCase() + weekday.slice(1);
                            const newText = `${day}/${month} ${weekdayCapitalized} | ${newEvent} (chegar ${newTime})`;
                            
                            console.log('✏️ Atualizando evento:');
                            console.log('  Valor antigo (eventValue):', oldValue);
                            console.log('  Valor novo (eventValue):', newValue);
                            
                            // Atualizar no array com novos limites
                            availableDates[index] = {
                                ...dateToEdit,
                                value: newValue,
                                text: newText,
                                teamLimits: newTeamLimits,
                                lastUpdated: new Date().toISOString(),
                                updatedBy: currentUser?.email || 'unknown'
                            };
                            
                            // Salvar no Firestore
                            const { doc, setDoc, collection, query, where, getDocs, updateDoc } = window.firestoreMethods;
                            
                            // 1. Atualizar config/availableDates
                            await setDoc(doc(window.firebaseDb, 'config', 'availableDates'), { 
                                dates: availableDates,
                                lastUpdated: new Date().toISOString()
                            });
                            
                            // 2. Atualizar todas as escalas DESTE EVENTO ESPECÍFICO (usando eventValue)
                            const q = query(
                                collection(window.firebaseDb, 'escalas'),
                                where('eventValue', '==', oldValue)
                            );
                            
                            const querySnapshot = await getDocs(q);
                            console.log('📋 Atualizando escalas deste evento:', querySnapshot.size);
                            
                            const updatePromises = [];
                            querySnapshot.forEach((docSnapshot) => {
                                const escalaRef = doc(window.firebaseDb, 'escalas', docSnapshot.id);
                                updatePromises.push(updateDoc(escalaRef, {
                                    date: newDate,
                                    time: newTime,
                                    eventName: newEvent,
                                    eventValue: newValue, // Atualizar eventValue para o novo valor
                                    culto: newText, // Atualizar campo culto também
                                    updatedAt: new Date().toISOString()
                                }));
                            });
                            
                            await Promise.all(updatePromises);
                            
                            // Atualizar UI
                            renderAdminDatesList();
                            await loadUserEscalas();
                            await loadAllEscalas();
                            
                            showModal('✅ Evento atualizado com sucesso!', false, null, true);
                        },
                        true,
                        null,
                        '✏️'
                    );
                    
                } catch (error) {
                    console.error('❌ Erro ao editar evento:', error);
                    showModal(`❌ Erro ao editar evento: ${error.message}`, false, null, true);
                }
            }

            // Deletar data (apenas superadmin) COM BACKUP
            async function deleteDate(index) {
                try {
                    // Verificar se é superadmin
                    if (!isSuperAdmin) {
                        showModal('❌ Apenas Super Administradores podem deletar eventos.', false, null, true);
                        console.warn('⚠️ Usuário não é super admin. Deleção bloqueada.');
                        return;
                    }
                    
                    console.log('🗑️ [INICIANDO DELEÇÃO] Índice recebido:', index);
                    console.log('🗑️ Total de datas disponíveis:', availableDates.length);
                    console.log('🗑️ Array completo:', availableDates);
                    
                    if (index < 0 || index >= availableDates.length) {
                        throw new Error(`Índice inválido: ${index}. Total de datas: ${availableDates.length}`);
                    }
                    
                    const dateToDelete = availableDates[index];
                    const eventValue = dateToDelete.value; // Usar value completo do evento
                    
                    console.log('🗑️ Evento a deletar:', dateToDelete.text);
                    console.log('🗑️ Valor do evento (eventValue):', eventValue);
                    console.log('🗑️ Deletando evento:', eventValue);
                    
                    // 1. Buscar todas as escalas DESTE EVENTO ESPECÍFICO (usando eventValue)
                    const { collection, query, where, getDocs, deleteDoc, doc, setDoc, addDoc } = window.firestoreMethods;
                    const q = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('eventValue', '==', eventValue)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    console.log('📋 Escalas encontradas para deletar:', querySnapshot.size);
                    
                    if (querySnapshot.size > 0) {
                        console.log('⚠️ CUIDADO: Deletando', querySnapshot.size, 'escalas do evento', eventValue);
                    }
                    
                    // 2. CRIAR BACKUP antes de deletar
                    console.log('💾 [BACKUP] Iniciando backup das escalas...');
                    const escalasBackup = [];
                    
                    querySnapshot.forEach((docSnapshot) => {
                        const escalaData = docSnapshot.data();
                        escalasBackup.push({
                            id: docSnapshot.id,
                            ...escalaData
                        });
                    });
                    
                    if (escalasBackup.length > 0) {
                        try {
                            // Salvar backup em coleção separada
                            const backupId = `backup_${eventValue.replace(/[^a-zA-Z0-9]/g, '_')}_${Date.now()}`;
                            await setDoc(doc(window.firebaseDb, 'escalas_backups', backupId), {
                                backupId: backupId,
                                dateDeleted: dateValue,
                                eventName: dateToDelete.text,
                                deletedBy: currentUser.uid,
                                deletedByEmail: currentUser.email,
                                deletedByName: currentUser.displayName,
                                deletedAt: new Date().toISOString(),
                                escalasCount: escalasBackup.length,
                                escalas: escalasBackup
                            });
                            console.log('✅ [BACKUP] Backup salvo com sucesso! ID:', backupId);
                            
                            // Log de auditoria
                            await logAudit('DELETE_DATE_WITH_BACKUP', {
                                dateValue: dateValue,
                                eventName: dateToDelete.text,
                                escalasCount: escalasBackup.length,
                                backupId: backupId
                            });
                        } catch (backupError) {
                            console.error('⚠️ [BACKUP] Erro ao salvar backup (mas continuando):', backupError);
                        }
                    }
                    
                    // 3. Deletar todas as escalas desta data
                    const deletePromises = [];
                    querySnapshot.forEach((docSnapshot) => {
                        const escalaData = docSnapshot.data();
                        console.log('  → Deletando escala:', {
                            id: docSnapshot.id,
                            volunteer: escalaData.userName || escalaData.userEmail,
                            date: escalaData.date,
                            time: escalaData.time,
                            team: escalaData.team
                        });
                        deletePromises.push(deleteDoc(doc(window.firebaseDb, 'escalas', docSnapshot.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    console.log('✅ Escalas deletadas com sucesso');
                    
                    // 4. Remover data da lista
                    availableDates.splice(index, 1);
                    console.log('✅ Data removida do array local. Novo total:', availableDates.length);
                    
                    // 5. Salvar no Firestore
                    await setDoc(doc(window.firebaseDb, 'config', 'availableDates'), { dates: availableDates });
                    console.log('✅ Lista de datas atualizada no Firestore');
                    
                    showModal(`✅ Data removida com sucesso!<br><br>${querySnapshot.size} escala(s) foram deletada(s).<br><br>💾 Um backup foi criado e pode ser restaurado se necessário.`);
                    renderAdminDatesList();
                    await loadUserEscalas(); // Atualizar dropdown
                    await loadAllEscalas(); // Atualizar visão geral
                    
                } catch (error) {
                    console.error('❌ Erro ao deletar data:', error);
                    console.error('❌ Stack:', error.stack);
                    showModal('❌ Erro ao remover data. Tente novamente.<br><br>Erro: ' + error.message);
                }
            }

            // Renderizar visão admin
            function renderAdminView(grouped) {
                console.log('🔍 renderAdminView - isTeamLeader:', isTeamLeader);
                console.log('🔍 renderAdminView - userTeamLeadership:', userTeamLeadership);
                console.log('🔍 renderAdminView - isAdmin:', isAdmin);
                console.log('🔍 renderAdminView - isSuperAdmin:', isSuperAdmin);
                
                // Ordenar chaves por data e hora (ordem crescente)
                const dates = Object.keys(grouped).sort((a, b) => {
                    const [dateA, timeA] = a.split('_');
                    const [dateB, timeB] = b.split('_');
                    const dateTimeA = new Date(dateA + 'T' + timeA);
                    const dateTimeB = new Date(dateB + 'T' + timeB);
                    return dateTimeA - dateTimeB;
                });

                if (dates.length === 0) {
                    elements.adminView.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma escala cadastrada ainda.</p>';
                    return;
                }

                const html = dates.map(key => {
                    const data = grouped[key];
                    const dateObj = new Date(data.date + 'T' + data.time);
                    const dateStr = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const eventName = data.eventName ? ` - ${data.eventName}` : '';

                    // Função para renderizar voluntários com botão de deletar e transferir (para líderes do time específico)
                    const renderVolunteers = (volunteers, teamName) => {
                        if (volunteers.length === 0) {
                            return '<div class="text-gray-400">Ninguém escalado</div>';
                        }
                        
                        const teamKey = teamName.toLowerCase();
                        // Superadmin pode gerenciar TODOS os times
                        // Admin/líder pode gerenciar SOMENTE os times que lidera
                        const canManageThisTeam = isSuperAdmin || ((isAdmin || isTeamLeader) && userTeamLeadership && userTeamLeadership.includes(teamKey));
                        
                        console.log(`🔍 Team: ${teamKey}, isSuperAdmin: ${isSuperAdmin}, isAdmin: ${isAdmin}, isTeamLeader: ${isTeamLeader}, leadership:`, userTeamLeadership, `canManage: ${canManageThisTeam}`);
                        
                        // Ordenar voluntários por função (role) alfabeticamente
                        const sortedVolunteers = volunteers.sort((a, b) => {
                            const roleA = (a.role || '').toLowerCase();
                            const roleB = (b.role || '').toLowerCase();
                            return roleA.localeCompare(roleB, 'pt-BR');
                        });
                        
                        return sortedVolunteers.map(v => `
                            <div class="flex items-center justify-between py-2 md:py-1">
                                <span class="text-base md:text-sm font-medium">• ${v.userName}</span>
                                ${canManageThisTeam ? `
                                <div class="flex gap-3">
                                    <button class="transfer-volunteer-btn text-blue-600 hover:text-blue-800 w-10 h-10 md:w-7 md:h-7 flex items-center justify-center rounded focus:outline-none focus:ring-2 focus:ring-blue-300 text-2xl md:text-base"
                                            data-escala-id="${v.id}"
                                            data-volunteer-name="${v.userName}"
                                            data-current-team="${teamKey}"
                                            data-date="${data.date}"
                                            data-time="${data.time}"
                                            aria-label="Transferir ${v.userName} para outro time"
                                            title="Transferir ${v.userName} para outro time">
                                        🔁
                                    </button>
                                    <button class="admin-delete-escala text-red-600 hover:text-red-800 w-10 h-10 md:w-7 md:h-7 flex items-center justify-center rounded focus:outline-none focus:ring-2 focus:ring-red-300 text-2xl md:text-base"
                                            data-escala-id="${v.id}"
                                            data-current-team="${teamKey}"
                                            aria-label="Remover ${v.userName}"
                                            title="Remover ${v.userName}">
                                        🗑️
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        `).join('');
                    };

                    return `
                        <div class="border border-gray-200 rounded-lg p-4" style="border: 2px solid #e5e5e5; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                            <h3 class="font-bold text-lg mb-3" style="color: #151b29;">📅 ${dateStr}${eventName} - 🕐 ${data.time}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-color: #151b29;">
                                    <h4 class="font-semibold mb-2" style="color: #151b29;">Welcome (${data.welcome.length})</h4>
                                    <div class="text-sm space-y-1">
                                        ${renderVolunteers(data.welcome, 'Welcome')}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-color: #151b29;">
                                    <h4 class="font-semibold mb-2" style="color: #151b29;">Backstage (${data.backstage.length})</h4>
                                    <div class="text-sm space-y-1">
                                        ${renderVolunteers(data.backstage, 'Backstage')}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-color: #151b29;">
                                    <h4 class="font-semibold mb-2" style="color: #151b29;">Parking (${data.parking.length})</h4>
                                    <div class="text-sm space-y-1">
                                        ${renderVolunteers(data.parking, 'Parking')}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-color: #151b29;">
                                    <h4 class="font-semibold mb-2" style="color: #151b29;">Kids (${data.kids.length})</h4>
                                    <div class="text-sm space-y-1">
                                        ${renderVolunteers(data.kids, 'Kids')}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-color: #151b29;">
                                    <h4 class="font-semibold mb-2" style="color: #151b29;">Comunicação (${data.comunicacao.length})</h4>
                                    <div class="text-sm space-y-1">
                                        ${renderVolunteers(data.comunicacao, 'Comunicação')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                elements.adminView.innerHTML = html;

                // Event listeners para deletar escala (superadmin tem acesso total, outros apenas times que lideram)
                document.querySelectorAll('.admin-delete-escala').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        const currentTeam = e.currentTarget.dataset.currentTeam;
                        
                        // Permissão: superadmin pode tudo, admin/líder apenas nos times que lidera
                        const hasPermission = isSuperAdmin || ((isAdmin || isTeamLeader) && userTeamLeadership && userTeamLeadership.includes(currentTeam));
                        
                        if (hasPermission) {
                            showModal(
                                `Como ${isSuperAdmin ? 'super administrador' : 'líder do time'}, deseja remover esta pessoa da escala?`,
                                true,
                                () => deleteEscala(escalaId),
                                true
                            );
                        } else {
                            showModal('❌ Você só pode remover voluntários dos times que lidera.', false, null, true);
                        }
                    });
                });
                
                // Event listeners para transferir voluntário (superadmin tem acesso total, outros apenas times que lideram)
                document.querySelectorAll('.transfer-volunteer-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        const volunteerName = e.currentTarget.dataset.volunteerName;
                        const currentTeam = e.currentTarget.dataset.currentTeam;
                        const date = e.currentTarget.dataset.date;
                        const time = e.currentTarget.dataset.time;
                        
                        // Permissão: superadmin pode tudo, admin/líder apenas nos times que lidera
                        const hasPermission = isSuperAdmin || ((isAdmin || isTeamLeader) && userTeamLeadership && userTeamLeadership.includes(currentTeam));
                        
                        if (hasPermission) {
                            openTransferModal(escalaId, volunteerName, currentTeam, date, time);
                        } else {
                            showModal('❌ Você só pode transferir voluntários dos times que lidera.', false, null, true);
                        }
                    });
                });
            }

            // ===== DASHBOARD E GRÁFICOS =====

            let dashboardCharts = {
                teams: null,
                volunteers: null,
                events: null,
                emptyTeams: null,
                chart5: null,
                checkinRanking: null
            };

            // Event listeners para filtros de Dashboard
            const dashboardPeriodSelect = document.getElementById('dashboard-period');
            const customDateRange = document.getElementById('custom-date-range');
            const refreshDashboardBtn = document.getElementById('refresh-dashboard');

            if (dashboardPeriodSelect) {
                dashboardPeriodSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        customDateRange.classList.remove('hidden');
                    } else {
                        customDateRange.classList.add('hidden');
                        loadDashboard(); // Recarregar automaticamente
                    }
                });
            }

            if (refreshDashboardBtn) {
                refreshDashboardBtn.addEventListener('click', () => {
                    loadDashboard();
                });
            }

            // Função principal para carregar Dashboard
            async function loadDashboard() {
                try {
                    console.log('📊 Carregando Dashboard...');
                    
                    // Obter período selecionado
                    const period = dashboardPeriodSelect.value;
                    let dateFrom, dateTo;
                    
                    // Obter data atual no horário local
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    
                    if (period === 'custom') {
                        const fromInput = document.getElementById('date-from').value;
                        const toInput = document.getElementById('date-to').value;
                        
                        if (!fromInput || !toInput) {
                            showModal('❌ Por favor, selecione as datas de início e fim.', false, null, true);
                            return;
                        }
                        
                        dateFrom = new Date(fromInput + 'T00:00:00');
                        dateTo = new Date(toInput + 'T23:59:59');
                    } else if (period === 'all') {
                        dateFrom = new Date('2020-01-01T00:00:00'); // Data antiga o suficiente
                        dateTo = new Date(today.getTime() + (365 * 24 * 60 * 60 * 1000)); // 1 ano no futuro
                    } else {
                        const days = parseInt(period);
                        if (days < 0) {
                            // Período passado (Últimos X dias) - incluindo hoje
                            dateFrom = new Date(today.getTime() + (days * 24 * 60 * 60 * 1000));
                            dateTo = new Date(today);
                            dateTo.setHours(23, 59, 59, 999);
                        } else {
                            // Período futuro (Próximos X dias) - incluindo o dia corrente
                            dateFrom = new Date(today);
                            dateTo = new Date(today.getTime() + (days * 24 * 60 * 60 * 1000));
                            dateTo.setHours(23, 59, 59, 999);
                        }
                    }
                    
                    console.log('📅 Período:', dateFrom.toLocaleDateString(), 'até', dateTo.toLocaleDateString());
                    
                    // Converter para formato YYYY-MM-DD usando data local (não UTC)
                    const formatDateLocal = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        return `${year}-${month}-${day}`;
                    };
                    
                    const dateFromStr = formatDateLocal(dateFrom);
                    const dateToStr = formatDateLocal(dateTo);
                    
                    console.log('📅 dateFromStr:', dateFromStr);
                    console.log('📅 dateToStr:', dateToStr);
                    
                    // Buscar todas as escalas no período
                    const { collection, getDocs } = window.firestoreMethods;
                    const escalasRef = collection(window.firebaseDb, 'escalas');
                    
                    // Buscar TODAS as escalas e filtrar no cliente (sem query where)
                    const querySnapshot = await getDocs(escalasRef);
                    console.log('📊 Total de documentos no Firestore:', querySnapshot.size);
                    
                    const escalas = [];
                    
                    console.log('📊 Filtrando escalas entre:', dateFromStr, 'e', dateToStr);
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        
                        if (data.date >= dateFromStr && data.date <= dateToStr) {
                            escalas.push({ id: doc.id, ...data });
                        }
                    });
                    
                    console.log('📋 Escalas encontradas no período:', escalas.length);
                    if (escalas.length === 0) {
                        console.warn('⚠️ Nenhuma escala encontrada! Verifique se existem escalas no Firestore para este período.');
                    }
                    
                    // Armazenar escalas globalmente para atualização do gráfico
                    window.currentDashboardEscalas = escalas;
                    
                    // Atualizar estatísticas de voluntários
                    await getVolunteerStats(escalas);
                    
                    // Gerar dados dos gráficos
                    await generateChart1_TeamParticipation(escalas);
                    await generateChart2_TopVolunteers(escalas);
                    await generateChart3_EventsWithMostVolunteers(escalas);
                    await generateChart4_EventsWithEmptyTeams(dateFrom, dateTo);
                    await generateChart5_CheckinAttendance(escalas); // Novo gráfico de presença
                    await generateChart6_CheckinRanking(escalas); // Ranking de check-in
                    
                    // Configurar navegação dos gráficos com scroll
                    setupChartNavigation();
                    
                    console.log('✅ Dashboard carregado com sucesso!');
                    
                } catch (error) {
                    console.error('❌ Erro ao carregar Dashboard:', error);
                    showModal('❌ Erro ao carregar Dashboard. Tente novamente.', false, null, true);
                }
            }

            // Gráfico 1: Participação por Time (voluntários únicos)
            // Armazenar detalhes dos voluntários para o popup do Chart 1
            window.chart1VolunteerDetails = {};

            async function generateChart1_TeamParticipation(escalas) {
                const teamVolunteers = {
                    welcome: new Map(),
                    backstage: new Map(),
                    parking: new Map(),
                    kids: new Map(),
                    comunicacao: new Map()
                };
                
                // Adicionar userId único por time (Map armazena userId -> volunteer data)
                escalas.forEach(escala => {
                    const team = escala.team?.toLowerCase();
                    const userId = escala.userId;
                    
                    if (teamVolunteers.hasOwnProperty(team) && userId) {
                        if (!teamVolunteers[team].has(userId)) {
                            teamVolunteers[team].set(userId, {
                                name: escala.userName || 'Sem nome',
                                email: escala.userEmail || '',
                                photo: escala.userPhoto || 'Zele logo.png'
                            });
                        }
                    }
                });
                
                // Armazenar detalhes para o popup
                window.chart1VolunteerDetails = {
                    welcome: Array.from(teamVolunteers.welcome.values()),
                    backstage: Array.from(teamVolunteers.backstage.values()),
                    parking: Array.from(teamVolunteers.parking.values()),
                    kids: Array.from(teamVolunteers.kids.values()),
                    comunicacao: Array.from(teamVolunteers.comunicacao.values())
                };
                
                // Converter Maps para contagem
                const teamCount = {
                    welcome: teamVolunteers.welcome.size,
                    backstage: teamVolunteers.backstage.size,
                    parking: teamVolunteers.parking.size,
                    kids: teamVolunteers.kids.size,
                    comunicacao: teamVolunteers.comunicacao.size
                };
                
                const ctx = document.getElementById('chart-teams');
                
                // Destruir gráfico anterior se existir
                if (dashboardCharts.teams) {
                    dashboardCharts.teams.destroy();
                }
                
                dashboardCharts.teams = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['👋 Welcome', '🤝 Backstage', '🚗 Parking', '👶 Kids', '📢 Comunicação'],
                        datasets: [{
                            label: 'Voluntários Únicos',
                            data: [teamCount.welcome, teamCount.backstage, teamCount.parking, teamCount.kids, teamCount.comunicacao],
                            backgroundColor: [
                                'rgba(254, 243, 199, 0.7)',  // Amarelo claro (1º)
                                'rgba(245, 208, 71, 0.7)',   // Amarelo mais escuro (2º)
                                'rgba(254, 180, 123, 0.7)',  // Laranja claro (3º)
                                'rgba(251, 146, 60, 0.7)',   // Laranja escuro (4º)
                                'rgba(239, 68, 68, 0.7)'     // Vermelho (5º)
                            ],
                            borderColor: [
                                'rgba(254, 243, 199, 1)',    // Amarelo claro (1º)
                                'rgba(245, 208, 71, 1)',     // Amarelo mais escuro (2º)
                                'rgba(254, 180, 123, 1)',    // Laranja claro (3º)
                                'rgba(251, 146, 60, 1)',     // Laranja escuro (4º)
                                'rgba(239, 68, 68, 1)'       // Vermelho (5º)
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    font: { size: 12 },
                                    padding: 15,
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                suggestedMax: 6,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : '';
                                    }
                                }
                            }
                        },
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                showChart1Popup(index);
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
            }

            // Gráfico 2: Ranking de Voluntários com mais Escalas
            async function generateChart2_TopVolunteers(escalas) {
                // Contar escalas por voluntário e por time
                const volunteerTeamCount = {};
                
                escalas.forEach(escala => {
                    const name = escala.userName || 'Desconhecido';
                    const team = escala.team?.toLowerCase();
                    
                    if (!volunteerTeamCount[name]) {
                        volunteerTeamCount[name] = {
                            total: 0,
                            welcome: 0,
                            backstage: 0,
                            parking: 0,
                            kids: 0,
                            comunicacao: 0
                        };
                    }
                    
                    volunteerTeamCount[name].total++;
                    if (team && volunteerTeamCount[name].hasOwnProperty(team)) {
                        volunteerTeamCount[name][team]++;
                    }
                });
                
                // Ordenar por total e pegar top 10
                const sorted = Object.entries(volunteerTeamCount)
                    .sort((a, b) => b[1].total - a[1].total)
                    .slice(0, 10);
                
                const labels = sorted.map(item => item[0]);
                
                // Preparar datasets por time (do menor para o maior na barra)
                const welcomeData = sorted.map(item => item[1].welcome);
                const backstageData = sorted.map(item => item[1].backstage);
                const parkingData = sorted.map(item => item[1].parking);
                const kidsData = sorted.map(item => item[1].kids);
                const comunicacaoData = sorted.map(item => item[1].comunicacao);
                
                const ctx = document.getElementById('chart-volunteers');
                
                if (dashboardCharts.volunteers) {
                    dashboardCharts.volunteers.destroy();
                }
                
                dashboardCharts.volunteers = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '👋 Welcome',
                                data: welcomeData,
                                backgroundColor: 'rgba(55, 125, 184, 0.8)',
                                borderColor: 'rgba(55, 125, 184, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '🤝 Backstage',
                                data: backstageData,
                                backgroundColor: 'rgba(128, 128, 128, 0.8)',
                                borderColor: 'rgba(128, 128, 128, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '🚗 Parking',
                                data: parkingData,
                                backgroundColor: 'rgba(248, 113, 113, 0.8)',
                                borderColor: 'rgba(248, 113, 113, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '👶 Kids',
                                data: kidsData,
                                backgroundColor: 'rgba(251, 191, 36, 0.8)',
                                borderColor: 'rgba(251, 191, 36, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '📢 Comunicação',
                                data: comunicacaoData,
                                backgroundColor: 'rgba(147, 51, 234, 0.8)',
                                borderColor: 'rgba(147, 51, 234, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // Horizontal
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 15,
                                    padding: 10,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.x;
                                        return value > 0 ? `${label}: ${value}` : null;
                                    },
                                    footer: function(tooltipItems) {
                                        let total = 0;
                                        tooltipItems.forEach(item => {
                                            total += item.parsed.x;
                                        });
                                        return `Total: ${total} escalas`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            },
                            y: {
                                stacked: true
                            }
                        }
                    }
                });
            }

            // Gráfico 3: Quantidade de Voluntários por Dia
            async function generateChart3_EventsWithMostVolunteers(escalas) {
                const eventCount = {};
                const eventDetails = {}; // Armazenar detalhes completos de cada evento
                
                escalas.forEach(escala => {
                    const eventKey = `${escala.date}|${escala.time}|${escala.eventName || 'Evento'}`;
                    
                    if (!eventCount[eventKey]) {
                        eventCount[eventKey] = 0;
                        eventDetails[eventKey] = {
                            date: escala.date,
                            time: escala.time,
                            eventName: escala.eventName || 'Evento',
                            teams: {
                                welcome: [],
                                backstage: [],
                                parking: [],
                                kids: [],
                                comunicacao: []
                            }
                        };
                    }
                    
                    eventCount[eventKey]++;
                    
                    // Adicionar voluntário ao time correspondente
                    let team = escala.team?.toLowerCase();
                    // Normalizar variações de comunicação
                    if (team === 'comunicação' || team === 'comunicacao') {
                        team = 'comunicacao';
                    }
                    if (eventDetails[eventKey].teams[team]) {
                        eventDetails[eventKey].teams[team].push({
                            name: escala.userName || 'Desconhecido',
                            photo: escala.userPhoto || '',
                            email: escala.userEmail || ''
                        });
                    }
                });
                
                // Ordenar por data (crescente)
                const sorted = Object.entries(eventCount)
                    .sort((a, b) => {
                        const dateA = new Date(a[0].split('|')[0] + 'T' + a[0].split('|')[1]);
                        const dateB = new Date(b[0].split('|')[0] + 'T' + b[0].split('|')[1]);
                        return dateA - dateB;
                    });
                
                const labels = sorted.map(item => {
                    const date = item[0].split('|')[0];
                    const dateObj = new Date(date + 'T00:00:00');
                    return `${dateObj.getDate().toString().padStart(2, '0')}/${(dateObj.getMonth() + 1).toString().padStart(2, '0')}`;
                });
                const data = sorted.map(item => item[1]);
                
                // Armazenar detalhes para uso no click
                window.chart3EventDetails = sorted.map(item => eventDetails[item[0]]);
                
                const ctx = document.getElementById('chart-events');
                
                if (dashboardCharts.events) {
                    dashboardCharts.events.destroy();
                }
                
                dashboardCharts.events = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total de Voluntários',
                            data: data,
                            backgroundColor: 'rgba(99, 102, 241, 0.7)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    afterLabel: () => '👆 Clique para ver detalhes'
                                }
                            }
                        },
                        scales: {
                            x: {
                                min: 0,
                                max: Math.min(9, labels.length - 1), // Mostrar apenas 10 barras por vez
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                showChart3Popup(index);
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
            }

            // Gráfico 4: Times com Menos de 5 Voluntários (ALERTA)
            const chart4EventDetails = []; // Armazena detalhes de cada evento para o popup
            
            async function generateChart4_EventsWithEmptyTeams(dateFrom, dateTo) {
                try {
                    // Limpar detalhes anteriores
                    chart4EventDetails.length = 0;
                    
                    // Filtrar eventos no período selecionado e ordenar por data (crescente)
                    const filteredEvents = availableDates
                        .filter(date => {
                            const eventDate = new Date(date.value.split('|')[0] + 'T00:00:00');
                            return eventDate >= dateFrom && eventDate <= dateTo;
                        })
                        .sort((a, b) => {
                            const dateA = new Date(a.value.split('|')[0] + 'T00:00:00');
                            const dateB = new Date(b.value.split('|')[0] + 'T00:00:00');
                            return dateA - dateB;
                        })
                        .slice(0, 30); // Máximo 30 eventos
                    
                    const labels = [];
                    const underStaffedCount = [];
                    const backgroundColors = [];
                    
                    for (const event of filteredEvents) {
                        const [dateStr, timeStr, ...eventParts] = event.value.split('|');
                        const eventName = eventParts.join('|');
                        
                        // Buscar escalas deste evento
                        const { collection, query, where, getDocs } = window.firestoreMethods;
                        const q = query(
                            collection(window.firebaseDb, 'escalas'),
                            where('date', '==', dateStr)
                        );
                        
                        const querySnapshot = await getDocs(q);
                        const teams = { welcome: 0, backstage: 0, parking: 0, kids: 0, comunicacao: 0 };
                        
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            const team = data.team?.toLowerCase();
                            if (teams.hasOwnProperty(team)) {
                                teams[team]++;
                            }
                        });
                        
                        // Contar times com menos de 5 voluntários (0 a 4)
                        const underStaffed = Object.values(teams).filter(count => count < 5).length;
                        
                        // Pular eventos com todos os times com 5 ou mais voluntários
                        if (underStaffed === 0) {
                            continue;
                        }
                        
                        // Formatação da label
                        const dateObj = new Date(dateStr + 'T00:00:00');
                        const day = dateObj.getDate().toString().padStart(2, '0');
                        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                        labels.push(`${day}/${month}`);
                        
                        // Armazenar detalhes para o popup
                        chart4EventDetails.push({
                            date: `${day}/${month}`,
                            fullDate: dateStr,
                            eventName: eventName,
                            teams: {
                                'Recepção': teams.welcome,
                                'Backstage': teams.backstage,
                                'Estacionamento': teams.parking,
                                'Kids': teams.kids,
                                'Comunicação': teams.comunicacao
                            }
                        });
                        
                        underStaffedCount.push(underStaffed);
                        
                        // Cor baseada na criticidade (1 a 5 times com menos de 5 voluntários)
                        if (underStaffed === 1) {
                            backgroundColors.push('rgba(254, 240, 138, 0.8)'); // Amarelo claro
                        } else if (underStaffed === 2) {
                            backgroundColors.push('rgba(234, 179, 8, 0.8)'); // Amarelo
                        } else if (underStaffed === 3) {
                            backgroundColors.push('rgba(249, 115, 22, 0.8)'); // Laranja
                        } else if (underStaffed === 4) {
                            backgroundColors.push('rgba(220, 38, 38, 0.8)'); // Vermelho escuro
                        } else { // underStaffed === 5
                            backgroundColors.push('rgba(239, 68, 68, 0.8)'); // Vermelho crítico
                        }
                    }
                    
                    const ctx = document.getElementById('chart-empty-teams');
                    
                    if (dashboardCharts.emptyTeams) {
                        dashboardCharts.emptyTeams.destroy();
                    }
                    
                    dashboardCharts.emptyTeams = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Times com Menos de 5',
                                data: underStaffedCount,
                                backgroundColor: backgroundColors,
                                borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        afterLabel: () => 'Clique para ver detalhes'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    min: 0,
                                    max: Math.min(9, labels.length - 1), // Mostrar apenas 10 barras por vez
                                },
                                y: {
                                    beginAtZero: true,
                                    suggestedMax: 5,
                                    ticks: {
                                        stepSize: 1,
                                        callback: function(value) {
                                            return Number.isInteger(value) ? value : '';
                                        }
                                    }
                                }
                            },
                            onClick: (event, activeElements) => {
                                if (activeElements.length > 0) {
                                    const index = activeElements[0].index;
                                    showChart4Popup(index);
                                }
                            },
                            interaction: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error('❌ Erro ao gerar gráfico de times vazios:', error);
                }
            }

            // Função para mostrar popup com detalhes do evento do gráfico 4
            function showChart4Popup(index) {
                const eventData = chart4EventDetails[index];
                if (!eventData) return;
                
                // Preencher título e data
                document.getElementById('chart4-popup-title').textContent = eventData.eventName || 'Evento';
                document.getElementById('chart4-popup-date').textContent = `📅 ${eventData.date}`;
                
                // Preencher times
                const teamsContainer = document.getElementById('chart4-popup-teams');
                teamsContainer.innerHTML = '';
                
                const teamEmojis = {
                    'Recepção': '👋',
                    'Backstage': '🤝',
                    'Estacionamento': '🚗',
                    'Kids': '👶',
                    'Comunicação': '📢'
                };
                
                Object.entries(eventData.teams).forEach(([teamName, count]) => {
                    const emoji = teamEmojis[teamName] || '👥';
                    let colorClass = '';
                    let statusText = '';
                    
                    if (count === 0) {
                        colorClass = 'bg-red-50 border-red-300';
                        statusText = 'text-red-700';
                    } else if (count >= 1 && count <= 2) {
                        colorClass = 'bg-orange-50 border-orange-300';
                        statusText = 'text-orange-700';
                    } else if (count >= 3 && count <= 4) {
                        colorClass = 'bg-yellow-50 border-yellow-300';
                        statusText = 'text-yellow-700';
                    } else {
                        colorClass = 'bg-green-50 border-green-300';
                        statusText = 'text-green-700';
                    }
                    
                    const teamDiv = document.createElement('div');
                    teamDiv.className = `flex items-center justify-between p-3 rounded-lg border-2 ${colorClass}`;
                    teamDiv.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${emoji}</span>
                            <span class="font-semibold text-gray-800">${teamName}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold ${statusText}">${count}</span>
                            <span class="text-xs text-gray-600 block">voluntário${count !== 1 ? 's' : ''}</span>
                        </div>
                    `;
                    teamsContainer.appendChild(teamDiv);
                });
                
                // Mostrar popup
                document.getElementById('chart4-popup-overlay').classList.remove('hidden');
            }
            
            // Event listeners do popup
            document.getElementById('chart4-popup-close').addEventListener('click', () => {
                document.getElementById('chart4-popup-overlay').classList.add('hidden');
            });
            
            document.getElementById('chart4-popup-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'chart4-popup-overlay') {
                    document.getElementById('chart4-popup-overlay').classList.add('hidden');
                }
            });

            // Função para mostrar popup com voluntários do evento (Gráfico 3)
            function showChart3Popup(index) {
                const eventData = window.chart3EventDetails[index];
                if (!eventData) return;
                
                // Formatar data
                const dateObj = new Date(eventData.date + 'T' + eventData.time);
                const formattedDate = dateObj.toLocaleDateString('pt-BR', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                // Calcular total de voluntários
                const totalVolunteers = Object.values(eventData.teams).reduce((sum, team) => sum + team.length, 0);
                
                // Preencher título e data
                document.getElementById('chart3-popup-title').textContent = eventData.eventName;
                document.getElementById('chart3-popup-date').textContent = `📅 ${formattedDate} às ${eventData.time}`;
                document.getElementById('chart3-popup-total').textContent = `👥 Total: ${totalVolunteers} voluntário${totalVolunteers !== 1 ? 's' : ''}`;
                
                // Preencher times
                const teamsContainer = document.getElementById('chart3-popup-teams');
                teamsContainer.innerHTML = '';
                
                const teamConfig = {
                    welcome: { name: 'Welcome', icon: '👋', color: 'bg-blue-50 border-blue-300' },
                    backstage: { name: 'Backstage', icon: '🤝', color: 'bg-gray-50 border-gray-300' },
                    parking: { name: 'Parking', icon: '🚗', color: 'bg-red-50 border-red-300' },
                    kids: { name: 'Kids', icon: '👶', color: 'bg-yellow-50 border-yellow-300' },
                    comunicacao: { name: 'Comunicação', icon: '📢', color: 'bg-purple-50 border-purple-300' }
                };
                
                Object.entries(eventData.teams).forEach(([teamKey, volunteers]) => {
                    if (volunteers.length === 0) return; // Pular times vazios
                    
                    const config = teamConfig[teamKey];
                    
                    // Ordenar voluntários por função (role) alfabeticamente
                    const sortedVolunteers = volunteers.sort((a, b) => {
                        const roleA = (a.role || '').toLowerCase();
                        const roleB = (b.role || '').toLowerCase();
                        return roleA.localeCompare(roleB, 'pt-BR');
                    });
                    
                    const teamDiv = document.createElement('div');
                    teamDiv.className = `border-2 rounded-lg p-3 ${config.color}`;
                    
                    const volunteersHtml = sortedVolunteers.map(v => `
                        <div class="flex items-center gap-2 py-1">
                            <img src="${v.photo || 'Zele logo.png'}" alt="${v.name}" class="w-8 h-8 rounded-full object-cover flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold text-gray-800 truncate">${v.name}</p>
                                <p class="text-xs text-gray-600 truncate">${v.email}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    teamDiv.innerHTML = `
                        <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-300">
                            <span class="text-2xl">${config.icon}</span>
                            <span class="font-bold text-gray-800">${config.name}</span>
                            <span class="ml-auto bg-white px-2 py-1 rounded-full text-xs font-bold text-gray-700">${volunteers.length}</span>
                        </div>
                        <div class="space-y-1">
                            ${volunteersHtml}
                        </div>
                    `;
                    
                    teamsContainer.appendChild(teamDiv);
                });
                
                // Mostrar popup
                document.getElementById('chart3-popup-overlay').classList.remove('hidden');
            }
            
            // Event listeners do popup do Gráfico 3
            document.getElementById('chart3-popup-close').addEventListener('click', () => {
                document.getElementById('chart3-popup-overlay').classList.add('hidden');
            });
            
            document.getElementById('chart3-popup-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'chart3-popup-overlay') {
                    document.getElementById('chart3-popup-overlay').classList.add('hidden');
                }
            });

            // Função para mostrar popup com voluntários únicos do time (Gráfico 1)
            function showChart1Popup(index) {
                const teams = ['welcome', 'backstage', 'parking', 'kids', 'comunicacao'];
                const teamNames = ['👋 Welcome', '🤝 Backstage', '🚗 Parking', '👶 Kids', '📢 Comunicação'];
                const teamColors = ['text-blue-600', 'text-gray-600', 'text-red-600', 'text-yellow-600', 'text-purple-600'];
                
                const teamKey = teams[index];
                const volunteers = window.chart1VolunteerDetails[teamKey] || [];
                
                // Preencher título
                document.getElementById('chart1-popup-title').textContent = teamNames[index];
                document.getElementById('chart1-popup-total').textContent = `👥 Total: ${volunteers.length} voluntário${volunteers.length !== 1 ? 's' : ''} único${volunteers.length !== 1 ? 's' : ''}`;
                
                // Preencher lista de voluntários
                const volunteersContainer = document.getElementById('chart1-popup-volunteers');
                
                if (volunteers.length === 0) {
                    volunteersContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum voluntário neste time.</p>';
                } else {
                    // Ordenar por nome
                    const sortedVolunteers = volunteers.sort((a, b) => a.name.localeCompare(b.name));
                    
                    volunteersContainer.innerHTML = sortedVolunteers.map(v => `
                        <div class="flex items-center gap-3 p-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                            <img src="${v.photo}" alt="${v.name}" class="w-10 h-10 rounded-full object-cover flex-shrink-0" onerror="this.src='Zele logo.png'">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold text-gray-800 truncate">${v.name}</p>
                                ${v.email ? `<p class="text-xs text-gray-600 truncate">${v.email}</p>` : ''}
                            </div>
                        </div>
                    `).join('');
                }
                
                // Mostrar popup
                document.getElementById('chart1-popup-overlay').classList.remove('hidden');
            }
            
            // Event listeners do popup do Gráfico 1
            document.getElementById('chart1-popup-close').addEventListener('click', () => {
                document.getElementById('chart1-popup-overlay').classList.add('hidden');
            });
            
            document.getElementById('chart1-popup-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'chart1-popup-overlay') {
                    document.getElementById('chart1-popup-overlay').classList.add('hidden');
                }
            });

            // Função para mostrar popup de presença/ausência (Gráfico 5)
            function showChart5Popup(teamIndex, status) {
                const teams = ['welcome', 'backstage', 'parking', 'kids', 'comunicacao'];
                const teamNames = ['👋 Welcome', '🤝 Backstage', '🚗 Parking', '👶 Kids', '📢 Comunicação'];
                
                const teamKey = teams[teamIndex];
                const volunteers = window.chart5AttendanceDetails[teamKey]?.[status] || [];
                
                const statusLabel = status === 'present' ? '✅ Presentes' : '❌ Ausentes';
                const statusColor = status === 'present' ? 'text-green-600' : 'text-red-600';
                
                // Preencher título
                document.getElementById('chart5-popup-title').textContent = teamNames[teamIndex];
                document.getElementById('chart5-popup-subtitle').innerHTML = `<span class="${statusColor}">${statusLabel}</span> - ${volunteers.length} voluntário${volunteers.length !== 1 ? 's' : ''}`;
                
                // Preencher lista
                const listContainer = document.getElementById('chart5-popup-list');
                
                if (volunteers.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Nenhum registro encontrado.</p>';
                } else {
                    // Ordenar por data (mais recente primeiro) e depois por nome
                    const sortedVolunteers = volunteers.sort((a, b) => {
                        const dateCompare = b.date.localeCompare(a.date);
                        if (dateCompare !== 0) return dateCompare;
                        return a.name.localeCompare(b.name);
                    });
                    
                    listContainer.innerHTML = sortedVolunteers.map(v => {
                        const dateObj = new Date(v.date + 'T00:00:00');
                        const formattedDate = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        const checkedDate = v.checkedAt ? new Date(v.checkedAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
                        
                        return `
                            <div class="bg-white border border-gray-200 rounded-lg p-3">
                                <div class="flex items-start gap-3 mb-2">
                                    <img src="${v.photo}" alt="${v.name}" class="w-10 h-10 rounded-full object-cover flex-shrink-0" onerror="this.src='Zele logo.png'">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-gray-800 truncate">${v.name}</p>
                                        <p class="text-xs text-gray-600">📅 ${formattedDate} - ${v.time}</p>
                                        <p class="text-xs text-gray-500 truncate">${v.eventName}</p>
                                    </div>
                                </div>
                                ${checkedDate ? `<p class="text-xs text-gray-400 mt-1">Registrado por ${v.checkedBy} em ${checkedDate}</p>` : ''}
                            </div>
                        `;
                    }).join('');
                }
                
                // Mostrar popup
                document.getElementById('chart5-popup-overlay').classList.remove('hidden');
            }
            
            // Event listeners do popup do Gráfico 5
            document.getElementById('chart5-popup-close').addEventListener('click', () => {
                document.getElementById('chart5-popup-overlay').classList.add('hidden');
            });
            
            document.getElementById('chart5-popup-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'chart5-popup-overlay') {
                    document.getElementById('chart5-popup-overlay').classList.add('hidden');
                }
            });

            // Função para configurar navegação dos gráficos
            function setupChartNavigation() {
                // Navegação do Gráfico 3 (Quantidade de Voluntários por Dia)
                const chart3PrevBtn = document.getElementById('chart3-prev');
                const chart3NextBtn = document.getElementById('chart3-next');
                
                if (chart3PrevBtn && chart3NextBtn && dashboardCharts.events) {
                    const chart3 = dashboardCharts.events;
                    const totalLabels3 = chart3.data.labels.length;
                    
                    chart3PrevBtn.addEventListener('click', () => {
                        const currentMin = chart3.options.scales.x.min || 0;
                        if (currentMin > 0) {
                            chart3.options.scales.x.min = Math.max(0, currentMin - 5);
                            chart3.options.scales.x.max = Math.max(9, currentMin + 4);
                            chart3.update();
                        }
                    });
                    
                    chart3NextBtn.addEventListener('click', () => {
                        const currentMax = chart3.options.scales.x.max || 9;
                        if (currentMax < totalLabels3 - 1) {
                            chart3.options.scales.x.max = Math.min(totalLabels3 - 1, currentMax + 5);
                            chart3.options.scales.x.min = Math.max(0, currentMax - 4);
                            chart3.update();
                        }
                    });
                }
                
                // Navegação do Gráfico 4 (Times com Menos de 5 Voluntários)
                const chart4PrevBtn = document.getElementById('chart4-prev');
                const chart4NextBtn = document.getElementById('chart4-next');
                
                if (chart4PrevBtn && chart4NextBtn && dashboardCharts.emptyTeams) {
                    const chart4 = dashboardCharts.emptyTeams;
                    const totalLabels4 = chart4.data.labels.length;
                    
                    chart4PrevBtn.addEventListener('click', () => {
                        const currentMin = chart4.options.scales.x.min || 0;
                        if (currentMin > 0) {
                            chart4.options.scales.x.min = Math.max(0, currentMin - 5);
                            chart4.options.scales.x.max = Math.max(9, currentMin + 4);
                            chart4.update();
                        }
                    });
                    
                    chart4NextBtn.addEventListener('click', () => {
                        const currentMax = chart4.options.scales.x.max || 9;
                        if (currentMax < totalLabels4 - 1) {
                            chart4.options.scales.x.max = Math.min(totalLabels4 - 1, currentMax + 5);
                            chart4.options.scales.x.min = Math.max(0, currentMax - 4);
                            chart4.update();
                        }
                    });
                }
            }

            // Gráfico 5: Presença vs Ausência por Time
            // Armazenar detalhes de presença para o popup do Chart 5
            window.chart5AttendanceDetails = {};

            // Gráfico 6: Ranking de Voluntários - Check-in vs Ausência
            async function generateChart6_CheckinRanking(escalas) {
                console.log('📊 Chart 6 - Total de escalas recebidas:', escalas.length);
                
                // Filtrar escalas com check-in primeiro
                const escalasWithCheckin = escalas.filter(e => e.checkIn && (e.checkIn.status === 'present' || e.checkIn.status === 'absent'));
                console.log('📊 Chart 6 - Escalas com check-in:', escalasWithCheckin.length);
                console.log('📊 Chart 6 - Eventos com check-in:', escalasWithCheckin.map(e => ({
                    userName: e.userName,
                    date: e.date,
                    time: e.time,
                    status: e.checkIn?.status
                })));
                
                // Contar check-ins por voluntário
                const volunteerCheckins = {};
                
                escalas.forEach(escala => {
                    const name = escala.userName || 'Desconhecido';
                    const checkinStatus = escala.checkIn?.status;
                    
                    if (!volunteerCheckins[name]) {
                        volunteerCheckins[name] = {
                            present: 0,
                            absent: 0,
                            total: 0
                        };
                    }
                    
                    if (checkinStatus === 'present') {
                        volunteerCheckins[name].present++;
                        volunteerCheckins[name].total++;
                    } else if (checkinStatus === 'absent') {
                        volunteerCheckins[name].absent++;
                        volunteerCheckins[name].total++;
                    }
                });
                
                // Filtrar apenas voluntários com check-ins e ordenar por total
                const totalVolunteersWithCheckin = Object.entries(volunteerCheckins).filter(item => item[1].total > 0).length;
                console.log('📊 Chart 6 - Voluntários com check-in:', totalVolunteersWithCheckin);
                
                const sorted = Object.entries(volunteerCheckins)
                    .filter(item => item[1].total > 0)
                    .sort((a, b) => b[1].total - a[1].total)
                    .slice(0, 10);
                    
                console.log('📊 Chart 6 - Top 10:', sorted.map(v => `${v[0]}: ${v[1].present} presentes, ${v[1].absent} ausentes`));
                
                const labels = sorted.map(item => item[0]);
                const presentData = sorted.map(item => item[1].present);
                const absentData = sorted.map(item => item[1].absent);
                
                const ctx = document.getElementById('chart-checkin-ranking');
                
                if (dashboardCharts.checkinRanking) {
                    dashboardCharts.checkinRanking.destroy();
                }
                
                dashboardCharts.checkinRanking = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '✅ Presença',
                                data: presentData,
                                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 1
                            },
                            {
                                label: '❌ Ausência',
                                data: absentData,
                                backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 15,
                                    padding: 10,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.x;
                                        return value > 0 ? `${label}: ${value}` : null;
                                    },
                                    footer: function(tooltipItems) {
                                        let total = 0;
                                        tooltipItems.forEach(item => {
                                            total += item.parsed.x;
                                        });
                                        return 'Total: ' + total;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y: {
                                stacked: true,
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    autoSkip: false
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                console.log('📊 Chart 6 - Ranking de Check-in gerado!');
            }

            async function generateChart5_CheckinAttendance(escalas) {
                try {
                    // Filtrar apenas escalas com check-in registrado
                    const escalasWithCheckin = escalas.filter(escala => 
                        escala.checkIn && (escala.checkIn.status === 'present' || escala.checkIn.status === 'absent')
                    );
                    
                    console.log('📊 Chart 5 - Total de escalas:', escalas.length);
                    console.log('📊 Chart 5 - Escalas com check-in:', escalasWithCheckin.length);
                    console.log('📊 Chart 5 - Detalhes:', escalasWithCheckin.map(e => ({
                        userName: e.userName,
                        date: e.date,
                        time: e.time,
                        team: e.team,
                        status: e.checkIn?.status
                    })));
                    
                    // Agregar por time e armazenar detalhes
                    const teamStats = {
                        welcome: { present: 0, absent: 0 },
                        backstage: { present: 0, absent: 0 },
                        parking: { present: 0, absent: 0 },
                        kids: { present: 0, absent: 0 },
                        comunicacao: { present: 0, absent: 0 }
                    };
                    
                    const teamDetails = {
                        welcome: { present: [], absent: [] },
                        backstage: { present: [], absent: [] },
                        parking: { present: [], absent: [] },
                        kids: { present: [], absent: [] },
                        comunicacao: { present: [], absent: [] }
                    };
                    
                    escalasWithCheckin.forEach(escala => {
                        const team = escala.team?.toLowerCase();
                        if (teamStats.hasOwnProperty(team)) {
                            const status = escala.checkIn.status;
                            const volunteerData = {
                                name: escala.userName || 'Sem nome',
                                photo: escala.userPhoto || 'Zele logo.png',
                                date: escala.date,
                                time: escala.time,
                                eventName: escala.eventName || 'Evento',
                                checkedBy: escala.checkIn.checkedByName || 'Sistema',
                                checkedAt: escala.checkIn.checkedAt
                            };
                            
                            if (status === 'present') {
                                teamStats[team].present++;
                                teamDetails[team].present.push(volunteerData);
                            } else if (status === 'absent') {
                                teamStats[team].absent++;
                                teamDetails[team].absent.push(volunteerData);
                            }
                        }
                    });
                    
                    // Armazenar detalhes para o popup
                    window.chart5AttendanceDetails = teamDetails;
                    
                    const ctx = document.getElementById('chart-attendance');
                    
                    // Destruir gráfico anterior se existir
                    if (dashboardCharts.attendance) {
                        dashboardCharts.attendance.destroy();
                    }
                    
                    dashboardCharts.attendance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['👋 Welcome', '🤝 Backstage', '🚗 Parking', '👶 Kids', '📢 Comunicação'],
                            datasets: [
                                {
                                    label: 'Presentes',
                                    data: [
                                        teamStats.welcome.present,
                                        teamStats.backstage.present,
                                        teamStats.parking.present,
                                        teamStats.kids.present,
                                        teamStats.comunicacao.present
                                    ],
                                    backgroundColor: 'rgba(34, 197, 94, 0.7)', // Verde
                                    borderColor: 'rgba(34, 197, 94, 1)',
                                    borderWidth: 2
                                },
                                {
                                    label: 'Ausentes',
                                    data: [
                                        teamStats.welcome.absent,
                                        teamStats.backstage.absent,
                                        teamStats.parking.absent,
                                        teamStats.kids.absent,
                                        teamStats.comunicacao.absent
                                    ],
                                    backgroundColor: 'rgba(239, 68, 68, 0.7)', // Vermelho
                                    borderColor: 'rgba(239, 68, 68, 1)',
                                    borderWidth: 2
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.dataset.label || '';
                                            const value = context.parsed.y;
                                            const teamIndex = context.dataIndex;
                                            const teamNames = ['welcome', 'backstage', 'parking', 'kids', 'comunicacao'];
                                            const team = teamNames[teamIndex];
                                            const total = teamStats[team].present + teamStats[team].absent;
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    stacked: false
                                },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            onClick: (event, activeElements) => {
                                if (activeElements.length > 0) {
                                    const teamIndex = activeElements[0].index;
                                    const datasetIndex = activeElements[0].datasetIndex;
                                    const status = datasetIndex === 0 ? 'present' : 'absent';
                                    showChart5Popup(teamIndex, status);
                                }
                            },
                            interaction: {
                                mode: 'nearest',
                                intersect: true
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error('❌ Erro ao gerar gráfico de presença:', error);
                }
            }

            // ===== GERENCIAMENTO DE FUNÇÕES POR TIME =====

            let teamRolesData = {};
            const TEAM_COLORS = {
                welcome: { bg: 'bg-blue-50', border: 'border-[#377db8]', text: 'text-blue-700', icon: '👋' },
                backstage: { bg: 'bg-gray-50', border: 'border-[#0a0e1a]', text: 'text-gray-700', icon: '🤝' },
                parking: { bg: 'bg-red-50', border: 'border-red-500', text: 'text-red-700', icon: '🚗' },
                kids: { bg: 'bg-yellow-50', border: 'border-yellow-500', text: 'text-yellow-700', icon: '👶' },
                comunicacao: { bg: 'bg-purple-50', border: 'border-purple-500', text: 'text-purple-700', icon: '📢' }
            };

            // Carregar configurações de funções do Firestore
            async function loadTeamRoles() {
                try {
                    const { doc, getDoc } = window.firestoreMethods;
                    const configRef = doc(window.firebaseDb, 'config', 'teamRoles');
                    const configSnap = await getDoc(configRef);
                    
                    if (configSnap.exists()) {
                        teamRolesData = configSnap.data().roles || {};
                    } else {
                        // Estrutura inicial vazia
                        teamRolesData = {
                            welcome: [],
                            backstage: [],
                            parking: [],
                            kids: [],
                            comunicacao: []
                        };
                    }
                    
                    console.log('✅ Funções carregadas:', teamRolesData);
                } catch (error) {
                    console.error('❌ Erro ao carregar funções:', error);
                    showModal('❌ Erro ao carregar funções. Tente novamente.');
                }
            }

            // Salvar configurações de funções no Firestore
            async function saveTeamRoles() {
                try {
                    const { doc, setDoc } = window.firestoreMethods;
                    const configRef = doc(window.firebaseDb, 'config', 'teamRoles');
                    
                    await setDoc(configRef, {
                        roles: teamRolesData,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser.email
                    });
                    
                    console.log('✅ Funções salvas com sucesso');
                } catch (error) {
                    console.error('❌ Erro ao salvar funções:', error);
                    showModal('❌ Erro ao salvar funções. Tente novamente.');
                }
            }

            // Renderizar lista de funções do time selecionado
            function renderRolesList(team) {
                console.log('🎨 renderRolesList chamada para o time:', team);
                const rolesList = document.getElementById('roles-list');
                
                if (!rolesList) {
                    console.error('❌ Elemento roles-list não encontrado!');
                    return;
                }
                
                const roles = teamRolesData[team] || [];
                const colors = TEAM_COLORS[team];
                
                console.log('📋 Funções do time:', roles);
                console.log('🎨 Cores do time:', colors);
                
                if (roles.length === 0) {
                    rolesList.innerHTML = `
                        <div class="text-center py-6 text-gray-500">
                            <p>Nenhuma função cadastrada ainda.</p>
                            <p class="text-sm mt-1">Use o campo acima para adicionar.</p>
                        </div>
                    `;
                    return;
                }
                
                rolesList.innerHTML = roles.map(role => `
                    <div class="flex items-center justify-between p-3 ${colors.bg} border-l-4 ${colors.border} rounded">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${colors.icon}</span>
                            <span class="font-medium ${colors.text}">${role}</span>
                        </div>
                        <button 
                            onclick="deleteRole('${team}', '${role.replace(/'/g, "\\'")}')" 
                            class="text-red-600 hover:text-red-800 transition p-2"
                            title="Excluir função"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                `).join('');
                
                console.log('✅ Lista renderizada com sucesso');
            }

            // Adicionar nova função
            async function addRole(team) {
                const input = document.getElementById('new-role-input');
                const roleName = input.value.trim();
                
                if (!roleName) {
                    showModal('⚠️ Por favor, digite o nome da função.');
                    return;
                }
                
                // Verificar se já existe
                if (teamRolesData[team].includes(roleName)) {
                    showModal('⚠️ Esta função já existe neste time.');
                    return;
                }
                
                // Adicionar ao array
                teamRolesData[team].push(roleName);
                
                // Salvar no Firestore
                await saveTeamRoles();
                
                // Atualizar UI
                renderRolesList(team);
                input.value = '';
                
                showModal(`✅ Função "${roleName}" adicionada com sucesso!`);
            }

            // Deletar função
            window.deleteRole = async function(team, roleName) {
                showModal(
                    `Tem certeza que deseja excluir a função "${roleName}"?`,
                    true,
                    async () => {
                        try {
                            // Remover do array
                            teamRolesData[team] = teamRolesData[team].filter(r => r !== roleName);
                            
                            // Salvar no Firestore
                            await saveTeamRoles();
                            
                            // Atualizar UI
                            renderRolesList(team);
                            
                            showModal(`✅ Função "${roleName}" excluída com sucesso!`);
                        } catch (error) {
                            console.error('❌ Erro ao excluir função:', error);
                            showModal('❌ Erro ao excluir função. Tente novamente.');
                        }
                    }
                );
            };

            // Event listeners para o modal de funções
            const rolesTeamSelect = document.getElementById('roles-team-select');
            const addRoleBtn = document.getElementById('add-role-btn');
            const newRoleInput = document.getElementById('new-role-input');
            const addRoleSection = document.getElementById('add-role-section');
            const rolesListSection = document.getElementById('roles-list-section');
            const noTeamSelectedMsg = document.getElementById('no-team-selected-msg');

            if (rolesTeamSelect) {
                rolesTeamSelect.addEventListener('change', (e) => {
                    const team = e.target.value;
                    console.log('🔄 Time selecionado:', team);
                    
                    if (team) {
                        console.log('✅ Mostrando seções de gerenciamento');
                        // Mostrar seções relevantes
                        addRoleSection.classList.remove('hidden');
                        rolesListSection.classList.remove('hidden');
                        noTeamSelectedMsg.classList.add('hidden');
                        
                        console.log('📋 Renderizando funções do time:', team);
                        // Renderizar funções do time
                        renderRolesList(team);
                        
                        // Limpar input
                        if (newRoleInput) newRoleInput.value = '';
                    } else {
                        console.log('❌ Ocultando seções de gerenciamento');
                        // Ocultar seções
                        addRoleSection.classList.add('hidden');
                        rolesListSection.classList.add('hidden');
                        noTeamSelectedMsg.classList.remove('hidden');
                    }
                });
            } else {
                console.error('❌ rolesTeamSelect não encontrado!');
            }

            if (addRoleBtn) {
                addRoleBtn.addEventListener('click', () => {
                    const team = rolesTeamSelect.value;
                    if (team) {
                        addRole(team);
                    }
                });
            }

            // Permitir adicionar com Enter
            if (newRoleInput) {
                newRoleInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const team = rolesTeamSelect.value;
                        if (team) {
                            addRole(team);
                        }
                    }
                });
            }

            // ===== GERENCIAMENTO DE ADMINISTRADORES =====

            // Carregar lista de todos os usuários (apenas superadmin)
            async function loadUsersList() {
                console.log('🔍 loadUsersList chamada');
                console.log('🔍 isSuperAdmin:', isSuperAdmin);
                console.log('🔍 currentUser:', currentUser?.email, currentUser?.uid);
                
                // Verificar se é super admin
                if (!isSuperAdmin) {
                    console.log('❌ Usuário não é super admin');
                    document.getElementById('users-list').innerHTML = 
                        '<p class="text-center text-red-500 py-8">⚠️ Acesso negado. Apenas Super Administradores podem gerenciar usuários.</p>';
                    return;
                }
                
                // VERIFICAÇÃO CRÍTICA: Garantir que o usuário está autenticado
                const auth = window.firebaseAuth;
                const currentAuthUser = auth.currentUser;
                
                if (!currentAuthUser) {
                    console.error('❌ ERRO: Nenhum usuário autenticado no Firebase Auth!');
                    document.getElementById('users-list').innerHTML = 
                        '<p class="text-center text-red-500 py-8">❌ Erro: Usuário não autenticado. Faça logout e login novamente.</p>';
                    return;
                }
                
                console.log('✅ Firebase Auth - Usuário autenticado:', currentAuthUser.email, currentAuthUser.uid);
                
                try {
                    const { collection, getDocs, query, orderBy } = window.firestoreMethods;
                    const usersList = document.getElementById('users-list');
                    
                    console.log('📋 Iniciando busca de usuários no Firestore...');
                    console.log('🔍 Firestore DB:', window.firebaseDb);
                    console.log('🔍 Firestore projectId:', window.firebaseDb._databaseId?.projectId);
                    
                    // Mostrar loading
                    usersList.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 mx-auto"></div><p class="text-gray-600 mt-4">Carregando usuários...</p></div>';
                    
                    // TENTATIVA 1: Buscar com query ordenada
                    console.log('🔍 Tentativa 1: Buscando com query ordenada...');
                    const usersRef = collection(window.firebaseDb, 'users');
                    const q = query(usersRef, orderBy('email', 'asc'));
                    
                    console.log('🔍 Query criada. Executando getDocs...');
                    const usersSnapshot = await getDocs(q);
                    console.log('✅ getDocs completado. Documentos encontrados:', usersSnapshot.size);
                    
                    if (usersSnapshot.empty) {
                        usersList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum usuário encontrado no sistema.</p>';
                        return;
                    }
                    
                    const users = [];
                    usersSnapshot.forEach(doc => {
                        const data = doc.data();
                        console.log(`📋 Usuário ${data.email}: teamLeader =`, data.teamLeader);
                        users.push({
                            id: doc.id,
                            email: data.email || 'Sem email',
                            displayName: data.displayName || data.email?.split('@')[0] || 'Sem nome',
                            photoURL: data.photoURL || '',
                            role: data.role || 'user',
                            blocked: data.blocked || false,
                            teamLeader: data.teamLeader || [],
                            lastLoginFormatted: data.lastLoginFormatted || 'Nunca acessou',
                            createdAt: data.createdAt || ''
                        });
                    });
                    
                    // Ordenar por role (superadmin > admin > user) e depois por nome
                    users.sort((a, b) => {
                        const roleOrder = { superadmin: 0, admin: 1, user: 2 };
                        const roleCompare = roleOrder[a.role] - roleOrder[b.role];
                        if (roleCompare !== 0) return roleCompare;
                        
                        const nameA = a.displayName || a.email || '';
                        const nameB = b.displayName || b.email || '';
                        return nameA.localeCompare(nameB);
                    });
                    
                    let html = '';
                    users.forEach(user => {
                                const isUserSuperAdmin = user.role === 'superadmin';
                                const isUserAdmin = user.role === 'admin';
                                const isCurrentUser = user.id === currentUser.uid;
                                const displayName = user.displayName || 'Sem nome';
                                const email = user.email || 'Sem email';
                                const photoURL = user.photoURL || 'Zele logo.png';
                                const isBlocked = user.blocked === true;
                                const lastLogin = user.lastLoginFormatted || 'Nunca acessou';
                                const teamLeader = user.teamLeader || [];
                                
                                // Badge visual
                                let roleBadge = '';
                                if (isUserSuperAdmin) {
                                    roleBadge = '<span class="text-purple-600" title="Super Administrador">👑👑</span>';
                                } else if (isUserAdmin) {
                                    roleBadge = '<span class="text-yellow-600" title="Administrador">👑</span>';
                                }
                                
                                // Badge de líder de time
                                let leaderBadge = '';
                                if (teamLeader.length > 0) {
                                    const teamEmojis = {
                                        welcome: '👋',
                                        backstage: '🤝',
                                        parking: '🚗',
                                        kids: '👶'
                                    };
                                    const leaderEmojis = teamLeader.map(t => teamEmojis[t] || '').join('');
                                    leaderBadge = `<span class="text-sm" title="Líder de: ${teamLeader.join(', ')}">${leaderEmojis}</span>`;
                                }                                html += `
                            <div class="border-l-4 ${isBlocked ? 'border-red-500 bg-red-50' : (isUserSuperAdmin ? 'border-purple-500 bg-purple-50' : (isUserAdmin ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300 bg-gray-50'))} rounded-lg p-3 mb-3">
                                <!-- LINHA 1: Foto + Nome/Email -->
                                <div class="flex items-center gap-3 mb-3">
                                    <img src="${photoURL}" alt="${displayName}" class="w-14 h-14 rounded-full object-cover flex-shrink-0 ${isBlocked ? 'opacity-50 grayscale' : ''}">
                                    
                                    <div class="flex-1 min-w-0">
                                        <p class="font-bold text-gray-800 text-sm leading-tight mb-1">
                                            ${displayName}
                                            ${roleBadge}
                                            ${leaderBadge}
                                            ${isBlocked ? '<span class="text-red-600">🚫</span>' : ''}
                                            ${isCurrentUser ? '<span class="text-xs text-gray-500">(você)</span>' : ''}
                                        </p>
                                        <p class="text-xs text-gray-600 break-all">${email}</p>
                                    </div>
                                </div>                                <!-- LINHA 2: Informações detalhadas -->
                                <div class="mb-3 space-y-1">
                                    <p class="text-xs text-gray-500">
                                        <strong>ID:</strong> <code class="bg-gray-200 px-1 rounded text-xs break-all">${user.id}</code>
                                    </p>
                                    <p class="text-xs text-gray-600">
                                        <strong>🕐 Último acesso:</strong><br>
                                        <span class="ml-4">${lastLogin}</span>
                                    </p>
                                    ${isUserSuperAdmin ? '<p class="text-xs text-purple-600 font-bold">👑 Super Administrador</p>' : ''}
                                    ${isUserAdmin && !isUserSuperAdmin ? '<p class="text-xs text-yellow-600 font-bold">👑 Administrador</p>' : ''}
                                    ${isBlocked ? '<p class="text-xs text-red-600 font-bold">⚠️ Usuário bloqueado</p>' : ''}
                                    ${teamLeader.length > 0 ? `<p class="text-xs text-blue-600 font-bold">🏆 Líder de: ${teamLeader.map(t => {
                                        const names = { welcome: 'Welcome', backstage: 'Backstage', parking: 'Parking', kids: 'Kids', comunicacao: 'Comunicação' };
                                        return names[t];
                                    }).join(', ')}</p>` : ''}
                                </div>
                                
                                <!-- LINHA 3: Botões de Ação -->
                                ${!isCurrentUser ? `
                                    <div class="space-y-2">
                                        <!-- Gerenciar Liderança de Times (apenas superadmin) -->
                                        <button 
                                            class="manage-team-leader-btn w-full px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600"
                                            data-user-id="${user.id}"
                                            data-user-name="${displayName}"
                                            data-team-leader='${JSON.stringify(teamLeader)}'
                                            title="Gerenciar liderança de times">
                                            🏆 ${teamLeader.length > 0 ? 'Editar' : 'Definir'} Liderança de Times
                                        </button>
                                        
                                        <div class="grid grid-cols-2 gap-2">
                                        <!-- Promover/Rebaixar Admin/SuperAdmin -->
                                        ${isUserSuperAdmin ? `
                                            <button 
                                                class="toggle-admin-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-purple-600 hover:bg-purple-700 col-span-2"
                                                data-user-id="${user.id}"
                                                data-user-name="${displayName}"
                                                data-current-role="superadmin"
                                                title="Rebaixar para Administrador">
                                                👑👑 → 👑 Rebaixar
                                            </button>
                                        ` : isUserAdmin ? `
                                            <button 
                                                class="toggle-admin-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-yellow-600 hover:bg-yellow-700 col-span-2"
                                                data-user-id="${user.id}"
                                                data-user-name="${displayName}"
                                                data-current-role="admin"
                                                title="Promover para Super Admin ou Remover Admin">
                                                👑 Gerenciar Permissões
                                            </button>
                                        ` : `
                                            <button 
                                                class="toggle-admin-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-green-500 hover:bg-green-600 col-span-2"
                                                data-user-id="${user.id}"
                                                data-user-name="${displayName}"
                                                data-current-role="user"
                                                title="Tornar Administrador">
                                                👑 Tornar Admin
                                            </button>
                                        `}
                                        
                                        <!-- Bloquear/Desbloquear -->
                                        <button 
                                            class="toggle-block-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition ${isBlocked ? 'bg-blue-500 hover:bg-blue-600' : 'bg-red-500 hover:bg-red-600'} ${isBlocked ? '' : 'col-span-2'}"
                                            data-user-id="${user.id}"
                                            data-user-name="${displayName}"
                                            data-is-blocked="${isBlocked}"
                                            data-user-role="${user.role}"
                                            title="${isBlocked ? 'Desbloquear acesso' : 'Bloquear acesso'}">
                                            ${isBlocked ? '🔓 Desbloquear' : '🔒 Bloquear'}
                                        </button>
                                        
                                        <!-- Excluir (só se bloqueado) -->
                                        ${isBlocked ? `
                                            <button 
                                                class="delete-user-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-red-700 hover:bg-red-800"
                                                data-user-id="${user.id}"
                                                data-user-name="${displayName}"
                                                title="Excluir usuário permanentemente">
                                                🗑️ Excluir
                                            </button>
                                        ` : ''}
                                        </div>
                                    </div>
                                ` : '<p class="text-xs text-gray-500 text-center py-2 bg-gray-100 rounded">Você não pode alterar seu próprio status</p>'}
                            </div>
                        `;
                    });
                    
                    usersList.innerHTML = html;
                    
                    // Adicionar event listeners aos botões
                    document.querySelectorAll('.toggle-admin-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            const userName = e.currentTarget.dataset.userName;
                            const currentRole = e.currentTarget.dataset.currentRole;
                            manageAdminRole(userId, userName, currentRole);
                        });
                    });
                    
                    document.querySelectorAll('.toggle-block-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            const userName = e.currentTarget.dataset.userName;
                            const isCurrentlyBlocked = e.currentTarget.dataset.isBlocked === 'true';
                            const userRole = e.currentTarget.dataset.userRole;
                            toggleBlockUser(userId, userName, isCurrentlyBlocked, userRole);
                        });
                    });
                    
                    document.querySelectorAll('.delete-user-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            const userName = e.currentTarget.dataset.userName;
                            deleteUser(userId, userName);
                        });
                    });
                    
                    document.querySelectorAll('.manage-team-leader-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            const userName = e.currentTarget.dataset.userName;
                            const teamLeader = JSON.parse(e.currentTarget.dataset.teamLeader || '[]');
                            openTeamLeaderModal(userId, userName, teamLeader);
                        });
                    });
                    
                } catch (error) {
                    console.error('❌ Erro ao carregar usuários:', error);
                    console.error('❌ Tipo de erro:', error.constructor.name);
                    console.error('❌ Código de erro:', error.code);
                    console.error('❌ Mensagem completa:', error.message);
                    console.error('❌ Stack trace:', error.stack);
                    
                    // Tentar ler o próprio documento do usuário para testar permissões
                    console.log('🔍 Testando leitura do próprio documento do usuário...');
                    try {
                        const { doc, getDoc } = window.firestoreMethods;
                        const userDocRef = doc(window.firebaseDb, 'users', currentUser.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        
                        if (userDocSnap.exists()) {
                            console.log('✅ Consegui ler MEU próprio documento!');
                            console.log('📄 Dados do meu documento:', userDocSnap.data());
                        } else {
                            console.error('❌ Meu próprio documento não existe!');
                        }
                    } catch (testError) {
                        console.error('❌ Erro ao tentar ler meu próprio documento:', testError);
                    }
                    
                    document.getElementById('users-list').innerHTML = 
                        `<div class="text-center text-red-500 py-8">
                            <p class="font-bold mb-2">❌ Erro ao carregar usuários</p>
                            <p class="text-sm mb-2">Código: ${error.code || 'desconhecido'}</p>
                            <p class="text-xs text-gray-600">${error.message}</p>
                            <button onclick="loadUsersList()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                🔄 Tentar novamente
                            </button>
                        </div>`;
                }
            }

            // Gerenciar role de administrador (superadmin pode promover/rebaixar)
            async function manageAdminRole(userId, userName, currentRole) {
                if (!isSuperAdmin) {
                    showModal('❌ Apenas Super Administradores podem gerenciar permissões.', false, null, true);
                    return;
                }
                
                let newRole = '';
                let message = '';
                
                if (currentRole === 'superadmin') {
                    // Rebaixar de superadmin para admin
                    newRole = 'admin';
                    message = `Tem certeza que deseja <strong>rebaixar</strong> de Super Admin para Admin:<br><br><strong>${userName}</strong>?<br><br>Ele perderá acesso ao gerenciamento de usuários.`;
                } else if (currentRole === 'admin') {
                    // Escolher entre promover para superadmin ou rebaixar para user
                    const action = await new Promise(resolve => {
                        showModal(
                            `Escolha a ação para <strong>${userName}</strong>:`,
                            false,
                            null,
                            false,
                            null,
                            '👑'
                        );
                        // Customizar botões do modal
                        document.getElementById('modal-buttons').innerHTML = `
                            <button id="promote-superadmin-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition">
                                👑👑 Promover para Super Admin
                            </button>
                            <button id="demote-user-btn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                ❌ Remover Admin
                            </button>
                            <button id="cancel-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">
                                Cancelar
                            </button>
                        `;
                        
                        document.getElementById('promote-superadmin-btn').addEventListener('click', () => {
                            closeModal();
                            resolve('superadmin');
                        });
                        
                        document.getElementById('demote-user-btn').addEventListener('click', () => {
                            closeModal();
                            resolve('user');
                        });
                        
                        document.getElementById('cancel-btn').addEventListener('click', () => {
                            closeModal();
                            resolve(null);
                        });
                    });
                    
                    if (!action) return;
                    
                    newRole = action;
                    if (action === 'superadmin') {
                        message = `Tem certeza que deseja <strong>promover</strong> para Super Admin:<br><br><strong>${userName}</strong>?<br><br>Ele terá controle total sobre o sistema.`;
                    } else {
                        message = `Tem certeza que deseja <strong>remover permissões de admin</strong> de:<br><br><strong>${userName}</strong>?`;
                    }
                } else {
                    // Promover de user para admin
                    newRole = 'admin';
                    message = `Tem certeza que deseja <strong>tornar administrador</strong>:<br><br><strong>${userName}</strong>?<br><br>Ele poderá gerenciar datas e escalas.`;
                }
                
                const confirmation = await new Promise(resolve => {
                    showModal(
                        message,
                        true,
                        () => resolve(true),
                        true,
                        () => resolve(false)
                    );
                });
                
                if (!confirmation) return;
                
                try {
                    const { doc, setDoc, getDoc } = window.firestoreMethods;
                    
                    // Buscar dados atuais do usuário
                    const userDocRef = doc(window.firebaseDb, 'users', userId);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        await setDoc(userDocRef, {
                            ...userDoc.data(),
                            role: newRole
                        });
                    } else {
                        await setDoc(userDocRef, {
                            role: newRole,
                            displayName: userName,
                            email: userName,
                            blocked: false,
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    const roleNames = {
                        superadmin: 'Super Administrador',
                        admin: 'Administrador',
                        user: 'Usuário comum'
                    };
                    
                    showModal(`✅ ${userName} agora é: <strong>${roleNames[newRole]}</strong>`);
                    
                    // Recarregar lista
                    await loadUsersList();
                    
                } catch (error) {
                    console.error('❌ Erro ao alterar role:', error);
                    showModal('❌ Erro ao alterar permissões. Tente novamente.');
                }
            }
            
            // Alternar bloqueio de usuário
            async function toggleBlockUser(userId, userName, isCurrentlyBlocked, userRole) {
                if (!isSuperAdmin) {
                    showModal('❌ Apenas Super Administradores podem bloquear/desbloquear usuários.', false, null, true);
                    return;
                }
                
                const action = isCurrentlyBlocked ? 'desbloquear' : 'bloquear';
                const confirmation = await new Promise(resolve => {
                    showModal(
                        `Tem certeza que deseja ${action} o acesso de:<br><br><strong>${userName}</strong>?${!isCurrentlyBlocked ? '<br><br>⚠️ O usuário não conseguirá mais acessar o app até ser desbloqueado.' : ''}`,
                        true,
                        () => resolve(true),
                        true,
                        () => resolve(false)
                    );
                });
                
                if (!confirmation) return;
                
                try {
                    const { doc, setDoc, getDoc } = window.firestoreMethods;
                    const newBlockedStatus = !isCurrentlyBlocked;
                    
                    // Buscar dados atuais do usuário
                    const userDocRef = doc(window.firebaseDb, 'users', userId);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        // Atualizar apenas o campo blocked
                        await setDoc(userDocRef, {
                            ...userDoc.data(),
                            blocked: newBlockedStatus
                        });
                    } else {
                        // Se não existe, criar documento básico
                        await setDoc(userDocRef, {
                            blocked: newBlockedStatus,
                            role: 'user',
                            displayName: userName,
                            email: userName,
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    const successMessage = isCurrentlyBlocked 
                        ? `✅ ${userName} foi desbloqueado e pode acessar o app novamente.`
                        : `✅ ${userName} foi bloqueado e não consegue mais acessar o app.`;
                    
                    showModal(successMessage);
                    
                    // Recarregar lista
                    await loadUsersList();
                    
                } catch (error) {
                    console.error('❌ Erro ao alterar bloqueio:', error);
                    console.error('Detalhes do erro:', error.message);
                    showModal('❌ Erro ao alterar bloqueio de usuário. Tente novamente.');
                }
            }
            
            // Abrir modal de transferir voluntário
            let currentTransferData = null;
            
            function openTransferModal(escalaId, volunteerName, currentTeam, date, time) {
                currentTransferData = { escalaId, currentTeam, date, time };
                
                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };
                
                const teamColors = {
                    welcome: 'bg-blue-50 border-blue-300 hover:bg-blue-100',
                    backstage: 'bg-gray-50 border-gray-300 hover:bg-gray-100',
                    parking: 'bg-red-50 border-red-300 hover:bg-red-100',
                    kids: 'bg-yellow-50 border-yellow-300 hover:bg-yellow-100',
                    comunicacao: 'bg-purple-50 border-purple-300 hover:bg-purple-100'
                };
                
                const teamEmojis = {
                    welcome: '👋',
                    backstage: '🤝',
                    parking: '🚗',
                    kids: '👶',
                    comunicacao: '📢'
                };
                
                document.getElementById('transfer-volunteer-name').textContent = volunteerName;
                document.getElementById('transfer-current-team').textContent = teamNames[currentTeam];
                
                // Gerar opções de times (excluindo o time atual)
                const teamsOptions = document.getElementById('transfer-teams-options');
                teamsOptions.innerHTML = '';
                
                Object.keys(teamNames).forEach(teamKey => {
                    if (teamKey !== currentTeam) {
                        const radio = document.createElement('label');
                        radio.className = `flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer transition ${teamColors[teamKey]}`;
                        radio.innerHTML = `
                            <input type="radio" name="transfer-team" class="w-5 h-5" value="${teamKey}">
                            <span class="text-2xl">${teamEmojis[teamKey]}</span>
                            <span class="font-semibold text-gray-800">${teamNames[teamKey]}</span>
                        `;
                        teamsOptions.appendChild(radio);
                    }
                });
                
                document.getElementById('transfer-volunteer-modal').classList.add('show');
            }
            
            // Fechar modal de transferência
            document.getElementById('close-transfer-modal')?.addEventListener('click', () => {
                document.getElementById('transfer-volunteer-modal').classList.remove('show');
                currentTransferData = null;
            });
            
            document.getElementById('transfer-volunteer-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'transfer-volunteer-modal') {
                    document.getElementById('transfer-volunteer-modal').classList.remove('show');
                    currentTransferData = null;
                }
            });
            
            // Confirmar transferência
            document.getElementById('confirm-transfer-btn')?.addEventListener('click', async () => {
                if (!currentTransferData) return;
                
                const selectedTeam = document.querySelector('input[name="transfer-team"]:checked')?.value;
                
                if (!selectedTeam) {
                    showModal('⚠️ Por favor, selecione um time para transferir o voluntário.', false, null, true);
                    return;
                }
                
                try {
                    const { doc, updateDoc, getDoc } = window.firestoreMethods;
                    const escalaRef = doc(window.firebaseDb, 'escalas', currentTransferData.escalaId);
                    const escalaDoc = await getDoc(escalaRef);
                    
                    if (!escalaDoc.exists()) {
                        showModal('❌ Escala não encontrada.', false, null, true);
                        return;
                    }
                    
                    const escalaData = escalaDoc.data();
                    const volunteerName = escalaData.userName;
                    
                    // Verificar limite do time de destino
                    const teamLimit = await checkTeamLimit(currentTransferData.date, currentTransferData.time, selectedTeam);
                    
                    if (teamLimit.isFull) {
                        const teamNames = {
                            welcome: '👋 Welcome',
                            backstage: '🤝 Backstage',
                            parking: '🚗 Parking',
                            kids: '👶 Kids',
                            comunicacao: '📢 Comunicação'
                        };
                        showModal(
                            `❌ O time ${teamNames[selectedTeam]} já está completo (${teamLimit.count}/${teamLimit.maxVolunteers} voluntários).<br><br>Não é possível transferir.`,
                            false,
                            null,
                            true
                        );
                        return;
                    }
                    
                    const teamNames = {
                        welcome: '👋 Welcome',
                        backstage: '🤝 Backstage',
                        parking: '🚗 Parking',
                        kids: '👶 Kids',
                        comunicacao: '📢 Comunicação'
                    };
                    
                    // Atualizar time do voluntário com aviso de mudança
                    await updateDoc(escalaRef, {
                        team: selectedTeam,
                        updatedAt: new Date().toISOString(),
                        transferredBy: currentUser.email,
                        transferredAt: new Date().toISOString(),
                        teamChangeNotice: `Foi necessário mudar você do time ${teamNames[currentTransferData.currentTeam]} para ${teamNames[selectedTeam]} para uma melhor organização dos times.`
                    });
                    
                    document.getElementById('transfer-volunteer-modal').classList.remove('show');
                    currentTransferData = null;
                    
                    showModal(`✅ ${volunteerName} foi transferido(a) para o time ${teamNames[selectedTeam]}!`);
                    
                    // Recarregar visão geral
                    await loadAllEscalas();
                    
                } catch (error) {
                    console.error('❌ Erro ao transferir voluntário:', error);
                    showModal('❌ Erro ao transferir voluntário. Tente novamente.');
                }
            });
            
            // Abrir modal de gerenciar liderança de times
            let currentLeaderUserId = null;
            
            function openTeamLeaderModal(userId, userName, currentTeamLeader = []) {
                currentLeaderUserId = userId;
                document.getElementById('leader-user-name').textContent = userName;
                
                // Marcar checkboxes dos times que o usuário já lidera
                document.querySelectorAll('.leader-team-checkbox').forEach(checkbox => {
                    checkbox.checked = currentTeamLeader.includes(checkbox.dataset.team);
                });
                
                document.getElementById('team-leader-modal').classList.add('show');
            }
            
            // Fechar modal de liderança
            document.getElementById('close-team-leader-modal')?.addEventListener('click', () => {
                document.getElementById('team-leader-modal').classList.remove('show');
                currentLeaderUserId = null;
            });
            
            document.getElementById('team-leader-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'team-leader-modal') {
                    document.getElementById('team-leader-modal').classList.remove('show');
                    currentLeaderUserId = null;
                }
            });
            
            // Salvar liderança de times
            document.getElementById('save-team-leader-btn')?.addEventListener('click', async () => {
                if (!currentLeaderUserId) return;
                
                // Coletar times selecionados
                const selectedTeams = [];
                document.querySelectorAll('.leader-team-checkbox:checked').forEach(checkbox => {
                    selectedTeams.push(checkbox.dataset.team);
                });
                
                console.log('💾 Salvando liderança para usuário:', currentLeaderUserId);
                console.log('💾 Times selecionados:', selectedTeams);
                
                try {
                    const { doc, setDoc, updateDoc, getDoc } = window.firestoreMethods;
                    const userDocRef = doc(window.firebaseDb, 'users', currentLeaderUserId);
                    const userDoc = await getDoc(userDocRef);
                    
                    console.log('💾 Documento existe?', userDoc.exists());
                    
                    if (userDoc.exists()) {
                        // Usar updateDoc para preservar outros campos
                        const updateData = {
                            teamLeader: selectedTeams,
                            updatedAt: new Date().toISOString()
                        };
                        console.log('💾 Dados a serem atualizados:', updateData);
                        await updateDoc(userDocRef, updateData);
                        console.log('✅ Dados atualizados com sucesso');
                    } else {
                        // Se não existir, criar com setDoc
                        const newData = {
                            teamLeader: selectedTeams,
                            createdAt: new Date().toISOString()
                        };
                        console.log('💾 Criando novo documento com:', newData);
                        await setDoc(userDocRef, newData);
                        console.log('✅ Novo documento criado');
                    }
                    
                    // Verificar se foi salvo corretamente
                    const verifyDoc = await getDoc(userDocRef);
                    if (verifyDoc.exists()) {
                        console.log('✅ Verificação - teamLeader salvo:', verifyDoc.data().teamLeader);
                    }
                    
                    document.getElementById('team-leader-modal').classList.remove('show');
                    currentLeaderUserId = null;
                    
                    const teamNames = {
                        welcome: '👋 Welcome',
                        backstage: '🤝 Backstage',
                        parking: '🚗 Parking',
                        kids: '👶 Kids',
                        comunicacao: '📢 Comunicação'
                    };
                    
                    if (selectedTeams.length > 0) {
                        const teamsText = selectedTeams.map(t => teamNames[t]).join(', ');
                        showModal(`✅ Liderança atualizada!<br><br><strong>Times:</strong> ${teamsText}`);
                    } else {
                        showModal('✅ Liderança removida de todos os times.');
                    }
                    
                    // Recarregar lista de usuários
                    await loadUsersList();
                    
                    // Se for o próprio usuário logado, atualizar liderança e UI
                    if (currentLeaderUserId === currentUser?.uid) {
                        userTeamLeadership = selectedTeams;
                        isTeamLeader = userTeamLeadership.length > 0;
                        updateUserUI(currentUser);
                        // Recarregar admin view se estiver aberta
                        if (document.getElementById('admin-view').style.display !== 'none') {
                            await renderAdminView();
                        }
                    }
                    
                } catch (error) {
                    console.error('❌ Erro ao salvar liderança:', error);
                    showModal('❌ Erro ao salvar liderança. Tente novamente.');
                }
            });
            
            // ============================================
            // ONBOARDING - PRIMEIRO ACESSO
            // ============================================
            
            let onboardingData = {
                preferredTeam: null,
                availability: {}
            };
            
            // Seleção de time preferido
            document.querySelectorAll('.onboarding-team-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover seleção anterior
                    document.querySelectorAll('.onboarding-team-btn').forEach(b => {
                        b.classList.remove('ring-4', 'ring-offset-2');
                        b.style.borderColor = '';
                    });
                    
                    // Selecionar novo time
                    const team = this.dataset.team;
                    onboardingData.preferredTeam = team;
                    this.classList.add('ring-4', 'ring-offset-2');
                    
                    // Cores por time
                    const colors = {
                        welcome: 'rgb(37, 99, 235)',
                        backstage: 'rgb(75, 85, 99)',
                        parking: 'rgb(239, 68, 68)',
                        kids: 'rgb(234, 179, 8)',
                        comunicacao: 'rgb(147, 51, 234)'
                    };
                    this.style.borderColor = colors[team];
                    
                    validateOnboarding();
                });
            });
            
            // Toggle de dias da semana
            document.querySelectorAll('.day-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const day = this.dataset.day;
                    const periodOptions = document.querySelector(`.period-options[data-day="${day}"]`);
                    const indicator = this.querySelector('.toggle-indicator');
                    
                    if (periodOptions.classList.contains('hidden')) {
                        periodOptions.classList.remove('hidden');
                        indicator.textContent = '●';
                        indicator.classList.add('text-blue-600');
                        this.classList.add('bg-blue-50');
                    } else {
                        periodOptions.classList.add('hidden');
                        indicator.textContent = '○';
                        indicator.classList.remove('text-blue-600');
                        this.classList.remove('bg-blue-50');
                        
                        // Limpar seleções de período deste dia
                        periodOptions.querySelectorAll('.period-btn').forEach(p => {
                            p.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                        });
                        
                        // Remover do objeto de dados
                        delete onboardingData.availability[day];
                    }
                    
                    validateOnboarding();
                });
            });
            
            // Seleção de períodos
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const day = this.closest('.period-options').dataset.day;
                    const period = this.dataset.period;
                    
                    // Inicializar array se não existir
                    if (!onboardingData.availability[day]) {
                        onboardingData.availability[day] = [];
                    }
                    
                    // Toggle seleção
                    if (this.classList.contains('bg-blue-500')) {
                        this.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                        onboardingData.availability[day] = onboardingData.availability[day].filter(p => p !== period);
                        
                        // Se não há mais períodos, remover o dia
                        if (onboardingData.availability[day].length === 0) {
                            delete onboardingData.availability[day];
                        }
                    } else {
                        this.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                        onboardingData.availability[day].push(period);
                    }
                    
                    validateOnboarding();
                });
            });
            
            // Validar se pode continuar
            function validateOnboarding() {
                const btn = document.getElementById('confirm-onboarding-btn');
                const hasTeam = onboardingData.preferredTeam !== null;
                const hasAvailability = Object.keys(onboardingData.availability).length > 0;
                
                if (hasTeam && hasAvailability) {
                    btn.disabled = false;
                } else {
                    btn.disabled = true;
                }
            }
            
            // Carregar dados do onboarding no formulário
            function loadOnboardingDataToForm() {
                // Limpar seleções anteriores
                document.querySelectorAll('.onboarding-team-btn').forEach(b => {
                    b.classList.remove('ring-4', 'ring-offset-2');
                    b.style.borderColor = '';
                });
                
                document.querySelectorAll('.day-toggle-btn').forEach(btn => {
                    const day = btn.dataset.day;
                    const periodOptions = document.querySelector(`.period-options[data-day="${day}"]`);
                    const indicator = btn.querySelector('.toggle-indicator');
                    
                    periodOptions.classList.add('hidden');
                    indicator.textContent = '○';
                    indicator.classList.remove('text-blue-600');
                    btn.classList.remove('bg-blue-50');
                });
                
                document.querySelectorAll('.period-btn').forEach(p => {
                    p.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                });

                // Selecionar time preferido
                if (onboardingData.preferredTeam) {
                    const teamBtn = document.querySelector(`.onboarding-team-btn[data-team="${onboardingData.preferredTeam}"]`);
                    if (teamBtn) {
                        teamBtn.classList.add('ring-4', 'ring-offset-2');
                        const colors = {
                            welcome: 'rgb(37, 99, 235)',
                            backstage: 'rgb(75, 85, 99)',
                            parking: 'rgb(239, 68, 68)',
                            kids: 'rgb(234, 179, 8)',
                            comunicacao: 'rgb(147, 51, 234)'
                        };
                        teamBtn.style.borderColor = colors[onboardingData.preferredTeam];
                    }
                }

                // Selecionar dias e períodos
                if (onboardingData.availability) {
                    for (const [day, periods] of Object.entries(onboardingData.availability)) {
                        const dayBtn = document.querySelector(`.day-toggle-btn[data-day="${day}"]`);
                        const periodOptions = document.querySelector(`.period-options[data-day="${day}"]`);
                        const indicator = dayBtn?.querySelector('.toggle-indicator');
                        
                        if (dayBtn && periodOptions && indicator) {
                            // Abrir o dia
                            periodOptions.classList.remove('hidden');
                            indicator.textContent = '●';
                            indicator.classList.add('text-blue-600');
                            dayBtn.classList.add('bg-blue-50');
                            
                            // Selecionar períodos
                            periods.forEach(period => {
                                const periodBtn = periodOptions.querySelector(`.period-btn[data-period="${period}"]`);
                                if (periodBtn) {
                                    periodBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                                }
                            });
                        }
                    }
                }

                validateOnboarding();
            }
            
            // Carregar e editar dados do onboarding
            async function loadAndEditOnboarding() {
                if (!currentUser?.uid) {
                    showModal('❌ Usuário não autenticado.');
                    return;
                }

                try {
                    const { doc, getDoc } = window.firestoreMethods;
                    const userDocRef = doc(window.firebaseDb, 'users', currentUser.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (!userDoc.exists()) {
                        showModal('❌ Dados do usuário não encontrados.');
                        return;
                    }

                    const userData = userDoc.data();
                    
                    // Verificar se tem dados de onboarding
                    if (!userData.preferredTeam || !userData.availability) {
                        showModal('ℹ️ Você ainda não preencheu suas informações de disponibilidade.<br><br>Complete o cadastro primeiro!', false, null, false, null, 'ℹ️');
                        return;
                    }

                    // Carregar dados no onboardingData
                    onboardingData.preferredTeam = userData.preferredTeam;
                    onboardingData.availability = userData.availability || {};

                    // Mostrar resumo no modal de confirmação
                    showOnboardingSummary();
                    document.getElementById('onboarding-confirm-modal').style.display = 'flex';

                } catch (error) {
                    console.error('Erro ao carregar dados do onboarding:', error);
                    showModal('❌ Erro ao carregar suas informações. Tente novamente.');
                }
            }
            
            // Abrir modal de confirmação
            document.getElementById('confirm-onboarding-btn')?.addEventListener('click', () => {
                showOnboardingSummary();
                document.getElementById('onboarding-modal').style.display = 'none';
                document.getElementById('onboarding-confirm-modal').style.display = 'flex';
            });
            
            // Mostrar resumo
            function showOnboardingSummary() {
                const summaryDiv = document.getElementById('onboarding-summary');
                
                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };
                
                const dayNames = {
                    monday: 'Segunda-feira',
                    tuesday: 'Terça-feira',
                    wednesday: 'Quarta-feira',
                    thursday: 'Quinta-feira',
                    friday: 'Sexta-feira',
                    saturday: 'Sábado',
                    sunday: 'Domingo'
                };
                
                const periodNames = {
                    morning: '☀️ Manhã',
                    afternoon: '🌤️ Tarde',
                    night: '🌙 Noite'
                };
                
                let html = `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-1">Time Preferido:</p>
                        <p class="text-lg font-bold text-blue-600">${teamNames[onboardingData.preferredTeam]}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Disponibilidade:</p>
                        <div class="space-y-2">
                `;
                
                for (const [day, periods] of Object.entries(onboardingData.availability)) {
                    const periodsList = periods.map(p => periodNames[p]).join(', ');
                    html += `
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-medium text-gray-700">${dayNames[day]}:</span>
                            <span class="text-gray-600">${periodsList}</span>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                summaryDiv.innerHTML = html;
            }
            
            // Voltar para editar
            document.getElementById('edit-onboarding-btn')?.addEventListener('click', () => {
                // Carregar dados atuais no formulário
                loadOnboardingDataToForm();
                document.getElementById('onboarding-confirm-modal').style.display = 'none';
                document.getElementById('onboarding-modal').style.display = 'flex';
            });
            
            // Salvar onboarding (com validações e proteção contra duplo clique)
            document.getElementById('save-onboarding-btn')?.addEventListener('click', async () => {
                const btn = document.getElementById('save-onboarding-btn');
                if (!currentUser?.uid) {
                    showModal('❌ Usuário não autenticado. Faça login novamente.');
                    return;
                }
                // Evitar múltiplos cliques
                if (btn.dataset.loading === 'true') return;
                btn.dataset.loading = 'true';
                btn.classList.add('opacity-60','cursor-not-allowed');
                try {
                    const { doc, setDoc, getDoc } = window.firestoreMethods;
                    const userDocRef = doc(window.firebaseDb, 'users', currentUser.uid);

                    // Sanitizar e validar dados
                    const allowedTeams = ['welcome','backstage','parking','kids','comunicacao','no-preference'];
                    if (!allowedTeams.includes(onboardingData.preferredTeam)) {
                        showModal('⚠️ Selecione um time válido antes de salvar.');
                        return;
                    }
                    const availability = onboardingData.availability || {};
                    const days = Object.keys(availability);
                    if (days.length === 0) {
                        showModal('⚠️ Selecione pelo menos um dia de disponibilidade.');
                        return;
                    }
                    // Garantir arrays de períodos válidos
                    const sanitizedAvailability = {};
                    const allowedPeriods = ['morning','afternoon','night'];
                    for (const day of days) {
                        const periodsArr = Array.isArray(availability[day]) ? availability[day] : [];
                        const filtered = periodsArr.filter(p => allowedPeriods.includes(p));
                        if (filtered.length > 0) {
                            sanitizedAvailability[day] = filtered;
                        }
                    }
                    if (Object.keys(sanitizedAvailability).length === 0) {
                        showModal('⚠️ Selecione períodos válidos para sua disponibilidade.');
                        return;
                    }

                    const dataToSave = {
                        preferredTeam: onboardingData.preferredTeam,
                        availability: sanitizedAvailability,
                        onboardingComplete: true,
                        onboardingDate: new Date().toISOString()
                    };

                    console.log('💾 Salvando onboarding para:', currentUser.uid);
                    console.log('💾 Dados (sanitizados):', dataToSave);

                    await setDoc(userDocRef, dataToSave, { merge: true });
                    console.log('💾 Dados salvos com setDoc merge:true');

                    // Verificar se foi salvo corretamente
                    const verifyDoc = await getDoc(userDocRef);
                    const vData = verifyDoc.data() || {};
                    console.log('✅ Verificação - onboardingComplete salvo:', vData.onboardingComplete);
                    if (vData.onboardingComplete !== true) {
                        console.warn('⚠️ Campo onboardingComplete não é boolean true. Valor:', vData.onboardingComplete);
                    }
                    console.log('✅ Documento completo pós-salvo:', vData);

                    // Marcar onboarding como completo nesta sessão para evitar reabrir
                    onboardingCompleted = true;
                    console.log('🔄 Flag onboardingCompleted definida para true');

                    // Fechar modais
                    const confirmModal = document.getElementById('onboarding-confirm-modal');
                    const mainModal = document.getElementById('onboarding-modal');
                    if (confirmModal) confirmModal.style.display = 'none';
                    if (mainModal) mainModal.style.display = 'none';

                    showModal('✅ Suas preferências foram salvas com sucesso!<br><br>Agora você pode começar a se escalar nos eventos.');
                    console.log('✅ Onboarding concluído com sucesso.');
                } catch (error) {
                    console.error('❌ Erro ao salvar onboarding:', error);
                    showModal('❌ Erro ao salvar suas preferências. Tente novamente.');
                } finally {
                    btn.dataset.loading = 'false';
                    btn.classList.remove('opacity-60','cursor-not-allowed');
                }
            });
            
            // Verificar se precisa mostrar onboarding
            async function checkOnboarding(user) {
                try {
                    if (!user?.uid) return;
                    
                    // Se onboarding já foi concluído nesta sessão, não mostrar
                    if (onboardingCompleted) {
                        console.log('✅ Onboarding já concluído nesta sessão - não mostrar modal');
                        return;
                    }
                    
                    const { doc, getDoc } = window.firestoreMethods;
                    const ref = doc(window.firebaseDb, 'users', user.uid);
                    const userDoc = await getDoc(ref);
                    console.log('🔍 checkOnboarding - userDoc.exists():', userDoc.exists());

                    let shouldShowOnboarding = false;
                    if (!userDoc.exists()) {
                        console.log('👋 Novo usuário - mostrar onboarding');
                        shouldShowOnboarding = true;
                    } else {
                        const data = userDoc.data() || {};
                        const completed = data.onboardingComplete === true || data.onboardingComplete === 'true';
                        console.log('🔍 checkOnboarding - raw value:', data.onboardingComplete, '-> completed:', completed);
                        if (!completed) {
                            console.log('👋 Usuário sem onboarding completo - mostrar formulário');
                            shouldShowOnboarding = true;
                        } else {
                            console.log('✅ Onboarding já foi completado');
                            onboardingCompleted = true; // Marcar como completo
                        }
                    }

                    if (shouldShowOnboarding) {
                        const modal = document.getElementById('onboarding-modal');
                        if (modal && modal.style.display !== 'flex') {
                            setTimeout(() => { modal.style.display = 'flex'; }, 500);
                        }
                    }
                } catch (error) {
                    console.error('❌ Erro ao verificar onboarding:', error);
                }
            }
            
            // Excluir usuário permanentemente (apenas se bloqueado)
            async function deleteUser(userId, userName) {
                const confirmation = await new Promise(resolve => {
                    showModal(
                        `<div class="text-left"><p class="text-center mb-4">⚠️ <strong>ATENÇÃO: Esta ação é irreversível!</strong></p><p>Tem certeza que deseja <strong>EXCLUIR PERMANENTEMENTE</strong> o usuário:</p><p class="text-center my-4 font-bold text-lg">${userName}</p><p class="text-red-600 font-bold">⚠️ Todas as escalas deste usuário serão deletadas de todos os eventos!</p><p class="text-red-600 font-bold">⚠️ A conta de autenticação será deletada permanentemente!</p></div>`,
                        true,
                        () => resolve(true),
                        true,
                        () => resolve(false)
                    );
                });
                
                if (!confirmation) return;
                
                try {
                    const { doc, deleteDoc, collection, query, where, getDocs } = window.firestoreMethods;
                    
                    // 1. Deletar todas as escalas do usuário
                    const escalasQuery = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('userId', '==', userId)
                    );
                    
                    const escalasSnapshot = await getDocs(escalasQuery);
                    const deleteEscalasPromises = [];
                    
                    escalasSnapshot.forEach((docSnapshot) => {
                        deleteEscalasPromises.push(
                            deleteDoc(doc(window.firebaseDb, 'escalas', docSnapshot.id))
                        );
                    });
                    
                    await Promise.all(deleteEscalasPromises);
                    console.log(`🗑️ ${deleteEscalasPromises.length} escala(s) deletada(s)`);
                    
                    // 2. Deletar o documento do usuário no Firestore
                    await deleteDoc(doc(window.firebaseDb, 'users', userId));
                    console.log('🗑️ Usuário deletado do Firestore');
                    
                    // 3. Marcar usuário para deleção no Auth (Cloud Function fará a deleção real)
                    // Como não podemos deletar diretamente do Auth no client-side, vamos marcar para deleção
                    try {
                        const { setDoc } = window.firestoreMethods;
                        await setDoc(doc(window.firebaseDb, 'pendingAccountDeletions', userId), {
                            userId: userId,
                            userName: userName,
                            deletedBy: currentUser.uid,
                            deletedByEmail: currentUser.email,
                            deletedAt: new Date().toISOString(),
                            status: 'pending'
                        });
                        console.log('🗑️ Conta marcada para deleção no Authentication');
                    } catch (authError) {
                        console.warn('⚠️ Não foi possível marcar conta para deleção:', authError);
                    }
                    
                    showModal(`✅ ${userName} foi excluído permanentemente do sistema.<br><br>${deleteEscalasPromises.length} escala(s) foram deletadas.<br><br>A conta será removida do sistema de autenticação em alguns minutos.`);
                    
                    // Recarregar listas
                    await loadUsersList();
                    await loadUserEscalas();
                    await loadAllEscalas();
                    
                } catch (error) {
                    console.error('❌ Erro ao excluir usuário:', error);
                    console.error('Detalhes do erro:', error.message);
                    showModal('❌ Erro ao excluir usuário. Tente novamente.');
                }
            }

            // Event Listeners
            elements.googleLoginBtn.addEventListener('click', loginWithGoogle);

            // Event listeners para login com email
            const emailLoginModal = document.getElementById('email-login-modal');
            const showEmailLogin = document.getElementById('show-email-login');
            const closeEmailModal = document.getElementById('close-email-modal');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const resetPasswordForm = document.getElementById('reset-password-form');
            
            // Event listener para adicionar data (admin)
            const adminAddDateBtn = document.getElementById('admin-add-date-btn');
            if (adminAddDateBtn) {
                adminAddDateBtn.addEventListener('click', addNewDate);
            }
            
            // Abrir modal de email
            showEmailLogin.addEventListener('click', () => {
                emailLoginModal.classList.add('show');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                resetPasswordForm.style.display = 'none';
            });
            
            // Fechar modal
            closeEmailModal.addEventListener('click', () => {
                emailLoginModal.classList.remove('show');
            });
            
            emailLoginModal.addEventListener('click', (e) => {
                if (e.target === emailLoginModal) {
                    emailLoginModal.classList.remove('show');
                }
            });
            
            // Alternar entre formulários
            document.getElementById('show-register-form').addEventListener('click', () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                resetPasswordForm.style.display = 'none';
            });
            
            document.getElementById('show-login-form').addEventListener('click', () => {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                resetPasswordForm.style.display = 'none';
            });
            
            document.getElementById('show-reset-password').addEventListener('click', () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'none';
                resetPasswordForm.style.display = 'block';
            });
            
            document.getElementById('back-to-login').addEventListener('click', () => {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                resetPasswordForm.style.display = 'none';
            });
            
            // Login com email
            document.getElementById('email-login-btn').addEventListener('click', async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    showModal('Por favor, preencha email e senha!');
                    return;
                }
                
                try {
                    emailLoginModal.classList.remove('show');
                    showLoading(); // Mostrar loading durante o login
                    await window.firebaseAuthMethods.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log('✅ Login com email realizado');
                    // O onAuthStateChanged vai cuidar de mostrar o app
                } catch (error) {
                    console.error('❌ Erro no login:', error);
                    showLogin(); // Voltar para login em caso de erro
                    emailLoginModal.classList.add('show'); // Reabrir modal
                    let message = 'Erro ao fazer login. Tente novamente.';
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        message = 'Email ou senha incorretos.';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Email inválido.';
                    } else if (error.code === 'auth/too-many-requests') {
                        message = 'Muitas tentativas. Tente novamente mais tarde.';
                    }
                    showModal(message);
                }
            });
            
            // Alternar visibilidade da senha no cadastro
            document.getElementById('toggle-register-password').addEventListener('click', () => {
                const input = document.getElementById('register-password');
                if (input.type === 'password') {
                    input.type = 'text';
                } else {
                    input.type = 'password';
                }
            });
            
            document.getElementById('toggle-register-password-confirm').addEventListener('click', () => {
                const input = document.getElementById('register-password-confirm');
                if (input.type === 'password') {
                    input.type = 'text';
                } else {
                    input.type = 'password';
                }
            });
            
            // Cadastro com email
            document.getElementById('email-register-btn').addEventListener('click', async () => {
                const name = document.getElementById('register-name').value.trim();
                const lastname = document.getElementById('register-lastname').value.trim();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const passwordConfirm = document.getElementById('register-password-confirm').value;
                
                if (!name || !lastname || !email || !password || !passwordConfirm) {
                    showModal('Por favor, preencha todos os campos!');
                    return;
                }
                
                if (password.length < 6) {
                    showModal('A senha deve ter no mínimo 6 caracteres!');
                    return;
                }
                
                if (password !== passwordConfirm) {
                    showModal('As senhas não coincidem! Por favor, verifique.', false, null, false, null, '⚠️');
                    return;
                }
                
                try {
                    emailLoginModal.classList.remove('show');
                    showLoading(); // Mostrar loading durante o cadastro
                    const userCredential = await window.firebaseAuthMethods.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                    
                    // Atualizar perfil com nome completo
                    await window.firebaseAuthMethods.updateProfile(userCredential.user, {
                        displayName: `${name} ${lastname}`
                    });
                    
                    console.log('✅ Cadastro realizado');
                    // O onAuthStateChanged vai cuidar de mostrar o app e depois o modal de sucesso
                } catch (error) {
                    console.error('❌ Erro no cadastro:', error);
                    showLogin(); // Voltar para login em caso de erro
                    emailLoginModal.classList.add('show'); // Reabrir modal
                    let message = 'Erro ao criar conta. Tente novamente.';
                    if (error.code === 'auth/email-already-in-use') {
                        message = 'Este email já está cadastrado. Faça login.';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Email inválido.';
                    } else if (error.code === 'auth/weak-password') {
                        message = 'Senha muito fraca. Use no mínimo 6 caracteres.';
                    }
                    showModal(message);
                }
            });
            
            // Recuperação de senha
            document.getElementById('send-reset-btn').addEventListener('click', async () => {
                const email = document.getElementById('reset-email').value;
                
                if (!email) {
                    showModal('Por favor, digite seu email!');
                    return;
                }
                
                try {
                    await window.firebaseAuthMethods.sendPasswordResetEmail(window.firebaseAuth, email);
                    showModal('Email de recuperação enviado! Verifique sua caixa de entrada.');
                    // Voltar para tela de login
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    resetPasswordForm.style.display = 'none';
                } catch (error) {
                    console.error('❌ Erro ao enviar email:', error);
                    let message = 'Erro ao enviar email. Tente novamente.';
                    if (error.code === 'auth/invalid-email') {
                        message = 'Email inválido.';
                    } else if (error.code === 'auth/user-not-found') {
                        message = 'Email não encontrado.';
                    }
                    showModal(message);
                }
            });
            
            // Enter para login
            document.getElementById('login-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('email-login-btn').click();
                }
            });
            
            document.getElementById('register-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('email-register-btn').click();
                }
            });
            
            document.getElementById('reset-email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('send-reset-btn').click();
                }
            });

            // Monitorar autenticação
            window.firebaseAuthMethods.onAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    console.log('✅ Estado de auth mudou: LOGADO');
                    console.log('👤 Usuário:', user.displayName);
                    console.log('📧 Email:', user.email);
                    console.log('🆔 UID:', user.uid);
                    console.log('🔐 Provider:', user.providerData[0]?.providerId);
                } else {
                    console.log('🔄 Estado de auth mudou: DESLOGADO');
                }
                currentUser = user;

                if (user) {
                    // 1. Mostrar app IMEDIATAMENTE (não espera nada)
                    updateUserUI(user);
                    showApp();
                    
                    // 2. Carregar dados em paralelo (incluindo checkAdminStatus)
                    Promise.all([
                        checkAdminStatus(user),
                        loadAvailableDates(),
                        loadUserEscalas(),
                        loadAllEscalas()
                    ]).then(() => {
                        console.log('✅ Todos os dados carregados');
                        setupUserEscalasListener(); // Configurar listener após carregar escalas
                    }).catch(err => {
                        console.error('❌ Erro ao carregar dados:', err);
                    });
                    
                    // 3. Operações secundárias (não bloqueiam)
                    setupInstallButton();
                    
                    // 4. Verificar onboarding (pode ser feito depois)
                    // DISABLED: Modal de onboarding desabilitado
                    // setTimeout(async () => {
                    //     await checkOnboarding(user);
                    // }, 500);
                    
                    // 5. Verificar check-in de voluntários (para líderes)
                    setTimeout(async () => {
                        await checkForCheckinEvents();
                    }, 1500);
                } else {
                    showLogin();
                }
            });

            // ===== Bloqueio de Datas: Funções e Listeners =====
            function openBlockedDatesModal() {
                const modal = document.getElementById('blocked-dates-modal');
                renderBlockedDatesList();
                modal.classList.remove('hidden');
            }

            function closeBlockedDatesModal() {
                const modal = document.getElementById('blocked-dates-modal');
                modal.classList.add('hidden');
            }

            function renderBlockedDatesList() {
                const list = document.getElementById('blocked-dates-list');
                if (!list) return;
                const entries = Object.entries(userBlockedDates || {});
                if (entries.length === 0) {
                    list.innerHTML = '<p class="text-gray-500">Sem bloqueios cadastrados.</p>';
                    return;
                }
                const periodLabel = { all: 'Dia inteiro', morning: 'Manhã', afternoon: 'Tarde', night: 'Noite' };
                const html = entries.sort((a,b)=>a[0].localeCompare(b[0])).map(([date, periods])=>{
                    const dateStr = new Date(date+'T12:00:00').toLocaleDateString('pt-BR');
                    const chips = (periods||[]).map(p=>`
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 text-xs rounded bg-gray-100 border border-gray-200 mr-1 mb-1">
                            ${periodLabel[p] || p}
                            <button class="remove-block-btn text-gray-500 hover:text-red-600" data-date="${date}" data-period="${p}" title="Remover">×</button>
                        </span>
                    `).join('');
                    return `
                        <div class="flex items-center justify-between bg-white border border-gray-200 rounded p-2">
                            <div>
                                <div class="font-semibold text-gray-800">${dateStr}</div>
                                <div class="mt-1 flex flex-wrap">${chips}</div>
                            </div>
                            <button class="remove-block-date-btn text-red-600 hover:text-red-800" data-date="${date}" title="Remover dia inteiro">🗑️</button>
                        </div>
                    `;
                }).join('');
                list.innerHTML = html;

                // Listeners de remoção
                list.querySelectorAll('.remove-block-btn').forEach(btn=>{
                    btn.addEventListener('click', async (e)=>{
                        const date = e.currentTarget.dataset.date;
                        const period = e.currentTarget.dataset.period;
                        await removeBlockedPeriod(date, period);
                    });
                });
                list.querySelectorAll('.remove-block-date-btn').forEach(btn=>{
                    btn.addEventListener('click', async (e)=>{
                        const date = e.currentTarget.dataset.date;
                        await removeBlockedDate(date);
                    });
                });
            }

            async function saveBlockedDatesToFirestore() {
                try {
                    const { doc, setDoc } = window.firestoreMethods;
                    const userDocRef = doc(window.firebaseDb, 'users', currentUser.uid);
                    await setDoc(userDocRef, { blockedDates: userBlockedDates }, { merge: true });
                    console.log('✅ Bloqueios salvos:', userBlockedDates);
                } catch (err) {
                    console.error('❌ Erro ao salvar bloqueios:', err);
                    showModal('Erro ao salvar bloqueios. Tente novamente.');
                }
            }

            async function addBlockedDate(date, period) {
                if (!date || !period) return;
                userBlockedDates = userBlockedDates || {};
                const existing = userBlockedDates[date] || [];
                if (period === 'all') {
                    userBlockedDates[date] = ['all'];
                } else {
                    if (!existing.includes('all')) {
                        const set = new Set(existing);
                        set.add(period);
                        userBlockedDates[date] = Array.from(set);
                    }
                }
                await saveBlockedDatesToFirestore();
                renderBlockedDatesList();
            }

            async function removeBlockedPeriod(date, period) {
                const existing = userBlockedDates[date] || [];
                if (existing.includes('all')) {
                    delete userBlockedDates[date];
                } else {
                    userBlockedDates[date] = existing.filter(p=>p!==period);
                    if (userBlockedDates[date].length === 0) delete userBlockedDates[date];
                }
                await saveBlockedDatesToFirestore();
                renderBlockedDatesList();
            }

            async function removeBlockedDate(date) {
                delete userBlockedDates[date];
                await saveBlockedDatesToFirestore();
                renderBlockedDatesList();
            }

            // Listeners do modal
            document.getElementById('menu-edit-onboarding-btn')?.addEventListener('click', async () => {
                closeMenu();
                await loadAndEditOnboarding();
            });

            document.getElementById('menu-block-dates-btn')?.addEventListener('click', () => {
                closeMenu();
                openBlockedDatesModal();
            });
            document.getElementById('close-blocked-dates-modal')?.addEventListener('click', closeBlockedDatesModal);
            document.getElementById('close-blocked-dates-btn')?.addEventListener('click', closeBlockedDatesModal);
            document.getElementById('add-blocked-date-btn')?.addEventListener('click', async ()=>{
                const date = (document.getElementById('block-date-input').value || '').trim();
                const period = document.getElementById('block-period-select').value;
                if (!date) { showModal('Selecione uma data.'); return; }
                await addBlockedDate(date, period);
            });

            // ===== CHECK-IN DE VOLUNTÁRIOS =====
            let currentCheckinEvents = []; // Agora é um array

            async function checkForCheckinEvents() {
                // Só executar para líderes de time
                if (!isTeamLeader || !userTeamLeadership || userTeamLeadership.length === 0) {
                    console.log('🔍 Check-in: Usuário não é líder de time');
                    return;
                }

                try {
                    const { collection, query, where, getDocs } = window.firestoreMethods;
                    const now = new Date();
                    const twoHoursBefore = new Date(now.getTime() - (2 * 60 * 60 * 1000));
                    const fourHoursAfter = new Date(now.getTime() + (4 * 60 * 60 * 1000));

                    console.log('🔍 Check-in: Buscando eventos entre', twoHoursBefore, 'e', fourHoursAfter);

                    // Buscar escalas dos times que lidera
                    const escalasRef = collection(window.firebaseDb, 'escalas');
                    const q = query(escalasRef, where('team', 'in', userTeamLeadership));
                    const snapshot = await getDocs(q);

                    const eventsInWindow = [];
                    snapshot.forEach(doc => {
                        const escala = { id: doc.id, ...doc.data() };
                        const eventDateTime = new Date(escala.date + 'T' + escala.time);
                        
                        // Verificar se está na janela: 2h antes até 4h depois
                        const twoHoursBeforeEvent = new Date(eventDateTime.getTime() - (2 * 60 * 60 * 1000));
                        const fourHoursAfterEvent = new Date(eventDateTime.getTime() + (4 * 60 * 60 * 1000));

                        if (now >= twoHoursBeforeEvent && now <= fourHoursAfterEvent) {
                            eventsInWindow.push({ ...escala, eventDateTime });
                        }
                    });

                    console.log('🔍 Check-in: Eventos encontrados na janela:', eventsInWindow.length);

                    if (eventsInWindow.length > 0) {
                        // Agrupar por evento (date + time)
                        const groupedByEvent = {};
                        eventsInWindow.forEach(escala => {
                            const key = `${escala.date}_${escala.time}`;
                            if (!groupedByEvent[key]) {
                                groupedByEvent[key] = {
                                    date: escala.date,
                                    time: escala.time,
                                    eventName: escala.eventName,
                                    eventDateTime: escala.eventDateTime,
                                    teams: {}
                                };
                            }
                            if (!groupedByEvent[key].teams[escala.team]) {
                                groupedByEvent[key].teams[escala.team] = [];
                            }
                            groupedByEvent[key].teams[escala.team].push(escala);
                        });

                        // Ordenar eventos por data/hora
                        const sortedEvents = Object.entries(groupedByEvent).sort((a, b) => {
                            return a[1].eventDateTime - b[1].eventDateTime; // Mais antigo primeiro
                        });
                        
                        // Armazenar todos os eventos (não apenas um)
                        currentCheckinEvents = sortedEvents.map(entry => entry[1]);
                        
                        console.log('🎯 Check-in: Eventos selecionados:', currentCheckinEvents.map(e => `${e.date}_${e.time}`).join(', '));
                        
                        openCheckinModal();
                    }
                } catch (error) {
                    console.error('❌ Erro ao verificar eventos para check-in:', error);
                }
            }

            function openCheckinModal() {
                if (!currentCheckinEvents || currentCheckinEvents.length === 0) return;

                const modal = document.getElementById('checkin-modal');
                const eventInfo = document.getElementById('checkin-event-info');
                const teamsList = document.getElementById('checkin-teams-list');

                // Renderizar todos os eventos em seções
                let eventsHtml = '';
                
                currentCheckinEvents.forEach((event, eventIndex) => {
                    const dateObj = new Date(event.date + 'T' + event.time);
                    const dateStr = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
                    const eventNameDisplay = event.eventName ? ` - ${event.eventName}` : '';
                    
                    eventsHtml += `
                        <div class="mb-6 pb-6 border-b border-gray-200 last:border-b-0">
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded text-sm mb-4">
                                <div class="font-semibold">📅 ${dateStr}${eventNameDisplay}</div>
                                <div class="text-xs text-gray-600">🕐 ${event.time}</div>
                            </div>
                    `;

                    // Listar times e voluntários
                    const teamNames = {
                        welcome: { name: 'Welcome', icon: '👋', color: 'bg-blue-50 border-blue-200' },
                        backstage: { name: 'Backstage', icon: '🤝', color: 'bg-gray-50 border-gray-200' },
                        parking: { name: 'Parking', icon: '🚗', color: 'bg-red-50 border-red-200' },
                        kids: { name: 'Kids', icon: '👶', color: 'bg-yellow-50 border-yellow-200' },
                        comunicacao: { name: 'Comunicação', icon: '📢', color: 'bg-purple-50 border-purple-200' }
                    };

                    Object.entries(event.teams).forEach(([teamKey, volunteers]) => {
                        const teamInfo = teamNames[teamKey] || { name: teamKey, icon: '👥', color: 'bg-gray-50' };
                        
                        // Ordenar voluntários por função (role) alfabeticamente
                        const sortedVolunteers = volunteers.sort((a, b) => {
                            const roleA = (a.role || '').toLowerCase();
                            const roleB = (b.role || '').toLowerCase();
                            return roleA.localeCompare(roleB, 'pt-BR');
                        });
                        
                        eventsHtml += `
                            <div class="border-l-4 ${teamInfo.color} border rounded p-3 mb-3">
                                <h4 class="font-semibold mb-2 flex items-center gap-2">
                                    <span>${teamInfo.icon}</span>
                                    <span>${teamInfo.name}</span>
                                    <span class="text-xs text-gray-500">(${volunteers.length})</span>
                                </h4>
                                <div class="space-y-2">
                                    ${sortedVolunteers.map(v => {
                                        const checkInStatus = v.checkIn?.status || 'pending';
                                        const photoUrl = v.userPhoto || 'Zele logo.png';
                                        return `
                                            <div class="flex items-center justify-between bg-white p-2 rounded border">
                                                <div class="flex items-center gap-2">
                                                    <img src="${photoUrl}" alt="${v.userName}" class="w-8 h-8 rounded-full object-cover" onerror="this.src='Zele logo.png'">
                                                    <span class="font-medium text-sm">${v.userName}</span>
                                                    ${checkInStatus === 'present' ? '<span class="text-xs text-green-600 font-semibold">✓ Presente</span>' : ''}
                                                    ${checkInStatus === 'absent' ? '<span class="text-xs text-red-600 font-semibold">✗ Ausente</span>' : ''}
                                                </div>
                                                <div class="flex gap-2">
                                                    <button class="checkin-present-btn w-10 h-10 flex items-center justify-center rounded ${checkInStatus === 'present' ? 'bg-green-500 text-white' : 'bg-green-50 text-green-600 border border-green-200'} hover:bg-green-600 hover:text-white transition"
                                                            data-escala-id="${v.id}"
                                                            data-volunteer-name="${v.userName}"
                                                            title="Marcar ${v.userName} como presente">
                                                        ✓
                                                    </button>
                                                    <button class="checkin-absent-btn w-10 h-10 flex items-center justify-center rounded ${checkInStatus === 'absent' ? 'bg-red-500 text-white' : 'bg-red-50 text-red-600 border border-red-200'} hover:bg-red-600 hover:text-white transition"
                                                            data-escala-id="${v.id}"
                                                            data-volunteer-name="${v.userName}"
                                                            title="Marcar ${v.userName} como ausente">
                                                        ✗
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    });
                    
                    eventsHtml += `</div>`; // Fechar seção do evento
                });

                // Atualizar header
                eventInfo.innerHTML = `<div class="font-semibold">✅ Check-in de Voluntários (${currentCheckinEvents.length} evento${currentCheckinEvents.length > 1 ? 's' : ''})</div>`;

                // Inserir conteúdo dos eventos
                teamsList.innerHTML = eventsHtml;

                // Event listeners para os botões
                document.querySelectorAll('.checkin-present-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        await markCheckin(escalaId, 'present');
                    });
                });

                document.querySelectorAll('.checkin-absent-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        await markCheckin(escalaId, 'absent');
                    });
                });

                modal.classList.remove('hidden');
            }

            function closeCheckinModal() {
                document.getElementById('checkin-modal').classList.add('hidden');
                
                // Limpar eventos atuais para permitir nova seleção
                currentCheckinEvents = [];
                
                // Atualizar o gráfico de presença após fechar o modal
                if (window.dashboardCharts && window.dashboardCharts.chart5 && window.currentDashboardEscalas) {
                    generateChart5_CheckinAttendance(window.currentDashboardEscalas);
                }
            }

            async function markCheckin(escalaId, status) {
                try {
                    const { doc, updateDoc } = window.firestoreMethods;
                    const escalaRef = doc(window.firebaseDb, 'escalas', escalaId);
                    
                    await updateDoc(escalaRef, {
                        checkIn: {
                            status: status,
                            checkedBy: currentUser.uid,
                            checkedByName: currentUser.displayName || currentUser.email,
                            checkedAt: new Date().toISOString()
                        }
                    });

                    console.log(`✅ Check-in registrado: ${escalaId} = ${status}`);
                    
                    // Atualizar visualmente os botões
                    const presentBtn = document.querySelector(`.checkin-present-btn[data-escala-id="${escalaId}"]`);
                    const absentBtn = document.querySelector(`.checkin-absent-btn[data-escala-id="${escalaId}"]`);
                    
                    if (presentBtn && absentBtn) {
                        // Resetar ambos os botões
                        presentBtn.classList.remove('bg-green-500', 'text-white');
                        presentBtn.classList.add('bg-green-50', 'text-green-600', 'border', 'border-green-200');
                        
                        absentBtn.classList.remove('bg-red-500', 'text-white');
                        absentBtn.classList.add('bg-red-50', 'text-red-600', 'border', 'border-red-200');
                        
                        // Aplicar estilo ao botão selecionado
                        if (status === 'present') {
                            presentBtn.classList.remove('bg-green-50', 'text-green-600', 'border', 'border-green-200');
                            presentBtn.classList.add('bg-green-500', 'text-white');
                        } else if (status === 'absent') {
                            absentBtn.classList.remove('bg-red-50', 'text-red-600', 'border', 'border-red-200');
                            absentBtn.classList.add('bg-red-500', 'text-white');
                        }
                    }
                } catch (error) {
                    console.error('❌ Erro ao registrar check-in:', error);
                    showModal('Erro ao registrar presença. Tente novamente.');
                }
            }

            // Listeners do modal de check-in
            document.getElementById('close-checkin-modal')?.addEventListener('click', closeCheckinModal);
            document.getElementById('close-checkin-btn')?.addEventListener('click', closeCheckinModal);
            
            // Listener do overlay para fechar ao clicar fora
            document.getElementById('checkin-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'checkin-modal') {
                    closeCheckinModal();
                }
            });
            
            // Listeners do modal de seleção de evento
            document.getElementById('close-event-selector-modal')?.addEventListener('click', closeEventSelectorModal);
            document.getElementById('close-event-selector-btn')?.addEventListener('click', closeEventSelectorModal);
            
            // Listener do overlay para fechar ao clicar fora
            document.getElementById('checkin-event-selector-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'checkin-event-selector-modal') {
                    closeEventSelectorModal();
                }
            });
            
            // Função para abrir modal de seleção de evento
            async function openEventSelectorModal() {
                if (!isTeamLeader || !userTeamLeadership || userTeamLeadership.length === 0) {
                    console.log('🔍 Check-in: Usuário não é líder de time');
                    return;
                }

                try {
                    const { collection, query, where, getDocs } = window.firestoreMethods;
                    const now = new Date();
                    const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));

                    console.log('🔍 Check-in: Buscando eventos dos últimos 30 dias');

                    // Buscar escalas dos times que lidera
                    const escalasRef = collection(window.firebaseDb, 'escalas');
                    const q = query(escalasRef, where('team', 'in', userTeamLeadership));
                    const snapshot = await getDocs(q);

                    const eventsInLast30Days = [];
                    snapshot.forEach(doc => {
                        const escala = { id: doc.id, ...doc.data() };
                        const eventDateTime = new Date(escala.date + 'T' + escala.time);
                        
                        // Verificar se está nos últimos 30 dias
                        if (eventDateTime >= thirtyDaysAgo && eventDateTime <= now) {
                            eventsInLast30Days.push({ ...escala, eventDateTime });
                        }
                    });

                    console.log('🔍 Check-in: Eventos encontrados (últimos 30 dias):', eventsInLast30Days.length);

                    if (eventsInLast30Days.length === 0) {
                        showModal('📭 Não há eventos nos últimos 30 dias.', false, null, false, null, '📭');
                        return;
                    }

                    // Agrupar por evento (date + time)
                    const groupedByEvent = {};
                    eventsInLast30Days.forEach(escala => {
                        const key = `${escala.date}_${escala.time}`;
                        if (!groupedByEvent[key]) {
                            groupedByEvent[key] = {
                                date: escala.date,
                                time: escala.time,
                                eventName: escala.eventName,
                                eventDateTime: escala.eventDateTime,
                                teams: {}
                            };
                        }
                        if (!groupedByEvent[key].teams[escala.team]) {
                            groupedByEvent[key].teams[escala.team] = [];
                        }
                        groupedByEvent[key].teams[escala.team].push(escala);
                    });

                    // Ordenar eventos por data/hora (mais recente primeiro)
                    const sortedEvents = Object.entries(groupedByEvent).sort((a, b) => {
                        return b[1].eventDateTime - a[1].eventDateTime; // Mais recente primeiro
                    });

                    // Renderizar lista de eventos
                    const eventsList = document.getElementById('event-selector-list');
                    eventsList.innerHTML = sortedEvents.map(([key, event]) => {
                        const dateObj = new Date(event.date + 'T' + event.time);
                        const dateStr = dateObj.toLocaleDateString('pt-BR', { 
                            weekday: 'short', 
                            day: '2-digit', 
                            month: '2-digit',
                            year: 'numeric'
                        });
                        const timeStr = event.time;
                        const eventNameDisplay = event.eventName ? ` - ${event.eventName}` : '';
                        
                        return `
                            <button class="event-selector-btn w-full p-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition text-left"
                                    data-date="${event.date}"
                                    data-time="${event.time}">
                                <div class="font-semibold text-gray-800">${dateStr}${eventNameDisplay}</div>
                                <div class="text-sm text-gray-600">🕐 ${timeStr}</div>
                            </button>
                        `;
                    }).join('');

                    // Adicionar listeners aos botões de evento
                    document.querySelectorAll('.event-selector-btn').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const selectedDate = btn.dataset.date;
                            const selectedTime = btn.dataset.time;
                            closeEventSelectorModal();
                            await loadCheckinForSpecificEvent(selectedDate, selectedTime);
                        });
                    });

                    // Mostrar modal
                    document.getElementById('checkin-event-selector-modal').classList.remove('hidden');
                } catch (error) {
                    console.error('❌ Erro ao buscar eventos:', error);
                    showModal('❌ Erro ao buscar eventos. Tente novamente.');
                }
            }

            function closeEventSelectorModal() {
                document.getElementById('checkin-event-selector-modal').classList.add('hidden');
            }

            // Função para carregar check-in de evento específico
            async function loadCheckinForSpecificEvent(date, time) {
                if (!isTeamLeader || !userTeamLeadership || userTeamLeadership.length === 0) {
                    return;
                }

                try {
                    const { collection, query, where, getDocs } = window.firestoreMethods;

                    // Buscar escalas deste evento específico para os times que lidera
                    const escalasRef = collection(window.firebaseDb, 'escalas');
                    const q = query(escalasRef, where('team', 'in', userTeamLeadership));
                    const snapshot = await getDocs(q);

                    const eventEscalas = [];
                    snapshot.forEach(doc => {
                        const escala = { id: doc.id, ...doc.data() };
                        if (escala.date === date && escala.time === time) {
                            eventEscalas.push(escala);
                        }
                    });

                    if (eventEscalas.length === 0) {
                        showModal('📭 Não há voluntários escalados para este evento.', false, null, false, null, '📭');
                        return;
                    }

                    // Agrupar por time
                    const groupedByTeam = {};
                    eventEscalas.forEach(escala => {
                        if (!groupedByTeam[escala.team]) {
                            groupedByTeam[escala.team] = [];
                        }
                        groupedByTeam[escala.team].push(escala);
                    });

                    // Criar objeto de evento para passar ao modal
                    const eventDateTime = new Date(date + 'T' + time);
                    const eventData = {
                        date: date,
                        time: time,
                        eventName: eventEscalas[0].eventName || '',
                        eventDateTime: eventDateTime,
                        teams: groupedByTeam
                    };

                    // Armazenar e abrir modal de check-in
                    currentCheckinEvents = [eventData];
                    openCheckinModal();
                } catch (error) {
                    console.error('❌ Erro ao carregar check-in do evento:', error);
                    showModal('❌ Erro ao carregar evento. Tente novamente.');
                }
            }
            
            // Menu button para abrir seleção de eventos
            document.getElementById('menu-checkin-btn')?.addEventListener('click', async () => {
                closeMenu();
                
                // Mostrar indicador de carregamento
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                loadingDiv.innerHTML = '<div class="bg-white rounded-lg p-6 shadow-2xl"><p class="text-gray-800 font-semibold">⏳ Buscando eventos...</p></div>';
                document.body.appendChild(loadingDiv);
                
                try {
                    // Primeiro tenta buscar eventos na janela automática (2h antes até 4h depois)
                    await checkForCheckinEvents();
                    loadingDiv.remove();
                    
                    // Se não houver eventos na janela, abre seletor manual
                    if (!currentCheckinEvents || currentCheckinEvents.length === 0) {
                        await openEventSelectorModal();
                    }
                    // Se houver eventos na janela, abre o modal diretamente
                } catch (error) {
                    loadingDiv.remove();
                    console.error('❌ Erro ao buscar eventos para check-in:', error);
                    showModal('❌ Erro ao buscar eventos. Tente novamente.');
                }
            });

            // ========================================
            // PRÓXIMOS CULTOS DO LÍDER
            // ========================================
            let currentEditingVolunteer = null;

            async function showLeaderUpcomingServices() {
                try {
                    const leaderTeams = userTeamLeadership || [];
                if (leaderTeams.length === 0) {
                    showModal('❌ Você não é líder de nenhum time.');
                    return;
                }

                const modal = document.getElementById('leader-upcoming-services-modal');
                const listContainer = document.getElementById('leader-services-list');
                
                listContainer.innerHTML = '<div class="text-center py-8"><p class="text-gray-600">⏳ Carregando próximos cultos...</p></div>';
                
                modal.style.display = 'flex';
                setTimeout(() => modal.classList.remove('hidden'), 10);

                // Buscar próximos eventos (próximos 30 dias)
                const today = new Date();
                const thirtyDaysFromNow = new Date(today);
                thirtyDaysFromNow.setDate(today.getDate() + 30);

                const { collection, query, where, getDocs } = window.firestoreMethods;
                const q = query(
                    collection(window.firebaseDb, 'escalas'),
                    where('date', '>=', today.toISOString().split('T')[0])
                );

                const snapshot = await getDocs(q);
                const escalas = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const escalaTeam = data.team?.toLowerCase();
                    
                    // Filtrar apenas escalas dos times que o líder gerencia
                    if (leaderTeams.includes(escalaTeam)) {
                        escalas.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });

                // Agrupar por evento (data + hora)
                const groupedEvents = {};
                escalas.forEach(escala => {
                    const key = `${escala.date}_${escala.time}`;
                    if (!groupedEvents[key]) {
                        groupedEvents[key] = {
                            date: escala.date,
                            time: escala.time,
                            eventName: escala.eventName || '',
                            teams: {}
                        };
                    }
                    const team = escala.team.toLowerCase();
                    if (!groupedEvents[key].teams[team]) {
                        groupedEvents[key].teams[team] = [];
                    }
                    groupedEvents[key].teams[team].push(escala);
                });

                // Ordenar eventos por data
                const sortedEvents = Object.values(groupedEvents).sort((a, b) => {
                    const dateA = new Date(a.date + 'T' + a.time);
                    const dateB = new Date(b.date + 'T' + b.time);
                    return dateA - dateB;
                });

                if (sortedEvents.length === 0) {
                    listContainer.innerHTML = '<div class="text-center py-8"><p class="text-gray-600">✅ Não há próximos cultos agendados.</p></div>';
                    return;
                }

                // Renderizar eventos
                renderLeaderServicesList(sortedEvents, leaderTeams);
                
            } catch (error) {
                console.error('❌ Erro ao carregar próximos cultos:', error);
                showModal('❌ Erro ao carregar escalas. Tente novamente.');
            }
        }

        function renderLeaderServicesList(events, leaderTeams) {
            const listContainer = document.getElementById('leader-services-list');
            
            const teamConfig = {
                welcome: { name: 'Welcome', icon: '👋', color: 'bg-blue-50 border-blue-300' },
                backstage: { name: 'Backstage', icon: '🤝', color: 'bg-gray-50 border-gray-300' },
                parking: { name: 'Parking', icon: '🚗', color: 'bg-red-50 border-red-300' },
                kids: { name: 'Kids', icon: '👶', color: 'bg-yellow-50 border-yellow-300' },
                comunicacao: { name: 'Comunicação', icon: '📢', color: 'bg-purple-50 border-purple-300' }
            };

            let html = '';
            
            events.forEach((event, eventIndex) => {
                const dateObj = new Date(event.date + 'T' + event.time);
                const day = dateObj.getDate().toString().padStart(2, '0');
                const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                const year = dateObj.getFullYear().toString().slice(-2);
                const eventNameDisplay = event.eventName ? event.eventName : '';
                const timeStr = event.time === '00:00' ? '' : `${event.time}`;
                
                html += `
                    <div class="mb-4 pb-4 border-b border-gray-200 last:border-b-0">
                        <div class="bg-indigo-50 border-l-4 border-indigo-500 p-3 rounded-lg mb-3">
                            <div class="font-semibold text-base text-gray-800">${day}/${month}/${year} - ${eventNameDisplay}</div>
                            ${timeStr ? `<div class="text-xs text-gray-600 mt-1">🕐 ${timeStr}</div>` : ''}
                        </div>
                `;

                // Listar apenas times que o líder gerencia
                Object.entries(event.teams).forEach(([teamKey, volunteers]) => {
                    if (!leaderTeams.includes(teamKey)) return;
                    
                    const config = teamConfig[teamKey];
                    
                    // Ordenar voluntários por função (role) alfabeticamente
                    const sortedVolunteers = volunteers.sort((a, b) => {
                        const roleA = (a.role || '').toLowerCase();
                        const roleB = (b.role || '').toLowerCase();
                        return roleA.localeCompare(roleB, 'pt-BR');
                    });
                    
                    html += `
                        <div class="border-2 rounded-lg p-2 mb-2 ${config.color}">
                            <h4 class="font-semibold mb-2 flex items-center gap-1 text-sm">
                                <span>${config.icon}</span>
                                <span>${config.name}</span>
                                <span class="text-xs text-gray-500 font-normal">(${volunteers.length})</span>
                            </h4>
                            <div class="space-y-1">
                                ${sortedVolunteers.map(v => {
                                    const photoUrl = v.userPhoto || 'Zele logo.png';
                                    const functionDisplay = v.role ? `<p class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded inline-block">${v.role}</p>` : '';
                                    
                                    return `
                                        <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-gray-200">
                                            <img src="${photoUrl}" alt="${v.userName}" class="w-8 h-8 rounded-full object-cover" onerror="this.src='Zele logo.png'">
                                            <div class="flex-1 min-w-0">
                                                <p class="font-semibold text-xs truncate">${v.userName}</p>
                                                ${functionDisplay}
                                            </div>
                                            <button class="edit-volunteer-btn flex-shrink-0 text-purple-600 hover:text-purple-800 transition"
                                                    data-escala-id="${v.id}"
                                                    data-volunteer-name="${v.userName}"
                                                    data-volunteer-email="${v.userEmail}"
                                                    data-volunteer-team="${teamKey}"
                                                    data-event-date="${event.date}"
                                                    data-event-time="${event.time}"
                                                    data-volunteer-role="${v.role || ''}">
                                                ✏️
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            listContainer.innerHTML = html;

            // Adicionar event listeners aos botões de editar
            document.querySelectorAll('.edit-volunteer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    openEditVolunteerModal({
                        escalaId: btn.dataset.escalaId,
                        volunteerName: btn.dataset.volunteerName,
                        volunteerEmail: btn.dataset.volunteerEmail,
                        team: btn.dataset.volunteerTeam,
                        eventDate: btn.dataset.eventDate,
                        eventTime: btn.dataset.eventTime,
                        role: btn.dataset.volunteerRole
                    });
                });
            });
        }

        // Event listeners dos modais
        document.getElementById('close-leader-services-modal')?.addEventListener('click', () => {
            const modal = document.getElementById('leader-upcoming-services-modal');
            modal.classList.add('hidden');
            setTimeout(() => modal.style.display = 'none', 300);
        });

        document.getElementById('leader-upcoming-services-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'leader-upcoming-services-modal') {
                const modal = document.getElementById('leader-upcoming-services-modal');
                modal.classList.add('hidden');
                setTimeout(() => modal.style.display = 'none', 300);
            }
        });

        function openEditVolunteerModal(data) {
            currentEditingVolunteer = data;
            
            document.getElementById('edit-volunteer-name').textContent = data.volunteerName;
            
            const modal = document.getElementById('edit-volunteer-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.remove('hidden'), 10);
        }

        document.getElementById('close-edit-volunteer-modal')?.addEventListener('click', () => {
            const modal = document.getElementById('edit-volunteer-modal');
            modal.classList.add('hidden');
            setTimeout(() => modal.style.display = 'none', 300);
            currentEditingVolunteer = null;
        });

        document.getElementById('edit-volunteer-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'edit-volunteer-modal') {
                const modal = document.getElementById('edit-volunteer-modal');
                modal.classList.add('hidden');
                setTimeout(() => modal.style.display = 'none', 300);
                currentEditingVolunteer = null;
            }
        });

        // Ações do modal de edição
        document.getElementById('edit-volunteer-function-btn')?.addEventListener('click', async () => {
            if (!currentEditingVolunteer) return;

            // Carregar funções do time
            await loadTeamRoles();
            const teamRoles = teamRolesData[currentEditingVolunteer.team] || [];
            
            let optionsHtml = '<option value="">Nenhuma função específica</option>';
            teamRoles.forEach(role => {
                const selected = role === currentEditingVolunteer.role ? 'selected' : '';
                optionsHtml += `<option value="${role}" ${selected}>${role}</option>`;
            });

            const roleInput = await showModalWithInput(
                '💼 Incluir/Editar Função',
                `<div class="mb-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Selecione uma função:</label>
                    <select id="role-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        ${optionsHtml}
                    </select>
                </div>
                <p class="text-xs text-gray-500 mt-2">Ou digite uma nova função personalizada:</p>`,
                'Salvar Função',
                currentEditingVolunteer.role || ''
            );

            if (roleInput !== null) {
                const selectedRole = document.getElementById('role-select')?.value || roleInput;
                await updateVolunteerFunction(currentEditingVolunteer.escalaId, selectedRole);
            }
        });

        document.getElementById('edit-volunteer-team-btn')?.addEventListener('click', async () => {
            if (!currentEditingVolunteer) return;

            const teamNames = {
                welcome: '👋 Welcome',
                backstage: '🤝 Backstage',
                parking: '🚗 Parking',
                kids: '👶 Kids',
                comunicacao: '📢 Comunicação'
            };

            let optionsHtml = '';
            Object.entries(teamNames).forEach(([key, name]) => {
                if (key !== currentEditingVolunteer.team) {
                    optionsHtml += `<option value="${key}">${name}</option>`;
                }
            });

            const modalHtml = `
                <div class="mb-3">
                    <p class="text-sm text-gray-600 mb-3">Time atual: <strong>${teamNames[currentEditingVolunteer.team]}</strong></p>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Transferir para:</label>
                    <select id="team-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        ${optionsHtml}
                    </select>
                </div>
            `;

            showModal(modalHtml, true, async () => {
                const newTeam = document.getElementById('team-select')?.value;
                if (newTeam) {
                    await changeVolunteerTeam(currentEditingVolunteer.escalaId, newTeam);
                }
            }, false, 'Confirmar Mudança', '🔄');
        });

        document.getElementById('edit-volunteer-delete-btn')?.addEventListener('click', async () => {
            if (!currentEditingVolunteer) return;

            showModal(
                `⚠️ Tem certeza que deseja <strong>excluir ${currentEditingVolunteer.volunteerName}</strong> desta escala?<br><br>Esta ação não pode ser desfeita.`,
                true,
                async () => await deleteVolunteerFromSchedule(currentEditingVolunteer.escalaId),
                false,
                'Sim, Excluir',
                '🗑️'
            );
        });

        async function updateVolunteerFunction(escalaId, newRole) {
            try {
                const { doc, updateDoc } = window.firestoreMethods;
                const escalaRef = doc(window.firebaseDb, 'escalas', escalaId);

                await updateDoc(escalaRef, {
                    role: newRole || null,
                    leaderModificationDate: new Date().toISOString(),
                    leaderModificationBy: currentUser.uid
                });

                // Se a função é personalizada (não está no dropdown), adicionar ao cadastro de funções
                if (newRole) {
                    const teamRoles = teamRolesData[currentEditingVolunteer.team] || [];
                    
                    // Verificar se a função já existe (case-insensitive)
                    const existingFunction = teamRoles.find(role => 
                        role.toLowerCase().trim() === newRole.toLowerCase().trim()
                    );
                    
                    if (existingFunction) {
                        // Função já existe - avisar o líder
                        console.log('⚠️ Função já existe no cadastro:', existingFunction);
                        showModal(`⚠️ A função "<strong>${existingFunction}</strong>" já existe no cadastro do time.<br><br>Será utilizada a versão já cadastrada.`, false, null, false, null, '📝');
                    } else {
                        // Função é nova - adicionar ao cadastro
                        // Normalizar: primeira letra maiúscula, restante minúsculo
                        const normalizedRole = newRole.trim().charAt(0).toUpperCase() + newRole.trim().slice(1).toLowerCase();
                        teamRolesData[currentEditingVolunteer.team] = [...teamRoles, normalizedRole];
                        await saveTeamRoles();
                        console.log('✅ Função personalizada salva ao cadastro:', normalizedRole);
                        showModal(`✅ Função "<strong>${normalizedRole}</strong>" adicionada ao cadastro do time!`, false, null, false, null, '📝');
                    }
                }

                // Log de auditoria
                await logAudit('LEADER_UPDATE_FUNCTION', {
                    escalaId: escalaId,
                    volunteerName: currentEditingVolunteer.volunteerName,
                    newRole: newRole || 'Nenhuma',
                    leaderName: currentUser.displayName || currentUser.email,
                    leaderId: currentUser.uid,
                    eventDate: currentEditingVolunteer.eventDate,
                    eventTime: currentEditingVolunteer.eventTime
                });

                showModal('✅ Função atualizada com sucesso!');
                
                // Fechar modal de edição e recarregar lista
                document.getElementById('edit-volunteer-modal').classList.add('hidden');
                setTimeout(() => document.getElementById('edit-volunteer-modal').style.display = 'none', 300);
                await showLeaderUpcomingServices();

            } catch (error) {
                console.error('❌ Erro ao atualizar função:', error);
                showModal('❌ Erro ao atualizar função. Tente novamente.');
            }
        }

        async function changeVolunteerTeam(escalaId, newTeam) {
            try {
                const { doc, updateDoc } = window.firestoreMethods;
                const escalaRef = doc(window.firebaseDb, 'escalas', escalaId);

                const teamNames = {
                    welcome: '👋 Welcome',
                    backstage: '🤝 Backstage',
                    parking: '🚗 Parking',
                    kids: '👶 Kids',
                    comunicacao: '📢 Comunicação'
                };

                const modification = `Transferido do time ${teamNames[currentEditingVolunteer.team]} para ${teamNames[newTeam]} pelo líder`;

                await updateDoc(escalaRef, {
                    team: newTeam,
                    leaderModification: modification,
                    leaderModificationDate: new Date().toISOString(),
                    leaderModificationBy: currentUser.uid
                });

                // Log de auditoria
                await logAudit('LEADER_CHANGE_TEAM', {
                    escalaId: escalaId,
                    volunteerName: currentEditingVolunteer.volunteerName,
                    oldTeam: currentEditingVolunteer.team,
                    newTeam: newTeam,
                    leaderName: currentUser.displayName || currentUser.email,
                    leaderId: currentUser.uid,
                    eventDate: currentEditingVolunteer.eventDate,
                    eventTime: currentEditingVolunteer.eventTime
                });

                showModal('✅ Voluntário transferido com sucesso!');
                
                // Fechar modal de edição e recarregar lista
                document.getElementById('edit-volunteer-modal').classList.add('hidden');
                setTimeout(() => document.getElementById('edit-volunteer-modal').style.display = 'none', 300);
                await showLeaderUpcomingServices();

            } catch (error) {
                console.error('❌ Erro ao mudar time:', error);
                showModal('❌ Erro ao mudar time. Tente novamente.');
            }
        }

        async function deleteVolunteerFromSchedule(escalaId) {
            try {
                const { doc, deleteDoc } = window.firestoreMethods;
                const escalaRef = doc(window.firebaseDb, 'escalas', escalaId);

                // Log de auditoria antes de deletar
                await logAudit('LEADER_DELETE_VOLUNTEER', {
                    escalaId: escalaId,
                    volunteerName: currentEditingVolunteer.volunteerName,
                    volunteerEmail: currentEditingVolunteer.volunteerEmail,
                    team: currentEditingVolunteer.team,
                    leaderName: currentUser.displayName || currentUser.email,
                    leaderId: currentUser.uid,
                    eventDate: currentEditingVolunteer.eventDate,
                    eventTime: currentEditingVolunteer.eventTime
                });

                await deleteDoc(escalaRef);

                showModal('✅ Voluntário removido da escala com sucesso!');
                
                // Fechar modal de edição e recarregar lista
                document.getElementById('edit-volunteer-modal').classList.add('hidden');
                setTimeout(() => document.getElementById('edit-volunteer-modal').style.display = 'none', 300);
                await showLeaderUpcomingServices();

            } catch (error) {
                console.error('❌ Erro ao excluir voluntário:', error);
                showModal('❌ Erro ao excluir voluntário. Tente novamente.');
            }
        }
        
            console.log('✅ App inicializado');
        } // FIM de initApp()
        
        // ========================================
        // 🤖 ANÁLISE COM IA (GOOGLE GEMINI)
        // ========================================
        // CONFIGURE SUA CHAVE DA API AQUI (obtenha GRÁTIS em: https://aistudio.google.com/app/apikey)
        const AI_API_KEY = 'AIzaSyCDAgkCHHKbP41f8pxSLc9nHKOHXnOYbLk'; // Substitua por sua chave do Google Gemini
        const AI_MODEL = 'gemini-2.5-flash'; // Modelo solicitado
        let aiModelsLogged = false; // Evita spam de logs ao listar modelos
        
        const aiModal = document.getElementById('ai-analysis-modal');
        const aiConfigWarning = document.getElementById('ai-config-warning');
        const aiChatArea = document.getElementById('ai-chat-area');
        const aiMessages = document.getElementById('ai-messages');

        // Diagnóstico: listar modelos disponíveis para a chave atual
        async function logAvailableModels() {
            if (aiModelsLogged || !AI_API_KEY) return;
            aiModelsLogged = true;
            try {
                const resV1 = await fetch(`https://generativelanguage.googleapis.com/v1/models?key=${AI_API_KEY}`);
                const dataV1 = await resV1.json();
                console.log('📋 Modelos (v1):', dataV1);
            } catch (err) {
                console.warn('⚠️ Não foi possível listar modelos v1:', err?.message || err);
            }

            try {
                const resV1b = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${AI_API_KEY}`);
                const dataV1b = await resV1b.json();
                console.log('📋 Modelos (v1beta):', dataV1b);
            } catch (err) {
                console.warn('⚠️ Não foi possível listar modelos v1beta:', err?.message || err);
            }
        }

        // Verificar se a chave foi configurada
        function updateAIStatus() {
            if (AI_API_KEY && AI_API_KEY !== 'COLE_SUA_CHAVE_AQUI') {
                aiConfigWarning.classList.add('hidden');
                aiChatArea.classList.remove('hidden');
            } else {
                aiConfigWarning.classList.remove('hidden');
                aiChatArea.classList.add('hidden');
            }
        }

        // Abrir modal de IA
        document.getElementById('menu-ai-analysis-btn')?.addEventListener('click', () => {
            // Fechar menu manualmente
            const menuOverlay = document.querySelector('.menu-overlay');
            const menuDrawer = document.querySelector('.menu-drawer');
            if (menuOverlay) menuOverlay.classList.remove('show');
            if (menuDrawer) menuDrawer.classList.remove('show');
            
            updateAIStatus();
            aiModal.classList.remove('hidden');
            aiModal.style.display = 'flex';
        });

        // Fechar modal de IA
        document.getElementById('close-ai-modal')?.addEventListener('click', () => {
            aiModal.classList.add('hidden');
            aiModal.style.display = 'none';
        });

        document.getElementById('close-ai-modal-btn')?.addEventListener('click', () => {
            aiModal.classList.add('hidden');
            aiModal.style.display = 'none';
        });

        aiModal?.addEventListener('click', (e) => {
            if (e.target === aiModal) {
                aiModal.classList.add('hidden');
                aiModal.style.display = 'none';
            }
        });

        // Removido: configuração manual da chave (agora é fixa no código)

        // Função para obter contexto dos dados
        async function getAnalysisContext() {
            try {
                const { collection, getDocs, query, where } = window.firestoreMethods;
                
                // Buscar todos os usuários (voluntários)
                const usersRef = collection(window.firebaseDb, 'users');
                const usersSnapshot = await getDocs(usersRef);
                const volunteers = [];
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    volunteers.push({
                        id: doc.id,
                        name: data.name || data.displayName || 'Sem nome',
                        email: data.email || '',
                        preferences: data.preferences || [],
                        blockedDates: data.blockedDates || []
                    });
                });

                // Buscar todas as escalas
                const escalasRef = collection(window.firebaseDb, 'escalas');
                const escalasSnapshot = await getDocs(escalasRef);
                const escalas = [];
                
                escalasSnapshot.forEach(doc => {
                    const data = doc.data();
                    escalas.push({
                        id: doc.id,
                        volunteer: data.userName || data.volunteerName || '',
                        team: data.team || '',
                        date: data.date || '',
                        role: data.role || '',
                        status: data.status || 'approved'
                    });
                });

                return {
                    volunteers,
                    escalas,
                    totalVolunteers: volunteers.length,
                    totalEscalas: escalas.length
                };
            } catch (error) {
                console.error('Erro ao buscar contexto:', error);
                return { volunteers: [], escalas: [], totalVolunteers: 0, totalEscalas: 0 };
            }
        }

        // Função para enviar mensagem à IA
        async function sendAIQuestion(question) {
            if (!AI_API_KEY || AI_API_KEY === 'COLE_SUA_CHAVE_AQUI') {
                showModal('⚠️ A chave da API não foi configurada no código. Entre em contato com o administrador.');
                return;
            }

            // Adicionar mensagem do usuário
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'flex gap-3 justify-end';
            userMessageDiv.innerHTML = `<div class="bg-blue-500 text-white p-3 rounded-lg rounded-tr-none max-w-xs">
                <p class="text-sm">${escapeHtml(question)}</p>
            </div>`;
            aiMessages.appendChild(userMessageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;

            // Mostrar loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex gap-3';
            loadingDiv.innerHTML = `<span class="text-2xl">🤖</span><div class="bg-gray-200 p-3 rounded-lg"><p class="text-sm text-gray-600">Analisando...</p></div>`;
            aiMessages.appendChild(loadingDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;

            try {
                // Obter contexto dos dados
                const context = await getAnalysisContext();
                
                // Preparar contexto para a IA
                const volunteersJson = JSON.stringify(context.volunteers, null, 2);
                const escalasJson = JSON.stringify(context.escalas, null, 2);
                
                const prompt = `Você é um assistente de análise de dados para um sistema de escalas de voluntários chamado Zele Serve.

CONTEXTO DOS DADOS:
- Total de voluntários: ${context.totalVolunteers}
- Total de escalas: ${context.totalEscalas}

DADOS DOS VOLUNTÁRIOS:
${volunteersJson}

DADOS DAS ESCALAS:
${escalasJson}

INSTRUÇÕES:
- Responda em português (Brasil)
- Seja conciso e direto
- Baseie suas respostas apenas nos dados fornecidos
- Se não conseguir responder, explique por que
- Use formatação clara com listas quando apropriado

PERGUNTA DO USUÁRIO: ${question}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/${AI_MODEL}:generateContent?key=${AI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1024
                        }
                    })
                });

                loadingDiv.remove();

                if (!response.ok) {
                    const error = await response.json();
                    await logAvailableModels(); // Diagnosticar modelos liberados para esta chave
                    throw new Error(error.error?.message || 'Erro ao processar requisição');
                }

                const data = await response.json();
                const aiResponse = data.candidates[0]?.content?.parts[0]?.text || 'Desculpe, não consegui gerar uma resposta.';

                // Adicionar resposta da IA
                const aiResponseDiv = document.createElement('div');
                aiResponseDiv.className = 'flex gap-3';
                aiResponseDiv.innerHTML = `<span class="text-2xl">🤖</span><div class="bg-white p-3 rounded-lg rounded-tl-none border border-gray-200">
                    <p class="text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(aiResponse)}</p>
                </div>`;
                aiMessages.appendChild(aiResponseDiv);
                aiMessages.scrollTop = aiMessages.scrollHeight;

            } catch (error) {
                console.error('Erro ao chamar IA:', error);
                await logAvailableModels(); // Apenas primeira vez, para diagnóstico
                loadingDiv.remove();
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'flex gap-3';
                errorDiv.innerHTML = `<span class="text-2xl">🤖</span><div class="bg-red-100 p-3 rounded-lg">
                    <p class="text-sm text-red-800">❌ Erro: ${error.message}</p>
                </div>`;
                aiMessages.appendChild(errorDiv);
                aiMessages.scrollTop = aiMessages.scrollHeight;
            }
        }

        // Função para escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listener para enviar pergunta
        document.getElementById('ai-send-btn')?.addEventListener('click', () => {
            const input = document.getElementById('ai-question-input');
            const question = input.value.trim();
            
            if (!question) return;
            
            sendAIQuestion(question);
            input.value = '';
            input.focus();
        });

        // Enviar com Enter
        document.getElementById('ai-question-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('ai-send-btn').click();
            }
        });

        // Inicializar status de IA ao carregar
        updateAIStatus();

        // ========================================
        // SERVICE WORKER (PWA) - HABILITADO
        // ========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // GitHub Pages na raiz do repositório
                const swPath = '/zele/service-worker.js';
                
                navigator.serviceWorker.register(swPath)
                    .then(reg => console.log('✅ Service Worker registrado:', swPath))
                    .catch(err => console.log('⚠️ Service Worker não disponível:', err.message));
            });
        }
        
        
        // Iniciar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>

