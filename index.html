<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zele Server</title>
    <meta name="application-name" content="Zele Server">
    <meta name="apple-mobile-web-app-title" content="Zele Server">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#151b29">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://github.com/escalaserver/zele/blob/main/Volunteers%20logo.png?raw=true">
    <link rel="icon" type="image/png" href="https://github.com/escalaserver/zele/blob/main/Volunteers%20logo.png?raw=true">
    
    <!-- Meta tags adicionais para Windows/Desktop PWA -->
    <meta name="msapplication-TileColor" content="#151b29">
    <meta name="msapplication-TileImage" content="https://github.com/escalaserver/zele/blob/main/Volunteers%20logo.png?raw=true">
    <meta name="msapplication-config" content="none">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- Chart.js para Dashboards -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, orderBy, addDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        console.log('üî• Firebase imports carregados - vers√£o com orderBy, addDoc, updateDoc e Storage');
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBGMYUmA0hJs1v2IlU-fdFDucYFp6LZaCg",
            authDomain: "z-ele-church-escalas.firebaseapp.com",
            projectId: "z-ele-church-escalas",
            storageBucket: "z-ele-church-escalas.firebasestorage.app",
            messagingSenderId: "473523773124",
            appId: "1:473523773124:web:9c57a51236a5a8fabc3391"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();
        
        // For√ßar sele√ß√£o de conta ao fazer login
        provider.setCustomParameters({
            prompt: 'select_account'
        });
        
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseProvider = provider;
        window.firebaseAuthMethods = { signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile };
        window.firestoreMethods = { doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, orderBy, addDoc, updateDoc };
        window.firebaseStorageMethods = { ref, uploadBytes, getDownloadURL };
        
        console.log('‚úÖ Firebase inicializado e exportado para window');
        window.firebaseReady = true;
    </script>
    
    <!-- Tailwind CDN: Para produ√ß√£o, considere instalar via npm e usar build process -->
    <!-- Veja: https://tailwindcss.com/docs/installation -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #cdc8c0; }
        .zele-primary { background-color: #151b29; }
        .zele-secondary { background-color: #151b29; }
        .zele-secondary-hover:hover { background-color: #1f2937; }
        .zele-tertiary { background-color: #cdc8c0; }
        .zele-btn {
            background-color: #151b29;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
            border: 1px solid #e5e5e5;
            transition: all 0.2s ease;
        }
        .zele-btn:hover {
            background-color: #1f2937;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        .zele-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .card-float {
            background-color: white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            border: 2px solid #e5e5e5;
        }
        .modal-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 9999; 
            align-items: center; 
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .menu-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }
        .menu-overlay.show { display: block; }
        .menu-drawer {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        .menu-drawer.show { right: 0; }
        .team-btn {
            background-color: #151b29;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
            border: 1px solid #e5e5e5;
            transition: all 0.2s ease;
            padding: 0;
            overflow: hidden;
        }
        .team-btn:hover {
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.25);
            transform: translateY(-2px);
        }
        .team-btn.selected {
            background-color: #377db8;
            border-color: #377db8;
            box-shadow: 0 0 0 3px rgba(55, 125, 184, 0.3);
        }
        .team-btn img {
            width: 100%;
            height: auto;
            display: block;
        }
        .team-btn .team-name-fallback {
            display: none;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-align: center;
            padding: 2rem 1rem;
            background-color: #151b29;
        }
        .team-btn img.error + .team-name-fallback {
            display: block;
        }
        @keyframes blink-border {
            0%, 100% { 
                box-shadow: 0 0 0 0px #377db8;
                border-color: #d1d5db;
            }
            50% { 
                box-shadow: 0 0 0 4px #377db8;
                border-color: #377db8;
            }
        }
        @-webkit-keyframes blink-border {
            0%, 100% { 
                box-shadow: 0 0 0 0px #377db8;
                border-color: #d1d5db;
            }
            50% { 
                box-shadow: 0 0 0 4px #377db8;
                border-color: #377db8;
            }
        }
        .blink-border {
            animation: blink-border 0.2s ease-in-out 4;
            -webkit-animation: blink-border 0.2s ease-in-out 4;
        }
        @keyframes pulse-team {
            0%, 100% { border: 1px solid #e5e5e5; }
            50% { border: 10px solid #cdc8c0; }
        }
        @-webkit-keyframes pulse-team {
            0%, 100% { border: 1px solid #e5e5e5; }
            50% { border: 10px solid #cdc8c0; }
        }
        .pulse-team {
            animation: pulse-team 0.8s ease-in-out 1;
            -webkit-animation: pulse-team 0.8s ease-in-out 1;
        }
        @keyframes pulse-save {
            0%, 100% { border: 2px solid transparent; }
            50% { border: 5px solid #cdc8c0; }
        }
        @-webkit-keyframes pulse-save {
            0%, 100% { border: 2px solid transparent; }
            50% { border: 5px solid #cdc8c0; }
        }
        .pulse-save {
            animation: pulse-save 0.5s ease-in-out 2;
            -webkit-animation: pulse-save 0.5s ease-in-out 2;
        }
        
        /* Onboarding Styles */
        .onboarding-team-btn {
            transition: all 0.3s ease;
        }
        .onboarding-team-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .day-toggle-btn {
            transition: all 0.2s ease;
        }
        .period-btn {
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        .period-btn:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body style="background-color: #cdc8c0;">
    
    <!-- Tela de Loading -->
    <div id="loading-screen" class="fixed inset-0 zele-primary flex items-center justify-center z-50">
        <div class="text-center text-white">
            <img src="Volunteers logo.png" alt="Zele Server" class="w-32 h-32 mx-auto mb-4 object-contain">
            <h1 class="text-5xl font-bold mb-4">Zele Server</h1>
            <p class="text-xl mb-8">Sistema de Escalas</p>
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-white mx-auto"></div>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="auth-screen" class="fixed inset-0 zele-primary flex items-center justify-center p-4 hidden">
        <div class="card-float rounded-2xl p-8 max-w-md w-full text-center">
            <img src="Volunteers logo.png" alt="Zele Server" class="w-24 h-24 mx-auto mb-4 object-contain">
            <h1 class="text-4xl font-bold mb-2" style="color: #151b29;">Zele Server</h1>
            <p class="text-gray-600 mb-8">Sistema de Escalas</p>
            
            <!-- Login com Google -->
            <button id="google-login-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-3">
                <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Entrar com Google
            </button>
            
            <!-- Link para login com email -->
            <button id="show-email-login" class="text-sm text-gray-600 hover:text-gray-800 mt-4 underline">
                Se n√£o tem Google, clique aqui
            </button>
        </div>
    </div>

    <!-- Modal de Login com Email -->
    <div id="email-login-modal" class="modal-overlay">
        <div class="card-float rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold" style="color: #151b29;">Login com Email</h2>
                <button id="close-email-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Formul√°rio de Login -->
            <div id="login-form">
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Email</label>
                    <input type="email" id="login-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="seu@email.com">
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Senha</label>
                    <input type="password" id="login-password" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button id="email-login-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg mb-3">
                    Entrar
                </button>
                <div class="text-center space-y-2">
                    <button id="show-register-form" class="text-sm text-gray-600 hover:text-gray-800 underline">
                        N√£o tem conta? Cadastre-se
                    </button>
                    <br>
                    <button id="show-reset-password" class="text-sm text-gray-600 hover:text-gray-800 underline">
                        Esqueci minha senha
                    </button>
                </div>
            </div>
            
            <!-- Formul√°rio de Cadastro -->
            <div id="register-form" style="display: none;">
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Nome</label>
                    <input type="text" id="register-name" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="Nome">
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Sobrenome</label>
                    <input type="text" id="register-lastname" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="Sobrenome">
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Email</label>
                    <input type="email" id="register-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="seu@email.com">
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Senha</label>
                    <div class="relative">
                        <input type="password" id="register-password" class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-12 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="M√≠nimo 6 caracteres">
                        <button type="button" id="toggle-register-password" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <svg id="eye-icon-register" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Confirmar Senha</label>
                    <div class="relative">
                        <input type="password" id="register-password-confirm" class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-12 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="Digite a senha novamente">
                        <button type="button" id="toggle-register-password-confirm" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <svg id="eye-icon-register-confirm" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <button id="email-register-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg mb-3">
                    Cadastrar
                </button>
                <div class="text-center">
                    <button id="show-login-form" class="text-sm text-gray-600 hover:text-gray-800 underline">
                        J√° tem conta? Fa√ßa login
                    </button>
                </div>
            </div>
            
            <!-- Formul√°rio de Recupera√ß√£o de Senha -->
            <div id="reset-password-form" style="display: none;">
                <p class="text-sm text-gray-600 mb-4 text-left">Digite seu email para receber o link de recupera√ß√£o de senha.</p>
                <div class="mb-4">
                    <label class="block text-left text-sm font-semibold mb-2" style="color: #151b29;">Email</label>
                    <input type="email" id="reset-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2" style="--tw-ring-color: #151b29;" placeholder="seu@email.com">
                </div>
                <button id="send-reset-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg mb-3">
                    Enviar Link de Recupera√ß√£o
                </button>
                <div class="text-center">
                    <button id="back-to-login" class="text-sm text-gray-600 hover:text-gray-800 underline">
                        Voltar para login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- App Principal -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Zele Server</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-semibold" id="user-name">Usu√°rio</p>
                            <p class="text-xs opacity-90" id="user-email">email@example.com</p>
                        </div>
                        <button id="user-photo-btn" class="relative cursor-pointer" style="background: none; border: none; padding: 0;">
                            <img id="user-photo" src="" alt="Foto" class="w-10 h-10 rounded-full border-2 border-white">
                            <span id="header-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center" style="box-shadow: 0 2px 4px rgba(0,0,0,0.3);">0</span>
                        </button>
                        <button id="menu-btn" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conte√∫do Principal -->
        <main class="container mx-auto px-4 py-8 max-w-6xl">
            
            <!-- Criar Nova Escala -->
            <div class="card-float rounded-xl p-6 mb-8">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1" style="color: #151b29;">Escolha seu dia de servir</h2>
                    <p class="text-sm text-gray-600 mb-3"><strong>1¬∫ - Comece escolhendo o dia na lista</strong></p>
                    <select id="culto-select" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 text-base" style="--tw-ring-color: #151b29; border-color: #e5e5e5;">
                        <option value="">Escolha uma data...</option>
                        <!-- Datas ser√£o carregadas dinamicamente pelo admin -->
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2" style="color: #151b29;">2¬∫ - Em qual equipe voc√™ vai servir nesta data?</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button class="team-btn rounded-lg" data-team="welcome" 
                                data-img-normal="Logo Welcome horizontal.png"
                                data-img-selected="Welcome azul claro.png">
                            <img src="Logo Welcome horizontal.png" alt="Welcome" onerror="this.classList.add('error');this.style.display='none';">
                            <div class="team-name-fallback">WELCOME</div>
                        </button>
                        <button class="team-btn rounded-lg" data-team="backstage"
                                data-img-normal="Logo Backstage horizontal.png"
                                data-img-selected="Backstage azul claro.png">
                            <img src="Logo Backstage horizontal.png" alt="Backstage" onerror="this.classList.add('error');this.style.display='none';">
                            <div class="team-name-fallback">BACKSTAGE</div>
                        </button>
                        <button class="team-btn rounded-lg" data-team="parking"
                                data-img-normal="Logo Parking horizontal.png"
                                data-img-selected="Parking azul claro.png">
                            <img src="Logo Parking horizontal.png" alt="Parking" onerror="this.classList.add('error');this.style.display='none';">
                            <div class="team-name-fallback">PARKING</div>
                        </button>
                        <button class="team-btn rounded-lg" data-team="kids"
                                data-img-normal="Logo Kids horizontal.png"
                                data-img-selected="Kids azul claro.png">
                            <img src="Logo Kids horizontal.png" alt="Kids" onerror="this.classList.add('error');this.style.display='none';">
                            <div class="team-name-fallback">KIDS</div>
                        </button>
                    </div>
                </div>

                <div class="mt-6">
                    <label class="block text-sm font-semibold mb-2" style="color: #151b29;">3¬∫ - Salve a data e time que vai servir</label>
                    <button id="save-escala-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg">
                        üíæ Salvar Escala
                    </button>
                </div>
            </div>

            <!-- Calend√°rio/Lista de Escalas -->
            <div class="card-float rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold" style="color: #151b29;">üìÖ Minhas Escalas</h2>
                    <select id="filter-minhas-escalas" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" style="border-color: #e5e5e5;">
                        <option value="">Todas as datas</option>
                    </select>
                </div>
                <div id="escalas-list" class="space-y-4">
                    <!-- Escalas ser√£o inseridas aqui -->
                </div>
            </div>

            <!-- Vis√£o Geral (Admin) -->
            <div class="card-float rounded-xl p-6 mt-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold" style="color: #151b29;">üë• Vis√£o Geral dos Times</h2>
                    <select id="filter-visao-geral" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" style="border-color: #e5e5e5;">
                        <option value="">Todas as datas</option>
                    </select>
                </div>
                <div id="admin-view" class="space-y-4">
                    <!-- Vis√£o geral ser√° inserida aqui -->
                </div>
            </div>

        </main>
    </div>

    <!-- P√°gina de Administra√ß√£o (apenas para admins) - Tela separada -->
    <div id="admin-page" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="back-from-admin" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Datas dos Eventos</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conte√∫do da p√°gina de Admin -->
        <main class="container mx-auto px-4 py-8 max-w-6xl">
            <div class="card-float rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-6" style="color: #151b29;">‚öôÔ∏è Gerenciar Sistema</h2>
                <!-- Adicionar Nova Data -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border-2" style="border-color: #377db8;">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">‚ûï Adicionar Nova Data</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-semibold mb-1" style="color: #151b29;">Data</label>
                            <input type="date" id="admin-new-date" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <span id="date-error" class="text-xs text-red-600 hidden mt-1"></span>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1" style="color: #151b29;">Hor√°rio</label>
                            <input type="time" id="admin-new-time" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <span id="time-error" class="text-xs text-red-600 hidden mt-1"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-semibold mb-1" style="color: #151b29;">Nome do Evento (opcional)</label>
                        <input type="text" id="admin-new-event" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Culto de Domingo, Quinta do Encontro, etc.">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-semibold mb-2" style="color: #151b29;">Limite de Volunt√°rios por Time</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">üëã Welcome</label>
                                <input type="number" id="admin-limit-welcome" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="4" min="1" max="20" value="4">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">ü§ù Backstage</label>
                                <input type="number" id="admin-limit-backstage" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="4" min="1" max="20" value="4">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">üöó Parking</label>
                                <input type="number" id="admin-limit-parking" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="4" min="1" max="20" value="4">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">üë∂ Kids</label>
                                <input type="number" id="admin-limit-kids" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="4" min="1" max="20" value="4">
                            </div>
                        </div>
                        <span id="limit-error" class="text-xs text-red-600 hidden mt-1"></span>
                        <p class="text-xs text-gray-500 mt-2">N√∫mero m√°ximo de volunt√°rios por time para este evento</p>
                    </div>
                    <button id="admin-add-date-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg">
                        ‚ûï Adicionar Data
                    </button>
                </div>

                <!-- Gerenciar Datas Existentes -->
                <div class="p-4 bg-gray-50 rounded-lg border-2 border-gray-300">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">üìã Gerenciar Datas Cadastradas</h3>
                    <div id="admin-dates-list" class="space-y-2">
                        <!-- Lista de datas ser√° inserida aqui -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- P√°gina de Gerenciar Administradores -->
    <div id="manage-admins-page" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="back-from-manage-admins" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Gerenciar Acesso</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conte√∫do -->
        <main class="container mx-auto px-4 py-8 max-w-4xl">
            <div class="card-float rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4" style="color: #151b29;">üë• Usu√°rios do Sistema</h2>
                <p class="text-sm text-gray-600 mb-6">Gerencie permiss√µes, bloqueie acesso ou exclua usu√°rios do sistema.</p>
                
                <!-- Lista de Usu√°rios -->
                <div id="users-list" class="space-y-3">
                    <div class="flex items-center justify-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: #377db8;"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- P√°gina de Dashboard -->
    <div id="dashboard-page" class="hidden">
        <!-- Header -->
        <header class="zele-primary text-white" style="box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="back-from-dashboard" class="zele-btn p-2 rounded-lg">
                            <svg class="w-6 h-6" fill="none" stroke="white" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <img src="Volunteers logo.png" alt="Logo" class="w-10 h-10 object-contain">
                        <h1 class="text-2xl font-bold">Dashboard</h1>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conte√∫do -->
        <main class="container mx-auto px-4 py-6 max-w-7xl">
            <!-- Filtros -->
            <div class="card-float rounded-xl p-4 mb-6">
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between">
                    <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center flex-1">
                        <label class="font-semibold text-gray-700 text-sm">üìÖ Per√≠odo:</label>
                        <select id="dashboard-period" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="-7">√öltimos 7 dias</option>
                            <option value="-30">√öltimos 30 dias</option>
                            <option value="30" selected>Pr√≥ximos 30 dias</option>
                            <option value="-90">√öltimos 3 meses</option>
                            <option value="-180">√öltimos 6 meses</option>
                            <option value="-365">√öltimo ano</option>
                            <option value="all">Todo o per√≠odo</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        
                        <div id="custom-date-range" class="hidden flex gap-2 items-center">
                            <input type="date" id="date-from" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-500">at√©</span>
                            <input type="date" id="date-to" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <button id="refresh-dashboard" class="zele-btn text-white font-bold py-2 px-6 rounded-lg text-sm whitespace-nowrap">
                        üîÑ Atualizar
                    </button>
                </div>
            </div>

            <!-- Grid de Gr√°ficos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Gr√°fico 1: Times com Menos de 5 Volunt√°rios (ALERTA) -->
                <div class="card-float rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg" style="color: #151b29;">üö® Times com Menos de 5 Volunt√°rios</h3>
                        <div class="flex gap-2">
                            <button id="chart4-prev" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm" title="Anterior">‚Üê</button>
                            <button id="chart4-next" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm" title="Pr√≥ximo">‚Üí</button>
                        </div>
                    </div>
                    <div class="h-64 cursor-pointer" title="Clique nas barras para ver detalhes">
                        <canvas id="chart-empty-teams"></canvas>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">
                        <span class="inline-block w-3 h-3 rounded mr-1" style="background-color: rgba(254, 240, 138, 0.8);"></span> 1 time
                        <span class="inline-block w-3 h-3 rounded mr-1 ml-3" style="background-color: rgba(234, 179, 8, 0.8);"></span> 2 times
                        <span class="inline-block w-3 h-3 rounded mr-1 ml-3" style="background-color: rgba(249, 115, 22, 0.8);"></span> 3 times
                        <span class="inline-block w-3 h-3 rounded mr-1 ml-3" style="background-color: rgba(239, 68, 68, 0.8);"></span> 4 times
                    </p>
                    <p class="text-xs text-gray-400 mt-2 text-center">‚Üê Use as setas para navegar ‚Üí</p>
                </div>

                <!-- Gr√°fico 2: Quantidade de Volunt√°rios por Dia -->
                <div class="card-float rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-lg" style="color: #151b29;">üìÜ Quantidade de Volunt√°rios por Dia</h3>
                        <div class="flex gap-2">
                            <button id="chart3-prev" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm" title="Anterior">‚Üê</button>
                            <button id="chart3-next" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm" title="Pr√≥ximo">‚Üí</button>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="chart-events"></canvas>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-center">‚Üê Use as setas para navegar ‚Üí</p>
                </div>

                <!-- Gr√°fico 3: Volunt√°rios √önicos por Time -->
                <div class="card-float rounded-xl p-6">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">üìä Volunt√°rios √önicos por Time</h3>
                    <div class="h-64">
                        <canvas id="chart-teams"></canvas>
                    </div>
                </div>

                <!-- Gr√°fico 4: Ranking de Volunt√°rios com mais Escalas -->
                <div class="card-float rounded-xl p-6">
                    <h3 class="font-bold text-lg mb-4" style="color: #151b29;">üìà Ranking de Volunt√°rios com mais Escalas</h3>
                    <div class="h-64">
                        <canvas id="chart-volunteers"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Popup de Detalhes do Evento (Gr√°fico 4) -->
    <div id="chart4-popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative">
            <button id="chart4-popup-close" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <h3 class="text-xl font-bold mb-2" style="color: #151b29;" id="chart4-popup-title">Detalhes do Evento</h3>
            <p class="text-sm text-gray-600 mb-4" id="chart4-popup-date"></p>
            
            <div class="space-y-3" id="chart4-popup-teams">
                <!-- Times ser√£o inseridos aqui -->
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500 text-center">
                    üí° Times com menos de 5 volunt√°rios podem precisar de aten√ß√£o
                </p>
            </div>
        </div>
    </div>

    <!-- Popup de Detalhes do Evento com Volunt√°rios (Gr√°fico 3) - Formato 9:16 -->
    <div id="chart3-popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm relative" style="max-height: 90vh; aspect-ratio: 9/16; overflow-y: auto;">
            <button id="chart3-popup-close" class="sticky top-4 right-4 float-right z-10 bg-white rounded-full p-2 shadow-lg text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6">
                <h3 class="text-xl font-bold mb-2" style="color: #151b29;" id="chart3-popup-title">Volunt√°rios Escalados</h3>
                <p class="text-sm text-gray-600 mb-1" id="chart3-popup-date"></p>
                <p class="text-sm font-semibold text-blue-600 mb-4" id="chart3-popup-total"></p>
                
                <div class="space-y-4" id="chart3-popup-teams">
                    <!-- Times com volunt√°rios ser√£o inseridos aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gerenciar Lideran√ßa de Times -->
    <div id="team-leader-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" style="color: #151b29;">üèÜ Gerenciar Lideran√ßa</h2>
                <button id="close-team-leader-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">Volunt√°rio: <strong id="leader-user-name"></strong></p>
                <p class="text-xs text-gray-500 mb-4">Selecione os times que esta pessoa ir√° liderar:</p>
            </div>
            
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                    <input type="checkbox" class="leader-team-checkbox w-5 h-5 text-blue-600" data-team="welcome">
                    <span class="text-2xl">üëã</span>
                    <span class="font-semibold text-gray-800">Welcome</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                    <input type="checkbox" class="leader-team-checkbox w-5 h-5 text-gray-600" data-team="backstage">
                    <span class="text-2xl">ü§ù</span>
                    <span class="font-semibold text-gray-800">Backstage</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-red-50 transition">
                    <input type="checkbox" class="leader-team-checkbox w-5 h-5 text-red-600" data-team="parking">
                    <span class="text-2xl">üöó</span>
                    <span class="font-semibold text-gray-800">Parking</span>
                </label>
                
                <label class="flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer hover:bg-yellow-50 transition">
                    <input type="checkbox" class="leader-team-checkbox w-5 h-5 text-yellow-600" data-team="kids">
                    <span class="text-2xl">üë∂</span>
                    <span class="font-semibold text-gray-800">Kids</span>
                </label>
            </div>
            
            <button id="save-team-leader-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg">
                üíæ Salvar Lideran√ßa
            </button>
        </div>
    </div>

    <!-- Modal de Transferir Volunt√°rio entre Times -->
    <div id="transfer-volunteer-modal" class="modal-overlay">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" style="color: #151b29;">üîÅ Transferir Volunt√°rio</h2>
                <button id="close-transfer-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-1">Volunt√°rio: <strong id="transfer-volunteer-name"></strong></p>
                <p class="text-sm text-gray-600 mb-4">Time atual: <strong id="transfer-current-team"></strong></p>
                <p class="text-xs text-gray-500 mb-4">Selecione o novo time:</p>
            </div>
            
            <div class="space-y-3 mb-6" id="transfer-teams-options">
                <!-- Op√ß√µes de times ser√£o inseridas dinamicamente -->
            </div>
            
            <button id="confirm-transfer-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg">
                ‚úÖ Confirmar Transfer√™ncia
            </button>
        </div>
    </div>

    <!-- Modal de Onboarding - Primeiro Acesso -->
    <div id="onboarding-modal" class="modal-overlay" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold mb-2" style="color: #151b29;">üëã Bem-vindo(a)!</h2>
                <p class="text-gray-600">Vamos conhecer suas prefer√™ncias para servir</p>
            </div>
            
            <!-- Escolha de Time -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3" style="color: #151b29;">üéØ Qual time voc√™ gostaria de servir?</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button class="onboarding-team-btn p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition" data-team="welcome">
                        <div class="text-3xl mb-2">üëã</div>
                        <div class="font-semibold text-blue-600">Welcome</div>
                    </button>
                    <button class="onboarding-team-btn p-4 border-2 border-gray-300 rounded-lg hover:border-gray-600 transition" data-team="backstage">
                        <div class="text-3xl mb-2">ü§ù</div>
                        <div class="font-semibold text-gray-600">Backstage</div>
                    </button>
                    <button class="onboarding-team-btn p-4 border-2 border-gray-300 rounded-lg hover:border-red-500 transition" data-team="parking">
                        <div class="text-3xl mb-2">üöó</div>
                        <div class="font-semibold text-red-600">Parking</div>
                    </button>
                    <button class="onboarding-team-btn p-4 border-2 border-gray-300 rounded-lg hover:border-yellow-500 transition" data-team="kids">
                        <div class="text-3xl mb-2">üë∂</div>
                        <div class="font-semibold text-yellow-600">Kids</div>
                    </button>
                </div>
            </div>
            
            <!-- Disponibilidade Semanal -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3" style="color: #151b29;">üìÖ Quando voc√™ tem disponibilidade?</h3>
                <p class="text-sm text-gray-600 mb-3">Selecione os dias e per√≠odos que voc√™ pode servir:</p>
                
                <div class="space-y-3" id="availability-days">
                    <!-- Segunda -->
                    <div class="border border-gray-300 rounded-lg p-3">
                        <button class="day-toggle-btn w-full flex items-center justify-between p-2 rounded hover:bg-gray-50 transition" data-day="monday">
                            <span class="font-semibold text-gray-700">Segunda-feira</span>
                            <span class="toggle-indicator text-gray-400">‚óã</span>
                        </button>
                        <div class="period-options hidden mt-2 flex gap-2 justify-center" data-day="monday">
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="morning">‚òÄÔ∏è Manh√£</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="afternoon">üå§Ô∏è Tarde</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="night">üåô Noite</button>
                        </div>
                    </div>
                    
                    <!-- Ter√ßa -->
                    <div class="border border-gray-300 rounded-lg p-3">
                        <button class="day-toggle-btn w-full flex items-center justify-between p-2 rounded hover:bg-gray-50 transition" data-day="tuesday">
                            <span class="font-semibold text-gray-700">Ter√ßa-feira</span>
                            <span class="toggle-indicator text-gray-400">‚óã</span>
                        </button>
                        <div class="period-options hidden mt-2 flex gap-2 justify-center" data-day="tuesday">
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="morning">‚òÄÔ∏è Manh√£</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="afternoon">üå§Ô∏è Tarde</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="night">üåô Noite</button>
                        </div>
                    </div>
                    
                    <!-- Quarta -->
                    <div class="border border-gray-300 rounded-lg p-3">
                        <button class="day-toggle-btn w-full flex items-center justify-between p-2 rounded hover:bg-gray-50 transition" data-day="wednesday">
                            <span class="font-semibold text-gray-700">Quarta-feira</span>
                            <span class="toggle-indicator text-gray-400">‚óã</span>
                        </button>
                        <div class="period-options hidden mt-2 flex gap-2 justify-center" data-day="wednesday">
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="morning">‚òÄÔ∏è Manh√£</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="afternoon">üå§Ô∏è Tarde</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="night">üåô Noite</button>
                        </div>
                    </div>
                    
                    <!-- Quinta -->
                    <div class="border border-gray-300 rounded-lg p-3">
                        <button class="day-toggle-btn w-full flex items-center justify-between p-2 rounded hover:bg-gray-50 transition" data-day="thursday">
                            <span class="font-semibold text-gray-700">Quinta-feira</span>
                            <span class="toggle-indicator text-gray-400">‚óã</span>
                        </button>
                        <div class="period-options hidden mt-2 flex gap-2 justify-center" data-day="thursday">
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="morning">‚òÄÔ∏è Manh√£</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="afternoon">üå§Ô∏è Tarde</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="night">üåô Noite</button>
                        </div>
                    </div>
                    
                    <!-- Sexta -->
                    <div class="border border-gray-300 rounded-lg p-3">
                        <button class="day-toggle-btn w-full flex items-center justify-between p-2 rounded hover:bg-gray-50 transition" data-day="friday">
                            <span class="font-semibold text-gray-700">Sexta-feira</span>
                            <span class="toggle-indicator text-gray-400">‚óã</span>
                        </button>
                        <div class="period-options hidden mt-2 flex gap-2 justify-center" data-day="friday">
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="morning">‚òÄÔ∏è Manh√£</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="afternoon">üå§Ô∏è Tarde</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="night">üåô Noite</button>
                        </div>
                    </div>
                    
                    <!-- S√°bado -->
                    <div class="border border-gray-300 rounded-lg p-3">
                        <button class="day-toggle-btn w-full flex items-center justify-between p-2 rounded hover:bg-gray-50 transition" data-day="saturday">
                            <span class="font-semibold text-gray-700">S√°bado</span>
                            <span class="toggle-indicator text-gray-400">‚óã</span>
                        </button>
                        <div class="period-options hidden mt-2 flex gap-2 justify-center" data-day="saturday">
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="morning">‚òÄÔ∏è Manh√£</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="afternoon">üå§Ô∏è Tarde</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="night">üåô Noite</button>
                        </div>
                    </div>
                    
                    <!-- Domingo -->
                    <div class="border border-gray-300 rounded-lg p-3">
                        <button class="day-toggle-btn w-full flex items-center justify-between p-2 rounded hover:bg-gray-50 transition" data-day="sunday">
                            <span class="font-semibold text-gray-700">Domingo</span>
                            <span class="toggle-indicator text-gray-400">‚óã</span>
                        </button>
                        <div class="period-options hidden mt-2 flex gap-2 justify-center" data-day="sunday">
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="morning">‚òÄÔ∏è Manh√£</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="afternoon">üå§Ô∏è Tarde</button>
                            <button class="period-btn px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-blue-100 transition" data-period="night">üåô Noite</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <button id="confirm-onboarding-btn" class="w-full zele-btn text-white font-bold py-3 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                ‚úÖ Continuar
            </button>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Onboarding -->
    <div id="onboarding-confirm-modal" class="modal-overlay" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
            <div class="text-center mb-4">
                <div class="text-4xl mb-3">‚úÖ</div>
                <h2 class="text-xl font-bold mb-2" style="color: #151b29;">Confirme suas informa√ß√µes</h2>
            </div>
            
            <div class="space-y-4 mb-6" id="onboarding-summary">
                <!-- Resumo ser√° inserido aqui -->
            </div>
            
            <div class="flex gap-3">
                <button id="edit-onboarding-btn" class="flex-1 bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition">
                    ‚úèÔ∏è Editar
                </button>
                <button id="save-onboarding-btn" class="flex-1 zele-btn text-white font-bold py-3 px-6 rounded-lg">
                    üíæ Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Menu Lateral -->
    <div id="menu-overlay" class="menu-overlay"></div>
    <div id="menu-drawer" class="menu-drawer">
        <div class="p-6">
            <!-- Header do Menu -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <img src="Volunteers logo.png" alt="Logo" class="w-12 h-12 object-contain">
                    <h2 class="text-xl font-bold" style="color: #151b29;">Menu</h2>
                </div>
                <button id="menu-close-btn" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- User Info -->
            <div class="mb-6 pb-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <img id="menu-user-photo" src="" alt="Foto" class="w-16 h-16 rounded-full">
                    <div>
                        <p class="font-semibold text-gray-800" id="menu-user-name">Usu√°rio</p>
                        <p class="text-sm text-gray-600" id="menu-user-email">email@example.com</p>
                    </div>
                </div>
            </div>

            <!-- Menu Items -->
            <div class="space-y-2">
                <button id="menu-upcoming-events-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left relative">
                    <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">Pr√≥ximos Eventos</p>
                        <p class="text-xs text-gray-600">Suas escalas pr√≥ximas</p>
                    </div>
                    <span id="upcoming-badge" class="hidden absolute top-3 right-3 bg-red-500 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center">0</span>
                </button>

                <button id="menu-admin-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left" style="display: none;">
                    <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Datas dos Eventos</p>
                        <p class="text-xs text-gray-600">Gerenciar datas dispon√≠veis</p>
                    </div>
                </button>

                <button id="menu-manage-admins-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left" style="display: none;">
                    <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Gerenciar Acesso</p>
                        <p class="text-xs text-gray-600">Gerenciar usu√°rios e permiss√µes</p>
                    </div>
                </button>

                <button id="menu-dashboard-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left" style="display: none;">
                    <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Dashboard</p>
                        <p class="text-xs text-gray-600">Estat√≠sticas e gr√°ficos</p>
                    </div>
                </button>

                <button id="menu-blocked-attempts-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left" style="display: none;">
                    <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Tentativas Bloqueadas</p>
                        <p class="text-xs text-gray-600">Ver dele√ß√µes bloqueadas</p>
                    </div>
                </button>

                <button id="menu-pending-escalas-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left" style="display: none;">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Pendentes para servir</p>
                        <p class="text-xs text-gray-600">Aprovar ou negar escalas</p>
                    </div>
                </button>

                <button id="install-app-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left" style="display: none;">
                    <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Instalar App</p>
                        <p class="text-xs text-gray-600">Adicionar √† tela inicial</p>
                    </div>
                </button>

                <button id="menu-change-photo-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left">
                    <svg class="w-6 h-6" style="color: #151b29;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Alterar Foto</p>
                        <p class="text-xs text-gray-600">Escolher foto de perfil</p>
                    </div>
                </button>

                <button id="menu-logout-btn" class="w-full flex items-center gap-3 p-4 rounded-lg hover:bg-gray-100 transition text-left">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    <div>
                        <p class="font-semibold text-gray-800">Sair</p>
                        <p class="text-xs text-gray-600">Fazer logout</p>
                    </div>
                </button>
            </div>

            <!-- Input oculto para upload de foto -->
            <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">

            <!-- Vers√£o -->
            <div class="mt-8 pt-6 border-t border-gray-200 text-center text-xs text-gray-500">
                <p>Zele Server v2.3</p>
                <p class="mt-1">Servir √© a linguagem do c√©u</p>
            </div>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div id="success-modal" class="modal-overlay">
        <div class="card-float rounded-2xl p-8 max-w-md w-full mx-4 text-center">
            <div class="mb-4 text-6xl">‚úÖ</div>
            <h2 class="text-2xl font-bold mb-2" style="color: #151b29;">Volunteers</h2>
            <p class="text-gray-600 mb-6" id="modal-message">Escala salva com sucesso!</p>
            <div id="modal-buttons" class="flex gap-3">
                <button id="modal-close-btn" class="flex-1 zele-btn text-white font-bold py-3 px-6 rounded-lg">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Instru√ß√µes iOS -->
    <div id="ios-install-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h2 class="text-xl font-bold mb-4 text-gray-800">üì± Instalar App no iPhone</h2>
            <p class="text-sm text-gray-600 mb-4">Para adicionar o Zele Server √† sua tela inicial:</p>
            <ol class="text-sm text-gray-700 space-y-3 mb-6">
                <li class="flex items-start">
                    <span class="font-bold mr-2">1.</span>
                    <span>Toque no bot√£o <strong>Compartilhar</strong> <svg class="inline w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/></svg> (na barra inferior do Safari)</span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold mr-2">2.</span>
                    <span>Role para baixo e toque em <strong>"Adicionar √† Tela de In√≠cio"</strong> <svg class="inline w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></span>
                </li>
                <li class="flex items-start">
                    <span class="font-bold mr-2">3.</span>
                    <span>Toque em <strong>"Adicionar"</strong> no canto superior direito</span>
                </li>
            </ol>
            <button id="close-ios-modal" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold">
                Entendi
            </button>
        </div>
    </div>

    <!-- Modal de Tentativas Bloqueadas -->
    <div id="blocked-attempts-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">‚ö†Ô∏è Tentativas Bloqueadas</h2>
                <button id="close-blocked-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Volunt√°rios que tentaram deletar escalas dentro do per√≠odo de 48 horas:</p>
            <div id="blocked-attempts-list" class="space-y-3">
                <!-- Lista ser√° preenchida dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Escalas Pendentes (Admin) -->
    <div id="pending-escalas-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full p-6 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">‚è∞ Pendentes para servir</h2>
                <button id="close-pending-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Escalas solicitadas com menos de 24h de anteced√™ncia:</p>
            <div id="pending-escalas-list" class="space-y-4">
                <!-- Lista ser√° preenchida dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Sele√ß√£o de Time para Aprova√ß√£o -->
    <div id="approve-team-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">‚úÖ Selecionar Time</h2>
                <button id="close-approve-team-modal" class="text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Selecione o time para aprovar a escala:</p>
            <div class="space-y-3" id="approve-team-options">
                <!-- Op√ß√µes de times ser√£o inseridas aqui -->
            </div>
        </div>
    </div>

    <script>
        // üîß CONFIGURA√á√ïES DO SISTEMA
        const CONFIG = {
            DEBUG_MODE: false, // Desativado para produ√ß√£o
            SCHEMA_VERSION: '2.3.0',
            MAX_RETRIES: 3,
            RETRY_DELAY: 1000, // ms
            BACKUP_ENABLED: true,
            // EmailJS - Configure em https://www.emailjs.com/
            EMAILJS_PUBLIC_KEY: 'wtigfazeluf0vyzGp', // Trocar pela sua chave
            EMAILJS_SERVICE_ID: 'service_a6x08k6', // Trocar pelo seu service
            EMAILJS_TEMPLATE_ID: 'template_jvfnmsp' // Trocar pelo seu template
        };
        
            // Sistema de logging condicional
            const logger = {
                log: (...args) => CONFIG.DEBUG_MODE && console.log(...args),
                info: (...args) => CONFIG.DEBUG_MODE && console.info(...args),
                warn: (...args) => console.warn(...args), // Sempre mostrar warnings
                error: (...args) => console.error(...args), // Sempre mostrar erros
                success: (...args) => CONFIG.DEBUG_MODE && console.log('‚úÖ', ...args)
            };
            
            // Inicializar EmailJS
            if (typeof emailjs !== 'undefined' && CONFIG.EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
                emailjs.init(CONFIG.EMAILJS_PUBLIC_KEY);
                console.log('üìß EmailJS inicializado');
            }        
        // ========================================
        // üöÄ INICIALIZA√á√ÉO DO APP - v2.3.0
        // ========================================
        // Aguardar Firebase estar pronto
        function initApp() {
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üöÄ ZELE SERVER v' + CONFIG.SCHEMA_VERSION);
            console.log('üìã DEBUG MODE:', CONFIG.DEBUG_MODE ? 'ATIVADO ‚ö†Ô∏è' : 'DESATIVADO');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            logger.log('üöÄ App iniciando... v' + CONFIG.SCHEMA_VERSION);
            
            // Verificar se Firebase foi inicializado
            if (!window.firebaseAuth || !window.firebaseDb) {
                logger.error('‚ùå Firebase n√£o inicializado, tentando novamente...');
                setTimeout(initApp, 100);
                return;
            }
            
            // Fun√ß√£o de retry para opera√ß√µes Firestore
            async function firestoreRetry(operation, operationName = 'Opera√ß√£o') {
                let lastError;
                for (let attempt = 1; attempt <= CONFIG.MAX_RETRIES; attempt++) {
                    try {
                        logger.log(`üîÑ ${operationName} - Tentativa ${attempt}/${CONFIG.MAX_RETRIES}`);
                        const result = await operation();
                        logger.success(`${operationName} - Sucesso`);
                        return result;
                    } catch (error) {
                        lastError = error;
                        console.error(`üîç DEBUG - Erro na tentativa ${attempt}:`, {
                            name: error.name,
                            message: error.message,
                            code: error.code,
                            stack: error.stack
                        });
                        logger.warn(`‚ö†Ô∏è ${operationName} - Falha na tentativa ${attempt}:`, error.message);
                        if (attempt < CONFIG.MAX_RETRIES) {
                            await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY * attempt));
                        }
                    }
                }
                console.error(`üîç DEBUG - Erro final ap√≥s todas tentativas:`, lastError);
                logger.error(`‚ùå ${operationName} - Todas as tentativas falharam`);
                throw lastError;
            }
            
            // Sistema de backup autom√°tico
            async function backupData(action, data) {
                if (!CONFIG.BACKUP_ENABLED) return;
                
                try {
                    const { collection, addDoc } = window.firestoreMethods;
                    await addDoc(collection(window.firebaseDb, 'backups'), {
                        action: action,
                        data: data,
                        user: currentUser?.email || 'unknown',
                        timestamp: new Date().toISOString(),
                        schemaVersion: CONFIG.SCHEMA_VERSION
                    });
                    logger.log('üíæ Backup criado:', action);
                } catch (error) {
                    logger.error('‚ùå Erro ao criar backup:', error);
                    // N√£o bloquear opera√ß√£o se backup falhar
                }
            }
            
            logger.success('Firebase Auth:', window.firebaseAuth ? 'OK' : 'Falha');
            logger.success('Firebase DB:', window.firebaseDb ? 'OK' : 'Falha');
            logger.success('Firebase Provider:', window.firebaseProvider ? 'OK' : 'Falha');
            
            let currentUser = null;
            let selectedTeam = null;
            let isAdmin = false;
            let isSuperAdmin = false;
            let isTeamLeader = false;
            let userTeamLeadership = [];
            let availableDates = [];
            let deferredPrompt = null;
            let isIOS = false;
            
            // Verificar e atualizar badge de pr√≥ximos eventos
            function updateUpcomingEventsBadge(escalas) {
                const now = new Date();
                const next48h = new Date(now.getTime() + (48 * 60 * 60 * 1000)); // 48 horas
                
                const upcomingEvents = escalas.filter(escala => {
                    const eventDateTime = new Date(escala.date + 'T' + escala.time);
                    return eventDateTime > now && eventDateTime <= next48h;
                });
                
                // Atualizar badge do menu
                const badge = document.getElementById('upcoming-badge');
                if (badge) {
                    if (upcomingEvents.length > 0) {
                        badge.textContent = upcomingEvents.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
                
                // Atualizar badge do header (foto do usu√°rio)
                const headerBadge = document.getElementById('header-badge');
                if (headerBadge) {
                    if (upcomingEvents.length > 0) {
                        headerBadge.textContent = upcomingEvents.length;
                        headerBadge.classList.remove('hidden');
                        console.log(`üîî ${upcomingEvents.length} evento(s) nas pr√≥ximas 48h`);
                    } else {
                        headerBadge.classList.add('hidden');
                    }
                }
                
                return upcomingEvents;
            }
            
            // Enviar email de lembrete 24h antes do evento
            async function sendReminderEmail(escalaData) {
                // Verificar se EmailJS est√° configurado
                if (CONFIG.EMAILJS_PUBLIC_KEY === 'YOUR_PUBLIC_KEY') {
                    console.log('‚ö†Ô∏è EmailJS n√£o configurado. Pule o envio de email.');
                    return;
                }
                
                const teamNames = {
                    welcome: 'Welcome',
                    backstage: 'Backstage',
                    parking: 'Parking',
                    kids: 'Kids'
                };
                
                const eventDate = new Date(escalaData.date + 'T' + escalaData.time);
                const formattedDate = eventDate.toLocaleDateString('pt-BR', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                const formattedTime = escalaData.time === '00:00' ? 'Hor√°rio a definir' : escalaData.time;
                
                const templateParams = {
                    to_email: currentUser.email,
                    to_name: currentUser.displayName || currentUser.email,
                    event_date: formattedDate,
                    event_time: formattedTime,
                    event_name: escalaData.eventName || '',
                    team_name: teamNames[escalaData.team] || escalaData.team
                };
                
                try {
                    await emailjs.send(
                        CONFIG.EMAILJS_SERVICE_ID,
                        CONFIG.EMAILJS_TEMPLATE_ID,
                        templateParams
                    );
                    console.log('üìß Email de lembrete enviado para:', currentUser.email);
                } catch (error) {
                    console.error('‚ùå Erro ao enviar email:', error);
                }
            }
            
            // Verificar eventos que precisam de lembrete (24h antes)
            async function checkAndSendReminders(escalas) {
                const now = new Date();
                const in24h = new Date(now.getTime() + (24 * 60 * 60 * 1000));
                const in25h = new Date(now.getTime() + (25 * 60 * 60 * 1000));
                
                for (const escala of escalas) {
                    const eventDateTime = new Date(escala.date + 'T' + escala.time);
                    
                    // Se o evento est√° entre 24h e 25h no futuro
                    if (eventDateTime > in24h && eventDateTime <= in25h) {
                        // Verificar se j√° enviou lembrete (evitar duplicatas)
                        const reminderSentKey = `reminder_sent_${escala.id}`;
                        const alreadySent = localStorage.getItem(reminderSentKey);
                        
                        if (!alreadySent) {
                            await sendReminderEmail(escala);
                            localStorage.setItem(reminderSentKey, 'true');
                        }
                    }
                }
            }
            
            // Pr√©-carregar todas as imagens dos times
            const preloadedImages = {};
            function preloadTeamImages() {
                const imageUrls = [
                    'https://github.com/escalaserver/zele/blob/main/Logo%20Welcome%20horizontal.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Welcome%20azul%20claro.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Logo%20Backstage%20horizontal.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Backstage%20azul%20claro.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Logo%20Parking%20horizontal.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Parking%20azul%20claro.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Logo%20Kids%20horizontal.png?raw=true',
                    'https://github.com/escalaserver/zele/blob/main/Kids%20azul%20claro.png?raw=true'
                ];
                
                imageUrls.forEach(url => {
                    const img = new Image();
                    img.src = url;
                    preloadedImages[url] = img;
                });
                
                console.log('‚úÖ Imagens dos times pr√©-carregadas');
            }
            
            // Chamar pr√©-carregamento assim que o app iniciar
            preloadTeamImages();
            
            // Elementos DOM
            const elements = {
                loadingScreen: document.getElementById('loading-screen'),
                authScreen: document.getElementById('auth-screen'),
                appContainer: document.getElementById('app-container'),
                googleLoginBtn: document.getElementById('google-login-btn'),
                menuBtn: document.getElementById('menu-btn'),
                menuOverlay: document.getElementById('menu-overlay'),
                menuDrawer: document.getElementById('menu-drawer'),
                menuCloseBtn: document.getElementById('menu-close-btn'),
                menuLogoutBtn: document.getElementById('menu-logout-btn'),
                installAppBtn: document.getElementById('install-app-btn'),
                menuUserName: document.getElementById('menu-user-name'),
                menuUserEmail: document.getElementById('menu-user-email'),
                menuUserPhoto: document.getElementById('menu-user-photo'),
                userName: document.getElementById('user-name'),
                userEmail: document.getElementById('user-email'),
                userPhoto: document.getElementById('user-photo'),
                cultoSelect: document.getElementById('culto-select'),
                saveEscalaBtn: document.getElementById('save-escala-btn'),
                escalasList: document.getElementById('escalas-list'),
                adminView: document.getElementById('admin-view'),
                teamBtns: document.querySelectorAll('.team-btn'),
                successModal: document.getElementById('success-modal'),
                modalMessage: document.getElementById('modal-message'),
                modalButtons: document.getElementById('modal-buttons'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                filterMinhasEscalas: document.getElementById('filter-minhas-escalas'),
                filterVisaoGeral: document.getElementById('filter-visao-geral')
            };
            
            // Vari√°veis para armazenar dados completos
            let allUserEscalas = [];
            let allEscalasGrouped = {};

            // Modal functions
            function showModal(message, showYesNo = false, onYes = null, isWarning = false, onClose = null, customEmoji = null) {
                console.log('üîî showModal chamado:', { showYesNo, hasOnYes: !!onYes, message: message.substring(0, 50) });
                
                // Usar innerHTML para suportar formata√ß√£o HTML
                elements.modalMessage.innerHTML = message;
                
                // Mudar emoji baseado no tipo de modal
                const emojiDiv = elements.successModal.querySelector('.mb-4');
                if (customEmoji) {
                    emojiDiv.textContent = customEmoji;
                } else if (isWarning) {
                    emojiDiv.textContent = '‚ö†Ô∏è';
                } else {
                    emojiDiv.textContent = '‚úÖ';
                }
                
                if (showYesNo && onYes) {
                    console.log('üîî Modal Sim/N√£o criado');
                    // Modal com Sim/N√£o
                    elements.modalButtons.innerHTML = `
                        <button id="modal-no-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">
                            N√£o
                        </button>
                        <button id="modal-yes-btn" class="flex-1 zele-btn text-white font-bold py-3 px-6 rounded-lg">
                            Sim
                        </button>
                    `;
                    
                    document.getElementById('modal-yes-btn').addEventListener('click', () => {
                        console.log('üîî Bot√£o SIM clicado');
                        closeModal();
                        onYes();
                    });
                    
                    document.getElementById('modal-no-btn').addEventListener('click', () => {
                        console.log('üîî Bot√£o N√ÉO clicado');
                        closeModal();
                        if (onClose) onClose();
                    });
                } else {
                    console.log('üîî Modal OK criado');
                    // Modal apenas com OK
                    elements.modalButtons.innerHTML = `
                        <button id="modal-close-btn" class="flex-1 zele-btn text-white font-bold py-3 px-6 rounded-lg">
                            OK
                        </button>
                    `;
                    
                    document.getElementById('modal-close-btn').addEventListener('click', () => {
                        console.log('üîî Bot√£o OK clicado');
                        closeModal();
                        if (onClose) onClose();
                    });
                }
                
                elements.successModal.classList.add('show');
            }

            function closeModal() {
                elements.successModal.classList.remove('show');
            }

            elements.successModal.addEventListener('click', (e) => {
                if (e.target === elements.successModal) {
                    closeModal();
                }
            });

            // Menu functions
            function openMenu() {
                elements.menuOverlay.classList.add('show');
                elements.menuDrawer.classList.add('show');
            }

            function closeMenu() {
                elements.menuOverlay.classList.remove('show');
                elements.menuDrawer.classList.remove('show');
            }

            elements.menuBtn.addEventListener('click', openMenu);
            elements.menuCloseBtn.addEventListener('click', closeMenu);
            elements.menuOverlay.addEventListener('click', closeMenu);
            elements.menuLogoutBtn.addEventListener('click', () => {
                closeMenu();
                logout();
            });

            // Navega√ß√£o para p√°gina de admin
            const menuAdminBtn = document.getElementById('menu-admin-btn');
            const backFromAdminBtn = document.getElementById('back-from-admin');
            const appContainer = document.getElementById('app-container');
            const adminPage = document.getElementById('admin-page');

            if (menuAdminBtn) {
                menuAdminBtn.addEventListener('click', () => {
                    closeMenu();
                    appContainer.classList.add('hidden');
                    adminPage.classList.remove('hidden');
                    renderAdminDatesList(); // Atualizar lista de datas
                });
            }

            if (backFromAdminBtn) {
                backFromAdminBtn.addEventListener('click', () => {
                    adminPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                });
            }

            // Navega√ß√£o para p√°gina de gerenciar admins
            const menuManageAdminsBtn = document.getElementById('menu-manage-admins-btn');
            const backFromManageAdminsBtn = document.getElementById('back-from-manage-admins');
            const manageAdminsPage = document.getElementById('manage-admins-page');

            if (menuManageAdminsBtn) {
                menuManageAdminsBtn.addEventListener('click', () => {
                    closeMenu();
                    appContainer.classList.add('hidden');
                    manageAdminsPage.classList.remove('hidden');
                    loadUsersList(); // Carregar lista de usu√°rios
                });
            }

            if (backFromManageAdminsBtn) {
                backFromManageAdminsBtn.addEventListener('click', () => {
                    manageAdminsPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                });
            }

            // Navega√ß√£o para p√°gina de Dashboard
            const menuDashboardBtn = document.getElementById('menu-dashboard-btn');
            const backFromDashboardBtn = document.getElementById('back-from-dashboard');
            const dashboardPage = document.getElementById('dashboard-page');

            if (menuDashboardBtn) {
                menuDashboardBtn.addEventListener('click', () => {
                    closeMenu();
                    appContainer.classList.add('hidden');
                    dashboardPage.classList.remove('hidden');
                    loadDashboard(); // Carregar dashboard
                });
            }

            if (backFromDashboardBtn) {
                backFromDashboardBtn.addEventListener('click', () => {
                    dashboardPage.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                });
            }

            // ===================================
            // DETEC√á√ÉO E INSTALA√á√ÉO PWA
            // ===================================

            // Detectar se √© iOS
            function detectIOS() {
                const userAgent = window.navigator.userAgent.toLowerCase();
                return /iphone|ipad|ipod/.test(userAgent);
            }

            // Detectar se j√° est√° instalado como PWA
            function isInStandaloneMode() {
                return (window.matchMedia('(display-mode: standalone)').matches) || 
                       (window.navigator.standalone) || 
                       document.referrer.includes('android-app://');
            }

            // Capturar evento beforeinstallprompt GLOBALMENTE (antes do login)
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('üì± beforeinstallprompt disparado (Android/Windows/Desktop)');
                e.preventDefault();
                deferredPrompt = e;
                console.log('‚úÖ Prompt de instala√ß√£o capturado e salvo');
            });

            // Configurar bot√£o de instala√ß√£o
            function setupInstallButton() {
                isIOS = detectIOS();
                const installBtn = elements.installAppBtn;
                
                // N√£o mostrar se j√° estiver instalado
                if (isInStandaloneMode()) {
                    console.log('‚úÖ App j√° est√° instalado');
                    installBtn.style.display = 'none';
                    return;
                }

                if (isIOS) {
                    // iOS: Mostrar bot√£o com instru√ß√µes manuais
                    console.log('üì± iOS detectado - mostrando instru√ß√µes manuais');
                    installBtn.style.display = 'block';
                    installBtn.addEventListener('click', () => {
                        closeMenu();
                        document.getElementById('ios-install-modal').classList.remove('hidden');
                    });
                } else {
                    // Android/Desktop/Windows: Mostrar bot√£o se houver deferredPrompt OU sempre (com fallback)
                    console.log('üíª Desktop/Android detectado');
                    console.log('üîç deferredPrompt dispon√≠vel?', !!deferredPrompt);
                    
                    // Sempre mostrar bot√£o no desktop (com instru√ß√µes manuais se necess√°rio)
                    installBtn.style.display = 'block';

                    installBtn.addEventListener('click', async () => {
                        console.log('üñ±Ô∏è Bot√£o de instala√ß√£o clicado');
                        if (!deferredPrompt) {
                            console.log('‚ùå Prompt de instala√ß√£o n√£o dispon√≠vel - mostrando instru√ß√µes manuais');
                            // Instru√ß√µes manuais para Windows/Desktop
                            showModal('Para instalar:<br><br><strong>Chrome:</strong><br>‚Ä¢ Clique no √≠cone ‚äï na barra de endere√ßo<br>‚Ä¢ Ou v√° em Menu (‚ãÆ) ‚Üí Instalar Zele Server<br><br><strong>Edge:</strong><br>‚Ä¢ Menu (‚ãØ) ‚Üí Apps ‚Üí Instalar Zele Server<br>‚Ä¢ Ou pressione Ctrl+Shift+A', false, null, false, null, 'üíª');
                            return;
                        }

                        try {
                            console.log('üöÄ Iniciando instala√ß√£o autom√°tica...');
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            console.log(`üë§ Usu√°rio escolheu: ${outcome}`);
                            
                            if (outcome === 'accepted') {
                                showModal('‚úÖ App instalado com sucesso!');
                                installBtn.style.display = 'none';
                            } else {
                                showModal('Instala√ß√£o cancelada.');
                            }
                        } catch (error) {
                            console.error('‚ùå Erro na instala√ß√£o:', error);
                            showModal('Erro ao instalar. Tente pelo menu do navegador.');
                        }
                        
                        deferredPrompt = null;
                        closeMenu();
                    }, { once: false }); // Permitir m√∫ltiplos cliques
                }

                // Listener quando o app √© instalado
                window.addEventListener('appinstalled', () => {
                    console.log('‚úÖ PWA instalado com sucesso');
                    installBtn.style.display = 'none';
                    deferredPrompt = null;
                });
            }

            // Fechar modal iOS
            document.getElementById('close-ios-modal')?.addEventListener('click', () => {
                document.getElementById('ios-install-modal').classList.add('hidden');
            });

            // Fechar modal clicando fora
            document.getElementById('ios-install-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'ios-install-modal') {
                    document.getElementById('ios-install-modal').classList.add('hidden');
                }
            });

            // Bot√£o de pr√≥ximos eventos no menu
            document.getElementById('menu-upcoming-events-btn')?.addEventListener('click', () => {
                closeMenu();
                showUpcomingEventsModal();
            });
            
            // Clicar na foto do usu√°rio abre modal de pr√≥ximos eventos
            document.getElementById('user-photo-btn')?.addEventListener('click', () => {
                showUpcomingEventsModal();
            });
            
            // Bot√£o de tentativas bloqueadas
            document.getElementById('menu-blocked-attempts-btn')?.addEventListener('click', () => {
                closeMenu();
                loadBlockedAttempts();
                document.getElementById('blocked-attempts-modal').classList.remove('hidden');
            });

            // Fechar modal de tentativas bloqueadas
            document.getElementById('close-blocked-modal')?.addEventListener('click', () => {
                document.getElementById('blocked-attempts-modal').classList.add('hidden');
                // Cancelar listener quando fechar o modal
                if (blockedAttemptsUnsubscribe) {
                    blockedAttemptsUnsubscribe();
                    blockedAttemptsUnsubscribe = null;
                    console.log('üëÇ Listener de tentativas bloqueadas cancelado');
                }
            });

            // Fechar modal clicando fora
            document.getElementById('blocked-attempts-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'blocked-attempts-modal') {
                    document.getElementById('blocked-attempts-modal').classList.add('hidden');
                    // Cancelar listener quando fechar o modal
                    if (blockedAttemptsUnsubscribe) {
                        blockedAttemptsUnsubscribe();
                        blockedAttemptsUnsubscribe = null;
                        console.log('üëÇ Listener de tentativas bloqueadas cancelado');
                    }
                }
            });

            // Bot√£o de escalas pendentes
            document.getElementById('menu-pending-escalas-btn')?.addEventListener('click', () => {
                closeMenu();
                loadPendingEscalas();
                document.getElementById('pending-escalas-modal').classList.remove('hidden');
            });

            // Fechar modal de escalas pendentes
            document.getElementById('close-pending-modal')?.addEventListener('click', () => {
                document.getElementById('pending-escalas-modal').classList.add('hidden');
            });

            // Fechar modal clicando fora
            document.getElementById('pending-escalas-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'pending-escalas-modal') {
                    document.getElementById('pending-escalas-modal').classList.add('hidden');
                }
            });

            // Fechar modal de sele√ß√£o de time
            document.getElementById('close-approve-team-modal')?.addEventListener('click', () => {
                document.getElementById('approve-team-modal').classList.add('hidden');
            });

            // Fechar modal iOS
            document.getElementById('close-ios-modal')?.addEventListener('click', () => {
                document.getElementById('ios-install-modal').classList.add('hidden');
            });

            // Bot√£o de alterar foto no menu
            document.getElementById('menu-change-photo-btn')?.addEventListener('click', () => {
                closeMenu();
                document.getElementById('photo-upload-input').click();
            });

            // Upload de foto de perfil (usando Base64 no Firestore - Gr√°tis)
            document.getElementById('photo-upload-input')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Validar tipo de arquivo
                if (!file.type.startsWith('image/')) {
                    showModal('‚ùå Por favor, selecione uma imagem v√°lida.');
                    e.target.value = '';
                    return;
                }
                
                // Validar tamanho (m√°ximo 200KB para Base64 otimizado)
                if (file.size > 200 * 1024) {
                    showModal('‚ùå A imagem deve ter no m√°ximo 200KB.<br><br>üí° Dica: Use um compressor online gratuito:<br>‚Ä¢ <a href="https://tinypng.com" target="_blank" style="color: #377db8;">tinypng.com</a><br>‚Ä¢ <a href="https://compressor.io" target="_blank" style="color: #377db8;">compressor.io</a>');
                    e.target.value = '';
                    return;
                }
                
                try {
                    showLoading();
                    console.log('üì∏ Processando foto...');
                    
                    // Converter imagem para Base64
                    const photoBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                    
                    console.log('‚úÖ Foto convertida para Base64 (' + Math.round(photoBase64.length / 1024) + 'KB)');
                    
                    // Salvar apenas no Firestore (Firebase Auth tem limite de tamanho)
                    console.log('üíæ Salvando no Firestore...');
                    const { doc, updateDoc } = window.firestoreMethods;
                    await updateDoc(doc(window.firebaseDb, 'users', currentUser.uid), {
                        photoURL: photoBase64,
                        updatedAt: new Date().toISOString()
                    });
                    
                    // Atualizar currentUser em mem√≥ria
                    currentUser.photoURL = photoBase64;
                    
                    console.log('‚úÖ Foto de perfil atualizada com sucesso');
                    
                    // Fechar loading e recarregar app ap√≥s modal ser fechado
                    showModal('‚úÖ Foto de perfil atualizada com sucesso!', false, null, false, () => {
                        hideLoading();
                        window.location.reload();
                    });
                    
                } catch (error) {
                    console.error('‚ùå Erro ao fazer upload da foto:', error);
                    console.error('Stack:', error.stack);
                    hideLoading();
                    showModal(`‚ùå Erro ao atualizar foto: ${error.message}`);
                }
                
                // Limpar input
                e.target.value = '';
            });

            // Sele√ß√£o de time
            elements.teamBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Verificar se uma data foi selecionada
                    if (!elements.cultoSelect.value) {
                        // Mostrar modal de alerta com callback para piscar ap√≥s fechar
                        showModal(
                            'Escolha o dia para depois selecionar a equipe que vai servir', 
                            false, 
                            null, 
                            true,
                            () => {
                                // Piscar a borda do select ap√≥s fechar o modal
                                // Delay maior para iOS e for√ßar reflow do DOM
                                setTimeout(() => {
                                    // Remover classe se j√° existir (para garantir nova anima√ß√£o)
                                    elements.cultoSelect.classList.remove('blink-border');
                                    
                                    // For√ßar reflow do DOM (cr√≠tico para iOS)
                                    void elements.cultoSelect.offsetWidth;
                                    
                                    // Adicionar classe de anima√ß√£o
                                    elements.cultoSelect.classList.add('blink-border');
                                    
                                    // Remover ap√≥s anima√ß√£o completar
                                    setTimeout(() => {
                                        elements.cultoSelect.classList.remove('blink-border');
                                    }, 1500); // 3 piscadas x 0.5s = 1.5s
                                }, 100); // Delay para iOS processar fechamento do modal
                            }
                        );
                        
                        return;
                    }
                    
                    // Resetar todos os bot√µes para imagem normal
                    elements.teamBtns.forEach(b => {
                        b.classList.remove('selected');
                        const img = b.querySelector('img');
                        const normalImg = b.dataset.imgNormal;
                        if (img && normalImg) {
                            img.src = normalImg;
                        }
                    });
                    
                    // Marcar bot√£o clicado como selecionado e trocar imagem
                    btn.classList.add('selected');
                    const img = btn.querySelector('img');
                    const selectedImg = btn.dataset.imgSelected;
                    if (img && selectedImg) {
                        img.src = selectedImg;
                    }
                    
                    selectedTeam = btn.dataset.team;
                    
                    // Animar bot√£o Salvar Escala ap√≥s selecionar o time
                    setTimeout(() => {
                        elements.saveEscalaBtn.classList.add('pulse-save');
                        setTimeout(() => {
                            elements.saveEscalaBtn.classList.remove('pulse-save');
                        }, 1000); // 2 piscadas x 0.5s = 1s
                    }, 200); // pequeno delay para o usu√°rio perceber a transi√ß√£o
                });
            });

            // Resetar sele√ß√£o de time quando trocar o culto
            elements.cultoSelect.addEventListener('change', () => {
                if (selectedTeam) {
                    // Resetar todos os bot√µes para imagem normal
                    elements.teamBtns.forEach(btn => {
                        btn.classList.remove('selected');
                        const img = btn.querySelector('img');
                        const normalImg = btn.dataset.imgNormal;
                        if (img && normalImg) {
                            img.src = normalImg;
                        }
                    });
                    selectedTeam = null;
                }
                
                // Se uma data foi selecionada, animar os bot√µes dos times em sequ√™ncia
                if (elements.cultoSelect.value) {
                    animateTeamButtonsSequence();
                }
            });
            
            // Fun√ß√£o para animar bot√µes dos times em sequ√™ncia (hor√°rio)
            function animateTeamButtonsSequence() {
                const teamOrder = ['welcome', 'backstage', 'parking', 'kids'];
                const delay = 350; // tempo entre cada anima√ß√£o
                
                teamOrder.forEach((teamName, index) => {
                    setTimeout(() => {
                        const btn = document.querySelector(`[data-team="${teamName}"]`);
                        if (btn) {
                            btn.classList.add('pulse-team');
                            setTimeout(() => {
                                btn.classList.remove('pulse-team');
                            }, 600); // dura√ß√£o da anima√ß√£o
                        }
                    }, index * delay);
                });
            }

            // Login com Google
            async function loginWithGoogle() {
                try {
                    showLoading(); // Mostrar loading durante o login
                    console.log('üîê Iniciando login...');
                    console.log('Auth:', window.firebaseAuth);
                    console.log('Provider:', window.firebaseProvider);
                    const result = await window.firebaseAuthMethods.signInWithPopup(window.firebaseAuth, window.firebaseProvider);
                    currentUser = result.user;
                    console.log('‚úÖ Login bem-sucedido:', currentUser.email);
                    // O onAuthStateChanged vai cuidar de mostrar o app
                } catch (error) {
                    console.error('‚ùå Erro no login:', error);
                    console.error('C√≥digo do erro:', error.code);
                    console.error('Mensagem:', error.message);
                    showLogin(); // Voltar para login em caso de erro
                    showModal(`Erro ao fazer login: ${error.message}\n\nVerifique:\n1. Autentica√ß√£o Google habilitada no Firebase\n2. Dom√≠nio autorizado no Firebase Console\n3. Conex√£o com internet`);
                }
            }

            // Logout
            async function logout() {
                try {
                    await window.firebaseAuthMethods.signOut(window.firebaseAuth);
                    console.log('üëã Logout realizado');
                    // Recarregar a p√°gina para limpar o estado e voltar para tela de login
                    window.location.reload();
                } catch (error) {
                    console.error('‚ùå Erro no logout:', error);
                }
            }

            // Salvar dados do usu√°rio no Firestore
            async function saveUserToFirestore(user) {
                try {
                    const { doc, setDoc, getDoc } = window.firestoreMethods;
                    const userDocRef = doc(window.firebaseDb, 'users', user.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    // Preparar dados do usu√°rio
                    const userData = {
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        lastLogin: new Date().toISOString(),
                        lastLoginFormatted: new Date().toLocaleString('pt-BR')
                    };
                    
                    if (userDoc.exists()) {
                        // Atualizar apenas dados do perfil, mantendo role, blocked e photoURL
                        const existingData = userDoc.data();
                        
                        // Se existe photoURL no Firestore, usar ele (Base64)
                        // Se n√£o, usar do Firebase Auth (Google login)
                        if (existingData.photoURL) {
                            user.photoURL = existingData.photoURL;
                        }
                        
                        await setDoc(userDocRef, {
                            ...userData,
                            photoURL: existingData.photoURL || user.photoURL || '',
                            role: existingData.role || 'user', // Preservar role existente
                            blocked: existingData.blocked || false, // Preservar status de bloqueio
                            createdAt: existingData.createdAt || new Date().toISOString()
                        });
                        logger.log('‚úÖ Dados do usu√°rio atualizados');
                    } else {
                        // Criar novo documento com role padr√£o
                        await setDoc(userDocRef, {
                            ...userData,
                            photoURL: user.photoURL || '',
                            role: 'user',
                            blocked: false,
                            createdAt: new Date().toISOString()
                        });
                        logger.log('‚úÖ Novo usu√°rio criado no Firestore');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao salvar usu√°rio:', error);
                }
            }

            // Verificar se usu√°rio √© admin ou superadmin
            async function checkAdminStatus(user) {
                if (!user) {
                    console.log('‚ö†Ô∏è Nenhum usu√°rio para verificar admin');
                    return false;
                }
                
                // Verificar se usu√°rio est√° bloqueado
                try {
                    const { doc, getDoc } = window.firestoreMethods;
                    const userDoc = await getDoc(doc(window.firebaseDb, 'users', user.uid));
                    
                    if (userDoc.exists() && userDoc.data().blocked === true) {
                        console.log('üö´ Usu√°rio bloqueado. Fazendo logout...');
                        showModal('Seu acesso foi bloqueado. Entre em contato com o administrador.', false, null, false, async () => {
                            await window.firebaseAuthMethods.signOut(window.firebaseAuth);
                            window.location.reload();
                        }, 'üö´');
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao verificar bloqueio:', error);
                }
                
                // Salvar/atualizar dados do usu√°rio
                await saveUserToFirestore(user);
                
                console.log('üîç Verificando status de admin para:', user.email);
                console.log('üîç UID do usu√°rio:', user.uid);
                
                try {
                    const { doc, getDoc, setDoc } = window.firestoreMethods;
                    const userDoc = await getDoc(doc(window.firebaseDb, 'users', user.uid));
                    
                    console.log('üìÑ Documento existe?', userDoc.exists());
                    
                    // Verificar lideran√ßa de times
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        console.log('üìÑ Dados completos do usu√°rio:', userData);
                        console.log('üìÑ Campo teamLeader:', userData.teamLeader);
                        console.log('üìÑ Tipo do campo teamLeader:', typeof userData.teamLeader);
                        userTeamLeadership = userData.teamLeader || [];
                        isTeamLeader = userTeamLeadership.length > 0;
                        console.log('üèÜ L√≠der de times:', userTeamLeadership);
                        console.log('üèÜ isTeamLeader:', isTeamLeader);
                        
                        // Atualizar UI ap√≥s carregar lideran√ßa
                        updateUserUI(user);
                    }
                    
                    // Super Admin hardcoded (primeiro super admin)
                    const SUPER_ADMIN_ID = 'HiCC8lYwRBgWJ0ATRYOV2rtc1ND2';
                    const SUPER_ADMIN_EMAIL = 'leandroalves.facilities@gmail.com';
                    
                    if (user.uid === SUPER_ADMIN_ID || user.email === SUPER_ADMIN_EMAIL) {
                        console.log('üëëüëë SUPER ADMINISTRADOR detectado!');
                        // Garantir que est√° como superadmin no Firestore
                        if (userDoc.exists()) {
                            const data = userDoc.data();
                            if (data.role !== 'superadmin') {
                                await setDoc(doc(window.firebaseDb, 'users', user.uid), {
                                    ...data,
                                    role: 'superadmin'
                                });
                                console.log('‚úÖ Role atualizado para superadmin');
                            }
                        }
                        isAdmin = true;
                        isSuperAdmin = true;
                        document.getElementById('menu-admin-btn').style.display = 'block';
                        document.getElementById('menu-manage-admins-btn').style.display = 'block';
                        document.getElementById('menu-dashboard-btn').style.display = 'block';
                        document.getElementById('menu-blocked-attempts-btn').style.display = 'block';
                        document.getElementById('menu-pending-escalas-btn').style.display = 'block';
                        console.log('‚úÖ Usu√°rio √â SUPER ADMINISTRADOR');
                        return true;
                    }
                    
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        console.log('üìÑ Dados do documento:', data);
                        console.log('üìÑ Valor do campo role:', data.role);
                        
                        if (data.role === 'superadmin') {
                            isAdmin = true;
                            isSuperAdmin = true;
                            document.getElementById('menu-admin-btn').style.display = 'block';
                            document.getElementById('menu-manage-admins-btn').style.display = 'block';
                            document.getElementById('menu-dashboard-btn').style.display = 'block';
                            document.getElementById('menu-blocked-attempts-btn').style.display = 'block';
                            document.getElementById('menu-pending-escalas-btn').style.display = 'block';
                            console.log('‚úÖ Usu√°rio √â SUPER ADMINISTRADOR');
                            return true;
                        } else if (data.role === 'admin') {
                            isAdmin = true;
                            isSuperAdmin = false;
                            document.getElementById('menu-admin-btn').style.display = 'block';
                            document.getElementById('menu-manage-admins-btn').style.display = 'none'; // Admin n√£o gerencia usu√°rios
                            document.getElementById('menu-dashboard-btn').style.display = 'block';
                            document.getElementById('menu-blocked-attempts-btn').style.display = 'block';
                            document.getElementById('menu-pending-escalas-btn').style.display = 'block';
                            console.log('‚úÖ Usu√°rio √â ADMINISTRADOR');
                            return true;
                        } else {
                            console.log('‚ùå Usu√°rio N√ÉO √© admin. Role =', data.role);
                        }
                    } else {
                        console.log('‚ùå Documento n√£o encontrado em users/' + user.uid);
                    }
                    
                    isAdmin = false;
                    isSuperAdmin = false;
                    document.getElementById('menu-admin-btn').style.display = 'none';
                    document.getElementById('menu-manage-admins-btn').style.display = 'none';
                    document.getElementById('menu-dashboard-btn').style.display = 'none';
                    document.getElementById('menu-blocked-attempts-btn').style.display = 'none';
                    document.getElementById('menu-pending-escalas-btn').style.display = 'none';
                    return false;
                } catch (error) {
                    console.error('‚ùå Erro ao verificar admin:', error);
                    isAdmin = false;
                    isSuperAdmin = false;
                    return false;
                }
            }

            // Atualizar UI do usu√°rio
            function updateUserUI(user) {
                if (user) {
                    const displayName = user.displayName || 'Usu√°rio';
                    const defaultPhoto = 'https://github.com/escalaserver/zele/blob/main/Zele%20logo.png?raw=true';
                    const badge = isSuperAdmin ? ' üëëüëë' : (isAdmin ? ' üëë' : '');
                    elements.userName.textContent = displayName + badge;
                    elements.userEmail.textContent = user.email;
                    elements.userPhoto.src = user.photoURL || defaultPhoto;
                    elements.menuUserName.textContent = displayName + badge;
                    elements.menuUserEmail.textContent = user.email;
                    elements.menuUserPhoto.src = user.photoURL || defaultPhoto;

                    // Mostrar times que o admin/l√≠der lidera abaixo do email no menu
                    const leadershipBadge = (userTeamLeadership && userTeamLeadership.length > 0)
                        ? `L√≠der de: ${userTeamLeadership.map(t => {
                            const map = { welcome: 'üëã Welcome', backstage: 'ü§ù Backstage', parking: 'üöó Parking', kids: 'üë∂ Kids' };
                            return map[t] || t;
                          }).join(' ‚Ä¢ ')}`
                        : '';
                    const leadershipEl = document.getElementById('menu-leadership-info');
                    if (leadershipEl) {
                        leadershipEl.textContent = leadershipBadge;
                        leadershipEl.style.display = leadershipBadge ? 'block' : 'none';
                    } else if (elements && elements.menuUserEmail) {
                        const newInfo = document.createElement('div');
                        newInfo.id = 'menu-leadership-info';
                        newInfo.className = 'text-xs text-gray-500 mt-1';
                        newInfo.textContent = leadershipBadge;
                        newInfo.style.display = leadershipBadge ? 'block' : 'none';
                        elements.menuUserEmail.parentElement?.insertBefore(newInfo, elements.menuUserEmail.nextSibling);
                    }

                    // Replicar exibi√ß√£o na barra superior abaixo do email
                    const topLeadershipEl = document.getElementById('top-leadership-info');
                    if (topLeadershipEl) {
                        topLeadershipEl.textContent = leadershipBadge;
                        topLeadershipEl.style.display = leadershipBadge ? 'inline-block' : 'none';
                    } else if (elements && elements.userEmail) {
                        const topInfo = document.createElement('div');
                        topInfo.id = 'top-leadership-info';
                        topInfo.className = 'text-xs text-gray-500';
                        topInfo.textContent = leadershipBadge;
                        topInfo.style.display = leadershipBadge ? 'inline-block' : 'none';
                        elements.userEmail.parentElement?.insertBefore(topInfo, elements.userEmail.nextSibling);
                    }
                }
            }

            // Mostrar app
            function showApp() {
                elements.loadingScreen.style.display = 'none';
                elements.authScreen.style.display = 'none';
                elements.appContainer.classList.remove('hidden');
            }

            // Mostrar tela de login
            function showLogin() {
                elements.loadingScreen.style.display = 'none';
                elements.authScreen.classList.remove('hidden');
                elements.appContainer.classList.add('hidden');
            }

            // Mostrar tela de loading
            function showLoading() {
                elements.loadingScreen.style.display = 'flex';
                elements.authScreen.style.display = 'none';
                elements.appContainer.classList.add('hidden');
            }

            function hideLoading() {
                elements.loadingScreen.style.display = 'none';
            }

            // Verificar limite de volunt√°rios no time (m√°ximo 4 por time por evento)
            async function checkTeamLimit(date, time, team) {
                try {
                    // Buscar o evento espec√≠fico
                    const eventKey = availableDates.find(d => {
                        const [eventDate, eventTime] = d.value.split('|');
                        return eventDate === date && eventTime === time;
                    });
                    
                    // Obter limite espec√≠fico do time (novo formato) ou padr√£o 4
                    let maxVolunteers = 4;
                    if (eventKey?.teamLimits && eventKey.teamLimits[team]) {
                        maxVolunteers = eventKey.teamLimits[team];
                    } else if (eventKey?.maxVolunteers) {
                        // Retrocompatibilidade com formato antigo
                        maxVolunteers = eventKey.maxVolunteers;
                    }
                    
                    const { collection, query, where, getDocs } = window.firestoreMethods;
                    const q = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('date', '==', date),
                        where('time', '==', time),
                        where('team', '==', team)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    const count = querySnapshot.size;
                    
                    logger.log(`üìä Time ${team} no evento ${date} ${time}: ${count}/${maxVolunteers} volunt√°rios`);
                    
                    return {
                        count: count,
                        isFull: count >= maxVolunteers,
                        remaining: Math.max(0, maxVolunteers - count),
                        maxVolunteers: maxVolunteers
                    };
                } catch (error) {
                    console.error('‚ùå Erro ao verificar limite do time:', error);
                    return { count: 0, isFull: false, remaining: 4, maxVolunteers: 4 };
                }
            }

            // Salvar escala
            async function saveEscala() {
                if (!currentUser) {
                    showModal('Voc√™ precisa estar logado!');
                    return;
                }

                const cultoData = elements.cultoSelect.value;
                const team = selectedTeam;

                if (!cultoData || !team) {
                    showModal('Por favor, selecione um culto e um time!');
                    return;
                }

                // Parsear os dados do culto (formato: "2024-11-20|19:00|Quinta")
                const [date, time, eventName] = cultoData.split('|');

                const teamNames = {
                    welcome: 'Welcome',
                    backstage: 'Backstage',
                    parking: 'Parking',
                    kids: 'Kids'
                };

                try {
                    // Verificar se falta menos de 24h para o evento
                    const eventDateTime = new Date(`${date}T${time}`);
                    const now = new Date();
                    const hoursUntilEvent = (eventDateTime - now) / (1000 * 60 * 60);
                    
                    const isPending = hoursUntilEvent < 24 && hoursUntilEvent > 0;
                    
                    // Verificar limite de volunt√°rios no time para esta data/hora
                    const teamLimit = await checkTeamLimit(date, time, team);
                    
                    // Verificar se j√° existe escala deste usu√°rio para esta data e hor√°rio
                    const escalaId = `${currentUser.uid}_${date}_${time}`;
                    const { doc, getDoc, setDoc } = window.firestoreMethods;
                    
                    // Buscar escala existente
                    const docRef = doc(window.firebaseDb, 'escalas', escalaId);
                    const docSnap = await getDoc(docRef);
                    
                    // Se usu√°rio j√° est√° escalado neste evento
                    const userAlreadyInEvent = docSnap.exists();
                    const isChangingTeam = userAlreadyInEvent && docSnap.data().team !== team;
                    
                    // Se time est√° cheio E usu√°rio n√£o est√° mudando de time (nova entrada)
                    if (teamLimit.isFull && !isChangingTeam) {
                        // Formatar data e hor√°rio para exibir
                        const dateObj = new Date(date + 'T' + time);
                        const dateStr = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                        const timeStr = time;
                        const eventDisplay = eventName ? ` - ${eventName}` : '';
                        
                        // Criar escala como pendente para aprova√ß√£o do l√≠der
                        await saveEscalaToFirestore(escalaId, date, time, team, eventName, false, 'pending');
                        
                        // Criar elemento de mensagem com HTML
                        const message = document.createElement('div');
                        message.innerHTML = `
                            <p>Obrigado pela sua disponibilidade! üòä</p>
                            <p>O time <strong>${teamNames[team]}</strong> j√° est√° com a escala completa para:</p>
                            <p class="mt-2 mb-2"><strong>${dateStr}${eventDisplay} √†s ${timeStr}</strong></p>
                            <p class="mt-2">‚õî Sua solicita√ß√£o foi enviada para o l√≠der para aprova√ß√£o ou remanejamento de time.</p>
                        `;
                        
                        showModal(
                            message.innerHTML,
                            false,
                            null,
                            false,
                            null,
                            '‚õî'
                        );
                        return;
                    }
                    
                    if (docSnap.exists()) {
                        const existingTeam = docSnap.data().team;
                        
                        // Se for o mesmo time, apenas atualiza
                        if (existingTeam === team) {
                            // Mostrar confirma√ß√£o antes de salvar
                            if (isPending) {
                                // Salvar automaticamente sem bot√µes SIM/N√ÉO
                                await saveEscalaToFirestore(escalaId, date, time, team, eventName, true, 'pending');
                                showModal(
                                    `‚õî Aten√ß√£o: faltam menos de 24 horas para o evento. Sua solicita√ß√£o foi enviada para aprova√ß√£o do l√≠der do time.`,
                                    false,
                                    null,
                                    false,
                                    null,
                                    '‚õî'
                                );
                                return;
                            } else {
                                showModal(
                                    `Confirmar escala no time ${teamNames[team]}?`,
                                    true,
                                    async () => {
                                        await saveEscalaToFirestore(escalaId, date, time, team, eventName, true, 'approved');
                                    }
                                );
                            }
                        } else {
                            // Times diferentes - pedir confirma√ß√£o
                            if (isPending) {
                                // Salvar automaticamente sem bot√µes SIM/N√ÉO
                                await saveEscalaToFirestore(escalaId, date, time, team, eventName, false, 'pending');
                                showModal(
                                    `‚õî Voc√™ j√° est√° escalado no time ${teamNames[existingTeam]}. Como faltam menos de 24 horas para o evento, sua mudan√ßa para o time ${teamNames[team]} foi enviada para aprova√ß√£o.`,
                                    false,
                                    null,
                                    false,
                                    null,
                                    '‚õî'
                                );
                                return;
                            } else {
                                showModal(
                                    `Voc√™ j√° escolheu servir no time ${teamNames[existingTeam]}. Deseja confirmar a mudan√ßa para o time ${teamNames[team]} nesta escala?`,
                                    true,
                                    async () => {
                                        await saveEscalaToFirestore(escalaId, date, time, team, eventName, false, 'approved');
                                    }
                                );
                            }
                        }
                    } else {
                        // Nova escala - verificar se √© pendente ou aprovada
                        if (isPending) {
                            // Escala pendente (menos de 24h) - salvar automaticamente
                            await saveEscalaToFirestore(escalaId, date, time, team, eventName, false, 'pending');
                            showModal(
                                `‚õî Aten√ß√£o: faltam menos de 24 horas para o evento. Sua solicita√ß√£o foi enviada para aprova√ß√£o do l√≠der do time.`,
                                false,
                                null,
                                false,
                                null,
                                '‚õî'
                            );
                            return;
                        } else {
                            // Escala normal - mostrar confirma√ß√£o
                            showModal(
                                `Confirmar escala no time ${teamNames[team]}?`,
                                true,
                                async () => {
                                    await saveEscalaToFirestore(escalaId, date, time, team, eventName, false, 'approved');
                                }
                            );
                        }
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar escala:', error);
                    showModal('Erro ao salvar escala. Tente novamente.');
                }
            }

            // Fun√ß√£o auxiliar para salvar no Firestore
            async function saveEscalaToFirestore(escalaId, date, time, team, eventName, skipCalendarPrompt, status = 'approved') {
                try {
                    const { doc, setDoc } = window.firestoreMethods;
                    
                    const escalaData = {
                        userId: currentUser.uid,
                        userName: currentUser.displayName,
                        userEmail: currentUser.email,
                        userPhoto: currentUser.photoURL,
                        date: date,
                        time: time,
                        team: team,
                        eventName: eventName || '',
                        createdAt: new Date().toISOString(),
                        status: status,
                        requestedTeam: team,
                        requestTimestamp: new Date().toISOString()
                    };
                    
                    // Se for escala negada, adicionar raz√£o
                    if (status === 'denied') {
                        escalaData.deniedReason = 'Escala n√£o aprovada pelo l√≠der';
                    }
                    
                    await setDoc(doc(window.firebaseDb, 'escalas', escalaId), escalaData);

                    console.log('‚úÖ Escala salva com sucesso!', status);
                    
                    // Limpar sele√ß√£o e resetar imagens
                    selectedTeam = null;
                    elements.teamBtns.forEach(btn => {
                        btn.classList.remove('selected');
                        const img = btn.querySelector('img');
                        const normalImg = btn.dataset.imgNormal;
                        if (img && normalImg) {
                            img.src = normalImg;
                        }
                    });
                    elements.cultoSelect.value = '';
                    
                    // Recarregar escalas e atualizar dropdown
                    loadUserEscalas();
                    loadAllEscalas();
                    
                    // Mostrar confirma√ß√£o de sucesso
                    if (status === 'pending') {
                        showModal('‚úÖ Solicita√ß√£o enviada! Aguarde aprova√ß√£o do l√≠der do time.');
                    } else {
                        showModal('Escala salva com sucesso!');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar escala:', error);
                    showModal('Erro ao salvar escala. Tente novamente.');
                    throw error;
                }
            }

            // Exportar para Google Calendar
            function exportToGoogleCalendar(date, time, team, eventName) {
                const teamNames = {
                    welcome: 'Welcome',
                    backstage: 'Backstage',
                    parking: 'Parking',
                    kids: 'Kids'
                };

                const startDateTime = `${date}T${time}:00`;
                const endDate = new Date(`${date}T${time}:00`);
                endDate.setHours(endDate.getHours() + 2);
                const endDateTime = endDate.toISOString().slice(0, 16).replace('T', ' ').replace(' ', 'T');

                const title = `Z'ele Church - ${teamNames[team]}${eventName ? ' - ' + eventName : ''}`;
                const description = `Escala volunt√°ria no time ${teamNames[team]}${eventName ? '\\nEvento: ' + eventName : ''}`;
                const location = 'Z\'ele Church - Av. Jacu P√™ssego, 7639';

                const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDateTime.replace(/[-:]/g, '')}/${endDateTime.replace(/[-:]/g, '')}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(location)}`;
                
                window.open(googleCalendarUrl, '_blank');
            }

            // Formatar data para ICS (formato: YYYYMMDDTHHmmss)
            function formatICSDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}${month}${day}T${hours}${minutes}${seconds}`;
            }

            // Carregar escalas do usu√°rio
            async function loadUserEscalas() {
                if (!currentUser) return;

                try {
                    // Limpar escalas de eventos passados
                    await cleanPastEscalas();
                    
                    const { collection, query, where, getDocs } = window.firestoreMethods;
                    const q = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('userId', '==', currentUser.uid)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    const escalas = [];
                    
                    querySnapshot.forEach((doc) => {
                        escalas.push({ id: doc.id, ...doc.data() });
                    });

                    // Ordenar por data e hor√°rio (ordem crescente)
                    escalas.sort((a, b) => {
                        const dateTimeA = new Date(a.date + 'T' + a.time);
                        const dateTimeB = new Date(b.date + 'T' + b.time);
                        return dateTimeA - dateTimeB;
                    });

                    // Armazenar todas as escalas
                    allUserEscalas = escalas;
                    
                    // Atualizar filtro com datas dispon√≠veis
                    updateMinhasEscalasFilter(escalas);
                    
                    renderUserEscalas(escalas);
                    updateCultoDropdown(escalas);
                    updateUpcomingEventsBadge(escalas);
                    checkAndSendReminders(escalas);
                } catch (error) {
                    console.error('‚ùå Erro ao carregar escalas:', error);
                }
            }
            
            // Atualizar filtro de Minhas Escalas
            function updateMinhasEscalasFilter(escalas) {
                const filter = elements.filterMinhasEscalas;
                const uniqueDates = [...new Set(escalas.map(e => e.date))].sort();
                
                filter.innerHTML = '<option value="">Todas as datas</option>';
                
                uniqueDates.forEach(date => {
                    const dateObj = new Date(date + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = dateStr;
                    filter.appendChild(option);
                });
            }
            
            // Event listener para filtro de Minhas Escalas
            elements.filterMinhasEscalas.addEventListener('change', () => {
                const selectedDate = elements.filterMinhasEscalas.value;
                if (selectedDate) {
                    const filtered = allUserEscalas.filter(e => e.date === selectedDate);
                    renderUserEscalas(filtered);
                } else {
                    renderUserEscalas(allUserEscalas);
                }
            });
            
            // Mostrar modal de pr√≥ximos eventos
            function showUpcomingEventsModal() {
                const upcomingEvents = updateUpcomingEventsBadge(allUserEscalas);
                
                const teamNames = {
                    welcome: 'Welcome',
                    backstage: 'Backstage',
                    parking: 'Parking',
                    kids: 'Kids'
                };
                
                if (upcomingEvents.length === 0) {
                    showModal('‚úÖ Voc√™ n√£o tem eventos nas pr√≥ximas 48 horas!', false, null, false, null, 'üìÖ');
                    return;
                }
                
                const eventsList = upcomingEvents.map(event => {
                    const eventDate = new Date(event.date + 'T' + event.time);
                    const formattedDate = eventDate.toLocaleDateString('pt-BR', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short' 
                    });
                    const formattedTime = event.time === '00:00' ? '(hor√°rio a definir)' : event.time;
                    const hoursUntil = Math.round((eventDate - new Date()) / (1000 * 60 * 60));
                    
                    return `<div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-2 rounded">
                        <div class="font-bold text-gray-800">${teamNames[event.team]}</div>
                        <div class="text-sm text-gray-700">üìÖ ${formattedDate} ${event.eventName ? '- ' + event.eventName : ''}</div>
                        <div class="text-sm text-gray-700">üïê ${formattedTime}</div>
                        <div class="text-xs text-yellow-700 font-semibold mt-1">‚è∞ Faltam ${hoursUntil}h</div>
                    </div>`;
                }).join('');
                
                showModal(
                    `<div class="text-left">
                        <div class="mb-4 text-center">
                            <h3 class="text-lg font-bold text-gray-800">üîî Seus Pr√≥ximos Eventos</h3>
                            <p class="text-sm text-gray-600">Voc√™ tem ${upcomingEvents.length} evento(s) nas pr√≥ximas 48h</p>
                        </div>
                        ${eventsList}
                    </div>`,
                    false,
                    null,
                    false,
                    null,
                    null
                );
            }

            // Limpar escalas de eventos passados
            async function cleanPastEscalas() {
                try {
                    const { collection, query, where, getDocs, deleteDoc, doc } = window.firestoreMethods;
                    const now = new Date();
                    
                    // Buscar todas as escalas
                    const q = query(collection(window.firebaseDb, 'escalas'));
                    const querySnapshot = await getDocs(q);
                    
                    let deletedCount = 0;
                    const deletePromises = [];
                    
                    querySnapshot.forEach((docSnapshot) => {
                        const escala = docSnapshot.data();
                        const eventDateTime = new Date(escala.date + 'T' + escala.time);
                        const status = escala.status || 'approved';
                        
                        // Se o evento j√° passou, deletar apenas escalas aprovadas OU negadas
                        // Escalas pendentes n√£o devem ser deletadas automaticamente (admin decide)
                        if (eventDateTime < now && (status === 'approved' || status === 'denied')) {
                            deletePromises.push(
                                deleteDoc(doc(window.firebaseDb, 'escalas', docSnapshot.id))
                            );
                            deletedCount++;
                        }
                    });
                    
                    if (deletePromises.length > 0) {
                        await Promise.all(deletePromises);
                        console.log(`üßπ ${deletedCount} escala(s) de eventos passados foram removidas`);
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao limpar escalas passadas:', error);
                }
            }

            // Carregar datas dispon√≠veis do Firestore
            async function loadAvailableDates() {
                try {
                    console.log('üîÑ Carregando datas dispon√≠veis...');
                    const { doc, getDoc } = window.firestoreMethods;
                    const datesDoc = await getDoc(doc(window.firebaseDb, 'config', 'availableDates'));
                    
                    console.log('üîç DEBUG - Documento existe?', datesDoc.exists());
                    console.log('üîç DEBUG - Dados do documento:', datesDoc.data());
                    
                    if (datesDoc.exists()) {
                        availableDates = datesDoc.data().dates || [];
                        console.log('üì¶ Datas encontradas no Firestore:', availableDates.length);
                        console.log('üîç DEBUG - Primeira data (exemplo):', availableDates[0]);
                        
                        // Adicionar teamLimits padr√£o se n√£o existir (retrocompatibilidade)
                        availableDates = availableDates.map(date => {
                            if (!date.teamLimits) {
                                // Se tem maxVolunteers antigo, usar para todos os times
                                const defaultLimit = date.maxVolunteers || 4;
                                return {
                                    ...date,
                                    teamLimits: {
                                        welcome: defaultLimit,
                                        backstage: defaultLimit,
                                        parking: defaultLimit,
                                        kids: defaultLimit
                                    }
                                };
                            }
                            return date;
                        });
                        
                        // Filtrar apenas eventos futuros
                        const now = new Date();
                        console.log('üîç DEBUG - Data/hora atual:', now.toISOString());
                        const initialCount = availableDates.length;
                        availableDates = availableDates.filter(d => {
                            const [date, time] = d.value.split('|');
                            const eventDateTime = new Date(date + 'T' + time);
                            const isFuture = eventDateTime > now;
                            console.log(`üîç DEBUG - Evento: ${d.text} (${d.value}) ‚Üí ${eventDateTime.toISOString()} ‚Üí Futuro? ${isFuture}`);
                            return isFuture;
                        });
                        
                        console.log(`üßπ Filtrado: ${initialCount} ‚Üí ${availableDates.length} eventos futuros`);
                    } else {
                        // Documento n√£o existe - lista vazia (admin deve adicionar)
                        availableDates = [];
                        console.log('üì≠ Nenhuma data cadastrada. Admin deve adicionar datas.');
                        
                        // Criar documento vazio no Firestore
                        const { setDoc } = window.firestoreMethods;
                        await setDoc(doc(window.firebaseDb, 'config', 'availableDates'), { dates: [] });
                        console.log('‚úÖ Documento availableDates criado');
                    }
                    
                    console.log('‚úÖ Datas dispon√≠veis carregadas:', availableDates.length);
                    
                    // Renderizar lista de datas para admin
                    if (isAdmin) {
                        renderAdminDatesList();
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar datas:', error);
                    availableDates = [];
                }
            }

            // Atualizar dropdown removendo datas j√° escaladas
            function updateCultoDropdown(escalas) {
                const select = elements.cultoSelect;
                
                console.log('üîç updateCultoDropdown chamado');
                console.log('üîç Datas dispon√≠veis:', availableDates.length);
                console.log('üîç Escalas do usu√°rio:', escalas.length);

                // Criar set com data+hora j√° escaladas (formato: date_time)
                const escaladasDateTimes = new Set(escalas.map(e => `${e.date}_${e.time}`));
                
                // Data/hora atual
                const now = new Date();

                // Limpar select
                select.innerHTML = '';

                // Adicionar op√ß√£o padr√£o
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Escolha uma data...';
                select.appendChild(defaultOption);

                // Filtrar apenas eventos futuros e ordenar por data
                const sortedDates = [...availableDates]
                    .filter(option => {
                        const [date, time] = option.value.split('|');
                        const eventDateTime = new Date(date + 'T' + time);
                        return eventDateTime > now;
                    })
                    .sort((a, b) => {
                        const dateA = a.value.split('|')[0];
                        const dateB = b.value.split('|')[0];
                        return dateA.localeCompare(dateB);
                    });

                // Adicionar apenas op√ß√µes n√£o escaladas e futuras (j√° ordenadas)
                sortedDates.forEach(option => {
                    const [date, time] = option.value.split('|');
                    const dateTimeKey = `${date}_${time}`;
                    if (!escaladasDateTimes.has(dateTimeKey)) {
                        const optionElement = document.createElement('option');
                        optionElement.value = option.value;
                        optionElement.textContent = option.text;
                        select.appendChild(optionElement);
                    }
                });

                // Se n√£o houver mais datas dispon√≠veis
                if (select.options.length === 1) {
                    select.innerHTML = '<option value="">Todas as datas j√° est√£o escaladas</option>';
                    select.disabled = true;
                } else {
                    select.disabled = false;
                }
                
                console.log('‚úÖ Dropdown atualizado. Total de op√ß√µes:', select.options.length);
            }

            // Renderizar escalas do usu√°rio
            function renderUserEscalas(escalas) {
                const teamConfig = {
                    welcome: { name: 'Welcome', icon: 'üëã', color: 'border-[#377db8]', bg: 'bg-blue-50' },
                    backstage: { name: 'Backstage', icon: 'ü§ù', color: 'border-[#0a0e1a]', bg: 'bg-gray-50' },
                    parking: { name: 'Parking', icon: 'üöó', color: 'border-[#f87171]', bg: 'bg-red-50' },
                    kids: { name: 'Kids', icon: 'üë∂', color: 'border-[#fbbf24]', bg: 'bg-yellow-50' }
                };

                if (escalas.length === 0) {
                    elements.escalasList.innerHTML = '<p class="text-gray-500 text-center py-8">Voc√™ ainda n√£o tem escalas agendadas.</p>';
                    return;
                }

                const html = escalas.map(escala => {
                    const status = escala.status || 'approved';
                    const config = teamConfig[escala.team];
                    const dateObj = new Date(escala.date + 'T' + escala.time);
                    const dateStr = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const timeStr = escala.time;
                    const eventNameDisplay = escala.eventName ? ` - ${escala.eventName}` : '';
                    
                    // Mostrar bot√£o de deletar apenas se for a pr√≥pria escala do usu√°rio e estiver aprovada
                    const canDelete = escala.userId === currentUser.uid && status === 'approved';
                    
                    // Estilos diferentes por status
                    let cardStyles = {
                        icon: config.icon,
                        teamName: config.name,
                        borderColor: config.color,
                        bgColor: config.bg,
                        textStyle: '',
                        teamDisplay: config.name
                    };
                    
                    if (status === 'pending') {
                        cardStyles = {
                            icon: '‚õî',
                            teamName: 'PENDENTE',
                            borderColor: 'border-red-500',
                            bgColor: 'bg-white',
                            textStyle: 'text-red-600 italic',
                            teamDisplay: 'PENDENTE'
                        };
                    } else if (status === 'denied') {
                        cardStyles = {
                            icon: 'üôè',
                            teamName: 'Obrigado',
                            borderColor: 'border-gray-300',
                            bgColor: 'bg-white',
                            textStyle: 'text-black',
                            teamDisplay: 'Obrigado, mas n√£o ser√° necess√°rio servir neste culto'
                        };
                    } else if (status === 'approved' && escala.requestedTeam && escala.requestedTeam !== escala.team) {
                        // Aprovado mas time mudou - mostrar em verde
                        cardStyles.textStyle = 'text-green-600';
                    } else if (status === 'approved') {
                        // Aprovado normal
                        cardStyles.textStyle = '';
                    }

                    return `
                        <div class="border-l-4 ${cardStyles.borderColor} ${cardStyles.bgColor} p-4 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="text-3xl">${cardStyles.icon}</div>
                                    <div>
                                        <h3 class="font-bold text-lg ${cardStyles.textStyle}">${cardStyles.teamDisplay}${eventNameDisplay}</h3>
                                        <p class="text-sm text-gray-600">üìÖ ${dateStr}</p>
                                        <p class="text-sm text-gray-600">üïê ${timeStr}</p>
                                        ${escala.teamChangeNotice ? `<p class="text-xs text-orange-600 mt-1">‚ö†Ô∏è ${escala.teamChangeNotice}</p>` : ''}
                                    </div>
                                </div>
                                ${canDelete ? `
                                <button class="delete-escala-btn text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition" data-escala-id="${escala.id}" data-escala-date="${escala.date}" title="Deletar escala">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                elements.escalasList.innerHTML = html;

                // Event listeners para deletar (apenas escalas pr√≥prias)
                document.querySelectorAll('.delete-escala-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        const escalaDate = e.currentTarget.dataset.escalaDate;
                        
                        // Buscar dados completos da escala
                        const escala = escalas.find(esc => esc.id === escalaId);
                        
                        // Verificar se pode deletar (n√£o pode deletar na v√©spera ou no dia)
                        if (!canDeleteEscala(escalaDate)) {
                            // Registrar tentativa bloqueada
                            if (escala) {
                                logBlockedAttempt(escala);
                            }
                            
                            showModal(
                                'Por aqui, n√£o √© poss√≠vel deletar escala na v√©spera ou no dia do evento. Entre em contato com o l√≠der para solicitar a exclus√£o.',
                                false,
                                null,
                                false,
                                null,
                                '‚õî'
                            );
                            return;
                        }
                        
                        showModal(
                            'Tem certeza que deseja remover esta escala?',
                            true,
                            () => deleteEscala(escalaId),
                            true
                        );
                    });
                });
            }

            // Carregar todas as escalas (vis√£o admin)
            async function loadAllEscalas() {
                try {
                    const { collection, getDocs } = window.firestoreMethods;
                    const querySnapshot = await getDocs(collection(window.firebaseDb, 'escalas'));
                    const escalas = [];
                    
                    querySnapshot.forEach((doc) => {
                        escalas.push({ id: doc.id, ...doc.data() });
                    });

                    // Agrupar por data e time
                    const grouped = {};
                    escalas.forEach(escala => {
                        const key = `${escala.date}_${escala.time}`;
                        if (!grouped[key]) {
                            grouped[key] = {
                                date: escala.date,
                                time: escala.time,
                                eventName: escala.eventName || '',
                                welcome: [],
                                backstage: [],
                                parking: [],
                                kids: []
                            };
                        }
                        grouped[key][escala.team].push(escala);
                    });

                    // Armazenar dados completos
                    allEscalasGrouped = grouped;
                    
                    // Atualizar filtro
                    updateVisaoGeralFilter(grouped);
                    
                    renderAdminView(grouped);
                } catch (error) {
                    console.error('‚ùå Erro ao carregar vis√£o geral:', error);
                }
            }
            
            // Atualizar filtro de Vis√£o Geral
            function updateVisaoGeralFilter(grouped) {
                const filter = elements.filterVisaoGeral;
                // Ordenar chaves por data e hora
                const dates = Object.keys(grouped).sort((a, b) => {
                    const [dateA, timeA] = a.split('_');
                    const [dateB, timeB] = b.split('_');
                    const dateTimeA = new Date(dateA + 'T' + timeA);
                    const dateTimeB = new Date(dateB + 'T' + timeB);
                    return dateTimeA - dateTimeB;
                });
                
                filter.innerHTML = '<option value="">Todas as datas</option>';
                
                // Agrupar por data √∫nica (sem hora)
                const uniqueDates = new Map();
                dates.forEach(key => {
                    const data = grouped[key];
                    const dateOnly = data.date; // Apenas YYYY-MM-DD
                    if (!uniqueDates.has(dateOnly)) {
                        uniqueDates.set(dateOnly, []);
                    }
                    uniqueDates.get(dateOnly).push(key);
                });
                
                // Criar op√ß√µes por data √∫nica
                uniqueDates.forEach((keys, dateOnly) => {
                    const dateObj = new Date(dateOnly + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const option = document.createElement('option');
                    option.value = keys.join(','); // M√∫ltiplas chaves separadas por v√≠rgula
                    option.textContent = dateStr;
                    filter.appendChild(option);
                });
            }
            
            // Event listener para filtro de Vis√£o Geral
            elements.filterVisaoGeral.addEventListener('change', () => {
                const selectedValue = elements.filterVisaoGeral.value;
                if (selectedValue) {
                    // Pode ter m√∫ltiplas chaves (eventos no mesmo dia)
                    const keys = selectedValue.split(',');
                    const filtered = {};
                    keys.forEach(key => {
                        if (allEscalasGrouped[key]) {
                            filtered[key] = allEscalasGrouped[key];
                        }
                    });
                    renderAdminView(filtered);
                } else {
                    renderAdminView(allEscalasGrouped);
                }
            });

            // Salvar tentativa bloqueada de dele√ß√£o no Firestore
            async function logBlockedAttempt(escalaData) {
                try {
                    const { collection, addDoc } = window.firestoreMethods;
                    await addDoc(collection(window.firebaseDb, 'blockedAttempts'), {
                        userId: currentUser.uid,
                        userName: currentUser.displayName || currentUser.email,
                        userEmail: currentUser.email,
                        escalaDate: escalaData.date,
                        escalaTime: escalaData.time,
                        escalaTeam: escalaData.team,
                        escalaEventName: escalaData.eventName || '',
                        attemptDate: new Date().toISOString(),
                        attemptDateFormatted: new Date().toLocaleString('pt-BR'),
                        timestamp: Date.now()
                    });
                    console.log('üìã Tentativa bloqueada registrada');
                } catch (error) {
                    console.error('‚ùå Erro ao registrar tentativa bloqueada:', error);
                }
            }

            // Mostrar modal de pr√≥ximos eventos
            function showUpcomingEventsModal() {
                const upcomingEvents = updateUpcomingEventsBadge(allUserEscalas);
                
                const teamNames = {
                    welcome: 'Welcome',
                    backstage: 'Backstage',
                    parking: 'Parking',
                    kids: 'Kids'
                };
                
                if (upcomingEvents.length === 0) {
                    showModal('‚úÖ Voc√™ n√£o tem eventos nas pr√≥ximas 48 horas!', false, null, false, null, 'üìÖ');
                    return;
                }
                
                const eventsList = upcomingEvents.map(event => {
                    const eventDate = new Date(event.date + 'T' + event.time);
                    const formattedDate = eventDate.toLocaleDateString('pt-BR', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short' 
                    });
                    const formattedTime = event.time === '00:00' ? '(hor√°rio a definir)' : event.time;
                    const hoursUntil = Math.round((eventDate - new Date()) / (1000 * 60 * 60));
                    
                    return `<div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-2 rounded">
                        <div class="font-bold text-gray-800">${teamNames[event.team]}</div>
                        <div class="text-sm text-gray-700">üìÖ ${formattedDate} ${event.eventName ? '- ' + event.eventName : ''}</div>
                        <div class="text-sm text-gray-700">üïê ${formattedTime}</div>
                        <div class="text-xs text-yellow-700 font-semibold mt-1">‚è∞ Faltam ${hoursUntil}h</div>
                    </div>`;
                }).join('');
                
                showModal(
                    `<div class="text-left">
                        <div class="mb-4 text-center">
                            <h3 class="text-lg font-bold text-gray-800">üîî Seus Pr√≥ximos Eventos</h3>
                            <p class="text-sm text-gray-600">Voc√™ tem ${upcomingEvents.length} evento(s) nas pr√≥ximas 48h</p>
                        </div>
                        ${eventsList}
                    </div>`,
                    false,
                    null,
                    false,
                    null,
                    null
                );
            }
            
            // Carregar tentativas bloqueadas (apenas superadmin)
            let blockedAttemptsUnsubscribe = null; // Guardar refer√™ncia do listener
            
            async function loadBlockedAttempts() {
                // Apenas superadmin pode ver tentativas bloqueadas
                if (!isSuperAdmin) {
                    console.log('‚ö†Ô∏è Usu√°rio n√£o √© super admin. Acesso negado.');
                    const listEl = document.getElementById('blocked-attempts-list');
                    if (listEl) {
                        listEl.innerHTML = '<p class="text-red-500 text-center py-8">‚ö†Ô∏è Apenas Super Administradores podem acessar esta √°rea.</p>';
                    }
                    return;
                }
                
                const listEl = document.getElementById('blocked-attempts-list');
                if (!listEl) {
                    console.error('‚ùå Elemento blocked-attempts-list n√£o encontrado');
                    return;
                }
                
                // Mostrar loading
                listEl.innerHTML = '<p class="text-gray-500 text-center py-8">Carregando...</p>';
                
                // Cancelar listener anterior se existir
                if (blockedAttemptsUnsubscribe) {
                    blockedAttemptsUnsubscribe();
                    blockedAttemptsUnsubscribe = null;
                }
                
                try {
                    console.log('üîç Verificando m√©todos dispon√≠veis:', Object.keys(window.firestoreMethods || {}));
                    
                    const { collection, query, orderBy, onSnapshot, getDocs } = window.firestoreMethods || {};
                    
                    if (!collection) {
                        throw new Error('M√©todos do Firestore n√£o dispon√≠veis. Recarregue a p√°gina.');
                    }
                    
                    // Criar query com ordena√ß√£o
                    let q;
                    if (query && orderBy) {
                        q = query(
                            collection(window.firebaseDb, 'blockedAttempts'),
                            orderBy('timestamp', 'desc')
                        );
                    } else {
                        console.warn('‚ö†Ô∏è orderBy n√£o dispon√≠vel');
                        q = collection(window.firebaseDb, 'blockedAttempts');
                    }
                    
                    // Listener em tempo real
                    if (onSnapshot) {
                        console.log('üëÇ Configurando listener em tempo real...');
                        blockedAttemptsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                            const attempts = [];
                            querySnapshot.forEach((doc) => {
                                attempts.push({ id: doc.id, ...doc.data() });
                            });
                            
                            // Ordenar manualmente se orderBy n√£o estiver dispon√≠vel
                            if (!orderBy) {
                                attempts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                            }
                            
                            console.log('üìã Tentativas bloqueadas atualizadas em tempo real:', attempts.length);
                            renderBlockedAttempts(attempts);
                        }, (error) => {
                            console.error('‚ùå Erro no listener:', error);
                            console.error('‚ùå C√≥digo do erro:', error.code);
                            console.error('‚ùå Mensagem:', error.message);
                            
                            // Erro de permiss√£o
                            if (error.code === 'permission-denied') {
                                listEl.innerHTML = `
                                    <div class="text-center py-8">
                                        <p class="text-red-500 font-bold mb-2">üîí Permiss√£o Negada</p>
                                        <p class="text-sm text-gray-600 mb-4">Voc√™ n√£o tem permiss√£o para acessar tentativas bloqueadas.</p>
                                        <p class="text-xs text-gray-500">Configure as regras do Firestore para permitir leitura da cole√ß√£o 'blockedAttempts' para super admins.</p>
                                        <code class="text-xs bg-gray-100 p-3 rounded block text-left mt-4">
                                            match /blockedAttempts/{document} {<br>
                                            &nbsp;&nbsp;allow read: if request.auth != null;<br>
                                            &nbsp;&nbsp;allow write: if request.auth != null;<br>
                                            }
                                        </code>
                                    </div>
                                `;
                            } else {
                                listEl.innerHTML = `<p class="text-red-500 text-center py-8">‚ùå Erro ao monitorar dados: ${error.message}</p>`;
                            }
                        });
                    } else if (getDocs) {
                        // Fallback: usar getDocs (sem tempo real)
                        console.warn('‚ö†Ô∏è onSnapshot n√£o dispon√≠vel, usando getDocs');
                        const querySnapshot = await getDocs(q);
                        const attempts = [];
                        querySnapshot.forEach((doc) => {
                            attempts.push({ id: doc.id, ...doc.data() });
                        });
                        
                        if (!orderBy) {
                            attempts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        }
                        
                        console.log('üìã Tentativas bloqueadas carregadas:', attempts.length);
                        renderBlockedAttempts(attempts);
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar tentativas bloqueadas:', error);
                    console.error('‚ùå Detalhes do erro:', error.message);
                    console.error('‚ùå C√≥digo:', error.code);
                    
                    if (error.code === 'permission-denied') {
                        listEl.innerHTML = `
                            <div class="text-center py-8">
                                <p class="text-red-500 font-bold mb-2">üîí Permiss√£o Negada</p>
                                <p class="text-sm text-gray-600 mb-4">Voc√™ n√£o tem permiss√£o para acessar tentativas bloqueadas.</p>
                                <p class="text-xs text-gray-500 mb-4">Configure as regras do Firestore:</p>
                                <code class="text-xs bg-gray-100 p-3 rounded block text-left">
                                    match /blockedAttempts/{document} {<br>
                                    &nbsp;&nbsp;allow read: if request.auth != null;<br>
                                    &nbsp;&nbsp;allow write: if request.auth != null;<br>
                                    }
                                </code>
                            </div>
                        `;
                    } else {
                        listEl.innerHTML = `<p class="text-red-500 text-center py-8">‚ùå ${error.message || 'Erro ao carregar dados.'}<br><small class="text-xs">Tente recarregar a p√°gina (Ctrl+Shift+R)</small></p>`;
                    }
                }
            }

            // Renderizar lista de tentativas bloqueadas
            function renderBlockedAttempts(attempts) {
                const listEl = document.getElementById('blocked-attempts-list');
                
                if (!listEl) {
                    console.error('‚ùå Elemento blocked-attempts-list n√£o encontrado no render');
                    return;
                }
                
                if (attempts.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-8">‚úÖ Nenhuma tentativa bloqueada registrada.</p>';
                    return;
                }
                
                const teamNames = {
                    welcome: 'Welcome',
                    backstage: 'Backstage',
                    parking: 'Parking',
                    kids: 'Kids'
                };
                
                const html = attempts.map(attempt => {
                    const eventDate = new Date(attempt.escalaDate + 'T' + attempt.escalaTime);
                    const eventDateStr = eventDate.toLocaleDateString('pt-BR', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    const eventNameDisplay = attempt.escalaEventName ? ` - ${attempt.escalaEventName}` : '';
                    
                    return `
                        <div class="border-l-4 border-orange-500 bg-orange-50 p-4 rounded-lg mb-3">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="font-bold text-gray-800">${attempt.userName}</span>
                                        <span class="text-xs text-gray-500">${attempt.userEmail}</span>
                                    </div>
                                    <div class="space-y-1 text-sm text-gray-700">
                                        <p><strong>üìÖ Evento:</strong> ${eventDateStr}${eventNameDisplay}</p>
                                        <p><strong>üïë Hor√°rio:</strong> ${attempt.escalaTime}</p>
                                        <p><strong>üë• Equipe:</strong> ${teamNames[attempt.escalaTeam] || attempt.escalaTeam}</p>
                                        <p class="text-xs text-gray-500 mt-2"><strong>‚è∞ Tentativa em:</strong> ${attempt.attemptDateFormatted}</p>
                                    </div>
                                </div>
                                <button 
                                    class="delete-attempt-btn flex-shrink-0 p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition"
                                    data-attempt-id="${attempt.id}"
                                    title="Excluir tentativa">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                listEl.innerHTML = html;
                
                // Adicionar event listeners aos bot√µes de deletar
                document.querySelectorAll('.delete-attempt-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const attemptId = e.currentTarget.dataset.attemptId;
                        deleteBlockedAttempt(attemptId);
                    });
                });
            }
            
            // Deletar tentativa bloqueada
            async function deleteBlockedAttempt(attemptId) {
                console.log('üóëÔ∏è deleteBlockedAttempt chamada. ID:', attemptId);
                showModal(
                    'Tem certeza que deseja excluir esta tentativa de bloqueio?',
                    true,
                    async () => {
                        try {
                            console.log('üîµ Confirma√ß√£o recebida. Iniciando exclus√£o...');
                            console.log('üîç attemptId:', attemptId);
                            console.log('üîç firebaseDb existe?', !!window.firebaseDb);
                            console.log('üîç firestoreMethods existe?', !!window.firestoreMethods);
                            
                            const { doc, deleteDoc } = window.firestoreMethods;
                            
                            if (!doc || !deleteDoc) {
                                throw new Error('M√©todos Firestore n√£o dispon√≠veis');
                            }
                            
                            console.log('üîµ Criando refer√™ncia do documento...');
                            const docRef = doc(window.firebaseDb, 'blockedAttempts', attemptId);
                            console.log('üîµ Refer√™ncia criada:', docRef);
                            
                            console.log('üîµ Executando deleteDoc...');
                            await deleteDoc(docRef);
                            
                            console.log('‚úÖ Tentativa exclu√≠da com sucesso!');
                            showModal('‚úÖ Tentativa exclu√≠da com sucesso!');
                            // A lista ser√° atualizada automaticamente pelo listener em tempo real
                        } catch (error) {
                            console.error('‚ùå ERRO DETALHADO ao deletar tentativa:', error);
                            console.error('‚ùå Tipo:', error.name);
                            console.error('‚ùå Mensagem:', error.message);
                            console.error('‚ùå Code:', error.code);
                            console.error('‚ùå Stack:', error.stack);
                            showModal(`‚ùå Erro ao excluir tentativa: ${error.message || error.code}`);
                        }
                    },
                    true
                );
            }

            // Verificar se pode deletar escala (impede dele√ß√£o na v√©spera e no dia)
            
            // ========================================
            // ESCALAS PENDENTES (Admin)
            // ========================================
            
            let currentPendingEscalaId = null;
            
            // Carregar escalas pendentes (apenas admin)
            async function loadPendingEscalas() {
                if (!isAdmin && !isSuperAdmin) {
                    console.log('‚ö†Ô∏è Usu√°rio n√£o √© admin. Acesso negado.');
                    return;
                }
                
                const listEl = document.getElementById('pending-escalas-list');
                if (!listEl) {
                    console.error('‚ùå Elemento pending-escalas-list n√£o encontrado');
                    return;
                }
                
                listEl.innerHTML = '<p class="text-gray-500 text-center py-8">Carregando...</p>';
                
                try {
                    const { collection, query, where, getDocs } = window.firestoreMethods;
                    
                    if (!collection) {
                        throw new Error('M√©todos do Firestore n√£o dispon√≠veis. Recarregue a p√°gina.');
                    }
                    
                    // Buscar escalas com status pending
                    const q = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('status', '==', 'pending')
                    );
                    
                    const querySnapshot = await getDocs(q);
                    const pendingEscalas = [];
                    
                    querySnapshot.forEach((doc) => {
                        pendingEscalas.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordenar por timestamp de solicita√ß√£o
                    pendingEscalas.sort((a, b) => {
                        const timeA = new Date(a.requestTimestamp || a.createdAt).getTime();
                        const timeB = new Date(b.requestTimestamp || b.createdAt).getTime();
                        return timeB - timeA; // Mais recentes primeiro
                    });
                    
                    console.log('üìã Escalas pendentes carregadas:', pendingEscalas.length);
                    renderPendingEscalas(pendingEscalas);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar escalas pendentes:', error);
                    listEl.innerHTML = `<p class="text-red-500 text-center py-8">‚ùå ${error.message || 'Erro ao carregar dados.'}</p>`;
                }
            }
            
            // Renderizar lista de escalas pendentes
            function renderPendingEscalas(escalas) {
                const listEl = document.getElementById('pending-escalas-list');
                
                if (escalas.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-center py-8">‚úÖ N√£o h√° escalas pendentes no momento.</p>';
                    return;
                }
                
                const teamNames = {
                    welcome: 'Welcome üëã',
                    backstage: 'Backstage ü§ù',
                    parking: 'Parking üöó',
                    kids: 'Kids üë∂'
                };
                
                const html = escalas.map(escala => {
                    const eventDate = new Date(escala.date + 'T' + escala.time);
                    const eventDateStr = eventDate.toLocaleDateString('pt-BR', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    const requestDate = new Date(escala.requestTimestamp || escala.createdAt);
                    const requestDateStr = requestDate.toLocaleString('pt-BR');
                    const eventNameDisplay = escala.eventName ? ` - ${escala.eventName}` : '';
                    const hoursUntilEvent = Math.round((eventDate - new Date()) / (1000 * 60 * 60));
                    
                    return `
                        <div class="border-l-4 border-blue-500 bg-blue-50 p-4 rounded-lg">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <img src="${escala.userPhoto || 'https://via.placeholder.com/40'}" alt="${escala.userName}" class="w-10 h-10 rounded-full">
                                        <div>
                                            <p class="font-bold text-gray-800">${escala.userName}</p>
                                            <p class="text-xs text-gray-500">${escala.userEmail}</p>
                                        </div>
                                    </div>
                                    <div class="space-y-1 text-sm text-gray-700 mt-3">
                                        <p><strong>üìÖ Evento:</strong> ${eventDateStr}${eventNameDisplay}</p>
                                        <p><strong>üïë Hor√°rio:</strong> ${escala.time}</p>
                                        <p><strong>üë• Time solicitado:</strong> ${teamNames[escala.requestedTeam] || escala.requestedTeam}</p>
                                        <p class="text-xs text-gray-500 mt-2"><strong>‚è∞ Solicitado em:</strong> ${requestDateStr}</p>
                                        <p class="text-xs ${hoursUntilEvent < 12 ? 'text-red-600 font-bold' : 'text-orange-600'}">‚ö†Ô∏è Faltam ${hoursUntilEvent}h para o evento</p>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button 
                                        class="approve-escala-btn px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition text-sm font-semibold"
                                        data-escala-id="${escala.id}"
                                        data-escala-team="${escala.requestedTeam}"
                                        title="Aprovar escala">
                                        ‚úÖ Aprovar
                                    </button>
                                    <button 
                                        class="deny-escala-btn px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition text-sm font-semibold"
                                        data-escala-id="${escala.id}"
                                        title="Negar escala">
                                        ‚ùå Negar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                listEl.innerHTML = html;
                
                // Event listeners para aprovar
                document.querySelectorAll('.approve-escala-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        const requestedTeam = e.currentTarget.dataset.escalaTeam;
                        openApproveTeamModal(escalaId, requestedTeam);
                    });
                });
                
                // Event listeners para negar
                document.querySelectorAll('.deny-escala-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        denyPendingEscala(escalaId);
                    });
                });
            }
            
            // Abrir modal de sele√ß√£o de time para aprovar
            function openApproveTeamModal(escalaId, requestedTeam) {
                currentPendingEscalaId = escalaId;
                
                const teamOptions = [
                    { key: 'welcome', name: 'Welcome', icon: 'üëã', color: 'bg-blue-100 hover:bg-blue-200 border-blue-500' },
                    { key: 'backstage', name: 'Backstage', icon: 'ü§ù', color: 'bg-gray-100 hover:bg-gray-200 border-gray-500' },
                    { key: 'parking', name: 'Parking', icon: 'üöó', color: 'bg-red-100 hover:bg-red-200 border-red-500' },
                    { key: 'kids', name: 'Kids', icon: 'üë∂', color: 'bg-yellow-100 hover:bg-yellow-200 border-yellow-500' }
                ];
                
                const html = teamOptions.map(team => {
                    const isRequested = team.key === requestedTeam;
                    return `
                        <button 
                            class="approve-team-option w-full flex items-center gap-3 p-3 rounded-lg border-2 ${team.color} transition"
                            data-team="${team.key}">
                            <span class="text-2xl">${team.icon}</span>
                            <span class="font-semibold text-gray-800">${team.name}</span>
                            ${isRequested ? '<span class="ml-auto text-xs bg-blue-500 text-white px-2 py-1 rounded">Solicitado</span>' : ''}
                        </button>
                    `;
                }).join('');
                
                document.getElementById('approve-team-options').innerHTML = html;
                
                // Event listeners para sele√ß√£o de time
                document.querySelectorAll('.approve-team-option').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const selectedTeam = e.currentTarget.dataset.team;
                        approvePendingEscala(currentPendingEscalaId, selectedTeam, requestedTeam);
                    });
                });
                
                document.getElementById('approve-team-modal').classList.remove('hidden');
            }
            
            // Aprovar escala pendente
            async function approvePendingEscala(escalaId, selectedTeam, requestedTeam) {
                try {
                    const { doc, updateDoc, getDoc } = window.firestoreMethods;
                    
                    // Fechar modal de sele√ß√£o de time
                    document.getElementById('approve-team-modal').classList.add('hidden');
                    
                    // Buscar dados completos da escala
                    const escalaRef = doc(window.firebaseDb, 'escalas', escalaId);
                    const escalaDoc = await getDoc(escalaRef);
                    
                    if (!escalaDoc.exists()) {
                        throw new Error('Escala n√£o encontrada');
                    }
                    
                    const escalaData = escalaDoc.data();
                    
                    // Determinar se houve mudan√ßa de time
                    const teamChanged = selectedTeam !== requestedTeam;
                    const updateData = {
                        status: 'approved',
                        team: selectedTeam,
                        approvedAt: new Date().toISOString(),
                        approvedBy: currentUser.uid
                    };
                    
                    // Se mudou de time, adicionar aviso
                    if (teamChanged) {
                        const teamNames = {
                            welcome: 'Welcome',
                            backstage: 'Backstage',
                            parking: 'Parking',
                            kids: 'Kids'
                        };
                        updateData.teamChangeNotice = `Foi necess√°rio mudar sua escolha do time ${teamNames[requestedTeam]} para ${teamNames[selectedTeam]} para uma melhor organiza√ß√£o dos times.`;
                    }
                    
                    // Atualizar escala
                    await updateDoc(escalaRef, updateData);
                    
                    console.log('‚úÖ Escala aprovada com sucesso!');
                    showModal(`‚úÖ Escala aprovada! ${teamChanged ? 'Time ajustado para melhor organiza√ß√£o.' : ''}`);
                    
                    // Recarregar lista
                    loadPendingEscalas();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao aprovar escala:', error);
                    showModal(`‚ùå Erro ao aprovar escala: ${error.message}`);
                }
            }
            
            // Negar escala pendente
            async function denyPendingEscala(escalaId) {
                showModal(
                    'Tem certeza que deseja NEGAR esta escala?',
                    true,
                    async () => {
                        try {
                            const { doc, updateDoc } = window.firestoreMethods;
                            
                            // Atualizar status para denied
                            const escalaRef = doc(window.firebaseDb, 'escalas', escalaId);
                            await updateDoc(escalaRef, {
                                status: 'denied',
                                deniedAt: new Date().toISOString(),
                                deniedBy: currentUser.uid,
                                deniedReason: 'Escala n√£o aprovada pelo administrador'
                            });
                            
                            console.log('‚úÖ Escala negada com sucesso!');
                            showModal('‚úÖ Escala negada. O volunt√°rio ser√° notificado.');
                            
                            // Recarregar lista
                            loadPendingEscalas();
                            
                        } catch (error) {
                            console.error('‚ùå Erro ao negar escala:', error);
                            showModal(`‚ùå Erro ao negar escala: ${error.message}`);
                        }
                    },
                    true
                );
            }

            // Verificar se pode deletar escala (impede dele√ß√£o na v√©spera e no dia)
            function canDeleteEscala(escalaDate) {
                // Admin sempre pode deletar
                if (isAdmin) {
                    return true;
                }
                
                // Pegar data atual (apenas dia, sem hora)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Pegar data do evento (apenas dia, sem hora)
                const eventDate = new Date(escalaDate + 'T00:00:00');
                eventDate.setHours(0, 0, 0, 0);
                
                // Calcular diferen√ßa em dias
                const diffTime = eventDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Pode deletar se faltar mais de 1 dia (ou seja, pelo menos 2 dias)
                return diffDays >= 2;
            }

            // Deletar escala
            async function deleteEscala(escalaId) {
                try {
                    const { doc, deleteDoc } = window.firestoreMethods;
                    await deleteDoc(doc(window.firebaseDb, 'escalas', escalaId));
                    
                    console.log('‚úÖ Escala deletada com sucesso!');
                    showModal('Escala removida com sucesso!');
                    
                    // Recarregar escalas e atualizar dropdown
                    loadUserEscalas();
                    loadAllEscalas();
                } catch (error) {
                    console.error('‚ùå Erro ao deletar escala:', error);
                    showModal('Erro ao remover escala. Tente novamente.');
                }
            }

            // Renderizar lista de datas para admin
            function renderAdminDatesList() {
                const datesList = document.getElementById('admin-dates-list');
                
                if (availableDates.length === 0) {
                    datesList.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma data cadastrada.</p>';
                    return;
                }
                
                // Ordenar datas por data (ordem crescente)
                const sortedDates = [...availableDates].sort((a, b) => {
                    const dateA = a.value.split('|')[0];
                    const dateB = b.value.split('|')[0];
                    return dateA.localeCompare(dateB);
                });
                
                const html = sortedDates.map((date) => {
                    // Encontrar o √≠ndice real no array original
                    const realIndex = availableDates.findIndex(d => d.value === date.value);
                    return `
                        <div class="bg-white p-3 rounded border border-gray-200 space-y-2">
                            <!-- Linha 1: Descri√ß√£o do evento -->
                            <div class="text-sm font-medium text-gray-800">
                                ${date.text}
                            </div>
                            
                            <!-- Linha 2: Bot√µes de a√ß√£o -->
                            <div class="flex gap-2 pt-1">
                                <button class="admin-edit-date flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded text-sm transition border border-blue-200" data-index="${realIndex}">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="admin-delete-date flex-1 bg-red-50 hover:bg-red-100 text-red-700 font-semibold py-2 px-4 rounded text-sm transition border border-red-200" data-index="${realIndex}">
                                    üóëÔ∏è Remover
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                datesList.innerHTML = html;
                
                // Event listeners para editar data
                document.querySelectorAll('.admin-edit-date').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        editDate(index);
                    });
                });
                
                // Event listeners para deletar data
                document.querySelectorAll('.admin-delete-date').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        const date = availableDates[index];
                        showModal(
                            `Tem certeza que deseja remover a data "${date.text}"? ATEN√á√ÉO: Todas as escalas desta data ser√£o deletadas permanentemente!`,
                            true,
                            () => deleteDate(index),
                            true
                        );
                    });
                });
            }

            // Validar campos do formul√°rio admin com feedback visual
            function validateAdminFields() {
                let isValid = true;
                
                // Validar data
                const dateInput = document.getElementById('admin-new-date');
                const dateError = document.getElementById('date-error');
                if (!dateInput.value) {
                    dateInput.classList.add('border-red-500');
                    dateError.textContent = 'Data √© obrigat√≥ria';
                    dateError.classList.remove('hidden');
                    isValid = false;
                } else {
                    const now = new Date();
                    const eventDateTime = new Date(dateInput.value + 'T' + (document.getElementById('admin-new-time').value || '00:00'));
                    const oneHourFromNow = new Date(now.getTime() + (60 * 60 * 1000));
                    
                    if (eventDateTime < oneHourFromNow) {
                        dateInput.classList.add('border-red-500');
                        dateError.textContent = 'Data deve ser futura (m√≠nimo 1 hora)';
                        dateError.classList.remove('hidden');
                        isValid = false;
                    } else {
                        dateInput.classList.remove('border-red-500');
                        dateError.classList.add('hidden');
                    }
                }
                
                // Validar limite de volunt√°rios (4 times)
                const limitInputs = {
                    welcome: document.getElementById('admin-limit-welcome'),
                    backstage: document.getElementById('admin-limit-backstage'),
                    parking: document.getElementById('admin-limit-parking'),
                    kids: document.getElementById('admin-limit-kids')
                };
                const limitError = document.getElementById('limit-error');
                
                let hasInvalidLimit = false;
                Object.entries(limitInputs).forEach(([team, input]) => {
                    const limit = parseInt(input.value);
                    if (!limit || limit < 1 || limit > 20) {
                        input.classList.add('border-red-500');
                        hasInvalidLimit = true;
                    } else {
                        input.classList.remove('border-red-500');
                    }
                });
                
                if (hasInvalidLimit) {
                    limitError.textContent = 'Limites devem estar entre 1 e 20';
                    limitError.classList.remove('hidden');
                    isValid = false;
                } else {
                    limitError.classList.add('hidden');
                }
                
                return isValid;
            }
            
            // Limpar erros de valida√ß√£o ao digitar
            document.getElementById('admin-new-date')?.addEventListener('input', () => {
                document.getElementById('admin-new-date').classList.remove('border-red-500');
                document.getElementById('date-error').classList.add('hidden');
            });
            
            document.getElementById('admin-max-volunteers')?.addEventListener('input', () => {
                document.getElementById('admin-max-volunteers').classList.remove('border-red-500');
                document.getElementById('limit-error').classList.add('hidden');
            });
            
            // Limpar erros dos limites individuais
            ['welcome', 'backstage', 'parking', 'kids'].forEach(team => {
                document.getElementById(`admin-limit-${team}`)?.addEventListener('input', () => {
                    document.getElementById(`admin-limit-${team}`).classList.remove('border-red-500');
                    document.getElementById('limit-error').classList.add('hidden');
                });
            });

            // Adicionar nova data (apenas admin)
            async function addNewDate() {
                console.log('üîµ addNewDate() chamada');
                
                // Validar campos com feedback visual
                if (!validateAdminFields()) {
                    console.log('‚ùå Valida√ß√£o falhou');
                    return;
                }
                
                console.log('‚úÖ Valida√ß√£o passou');
                
                const dateInput = document.getElementById('admin-new-date').value;
                const timeInput = document.getElementById('admin-new-time').value;
                const eventInput = document.getElementById('admin-new-event').value.trim();
                const teamLimits = {
                    welcome: parseInt(document.getElementById('admin-limit-welcome').value) || 4,
                    backstage: parseInt(document.getElementById('admin-limit-backstage').value) || 4,
                    parking: parseInt(document.getElementById('admin-limit-parking').value) || 4,
                    kids: parseInt(document.getElementById('admin-limit-kids').value) || 4
                };
                
                console.log('üìù Dados coletados:', { dateInput, timeInput, eventInput, teamLimits });
                
                // Formatar data para exibi√ß√£o (dd/mm)
                const dateObj = new Date(dateInput + 'T12:00:00');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const weekday = dateObj.toLocaleDateString('pt-BR', { weekday: 'long' });
                const weekdayCapitalized = weekday.charAt(0).toUpperCase() + weekday.slice(1, 3);
                
                // Usar hor√°rio 00:00 se n√£o foi definido
                const finalTime = timeInput || '00:00';
                
                // Montar valor e texto
                const eventSuffix = eventInput ? ` - ${eventInput}` : '';
                const value = `${dateInput}|${finalTime}|${weekdayCapitalized}${eventSuffix}`;
                const timeDisplay = timeInput ? `(chegar ${timeInput})` : '(hor√°rio a definir)';
                const text = `${day}/${month} ${weekdayCapitalized}${eventInput ? ' | ' + eventInput : ''} ${timeDisplay}`;
                
                console.log('üìÖ Evento formatado:', { value, text });
                
                // Verificar se j√° existe
                const exists = availableDates.some(d => d.value === value);
                if (exists) {
                    console.log('‚ö†Ô∏è Data j√° existe');
                    showModal('Esta data j√° est√° cadastrada!');
                    return;
                }
                
                // Confirma√ß√£o antes de adicionar
                showModal(
                    `Confirmar cria√ß√£o do evento?<br><br><strong>${text}</strong><br><br>Limites por time:<br>Welcome: ${teamLimits.welcome} | Backstage: ${teamLimits.backstage}<br>Parking: ${teamLimits.parking} | Kids: ${teamLimits.kids}`,
                    true,
                    async () => {
                        try {
                            console.log('üíæ Salvando evento...');
                            
                            // Adicionar √† lista com teamLimits e schema version
                            availableDates.push({ 
                                value, 
                                text, 
                                teamLimits: teamLimits,
                                schemaVersion: CONFIG.SCHEMA_VERSION,
                                createdAt: new Date().toISOString(),
                                createdBy: currentUser?.email || 'unknown'
                            });
                            
                            console.log('üì¶ Array atualizado. Total:', availableDates.length);
                            console.log('üîç DEBUG - Array completo:', JSON.stringify(availableDates, null, 2));
                            
                            // Verificar se est√° autenticado
                            console.log('üîç DEBUG - Usu√°rio atual:', currentUser?.email);
                            console.log('üîç DEBUG - √â admin?', isAdmin);
                            console.log('üîç DEBUG - firebaseDb existe?', !!window.firebaseDb);
                            console.log('üîç DEBUG - firestoreMethods existe?', !!window.firestoreMethods);
                            
                            if (!currentUser) {
                                throw new Error('Usu√°rio n√£o autenticado');
                            }
                            
                            if (!isAdmin) {
                                throw new Error('Usu√°rio n√£o √© administrador');
                            }
                            
                            // Salvar no Firestore com retry
                            console.log('üîç DEBUG - Iniciando salvamento no Firestore...');
                            await firestoreRetry(async () => {
                                const { doc, setDoc } = window.firestoreMethods;
                                
                                if (!doc || !setDoc) {
                                    throw new Error('M√©todos Firestore n√£o dispon√≠veis');
                                }
                                
                                const dataToSave = { 
                                    dates: availableDates,
                                    lastUpdated: new Date().toISOString(),
                                    version: CONFIG.SCHEMA_VERSION
                                };
                                console.log('üîç DEBUG - Dados a salvar:', JSON.stringify(dataToSave, null, 2));
                                
                                const docRef = doc(window.firebaseDb, 'config', 'availableDates');
                                console.log('üîç DEBUG - Refer√™ncia do documento criada');
                                
                                await setDoc(docRef, dataToSave);
                                console.log('üîç DEBUG - setDoc completado');
                            }, 'Salvar evento');
                            
                            console.log('‚úÖ Salvo no Firestore');
                            
                            // Backup se habilitado
                            if (CONFIG.BACKUP_ENABLED) {
                                await backupData('eventCreated', { value, text, teamLimits });
                            }
                            
                            showModal('Data adicionada com sucesso!');
                            
                            // Limpar campos
                            document.getElementById('admin-new-date').value = '';
                            document.getElementById('admin-new-time').value = '';
                            document.getElementById('admin-new-event').value = '';
                            document.getElementById('admin-limit-welcome').value = '4';
                            document.getElementById('admin-limit-backstage').value = '4';
                            document.getElementById('admin-limit-parking').value = '4';
                            document.getElementById('admin-limit-kids').value = '4';
                            
                            console.log('üîÑ Atualizando listas...');
                            
                            // Atualizar lista
                            renderAdminDatesList();
                            await loadUserEscalas();
                            await loadAllEscalas();
                            
                            console.log('‚úÖ Evento adicionado com sucesso!');
                            
                        } catch (error) {
                            console.error('‚ùå ERRO DETALHADO ao salvar data:', error);
                            console.error('‚ùå Tipo do erro:', error.name);
                            console.error('‚ùå Mensagem:', error.message);
                            console.error('‚ùå Code:', error.code);
                            console.error('‚ùå Stack:', error.stack);
                            logger.error('‚ùå Erro ao salvar data:', error);
                            showModal(`Erro ao adicionar data: ${error.message || error.code || 'Desconhecido'}. Verifique o console (F12) para mais detalhes.`, false, null, false, null, '‚ùå');
                        }
                    },
                    false,
                    null,
                    '‚ùì'
                );
            }

            // Sistema de backup autom√°tico
            async function backupData(action, data) {
                if (!CONFIG.BACKUP_ENABLED) return;
                
                try {
                    const { collection, addDoc } = window.firestoreMethods;
                    await addDoc(collection(window.firebaseDb, 'backups'), {
                        action: action,
                        data: data,
                        user: currentUser?.email || 'unknown',
                        timestamp: new Date().toISOString(),
                        schemaVersion: CONFIG.SCHEMA_VERSION
                    });
                    logger.log('üíæ Backup criado:', action);
                } catch (error) {
                    logger.error('‚ùå Erro ao criar backup:', error);
                    // N√£o bloquear opera√ß√£o se backup falhar
                }
            }

            // Editar data/hor√°rio/evento (apenas admin)
            async function editDate(index) {
                try {
                    const dateToEdit = availableDates[index];
                    const [currentDate, currentTime, ...eventParts] = dateToEdit.value.split('|');
                    const currentEvent = eventParts.join('|'); // Nome do evento pode conter |
                    
                    // Criar modal customizado para edi√ß√£o
                    const modalHtml = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">üóìÔ∏è Nova Data:</label>
                                <input type="date" id="edit-date-input" value="${currentDate}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">üïê Novo Hor√°rio:</label>
                                <input type="time" id="edit-time-input" value="${currentTime}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">üìù Novo Nome do Evento:</label>
                                <input type="text" id="edit-event-input" value="${currentEvent}" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500" placeholder="Ex: Culto de Domingo">
                            </div>
                            <p class="text-xs text-gray-500">‚ö†Ô∏è As escalas existentes ser√£o mantidas e atualizadas automaticamente.</p>
                        </div>
                    `;
                    
                    // Mostrar modal com formul√°rio
                    showModal(
                        `<div class="text-left"><h3 class="font-bold text-lg mb-4">‚úèÔ∏è Editar Evento</h3>${modalHtml}</div>`,
                        true,
                        async () => {
                            const newDate = document.getElementById('edit-date-input').value;
                            const newTime = document.getElementById('edit-time-input').value;
                            const newEvent = document.getElementById('edit-event-input').value.trim();
                            
                            if (!newDate || !newTime) {
                                showModal('‚ùå Data e hor√°rio s√£o obrigat√≥rios!', false, null, true);
                                return;
                            }
                            
                            // Validar data futura
                            const now = new Date();
                            const eventDateTime = new Date(newDate + 'T' + newTime);
                            const oneHourFromNow = new Date(now.getTime() + (60 * 60 * 1000));
                            
                            if (eventDateTime < oneHourFromNow) {
                                showModal('‚ùå A data deve ser futura (m√≠nimo 1 hora a partir de agora)!', false, null, true);
                                return;
                            }
                            
                            // Atualizar o evento
                            const oldValue = dateToEdit.value;
                            const oldDate = oldValue.split('|')[0];
                            
                            // Criar novo value
                            const newValue = `${newDate}|${newTime}|${newEvent}`;
                            
                            // Formatar texto para exibi√ß√£o
                            const dateObj = new Date(newDate + 'T' + newTime);
                            const day = dateObj.getDate().toString().padStart(2, '0');
                            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                            const weekday = dateObj.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
                            const weekdayCapitalized = weekday.charAt(0).toUpperCase() + weekday.slice(1);
                            const newText = `${day}/${month} ${weekdayCapitalized} | ${newEvent} (chegar ${newTime})`;
                            
                            // Atualizar no array
                            availableDates[index] = {
                                ...dateToEdit,
                                value: newValue,
                                text: newText,
                                lastUpdated: new Date().toISOString(),
                                updatedBy: currentUser?.email || 'unknown'
                            };
                            
                            // Salvar no Firestore
                            const { doc, setDoc, collection, query, where, getDocs, updateDoc } = window.firestoreMethods;
                            
                            // 1. Atualizar config/availableDates
                            await setDoc(doc(window.firebaseDb, 'config', 'availableDates'), { 
                                dates: availableDates,
                                lastUpdated: new Date().toISOString()
                            });
                            
                            // 2. Atualizar todas as escalas desta data
                            const q = query(
                                collection(window.firebaseDb, 'escalas'),
                                where('date', '==', oldDate)
                            );
                            
                            const querySnapshot = await getDocs(q);
                            console.log('üìã Atualizando escalas:', querySnapshot.size);
                            
                            const updatePromises = [];
                            querySnapshot.forEach((docSnapshot) => {
                                const escalaRef = doc(window.firebaseDb, 'escalas', docSnapshot.id);
                                updatePromises.push(updateDoc(escalaRef, {
                                    date: newDate,
                                    time: newTime,
                                    eventName: newEvent,
                                    culto: newText, // Atualizar campo culto tamb√©m
                                    updatedAt: new Date().toISOString()
                                }));
                            });
                            
                            await Promise.all(updatePromises);
                            
                            // Atualizar UI
                            renderAdminDatesList();
                            await loadUserEscalas();
                            await loadAllEscalas();
                            
                            showModal('‚úÖ Evento atualizado com sucesso!', false, null, true);
                        },
                        true,
                        null,
                        '‚úèÔ∏è'
                    );
                    
                } catch (error) {
                    console.error('‚ùå Erro ao editar evento:', error);
                    showModal(`‚ùå Erro ao editar evento: ${error.message}`, false, null, true);
                }
            }

            // Deletar data (apenas admin)
            async function deleteDate(index) {
                try {
                    const dateToDelete = availableDates[index];
                    const dateValue = dateToDelete.value.split('|')[0]; // Extrair apenas a data (YYYY-MM-DD)
                    
                    console.log('üóëÔ∏è Deletando data:', dateValue);
                    
                    // 1. Buscar e deletar todas as escalas desta data
                    const { collection, query, where, getDocs, deleteDoc, doc, setDoc } = window.firestoreMethods;
                    const q = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('date', '==', dateValue)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    console.log('üìã Escalas encontradas para deletar:', querySnapshot.size);
                    
                    // Deletar todas as escalas desta data
                    const deletePromises = [];
                    querySnapshot.forEach((docSnapshot) => {
                        deletePromises.push(deleteDoc(doc(window.firebaseDb, 'escalas', docSnapshot.id)));
                    });
                    
                    await Promise.all(deletePromises);
                    console.log('‚úÖ Escalas deletadas');
                    
                    // 2. Remover data da lista
                    availableDates.splice(index, 1);
                    
                    // 3. Salvar no Firestore
                    await setDoc(doc(window.firebaseDb, 'config', 'availableDates'), { dates: availableDates });
                    
                    showModal(`Data removida com sucesso! ${querySnapshot.size} escala(s) foram deletada(s).`);
                    renderAdminDatesList();
                    await loadUserEscalas(); // Atualizar dropdown
                    await loadAllEscalas(); // Atualizar vis√£o geral
                    
                } catch (error) {
                    console.error('‚ùå Erro ao deletar data:', error);
                    showModal('Erro ao remover data. Tente novamente.');
                }
            }

            // Renderizar vis√£o admin
            function renderAdminView(grouped) {
                console.log('üîç renderAdminView - isTeamLeader:', isTeamLeader);
                console.log('üîç renderAdminView - userTeamLeadership:', userTeamLeadership);
                
                // Ordenar chaves por data e hora (ordem crescente)
                const dates = Object.keys(grouped).sort((a, b) => {
                    const [dateA, timeA] = a.split('_');
                    const [dateB, timeB] = b.split('_');
                    const dateTimeA = new Date(dateA + 'T' + timeA);
                    const dateTimeB = new Date(dateB + 'T' + timeB);
                    return dateTimeA - dateTimeB;
                });

                if (dates.length === 0) {
                    elements.adminView.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma escala cadastrada ainda.</p>';
                    return;
                }

                const html = dates.map(key => {
                    const data = grouped[key];
                    const dateObj = new Date(data.date + 'T' + data.time);
                    const dateStr = dateObj.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    const eventName = data.eventName ? ` - ${data.eventName}` : '';

                    // Fun√ß√£o para renderizar volunt√°rios com bot√£o de deletar e transferir (para l√≠deres do time espec√≠fico)
                    const renderVolunteers = (volunteers, teamName) => {
                        if (volunteers.length === 0) {
                            return '<div class="text-gray-400">Ningu√©m escalado</div>';
                        }
                        
                        const teamKey = teamName.toLowerCase();
                        // Superadmin pode gerenciar TODOS os times
                        // Admin/l√≠der pode gerenciar SOMENTE os times que lidera
                        const canManageThisTeam = isSuperAdmin || ((isAdmin || isTeamLeader) && userTeamLeadership && userTeamLeadership.includes(teamKey));
                        
                        console.log(`üîç Team: ${teamKey}, isSuperAdmin: ${isSuperAdmin}, isAdmin: ${isAdmin}, isTeamLeader: ${isTeamLeader}, leadership:`, userTeamLeadership, `canManage: ${canManageThisTeam}`);
                        
                        return volunteers.map(v => `
                            <div class="flex items-center justify-between group">
                                <span>‚Ä¢ ${v.userName}</span>
                                ${canManageThisTeam ? `
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                    <button class="transfer-volunteer-btn text-blue-600 hover:text-blue-800 text-sm" 
                                            data-escala-id="${v.id}"
                                            data-volunteer-name="${v.userName}"
                                            data-current-team="${teamKey}"
                                            data-date="${data.date}"
                                            data-time="${data.time}"
                                            title="Transferir ${v.userName} para outro time">
                                        üîÅ
                                    </button>
                                    <button class="admin-delete-escala text-red-600 hover:text-red-800 text-xs" 
                                            data-escala-id="${v.id}"
                                            data-current-team="${teamKey}"
                                            title="Remover ${v.userName}">
                                        üóëÔ∏è
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        `).join('');
                    };

                    return `
                        <div class="border border-gray-200 rounded-lg p-4" style="border: 2px solid #e5e5e5; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                            <h3 class="font-bold text-lg mb-3" style="color: #151b29;">üìÖ ${dateStr}${eventName} - üïê ${data.time}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-color: #151b29;">
                                    <h4 class="font-semibold mb-2" style="color: #151b29;">Welcome (${data.welcome.length})</h4>
                                    <div class="text-sm space-y-1">
                                        ${renderVolunteers(data.welcome, 'Welcome')}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-color: #151b29;">
                                    <h4 class="font-semibold mb-2" style="color: #151b29;">Backstage (${data.backstage.length})</h4>
                                    <div class="text-sm space-y-1">
                                        ${renderVolunteers(data.backstage, 'Backstage')}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-color: #151b29;">
                                    <h4 class="font-semibold mb-2" style="color: #151b29;">Parking (${data.parking.length})</h4>
                                    <div class="text-sm space-y-1">
                                        ${renderVolunteers(data.parking, 'Parking')}
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded border-l-4" style="border-color: #151b29;">
                                    <h4 class="font-semibold mb-2" style="color: #151b29;">Kids (${data.kids.length})</h4>
                                    <div class="text-sm space-y-1">
                                        ${renderVolunteers(data.kids, 'Kids')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                elements.adminView.innerHTML = html;

                // Event listeners para deletar escala (superadmin tem acesso total, outros apenas times que lideram)
                document.querySelectorAll('.admin-delete-escala').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        const currentTeam = e.currentTarget.dataset.currentTeam;
                        
                        // Permiss√£o: superadmin pode tudo, admin/l√≠der apenas nos times que lidera
                        const hasPermission = isSuperAdmin || ((isAdmin || isTeamLeader) && userTeamLeadership && userTeamLeadership.includes(currentTeam));
                        
                        if (hasPermission) {
                            showModal(
                                `Como ${isSuperAdmin ? 'super administrador' : 'l√≠der do time'}, deseja remover esta pessoa da escala?`,
                                true,
                                () => deleteEscala(escalaId),
                                true
                            );
                        } else {
                            showModal('‚ùå Voc√™ s√≥ pode remover volunt√°rios dos times que lidera.', false, null, true);
                        }
                    });
                });
                
                // Event listeners para transferir volunt√°rio (superadmin tem acesso total, outros apenas times que lideram)
                document.querySelectorAll('.transfer-volunteer-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const escalaId = e.currentTarget.dataset.escalaId;
                        const volunteerName = e.currentTarget.dataset.volunteerName;
                        const currentTeam = e.currentTarget.dataset.currentTeam;
                        const date = e.currentTarget.dataset.date;
                        const time = e.currentTarget.dataset.time;
                        
                        // Permiss√£o: superadmin pode tudo, admin/l√≠der apenas nos times que lidera
                        const hasPermission = isSuperAdmin || ((isAdmin || isTeamLeader) && userTeamLeadership && userTeamLeadership.includes(currentTeam));
                        
                        if (hasPermission) {
                            openTransferModal(escalaId, volunteerName, currentTeam, date, time);
                        } else {
                            showModal('‚ùå Voc√™ s√≥ pode transferir volunt√°rios dos times que lidera.', false, null, true);
                        }
                    });
                });
            }

            // ===== DASHBOARD E GR√ÅFICOS =====

            let dashboardCharts = {
                teams: null,
                volunteers: null,
                events: null,
                emptyTeams: null
            };

            // Event listeners para filtros de Dashboard
            const dashboardPeriodSelect = document.getElementById('dashboard-period');
            const customDateRange = document.getElementById('custom-date-range');
            const refreshDashboardBtn = document.getElementById('refresh-dashboard');

            if (dashboardPeriodSelect) {
                dashboardPeriodSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'custom') {
                        customDateRange.classList.remove('hidden');
                    } else {
                        customDateRange.classList.add('hidden');
                        loadDashboard(); // Recarregar automaticamente
                    }
                });
            }

            if (refreshDashboardBtn) {
                refreshDashboardBtn.addEventListener('click', () => {
                    loadDashboard();
                });
            }

            // Fun√ß√£o principal para carregar Dashboard
            async function loadDashboard() {
                try {
                    console.log('üìä Carregando Dashboard...');
                    
                    // Obter per√≠odo selecionado
                    const period = dashboardPeriodSelect.value;
                    let dateFrom, dateTo;
                    
                    const now = new Date();
                    
                    if (period === 'custom') {
                        const fromInput = document.getElementById('date-from').value;
                        const toInput = document.getElementById('date-to').value;
                        
                        if (!fromInput || !toInput) {
                            showModal('‚ùå Por favor, selecione as datas de in√≠cio e fim.', false, null, true);
                            return;
                        }
                        
                        dateFrom = new Date(fromInput);
                        dateTo = new Date(toInput);
                    } else if (period === 'all') {
                        dateFrom = new Date('2020-01-01'); // Data antiga o suficiente
                        dateTo = new Date(now.getTime() + (365 * 24 * 60 * 60 * 1000)); // 1 ano no futuro
                    } else {
                        const days = parseInt(period);
                        if (days < 0) {
                            // Per√≠odo passado (√öltimos X dias)
                            dateFrom = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));
                            dateTo = now;
                        } else {
                            // Per√≠odo futuro (Pr√≥ximos X dias)
                            dateFrom = now;
                            dateTo = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));
                        }
                    }
                    
                    console.log('üìÖ Per√≠odo:', dateFrom.toLocaleDateString(), 'at√©', dateTo.toLocaleDateString());
                    
                    // Buscar todas as escalas no per√≠odo
                    const { collection, query, where, getDocs } = window.firestoreMethods;
                    const escalasRef = collection(window.firebaseDb, 'escalas');
                    
                    const q = query(
                        escalasRef,
                        where('date', '>=', dateFrom.toISOString().split('T')[0]),
                        where('date', '<=', dateTo.toISOString().split('T')[0])
                    );
                    
                    const querySnapshot = await getDocs(escalasRef); // Buscar todas e filtrar no cliente
                    const escalas = [];
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const escalaDate = new Date(data.date);
                        if (escalaDate >= dateFrom && escalaDate <= dateTo) {
                            escalas.push({ id: doc.id, ...data });
                        }
                    });
                    
                    console.log('üìã Escalas encontradas:', escalas.length);
                    
                    // Gerar dados dos gr√°ficos
                    await generateChart1_TeamParticipation(escalas);
                    await generateChart2_TopVolunteers(escalas);
                    await generateChart3_EventsWithMostVolunteers(escalas);
                    await generateChart4_EventsWithEmptyTeams(dateFrom, dateTo);
                    
                    // Configurar navega√ß√£o dos gr√°ficos com scroll
                    setupChartNavigation();
                    
                    console.log('‚úÖ Dashboard carregado com sucesso!');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar Dashboard:', error);
                    showModal('‚ùå Erro ao carregar Dashboard. Tente novamente.', false, null, true);
                }
            }

            // Gr√°fico 1: Participa√ß√£o por Time (volunt√°rios √∫nicos)
            async function generateChart1_TeamParticipation(escalas) {
                const teamVolunteers = {
                    welcome: new Set(),
                    backstage: new Set(),
                    parking: new Set(),
                    kids: new Set()
                };
                
                // Adicionar userId √∫nico por time (Set garante unicidade)
                escalas.forEach(escala => {
                    const team = escala.team?.toLowerCase();
                    const userId = escala.userId || escala.userName; // Usar userId ou nome como fallback
                    
                    if (teamVolunteers.hasOwnProperty(team) && userId) {
                        teamVolunteers[team].add(userId);
                    }
                });
                
                // Converter Sets para contagem
                const teamCount = {
                    welcome: teamVolunteers.welcome.size,
                    backstage: teamVolunteers.backstage.size,
                    parking: teamVolunteers.parking.size,
                    kids: teamVolunteers.kids.size
                };
                
                const ctx = document.getElementById('chart-teams');
                
                // Destruir gr√°fico anterior se existir
                if (dashboardCharts.teams) {
                    dashboardCharts.teams.destroy();
                }
                
                dashboardCharts.teams = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['üëã Welcome', 'ü§ù Backstage', 'üöó Parking', 'üë∂ Kids'],
                        datasets: [{
                            label: 'Volunt√°rios √önicos',
                            data: [teamCount.welcome, teamCount.backstage, teamCount.parking, teamCount.kids],
                            backgroundColor: [
                                'rgba(55, 125, 184, 0.7)', // Azul Welcome
                                'rgba(128, 128, 128, 0.7)', // Cinza Backstage
                                'rgba(248, 113, 113, 0.7)', // Vermelho Parking
                                'rgba(251, 191, 36, 0.7)'   // Amarelo Kids
                            ],
                            borderColor: [
                                'rgba(55, 125, 184, 1)',
                                'rgba(128, 128, 128, 1)',
                                'rgba(248, 113, 113, 1)',
                                'rgba(251, 191, 36, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            // Gr√°fico 2: Ranking de Volunt√°rios com mais Escalas
            async function generateChart2_TopVolunteers(escalas) {
                const volunteerCount = {};
                
                escalas.forEach(escala => {
                    const name = escala.userName || 'Desconhecido';
                    volunteerCount[name] = (volunteerCount[name] || 0) + 1;
                });
                
                // Ordenar e pegar top 10
                const sorted = Object.entries(volunteerCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                const labels = sorted.map(item => item[0]);
                const data = sorted.map(item => item[1]);
                
                const ctx = document.getElementById('chart-volunteers');
                
                if (dashboardCharts.volunteers) {
                    dashboardCharts.volunteers.destroy();
                }
                
                dashboardCharts.volunteers = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Escalas Participadas',
                            data: data,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', // Horizontal
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            // Gr√°fico 3: Quantidade de Volunt√°rios por Dia
            async function generateChart3_EventsWithMostVolunteers(escalas) {
                const eventCount = {};
                const eventDetails = {}; // Armazenar detalhes completos de cada evento
                
                escalas.forEach(escala => {
                    const eventKey = `${escala.date}|${escala.time}|${escala.eventName || 'Evento'}`;
                    
                    if (!eventCount[eventKey]) {
                        eventCount[eventKey] = 0;
                        eventDetails[eventKey] = {
                            date: escala.date,
                            time: escala.time,
                            eventName: escala.eventName || 'Evento',
                            teams: {
                                welcome: [],
                                backstage: [],
                                parking: [],
                                kids: []
                            }
                        };
                    }
                    
                    eventCount[eventKey]++;
                    
                    // Adicionar volunt√°rio ao time correspondente
                    const team = escala.team?.toLowerCase();
                    if (eventDetails[eventKey].teams[team]) {
                        eventDetails[eventKey].teams[team].push({
                            name: escala.userName || 'Desconhecido',
                            photo: escala.userPhoto || '',
                            email: escala.userEmail || ''
                        });
                    }
                });
                
                // Ordenar por data (crescente)
                const sorted = Object.entries(eventCount)
                    .sort((a, b) => {
                        const dateA = new Date(a[0].split('|')[0] + 'T' + a[0].split('|')[1]);
                        const dateB = new Date(b[0].split('|')[0] + 'T' + b[0].split('|')[1]);
                        return dateA - dateB;
                    });
                
                const labels = sorted.map(item => {
                    const date = item[0].split('|')[0];
                    const dateObj = new Date(date + 'T00:00:00');
                    return `${dateObj.getDate().toString().padStart(2, '0')}/${(dateObj.getMonth() + 1).toString().padStart(2, '0')}`;
                });
                const data = sorted.map(item => item[1]);
                
                // Armazenar detalhes para uso no click
                window.chart3EventDetails = sorted.map(item => eventDetails[item[0]]);
                
                const ctx = document.getElementById('chart-events');
                
                if (dashboardCharts.events) {
                    dashboardCharts.events.destroy();
                }
                
                dashboardCharts.events = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total de Volunt√°rios',
                            data: data,
                            backgroundColor: 'rgba(99, 102, 241, 0.7)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    afterLabel: () => 'üëÜ Clique para ver detalhes'
                                }
                            }
                        },
                        scales: {
                            x: {
                                min: 0,
                                max: Math.min(9, labels.length - 1), // Mostrar apenas 10 barras por vez
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                showChart3Popup(index);
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
            }

            // Gr√°fico 4: Times com Menos de 5 Volunt√°rios (ALERTA)
            const chart4EventDetails = []; // Armazena detalhes de cada evento para o popup
            
            async function generateChart4_EventsWithEmptyTeams(dateFrom, dateTo) {
                try {
                    // Limpar detalhes anteriores
                    chart4EventDetails.length = 0;
                    
                    // Filtrar eventos no per√≠odo selecionado e ordenar por data (crescente)
                    const filteredEvents = availableDates
                        .filter(date => {
                            const eventDate = new Date(date.value.split('|')[0] + 'T00:00:00');
                            return eventDate >= dateFrom && eventDate <= dateTo;
                        })
                        .sort((a, b) => {
                            const dateA = new Date(a.value.split('|')[0] + 'T00:00:00');
                            const dateB = new Date(b.value.split('|')[0] + 'T00:00:00');
                            return dateA - dateB;
                        })
                        .slice(0, 30); // M√°ximo 30 eventos
                    
                    const labels = [];
                    const underStaffedCount = [];
                    const backgroundColors = [];
                    
                    for (const event of filteredEvents) {
                        const [dateStr, timeStr, ...eventParts] = event.value.split('|');
                        const eventName = eventParts.join('|');
                        
                        // Buscar escalas deste evento
                        const { collection, query, where, getDocs } = window.firestoreMethods;
                        const q = query(
                            collection(window.firebaseDb, 'escalas'),
                            where('date', '==', dateStr)
                        );
                        
                        const querySnapshot = await getDocs(q);
                        const teams = { welcome: 0, backstage: 0, parking: 0, kids: 0 };
                        
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            const team = data.team?.toLowerCase();
                            if (teams.hasOwnProperty(team)) {
                                teams[team]++;
                            }
                        });
                        
                        // Contar times com menos de 5 volunt√°rios (0 a 4)
                        const underStaffed = Object.values(teams).filter(count => count < 5).length;
                        
                        // Pular eventos com todos os times com 5 ou mais volunt√°rios
                        if (underStaffed === 0) {
                            continue;
                        }
                        
                        // Formata√ß√£o da label
                        const dateObj = new Date(dateStr + 'T00:00:00');
                        const day = dateObj.getDate().toString().padStart(2, '0');
                        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                        labels.push(`${day}/${month}`);
                        
                        // Armazenar detalhes para o popup
                        chart4EventDetails.push({
                            date: `${day}/${month}`,
                            fullDate: dateStr,
                            eventName: eventName,
                            teams: {
                                'Recep√ß√£o': teams.welcome,
                                'Backstage': teams.backstage,
                                'Estacionamento': teams.parking,
                                'Kids': teams.kids
                            }
                        });
                        
                        underStaffedCount.push(underStaffed);
                        
                        // Cor baseada na criticidade (1 a 4 times com menos de 5 volunt√°rios)
                        if (underStaffed === 1) {
                            backgroundColors.push('rgba(254, 240, 138, 0.8)'); // Amarelo claro
                        } else if (underStaffed === 2) {
                            backgroundColors.push('rgba(234, 179, 8, 0.8)'); // Amarelo
                        } else if (underStaffed === 3) {
                            backgroundColors.push('rgba(249, 115, 22, 0.8)'); // Laranja
                        } else { // underStaffed === 4
                            backgroundColors.push('rgba(239, 68, 68, 0.8)'); // Vermelho
                        }
                    }
                    
                    const ctx = document.getElementById('chart-empty-teams');
                    
                    if (dashboardCharts.emptyTeams) {
                        dashboardCharts.emptyTeams.destroy();
                    }
                    
                    dashboardCharts.emptyTeams = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Times com Menos de 5',
                                data: underStaffedCount,
                                backgroundColor: backgroundColors,
                                borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: true,
                                    callbacks: {
                                        afterLabel: () => 'Clique para ver detalhes'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    min: 0,
                                    max: Math.min(9, labels.length - 1), // Mostrar apenas 10 barras por vez
                                },
                                y: {
                                    beginAtZero: true,
                                    max: 4,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            onClick: (event, activeElements) => {
                                if (activeElements.length > 0) {
                                    const index = activeElements[0].index;
                                    showChart4Popup(index);
                                }
                            },
                            interaction: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    });
                    
                } catch (error) {
                    console.error('‚ùå Erro ao gerar gr√°fico de times vazios:', error);
                }
            }

            // Fun√ß√£o para mostrar popup com detalhes do evento do gr√°fico 4
            function showChart4Popup(index) {
                const eventData = chart4EventDetails[index];
                if (!eventData) return;
                
                // Preencher t√≠tulo e data
                document.getElementById('chart4-popup-title').textContent = eventData.eventName || 'Evento';
                document.getElementById('chart4-popup-date').textContent = `üìÖ ${eventData.date}`;
                
                // Preencher times
                const teamsContainer = document.getElementById('chart4-popup-teams');
                teamsContainer.innerHTML = '';
                
                const teamEmojis = {
                    'Recep√ß√£o': 'üëã',
                    'Backstage': 'ü§ù',
                    'Estacionamento': 'üöó',
                    'Kids': 'üë∂'
                };
                
                Object.entries(eventData.teams).forEach(([teamName, count]) => {
                    const emoji = teamEmojis[teamName] || 'üë•';
                    let colorClass = '';
                    let statusText = '';
                    
                    if (count === 0) {
                        colorClass = 'bg-red-50 border-red-300';
                        statusText = 'text-red-700';
                    } else if (count >= 1 && count <= 2) {
                        colorClass = 'bg-orange-50 border-orange-300';
                        statusText = 'text-orange-700';
                    } else if (count >= 3 && count <= 4) {
                        colorClass = 'bg-yellow-50 border-yellow-300';
                        statusText = 'text-yellow-700';
                    } else {
                        colorClass = 'bg-green-50 border-green-300';
                        statusText = 'text-green-700';
                    }
                    
                    const teamDiv = document.createElement('div');
                    teamDiv.className = `flex items-center justify-between p-3 rounded-lg border-2 ${colorClass}`;
                    teamDiv.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">${emoji}</span>
                            <span class="font-semibold text-gray-800">${teamName}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold ${statusText}">${count}</span>
                            <span class="text-xs text-gray-600 block">volunt√°rio${count !== 1 ? 's' : ''}</span>
                        </div>
                    `;
                    teamsContainer.appendChild(teamDiv);
                });
                
                // Mostrar popup
                document.getElementById('chart4-popup-overlay').classList.remove('hidden');
            }
            
            // Event listeners do popup
            document.getElementById('chart4-popup-close').addEventListener('click', () => {
                document.getElementById('chart4-popup-overlay').classList.add('hidden');
            });
            
            document.getElementById('chart4-popup-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'chart4-popup-overlay') {
                    document.getElementById('chart4-popup-overlay').classList.add('hidden');
                }
            });

            // Fun√ß√£o para mostrar popup com volunt√°rios do evento (Gr√°fico 3)
            function showChart3Popup(index) {
                const eventData = window.chart3EventDetails[index];
                if (!eventData) return;
                
                // Formatar data
                const dateObj = new Date(eventData.date + 'T' + eventData.time);
                const formattedDate = dateObj.toLocaleDateString('pt-BR', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                // Calcular total de volunt√°rios
                const totalVolunteers = Object.values(eventData.teams).reduce((sum, team) => sum + team.length, 0);
                
                // Preencher t√≠tulo e data
                document.getElementById('chart3-popup-title').textContent = eventData.eventName;
                document.getElementById('chart3-popup-date').textContent = `üìÖ ${formattedDate} √†s ${eventData.time}`;
                document.getElementById('chart3-popup-total').textContent = `üë• Total: ${totalVolunteers} volunt√°rio${totalVolunteers !== 1 ? 's' : ''}`;
                
                // Preencher times
                const teamsContainer = document.getElementById('chart3-popup-teams');
                teamsContainer.innerHTML = '';
                
                const teamConfig = {
                    welcome: { name: 'Welcome', icon: 'üëã', color: 'bg-blue-50 border-blue-300' },
                    backstage: { name: 'Backstage', icon: 'ü§ù', color: 'bg-gray-50 border-gray-300' },
                    parking: { name: 'Parking', icon: 'üöó', color: 'bg-red-50 border-red-300' },
                    kids: { name: 'Kids', icon: 'üë∂', color: 'bg-yellow-50 border-yellow-300' }
                };
                
                Object.entries(eventData.teams).forEach(([teamKey, volunteers]) => {
                    if (volunteers.length === 0) return; // Pular times vazios
                    
                    const config = teamConfig[teamKey];
                    
                    const teamDiv = document.createElement('div');
                    teamDiv.className = `border-2 rounded-lg p-3 ${config.color}`;
                    
                    const volunteersHtml = volunteers.map(v => `
                        <div class="flex items-center gap-2 py-1">
                            <img src="${v.photo || 'Zele logo.png'}" alt="${v.name}" class="w-8 h-8 rounded-full object-cover flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold text-gray-800 truncate">${v.name}</p>
                                <p class="text-xs text-gray-600 truncate">${v.email}</p>
                            </div>
                        </div>
                    `).join('');
                    
                    teamDiv.innerHTML = `
                        <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-300">
                            <span class="text-2xl">${config.icon}</span>
                            <span class="font-bold text-gray-800">${config.name}</span>
                            <span class="ml-auto bg-white px-2 py-1 rounded-full text-xs font-bold text-gray-700">${volunteers.length}</span>
                        </div>
                        <div class="space-y-1">
                            ${volunteersHtml}
                        </div>
                    `;
                    
                    teamsContainer.appendChild(teamDiv);
                });
                
                // Mostrar popup
                document.getElementById('chart3-popup-overlay').classList.remove('hidden');
            }
            
            // Event listeners do popup do Gr√°fico 3
            document.getElementById('chart3-popup-close').addEventListener('click', () => {
                document.getElementById('chart3-popup-overlay').classList.add('hidden');
            });
            
            document.getElementById('chart3-popup-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'chart3-popup-overlay') {
                    document.getElementById('chart3-popup-overlay').classList.add('hidden');
                }
            });

            // Fun√ß√£o para configurar navega√ß√£o dos gr√°ficos
            function setupChartNavigation() {
                // Navega√ß√£o do Gr√°fico 3 (Quantidade de Volunt√°rios por Dia)
                const chart3PrevBtn = document.getElementById('chart3-prev');
                const chart3NextBtn = document.getElementById('chart3-next');
                
                if (chart3PrevBtn && chart3NextBtn && dashboardCharts.events) {
                    const chart3 = dashboardCharts.events;
                    const totalLabels3 = chart3.data.labels.length;
                    
                    chart3PrevBtn.addEventListener('click', () => {
                        const currentMin = chart3.options.scales.x.min || 0;
                        if (currentMin > 0) {
                            chart3.options.scales.x.min = Math.max(0, currentMin - 5);
                            chart3.options.scales.x.max = Math.max(9, currentMin + 4);
                            chart3.update();
                        }
                    });
                    
                    chart3NextBtn.addEventListener('click', () => {
                        const currentMax = chart3.options.scales.x.max || 9;
                        if (currentMax < totalLabels3 - 1) {
                            chart3.options.scales.x.max = Math.min(totalLabels3 - 1, currentMax + 5);
                            chart3.options.scales.x.min = Math.max(0, currentMax - 4);
                            chart3.update();
                        }
                    });
                }
                
                // Navega√ß√£o do Gr√°fico 4 (Times com Menos de 5 Volunt√°rios)
                const chart4PrevBtn = document.getElementById('chart4-prev');
                const chart4NextBtn = document.getElementById('chart4-next');
                
                if (chart4PrevBtn && chart4NextBtn && dashboardCharts.emptyTeams) {
                    const chart4 = dashboardCharts.emptyTeams;
                    const totalLabels4 = chart4.data.labels.length;
                    
                    chart4PrevBtn.addEventListener('click', () => {
                        const currentMin = chart4.options.scales.x.min || 0;
                        if (currentMin > 0) {
                            chart4.options.scales.x.min = Math.max(0, currentMin - 5);
                            chart4.options.scales.x.max = Math.max(9, currentMin + 4);
                            chart4.update();
                        }
                    });
                    
                    chart4NextBtn.addEventListener('click', () => {
                        const currentMax = chart4.options.scales.x.max || 9;
                        if (currentMax < totalLabels4 - 1) {
                            chart4.options.scales.x.max = Math.min(totalLabels4 - 1, currentMax + 5);
                            chart4.options.scales.x.min = Math.max(0, currentMax - 4);
                            chart4.update();
                        }
                    });
                }
            }

            // ===== GERENCIAMENTO DE ADMINISTRADORES =====

            // Carregar lista de todos os usu√°rios (apenas superadmin)
            async function loadUsersList() {
                console.log('üîç loadUsersList chamada');
                console.log('üîç isSuperAdmin:', isSuperAdmin);
                console.log('üîç currentUser:', currentUser?.email, currentUser?.uid);
                
                // Verificar se √© super admin
                if (!isSuperAdmin) {
                    console.log('‚ùå Usu√°rio n√£o √© super admin');
                    document.getElementById('users-list').innerHTML = 
                        '<p class="text-center text-red-500 py-8">‚ö†Ô∏è Acesso negado. Apenas Super Administradores podem gerenciar usu√°rios.</p>';
                    return;
                }
                
                // VERIFICA√á√ÉO CR√çTICA: Garantir que o usu√°rio est√° autenticado
                const auth = window.firebaseAuth;
                const currentAuthUser = auth.currentUser;
                
                if (!currentAuthUser) {
                    console.error('‚ùå ERRO: Nenhum usu√°rio autenticado no Firebase Auth!');
                    document.getElementById('users-list').innerHTML = 
                        '<p class="text-center text-red-500 py-8">‚ùå Erro: Usu√°rio n√£o autenticado. Fa√ßa logout e login novamente.</p>';
                    return;
                }
                
                console.log('‚úÖ Firebase Auth - Usu√°rio autenticado:', currentAuthUser.email, currentAuthUser.uid);
                
                try {
                    const { collection, getDocs, query, orderBy } = window.firestoreMethods;
                    const usersList = document.getElementById('users-list');
                    
                    console.log('üìã Iniciando busca de usu√°rios no Firestore...');
                    console.log('üîç Firestore DB:', window.firebaseDb);
                    console.log('üîç Firestore projectId:', window.firebaseDb._databaseId?.projectId);
                    
                    // Mostrar loading
                    usersList.innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 mx-auto"></div><p class="text-gray-600 mt-4">Carregando usu√°rios...</p></div>';
                    
                    // TENTATIVA 1: Buscar com query ordenada
                    console.log('üîç Tentativa 1: Buscando com query ordenada...');
                    const usersRef = collection(window.firebaseDb, 'users');
                    const q = query(usersRef, orderBy('email', 'asc'));
                    
                    console.log('üîç Query criada. Executando getDocs...');
                    const usersSnapshot = await getDocs(q);
                    console.log('‚úÖ getDocs completado. Documentos encontrados:', usersSnapshot.size);
                    
                    if (usersSnapshot.empty) {
                        usersList.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum usu√°rio encontrado no sistema.</p>';
                        return;
                    }
                    
                    const users = [];
                    usersSnapshot.forEach(doc => {
                        const data = doc.data();
                        console.log(`üìã Usu√°rio ${data.email}: teamLeader =`, data.teamLeader);
                        users.push({
                            id: doc.id,
                            email: data.email || 'Sem email',
                            displayName: data.displayName || data.email?.split('@')[0] || 'Sem nome',
                            photoURL: data.photoURL || '',
                            role: data.role || 'user',
                            blocked: data.blocked || false,
                            teamLeader: data.teamLeader || [],
                            lastLoginFormatted: data.lastLoginFormatted || 'Nunca acessou',
                            createdAt: data.createdAt || ''
                        });
                    });
                    
                    // Ordenar por role (superadmin > admin > user) e depois por nome
                    users.sort((a, b) => {
                        const roleOrder = { superadmin: 0, admin: 1, user: 2 };
                        const roleCompare = roleOrder[a.role] - roleOrder[b.role];
                        if (roleCompare !== 0) return roleCompare;
                        
                        const nameA = a.displayName || a.email || '';
                        const nameB = b.displayName || b.email || '';
                        return nameA.localeCompare(nameB);
                    });
                    
                    let html = '';
                    users.forEach(user => {
                                const isUserSuperAdmin = user.role === 'superadmin';
                                const isUserAdmin = user.role === 'admin';
                                const isCurrentUser = user.id === currentUser.uid;
                                const displayName = user.displayName || 'Sem nome';
                                const email = user.email || 'Sem email';
                                const photoURL = user.photoURL || 'Zele logo.png';
                                const isBlocked = user.blocked === true;
                                const lastLogin = user.lastLoginFormatted || 'Nunca acessou';
                                const teamLeader = user.teamLeader || [];
                                
                                // Badge visual
                                let roleBadge = '';
                                if (isUserSuperAdmin) {
                                    roleBadge = '<span class="text-purple-600" title="Super Administrador">üëëüëë</span>';
                                } else if (isUserAdmin) {
                                    roleBadge = '<span class="text-yellow-600" title="Administrador">üëë</span>';
                                }
                                
                                // Badge de l√≠der de time
                                let leaderBadge = '';
                                if (teamLeader.length > 0) {
                                    const teamEmojis = {
                                        welcome: 'üëã',
                                        backstage: 'ü§ù',
                                        parking: 'üöó',
                                        kids: 'üë∂'
                                    };
                                    const leaderEmojis = teamLeader.map(t => teamEmojis[t] || '').join('');
                                    leaderBadge = `<span class="text-sm" title="L√≠der de: ${teamLeader.join(', ')}">${leaderEmojis}</span>`;
                                }                                html += `
                            <div class="border-l-4 ${isBlocked ? 'border-red-500 bg-red-50' : (isUserSuperAdmin ? 'border-purple-500 bg-purple-50' : (isUserAdmin ? 'border-yellow-500 bg-yellow-50' : 'border-gray-300 bg-gray-50'))} rounded-lg p-3 mb-3">
                                <!-- LINHA 1: Foto + Nome/Email -->
                                <div class="flex items-center gap-3 mb-3">
                                    <img src="${photoURL}" alt="${displayName}" class="w-14 h-14 rounded-full object-cover flex-shrink-0 ${isBlocked ? 'opacity-50 grayscale' : ''}">
                                    
                                    <div class="flex-1 min-w-0">
                                        <p class="font-bold text-gray-800 text-sm leading-tight mb-1">
                                            ${displayName}
                                            ${roleBadge}
                                            ${leaderBadge}
                                            ${isBlocked ? '<span class="text-red-600">üö´</span>' : ''}
                                            ${isCurrentUser ? '<span class="text-xs text-gray-500">(voc√™)</span>' : ''}
                                        </p>
                                        <p class="text-xs text-gray-600 break-all">${email}</p>
                                    </div>
                                </div>                                <!-- LINHA 2: Informa√ß√µes detalhadas -->
                                <div class="mb-3 space-y-1">
                                    <p class="text-xs text-gray-500">
                                        <strong>ID:</strong> <code class="bg-gray-200 px-1 rounded text-xs break-all">${user.id}</code>
                                    </p>
                                    <p class="text-xs text-gray-600">
                                        <strong>üïê √öltimo acesso:</strong><br>
                                        <span class="ml-4">${lastLogin}</span>
                                    </p>
                                    ${isUserSuperAdmin ? '<p class="text-xs text-purple-600 font-bold">üëë Super Administrador</p>' : ''}
                                    ${isUserAdmin && !isUserSuperAdmin ? '<p class="text-xs text-yellow-600 font-bold">üëë Administrador</p>' : ''}
                                    ${isBlocked ? '<p class="text-xs text-red-600 font-bold">‚ö†Ô∏è Usu√°rio bloqueado</p>' : ''}
                                    ${teamLeader.length > 0 ? `<p class="text-xs text-blue-600 font-bold">üèÜ L√≠der de: ${teamLeader.map(t => {
                                        const names = { welcome: 'Welcome', backstage: 'Backstage', parking: 'Parking', kids: 'Kids' };
                                        return names[t];
                                    }).join(', ')}</p>` : ''}
                                </div>
                                
                                <!-- LINHA 3: Bot√µes de A√ß√£o -->
                                ${!isCurrentUser ? `
                                    <div class="space-y-2">
                                        <!-- Gerenciar Lideran√ßa de Times (apenas superadmin) -->
                                        <button 
                                            class="manage-team-leader-btn w-full px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600"
                                            data-user-id="${user.id}"
                                            data-user-name="${displayName}"
                                            data-team-leader='${JSON.stringify(teamLeader)}'
                                            title="Gerenciar lideran√ßa de times">
                                            üèÜ ${teamLeader.length > 0 ? 'Editar' : 'Definir'} Lideran√ßa de Times
                                        </button>
                                        
                                        <div class="grid grid-cols-2 gap-2">
                                        <!-- Promover/Rebaixar Admin/SuperAdmin -->
                                        ${isUserSuperAdmin ? `
                                            <button 
                                                class="toggle-admin-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-purple-600 hover:bg-purple-700 col-span-2"
                                                data-user-id="${user.id}"
                                                data-user-name="${displayName}"
                                                data-current-role="superadmin"
                                                title="Rebaixar para Administrador">
                                                üëëüëë ‚Üí üëë Rebaixar
                                            </button>
                                        ` : isUserAdmin ? `
                                            <button 
                                                class="toggle-admin-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-yellow-600 hover:bg-yellow-700 col-span-2"
                                                data-user-id="${user.id}"
                                                data-user-name="${displayName}"
                                                data-current-role="admin"
                                                title="Promover para Super Admin ou Remover Admin">
                                                üëë Gerenciar Permiss√µes
                                            </button>
                                        ` : `
                                            <button 
                                                class="toggle-admin-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-green-500 hover:bg-green-600 col-span-2"
                                                data-user-id="${user.id}"
                                                data-user-name="${displayName}"
                                                data-current-role="user"
                                                title="Tornar Administrador">
                                                üëë Tornar Admin
                                            </button>
                                        `}
                                        
                                        <!-- Bloquear/Desbloquear -->
                                        <button 
                                            class="toggle-block-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition ${isBlocked ? 'bg-blue-500 hover:bg-blue-600' : 'bg-red-500 hover:bg-red-600'} ${isBlocked ? '' : 'col-span-2'}"
                                            data-user-id="${user.id}"
                                            data-user-name="${displayName}"
                                            data-is-blocked="${isBlocked}"
                                            data-user-role="${user.role}"
                                            title="${isBlocked ? 'Desbloquear acesso' : 'Bloquear acesso'}">
                                            ${isBlocked ? 'üîì Desbloquear' : 'üîí Bloquear'}
                                        </button>
                                        
                                        <!-- Excluir (s√≥ se bloqueado) -->
                                        ${isBlocked ? `
                                            <button 
                                                class="delete-user-btn px-3 py-2 rounded-lg font-semibold text-white text-xs transition bg-red-700 hover:bg-red-800"
                                                data-user-id="${user.id}"
                                                data-user-name="${displayName}"
                                                title="Excluir usu√°rio permanentemente">
                                                üóëÔ∏è Excluir
                                            </button>
                                        ` : ''}
                                        </div>
                                    </div>
                                ` : '<p class="text-xs text-gray-500 text-center py-2 bg-gray-100 rounded">Voc√™ n√£o pode alterar seu pr√≥prio status</p>'}
                            </div>
                        `;
                    });
                    
                    usersList.innerHTML = html;
                    
                    // Adicionar event listeners aos bot√µes
                    document.querySelectorAll('.toggle-admin-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            const userName = e.currentTarget.dataset.userName;
                            const currentRole = e.currentTarget.dataset.currentRole;
                            manageAdminRole(userId, userName, currentRole);
                        });
                    });
                    
                    document.querySelectorAll('.toggle-block-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            const userName = e.currentTarget.dataset.userName;
                            const isCurrentlyBlocked = e.currentTarget.dataset.isBlocked === 'true';
                            const userRole = e.currentTarget.dataset.userRole;
                            toggleBlockUser(userId, userName, isCurrentlyBlocked, userRole);
                        });
                    });
                    
                    document.querySelectorAll('.delete-user-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            const userName = e.currentTarget.dataset.userName;
                            deleteUser(userId, userName);
                        });
                    });
                    
                    document.querySelectorAll('.manage-team-leader-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            const userName = e.currentTarget.dataset.userName;
                            const teamLeader = JSON.parse(e.currentTarget.dataset.teamLeader || '[]');
                            openTeamLeaderModal(userId, userName, teamLeader);
                        });
                    });
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar usu√°rios:', error);
                    console.error('‚ùå Tipo de erro:', error.constructor.name);
                    console.error('‚ùå C√≥digo de erro:', error.code);
                    console.error('‚ùå Mensagem completa:', error.message);
                    console.error('‚ùå Stack trace:', error.stack);
                    
                    // Tentar ler o pr√≥prio documento do usu√°rio para testar permiss√µes
                    console.log('üîç Testando leitura do pr√≥prio documento do usu√°rio...');
                    try {
                        const { doc, getDoc } = window.firestoreMethods;
                        const userDocRef = doc(window.firebaseDb, 'users', currentUser.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        
                        if (userDocSnap.exists()) {
                            console.log('‚úÖ Consegui ler MEU pr√≥prio documento!');
                            console.log('üìÑ Dados do meu documento:', userDocSnap.data());
                        } else {
                            console.error('‚ùå Meu pr√≥prio documento n√£o existe!');
                        }
                    } catch (testError) {
                        console.error('‚ùå Erro ao tentar ler meu pr√≥prio documento:', testError);
                    }
                    
                    document.getElementById('users-list').innerHTML = 
                        `<div class="text-center text-red-500 py-8">
                            <p class="font-bold mb-2">‚ùå Erro ao carregar usu√°rios</p>
                            <p class="text-sm mb-2">C√≥digo: ${error.code || 'desconhecido'}</p>
                            <p class="text-xs text-gray-600">${error.message}</p>
                            <button onclick="loadUsersList()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                üîÑ Tentar novamente
                            </button>
                        </div>`;
                }
            }

            // Gerenciar role de administrador (superadmin pode promover/rebaixar)
            async function manageAdminRole(userId, userName, currentRole) {
                if (!isSuperAdmin) {
                    showModal('‚ùå Apenas Super Administradores podem gerenciar permiss√µes.', false, null, true);
                    return;
                }
                
                let newRole = '';
                let message = '';
                
                if (currentRole === 'superadmin') {
                    // Rebaixar de superadmin para admin
                    newRole = 'admin';
                    message = `Tem certeza que deseja <strong>rebaixar</strong> de Super Admin para Admin:<br><br><strong>${userName}</strong>?<br><br>Ele perder√° acesso ao gerenciamento de usu√°rios.`;
                } else if (currentRole === 'admin') {
                    // Escolher entre promover para superadmin ou rebaixar para user
                    const action = await new Promise(resolve => {
                        showModal(
                            `Escolha a a√ß√£o para <strong>${userName}</strong>:`,
                            false,
                            null,
                            false,
                            null,
                            'üëë'
                        );
                        // Customizar bot√µes do modal
                        document.getElementById('modal-buttons').innerHTML = `
                            <button id="promote-superadmin-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition">
                                üëëüëë Promover para Super Admin
                            </button>
                            <button id="demote-user-btn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition">
                                ‚ùå Remover Admin
                            </button>
                            <button id="cancel-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition">
                                Cancelar
                            </button>
                        `;
                        
                        document.getElementById('promote-superadmin-btn').addEventListener('click', () => {
                            closeModal();
                            resolve('superadmin');
                        });
                        
                        document.getElementById('demote-user-btn').addEventListener('click', () => {
                            closeModal();
                            resolve('user');
                        });
                        
                        document.getElementById('cancel-btn').addEventListener('click', () => {
                            closeModal();
                            resolve(null);
                        });
                    });
                    
                    if (!action) return;
                    
                    newRole = action;
                    if (action === 'superadmin') {
                        message = `Tem certeza que deseja <strong>promover</strong> para Super Admin:<br><br><strong>${userName}</strong>?<br><br>Ele ter√° controle total sobre o sistema.`;
                    } else {
                        message = `Tem certeza que deseja <strong>remover permiss√µes de admin</strong> de:<br><br><strong>${userName}</strong>?`;
                    }
                } else {
                    // Promover de user para admin
                    newRole = 'admin';
                    message = `Tem certeza que deseja <strong>tornar administrador</strong>:<br><br><strong>${userName}</strong>?<br><br>Ele poder√° gerenciar datas e escalas.`;
                }
                
                const confirmation = await new Promise(resolve => {
                    showModal(
                        message,
                        true,
                        () => resolve(true),
                        true,
                        () => resolve(false)
                    );
                });
                
                if (!confirmation) return;
                
                try {
                    const { doc, setDoc, getDoc } = window.firestoreMethods;
                    
                    // Buscar dados atuais do usu√°rio
                    const userDocRef = doc(window.firebaseDb, 'users', userId);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        await setDoc(userDocRef, {
                            ...userDoc.data(),
                            role: newRole
                        });
                    } else {
                        await setDoc(userDocRef, {
                            role: newRole,
                            displayName: userName,
                            email: userName,
                            blocked: false,
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    const roleNames = {
                        superadmin: 'Super Administrador',
                        admin: 'Administrador',
                        user: 'Usu√°rio comum'
                    };
                    
                    showModal(`‚úÖ ${userName} agora √©: <strong>${roleNames[newRole]}</strong>`);
                    
                    // Recarregar lista
                    await loadUsersList();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao alterar role:', error);
                    showModal('‚ùå Erro ao alterar permiss√µes. Tente novamente.');
                }
            }
            
            // Alternar bloqueio de usu√°rio
            async function toggleBlockUser(userId, userName, isCurrentlyBlocked, userRole) {
                if (!isSuperAdmin) {
                    showModal('‚ùå Apenas Super Administradores podem bloquear/desbloquear usu√°rios.', false, null, true);
                    return;
                }
                
                const action = isCurrentlyBlocked ? 'desbloquear' : 'bloquear';
                const confirmation = await new Promise(resolve => {
                    showModal(
                        `Tem certeza que deseja ${action} o acesso de:<br><br><strong>${userName}</strong>?${!isCurrentlyBlocked ? '<br><br>‚ö†Ô∏è O usu√°rio n√£o conseguir√° mais acessar o app at√© ser desbloqueado.' : ''}`,
                        true,
                        () => resolve(true),
                        true,
                        () => resolve(false)
                    );
                });
                
                if (!confirmation) return;
                
                try {
                    const { doc, setDoc, getDoc } = window.firestoreMethods;
                    const newBlockedStatus = !isCurrentlyBlocked;
                    
                    // Buscar dados atuais do usu√°rio
                    const userDocRef = doc(window.firebaseDb, 'users', userId);
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        // Atualizar apenas o campo blocked
                        await setDoc(userDocRef, {
                            ...userDoc.data(),
                            blocked: newBlockedStatus
                        });
                    } else {
                        // Se n√£o existe, criar documento b√°sico
                        await setDoc(userDocRef, {
                            blocked: newBlockedStatus,
                            role: 'user',
                            displayName: userName,
                            email: userName,
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    const successMessage = isCurrentlyBlocked 
                        ? `‚úÖ ${userName} foi desbloqueado e pode acessar o app novamente.`
                        : `‚úÖ ${userName} foi bloqueado e n√£o consegue mais acessar o app.`;
                    
                    showModal(successMessage);
                    
                    // Recarregar lista
                    await loadUsersList();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao alterar bloqueio:', error);
                    console.error('Detalhes do erro:', error.message);
                    showModal('‚ùå Erro ao alterar bloqueio de usu√°rio. Tente novamente.');
                }
            }
            
            // Abrir modal de transferir volunt√°rio
            let currentTransferData = null;
            
            function openTransferModal(escalaId, volunteerName, currentTeam, date, time) {
                currentTransferData = { escalaId, currentTeam, date, time };
                
                const teamNames = {
                    welcome: 'Welcome',
                    backstage: 'Backstage',
                    parking: 'Parking',
                    kids: 'Kids'
                };
                
                const teamColors = {
                    welcome: 'bg-blue-50 border-blue-300 hover:bg-blue-100',
                    backstage: 'bg-gray-50 border-gray-300 hover:bg-gray-100',
                    parking: 'bg-red-50 border-red-300 hover:bg-red-100',
                    kids: 'bg-yellow-50 border-yellow-300 hover:bg-yellow-100'
                };
                
                const teamEmojis = {
                    welcome: 'üëã',
                    backstage: 'ü§ù',
                    parking: 'üöó',
                    kids: 'üë∂'
                };
                
                document.getElementById('transfer-volunteer-name').textContent = volunteerName;
                document.getElementById('transfer-current-team').textContent = teamNames[currentTeam];
                
                // Gerar op√ß√µes de times (excluindo o time atual)
                const teamsOptions = document.getElementById('transfer-teams-options');
                teamsOptions.innerHTML = '';
                
                Object.keys(teamNames).forEach(teamKey => {
                    if (teamKey !== currentTeam) {
                        const radio = document.createElement('label');
                        radio.className = `flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer transition ${teamColors[teamKey]}`;
                        radio.innerHTML = `
                            <input type="radio" name="transfer-team" class="w-5 h-5" value="${teamKey}">
                            <span class="text-2xl">${teamEmojis[teamKey]}</span>
                            <span class="font-semibold text-gray-800">${teamNames[teamKey]}</span>
                        `;
                        teamsOptions.appendChild(radio);
                    }
                });
                
                document.getElementById('transfer-volunteer-modal').classList.add('show');
            }
            
            // Fechar modal de transfer√™ncia
            document.getElementById('close-transfer-modal')?.addEventListener('click', () => {
                document.getElementById('transfer-volunteer-modal').classList.remove('show');
                currentTransferData = null;
            });
            
            document.getElementById('transfer-volunteer-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'transfer-volunteer-modal') {
                    document.getElementById('transfer-volunteer-modal').classList.remove('show');
                    currentTransferData = null;
                }
            });
            
            // Confirmar transfer√™ncia
            document.getElementById('confirm-transfer-btn')?.addEventListener('click', async () => {
                if (!currentTransferData) return;
                
                const selectedTeam = document.querySelector('input[name="transfer-team"]:checked')?.value;
                
                if (!selectedTeam) {
                    showModal('‚ö†Ô∏è Por favor, selecione um time para transferir o volunt√°rio.', false, null, true);
                    return;
                }
                
                try {
                    const { doc, updateDoc, getDoc } = window.firestoreMethods;
                    const escalaRef = doc(window.firebaseDb, 'escalas', currentTransferData.escalaId);
                    const escalaDoc = await getDoc(escalaRef);
                    
                    if (!escalaDoc.exists()) {
                        showModal('‚ùå Escala n√£o encontrada.', false, null, true);
                        return;
                    }
                    
                    const escalaData = escalaDoc.data();
                    const volunteerName = escalaData.userName;
                    
                    // Verificar limite do time de destino
                    const teamLimit = await checkTeamLimit(currentTransferData.date, currentTransferData.time, selectedTeam);
                    
                    if (teamLimit.isFull) {
                        const teamNames = {
                            welcome: 'Welcome',
                            backstage: 'Backstage',
                            parking: 'Parking',
                            kids: 'Kids'
                        };
                        showModal(
                            `‚ùå O time ${teamNames[selectedTeam]} j√° est√° completo (${teamLimit.count}/${teamLimit.maxVolunteers} volunt√°rios).<br><br>N√£o √© poss√≠vel transferir.`,
                            false,
                            null,
                            true
                        );
                        return;
                    }
                    
                    // Atualizar time do volunt√°rio
                    await updateDoc(escalaRef, {
                        team: selectedTeam,
                        updatedAt: new Date().toISOString(),
                        transferredBy: currentUser.email,
                        transferredAt: new Date().toISOString()
                    });
                    
                    const teamNames = {
                        welcome: 'Welcome',
                        backstage: 'Backstage',
                        parking: 'Parking',
                        kids: 'Kids'
                    };
                    
                    document.getElementById('transfer-volunteer-modal').classList.remove('show');
                    currentTransferData = null;
                    
                    showModal(`‚úÖ ${volunteerName} foi transferido(a) para o time ${teamNames[selectedTeam]}!`);
                    
                    // Recarregar vis√£o geral
                    await loadAllEscalas();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao transferir volunt√°rio:', error);
                    showModal('‚ùå Erro ao transferir volunt√°rio. Tente novamente.');
                }
            });
            
            // Abrir modal de gerenciar lideran√ßa de times
            let currentLeaderUserId = null;
            
            function openTeamLeaderModal(userId, userName, currentTeamLeader = []) {
                currentLeaderUserId = userId;
                document.getElementById('leader-user-name').textContent = userName;
                
                // Marcar checkboxes dos times que o usu√°rio j√° lidera
                document.querySelectorAll('.leader-team-checkbox').forEach(checkbox => {
                    checkbox.checked = currentTeamLeader.includes(checkbox.dataset.team);
                });
                
                document.getElementById('team-leader-modal').classList.add('show');
            }
            
            // Fechar modal de lideran√ßa
            document.getElementById('close-team-leader-modal')?.addEventListener('click', () => {
                document.getElementById('team-leader-modal').classList.remove('show');
                currentLeaderUserId = null;
            });
            
            document.getElementById('team-leader-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'team-leader-modal') {
                    document.getElementById('team-leader-modal').classList.remove('show');
                    currentLeaderUserId = null;
                }
            });
            
            // Salvar lideran√ßa de times
            document.getElementById('save-team-leader-btn')?.addEventListener('click', async () => {
                if (!currentLeaderUserId) return;
                
                // Coletar times selecionados
                const selectedTeams = [];
                document.querySelectorAll('.leader-team-checkbox:checked').forEach(checkbox => {
                    selectedTeams.push(checkbox.dataset.team);
                });
                
                console.log('üíæ Salvando lideran√ßa para usu√°rio:', currentLeaderUserId);
                console.log('üíæ Times selecionados:', selectedTeams);
                
                try {
                    const { doc, setDoc, updateDoc, getDoc } = window.firestoreMethods;
                    const userDocRef = doc(window.firebaseDb, 'users', currentLeaderUserId);
                    const userDoc = await getDoc(userDocRef);
                    
                    console.log('üíæ Documento existe?', userDoc.exists());
                    
                    if (userDoc.exists()) {
                        // Usar updateDoc para preservar outros campos
                        const updateData = {
                            teamLeader: selectedTeams,
                            updatedAt: new Date().toISOString()
                        };
                        console.log('üíæ Dados a serem atualizados:', updateData);
                        await updateDoc(userDocRef, updateData);
                        console.log('‚úÖ Dados atualizados com sucesso');
                    } else {
                        // Se n√£o existir, criar com setDoc
                        const newData = {
                            teamLeader: selectedTeams,
                            createdAt: new Date().toISOString()
                        };
                        console.log('üíæ Criando novo documento com:', newData);
                        await setDoc(userDocRef, newData);
                        console.log('‚úÖ Novo documento criado');
                    }
                    
                    // Verificar se foi salvo corretamente
                    const verifyDoc = await getDoc(userDocRef);
                    if (verifyDoc.exists()) {
                        console.log('‚úÖ Verifica√ß√£o - teamLeader salvo:', verifyDoc.data().teamLeader);
                    }
                    
                    document.getElementById('team-leader-modal').classList.remove('show');
                    currentLeaderUserId = null;
                    
                    const teamNames = {
                        welcome: 'Welcome',
                        backstage: 'Backstage',
                        parking: 'Parking',
                        kids: 'Kids'
                    };
                    
                    if (selectedTeams.length > 0) {
                        const teamsText = selectedTeams.map(t => teamNames[t]).join(', ');
                        showModal(`‚úÖ Lideran√ßa atualizada!<br><br><strong>Times:</strong> ${teamsText}`);
                    } else {
                        showModal('‚úÖ Lideran√ßa removida de todos os times.');
                    }
                    
                    // Recarregar lista de usu√°rios
                    await loadUsersList();
                    
                    // Se for o pr√≥prio usu√°rio logado, atualizar lideran√ßa e UI
                    if (currentLeaderUserId === currentUser?.uid) {
                        userTeamLeadership = selectedTeams;
                        isTeamLeader = userTeamLeadership.length > 0;
                        updateUserUI(currentUser);
                        // Recarregar admin view se estiver aberta
                        if (document.getElementById('admin-view').style.display !== 'none') {
                            await renderAdminView();
                        }
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar lideran√ßa:', error);
                    showModal('‚ùå Erro ao salvar lideran√ßa. Tente novamente.');
                }
            });
            
            // ============================================
            // ONBOARDING - PRIMEIRO ACESSO
            // ============================================
            
            let onboardingData = {
                preferredTeam: null,
                availability: {}
            };
            
            // Sele√ß√£o de time preferido
            document.querySelectorAll('.onboarding-team-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remover sele√ß√£o anterior
                    document.querySelectorAll('.onboarding-team-btn').forEach(b => {
                        b.classList.remove('ring-4', 'ring-offset-2');
                        b.style.borderColor = '';
                    });
                    
                    // Selecionar novo time
                    const team = this.dataset.team;
                    onboardingData.preferredTeam = team;
                    this.classList.add('ring-4', 'ring-offset-2');
                    
                    // Cores por time
                    const colors = {
                        welcome: 'rgb(37, 99, 235)',
                        backstage: 'rgb(75, 85, 99)',
                        parking: 'rgb(239, 68, 68)',
                        kids: 'rgb(234, 179, 8)'
                    };
                    this.style.borderColor = colors[team];
                    
                    validateOnboarding();
                });
            });
            
            // Toggle de dias da semana
            document.querySelectorAll('.day-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const day = this.dataset.day;
                    const periodOptions = document.querySelector(`.period-options[data-day="${day}"]`);
                    const indicator = this.querySelector('.toggle-indicator');
                    
                    if (periodOptions.classList.contains('hidden')) {
                        periodOptions.classList.remove('hidden');
                        indicator.textContent = '‚óè';
                        indicator.classList.add('text-blue-600');
                        this.classList.add('bg-blue-50');
                    } else {
                        periodOptions.classList.add('hidden');
                        indicator.textContent = '‚óã';
                        indicator.classList.remove('text-blue-600');
                        this.classList.remove('bg-blue-50');
                        
                        // Limpar sele√ß√µes de per√≠odo deste dia
                        periodOptions.querySelectorAll('.period-btn').forEach(p => {
                            p.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                        });
                        
                        // Remover do objeto de dados
                        delete onboardingData.availability[day];
                    }
                    
                    validateOnboarding();
                });
            });
            
            // Sele√ß√£o de per√≠odos
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const day = this.closest('.period-options').dataset.day;
                    const period = this.dataset.period;
                    
                    // Inicializar array se n√£o existir
                    if (!onboardingData.availability[day]) {
                        onboardingData.availability[day] = [];
                    }
                    
                    // Toggle sele√ß√£o
                    if (this.classList.contains('bg-blue-500')) {
                        this.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
                        onboardingData.availability[day] = onboardingData.availability[day].filter(p => p !== period);
                        
                        // Se n√£o h√° mais per√≠odos, remover o dia
                        if (onboardingData.availability[day].length === 0) {
                            delete onboardingData.availability[day];
                        }
                    } else {
                        this.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
                        onboardingData.availability[day].push(period);
                    }
                    
                    validateOnboarding();
                });
            });
            
            // Validar se pode continuar
            function validateOnboarding() {
                const btn = document.getElementById('confirm-onboarding-btn');
                const hasTeam = onboardingData.preferredTeam !== null;
                const hasAvailability = Object.keys(onboardingData.availability).length > 0;
                
                if (hasTeam && hasAvailability) {
                    btn.disabled = false;
                } else {
                    btn.disabled = true;
                }
            }
            
            // Abrir modal de confirma√ß√£o
            document.getElementById('confirm-onboarding-btn')?.addEventListener('click', () => {
                showOnboardingSummary();
                document.getElementById('onboarding-modal').style.display = 'none';
                document.getElementById('onboarding-confirm-modal').style.display = 'flex';
            });
            
            // Mostrar resumo
            function showOnboardingSummary() {
                const summaryDiv = document.getElementById('onboarding-summary');
                
                const teamNames = {
                    welcome: 'üëã Welcome',
                    backstage: 'ü§ù Backstage',
                    parking: 'üöó Parking',
                    kids: 'üë∂ Kids'
                };
                
                const dayNames = {
                    monday: 'Segunda-feira',
                    tuesday: 'Ter√ßa-feira',
                    wednesday: 'Quarta-feira',
                    thursday: 'Quinta-feira',
                    friday: 'Sexta-feira',
                    saturday: 'S√°bado',
                    sunday: 'Domingo'
                };
                
                const periodNames = {
                    morning: '‚òÄÔ∏è Manh√£',
                    afternoon: 'üå§Ô∏è Tarde',
                    night: 'üåô Noite'
                };
                
                let html = `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-1">Time Preferido:</p>
                        <p class="text-lg font-bold text-blue-600">${teamNames[onboardingData.preferredTeam]}</p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Disponibilidade:</p>
                        <div class="space-y-2">
                `;
                
                for (const [day, periods] of Object.entries(onboardingData.availability)) {
                    const periodsList = periods.map(p => periodNames[p]).join(', ');
                    html += `
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-medium text-gray-700">${dayNames[day]}:</span>
                            <span class="text-gray-600">${periodsList}</span>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                summaryDiv.innerHTML = html;
            }
            
            // Voltar para editar
            document.getElementById('edit-onboarding-btn')?.addEventListener('click', () => {
                document.getElementById('onboarding-confirm-modal').style.display = 'none';
                document.getElementById('onboarding-modal').style.display = 'flex';
            });
            
            // Salvar onboarding
            document.getElementById('save-onboarding-btn')?.addEventListener('click', async () => {
                try {
                    const { doc, updateDoc, setDoc, getDoc } = window.firestoreMethods;
                    const userDocRef = doc(window.firebaseDb, 'users', currentUser.uid);
                    const userDoc = await getDoc(userDocRef);
                    
                    const dataToSave = {
                        preferredTeam: onboardingData.preferredTeam,
                        availability: onboardingData.availability,
                        onboardingComplete: true,
                        onboardingDate: new Date().toISOString()
                    };
                    
                    if (userDoc.exists()) {
                        await updateDoc(userDocRef, dataToSave);
                    } else {
                        await setDoc(userDocRef, {
                            ...dataToSave,
                            email: currentUser.email,
                            displayName: currentUser.displayName,
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    document.getElementById('onboarding-confirm-modal').style.display = 'none';
                    
                    showModal('‚úÖ Suas prefer√™ncias foram salvas com sucesso!<br><br>Agora voc√™ pode come√ßar a se escalar nos eventos.');
                    
                    console.log('‚úÖ Onboarding conclu√≠do:', dataToSave);
                } catch (error) {
                    console.error('‚ùå Erro ao salvar onboarding:', error);
                    showModal('‚ùå Erro ao salvar suas prefer√™ncias. Tente novamente.');
                }
            });
            
            // Verificar se precisa mostrar onboarding
            async function checkOnboarding(user) {
                try {
                    const { doc, getDoc } = window.firestoreMethods;
                    const userDoc = await getDoc(doc(window.firebaseDb, 'users', user.uid));
                    
                    // Mostrar onboarding se:
                    // 1. Usu√°rio n√£o existe no Firestore OU
                    // 2. Usu√°rio existe mas n√£o completou onboarding (campo === true)
                    let shouldShowOnboarding = false;
                    
                    if (!userDoc.exists()) {
                        console.log('üëã Novo usu√°rio - mostrar onboarding');
                        shouldShowOnboarding = true;
                    } else {
                        const userData = userDoc.data();
                        // S√≥ mostrar se onboardingComplete N√ÉO for true
                        if (userData.onboardingComplete !== true) {
                            console.log('üëã Usu√°rio sem onboarding completo - mostrar formul√°rio');
                            shouldShowOnboarding = true;
                        } else {
                            console.log('‚úÖ Onboarding j√° foi completado');
                        }
                    }
                    
                    if (shouldShowOnboarding) {
                        // Dar um delay para n√£o conflitar com outros modais
                        setTimeout(() => {
                            document.getElementById('onboarding-modal').style.display = 'flex';
                        }, 500);
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao verificar onboarding:', error);
                }
            }
            
            // Excluir usu√°rio permanentemente (apenas se bloqueado)
            async function deleteUser(userId, userName) {
                const confirmation = await new Promise(resolve => {
                    showModal(
                        `<div class="text-left"><p class="text-center mb-4">‚ö†Ô∏è <strong>ATEN√á√ÉO: Esta a√ß√£o √© irrevers√≠vel!</strong></p><p>Tem certeza que deseja <strong>EXCLUIR PERMANENTEMENTE</strong> o usu√°rio:</p><p class="text-center my-4 font-bold text-lg">${userName}</p><p class="text-red-600 font-bold">‚ö†Ô∏è Todas as escalas deste usu√°rio ser√£o deletadas de todos os eventos!</p></div>`,
                        true,
                        () => resolve(true),
                        true,
                        () => resolve(false)
                    );
                });
                
                if (!confirmation) return;
                
                try {
                    const { doc, deleteDoc, collection, query, where, getDocs } = window.firestoreMethods;
                    
                    // 1. Deletar todas as escalas do usu√°rio
                    const escalasQuery = query(
                        collection(window.firebaseDb, 'escalas'),
                        where('userId', '==', userId)
                    );
                    
                    const escalasSnapshot = await getDocs(escalasQuery);
                    const deleteEscalasPromises = [];
                    
                    escalasSnapshot.forEach((docSnapshot) => {
                        deleteEscalasPromises.push(
                            deleteDoc(doc(window.firebaseDb, 'escalas', docSnapshot.id))
                        );
                    });
                    
                    await Promise.all(deleteEscalasPromises);
                    console.log(`üóëÔ∏è ${deleteEscalasPromises.length} escala(s) deletada(s)`);
                    
                    // 2. Deletar o documento do usu√°rio
                    await deleteDoc(doc(window.firebaseDb, 'users', userId));
                    console.log('üóëÔ∏è Usu√°rio deletado do Firestore');
                    
                    showModal(`‚úÖ ${userName} foi exclu√≠do permanentemente do sistema.<br><br>${deleteEscalasPromises.length} escala(s) foram deletadas.`);
                    
                    // Recarregar listas
                    await loadUsersList();
                    await loadUserEscalas();
                    await loadAllEscalas();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao excluir usu√°rio:', error);
                    console.error('Detalhes do erro:', error.message);
                    showModal('‚ùå Erro ao excluir usu√°rio. Tente novamente.');
                }
            }

            // Event Listeners
            elements.googleLoginBtn.addEventListener('click', loginWithGoogle);
            elements.saveEscalaBtn.addEventListener('click', saveEscala);

            // Event listeners para login com email
            const emailLoginModal = document.getElementById('email-login-modal');
            const showEmailLogin = document.getElementById('show-email-login');
            const closeEmailModal = document.getElementById('close-email-modal');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const resetPasswordForm = document.getElementById('reset-password-form');
            
            // Event listener para adicionar data (admin)
            const adminAddDateBtn = document.getElementById('admin-add-date-btn');
            if (adminAddDateBtn) {
                adminAddDateBtn.addEventListener('click', addNewDate);
            }
            
            // Abrir modal de email
            showEmailLogin.addEventListener('click', () => {
                emailLoginModal.classList.add('show');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                resetPasswordForm.style.display = 'none';
            });
            
            // Fechar modal
            closeEmailModal.addEventListener('click', () => {
                emailLoginModal.classList.remove('show');
            });
            
            emailLoginModal.addEventListener('click', (e) => {
                if (e.target === emailLoginModal) {
                    emailLoginModal.classList.remove('show');
                }
            });
            
            // Alternar entre formul√°rios
            document.getElementById('show-register-form').addEventListener('click', () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                resetPasswordForm.style.display = 'none';
            });
            
            document.getElementById('show-login-form').addEventListener('click', () => {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                resetPasswordForm.style.display = 'none';
            });
            
            document.getElementById('show-reset-password').addEventListener('click', () => {
                loginForm.style.display = 'none';
                registerForm.style.display = 'none';
                resetPasswordForm.style.display = 'block';
            });
            
            document.getElementById('back-to-login').addEventListener('click', () => {
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                resetPasswordForm.style.display = 'none';
            });
            
            // Login com email
            document.getElementById('email-login-btn').addEventListener('click', async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    showModal('Por favor, preencha email e senha!');
                    return;
                }
                
                try {
                    emailLoginModal.classList.remove('show');
                    showLoading(); // Mostrar loading durante o login
                    await window.firebaseAuthMethods.signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    console.log('‚úÖ Login com email realizado');
                    // O onAuthStateChanged vai cuidar de mostrar o app
                } catch (error) {
                    console.error('‚ùå Erro no login:', error);
                    showLogin(); // Voltar para login em caso de erro
                    emailLoginModal.classList.add('show'); // Reabrir modal
                    let message = 'Erro ao fazer login. Tente novamente.';
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        message = 'Email ou senha incorretos.';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Email inv√°lido.';
                    } else if (error.code === 'auth/too-many-requests') {
                        message = 'Muitas tentativas. Tente novamente mais tarde.';
                    }
                    showModal(message);
                }
            });
            
            // Alternar visibilidade da senha no cadastro
            document.getElementById('toggle-register-password').addEventListener('click', () => {
                const input = document.getElementById('register-password');
                if (input.type === 'password') {
                    input.type = 'text';
                } else {
                    input.type = 'password';
                }
            });
            
            document.getElementById('toggle-register-password-confirm').addEventListener('click', () => {
                const input = document.getElementById('register-password-confirm');
                if (input.type === 'password') {
                    input.type = 'text';
                } else {
                    input.type = 'password';
                }
            });
            
            // Cadastro com email
            document.getElementById('email-register-btn').addEventListener('click', async () => {
                const name = document.getElementById('register-name').value.trim();
                const lastname = document.getElementById('register-lastname').value.trim();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const passwordConfirm = document.getElementById('register-password-confirm').value;
                
                if (!name || !lastname || !email || !password || !passwordConfirm) {
                    showModal('Por favor, preencha todos os campos!');
                    return;
                }
                
                if (password.length < 6) {
                    showModal('A senha deve ter no m√≠nimo 6 caracteres!');
                    return;
                }
                
                if (password !== passwordConfirm) {
                    showModal('As senhas n√£o coincidem! Por favor, verifique.', false, null, false, null, '‚ö†Ô∏è');
                    return;
                }
                
                try {
                    emailLoginModal.classList.remove('show');
                    showLoading(); // Mostrar loading durante o cadastro
                    const userCredential = await window.firebaseAuthMethods.createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                    
                    // Atualizar perfil com nome completo
                    await window.firebaseAuthMethods.updateProfile(userCredential.user, {
                        displayName: `${name} ${lastname}`
                    });
                    
                    console.log('‚úÖ Cadastro realizado');
                    // O onAuthStateChanged vai cuidar de mostrar o app e depois o modal de sucesso
                } catch (error) {
                    console.error('‚ùå Erro no cadastro:', error);
                    showLogin(); // Voltar para login em caso de erro
                    emailLoginModal.classList.add('show'); // Reabrir modal
                    let message = 'Erro ao criar conta. Tente novamente.';
                    if (error.code === 'auth/email-already-in-use') {
                        message = 'Este email j√° est√° cadastrado. Fa√ßa login.';
                    } else if (error.code === 'auth/invalid-email') {
                        message = 'Email inv√°lido.';
                    } else if (error.code === 'auth/weak-password') {
                        message = 'Senha muito fraca. Use no m√≠nimo 6 caracteres.';
                    }
                    showModal(message);
                }
            });
            
            // Recupera√ß√£o de senha
            document.getElementById('send-reset-btn').addEventListener('click', async () => {
                const email = document.getElementById('reset-email').value;
                
                if (!email) {
                    showModal('Por favor, digite seu email!');
                    return;
                }
                
                try {
                    await window.firebaseAuthMethods.sendPasswordResetEmail(window.firebaseAuth, email);
                    showModal('Email de recupera√ß√£o enviado! Verifique sua caixa de entrada.');
                    // Voltar para tela de login
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    resetPasswordForm.style.display = 'none';
                } catch (error) {
                    console.error('‚ùå Erro ao enviar email:', error);
                    let message = 'Erro ao enviar email. Tente novamente.';
                    if (error.code === 'auth/invalid-email') {
                        message = 'Email inv√°lido.';
                    } else if (error.code === 'auth/user-not-found') {
                        message = 'Email n√£o encontrado.';
                    }
                    showModal(message);
                }
            });
            
            // Enter para login
            document.getElementById('login-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('email-login-btn').click();
                }
            });
            
            document.getElementById('register-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('email-register-btn').click();
                }
            });
            
            document.getElementById('reset-email').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('send-reset-btn').click();
                }
            });

            // Monitorar autentica√ß√£o
            window.firebaseAuthMethods.onAuthStateChanged(window.firebaseAuth, async (user) => {
                console.log('üîÑ Estado de auth mudou:', user?.email || 'deslogado');
                currentUser = user;

                if (user) {
                    await checkAdminStatus(user);
                    await loadAvailableDates(); // Carregar datas ANTES de carregar escalas
                    updateUserUI(user);
                    showApp();
                    await loadUserEscalas(); // Agora sim carregar escalas
                    await loadAllEscalas();
                    setupInstallButton(); // Configurar bot√£o de instala√ß√£o ap√≥s login
                    await checkOnboarding(user); // Verificar se precisa mostrar onboarding
                } else {
                    showLogin();
                }
            });

            console.log('‚úÖ App inicializado');
        }
        
        // ========================================
        // SERVICE WORKER (PWA) - HABILITADO
        // ========================================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // GitHub Pages na raiz do reposit√≥rio
                const swPath = '/zele/service-worker.js';
                
                navigator.serviceWorker.register(swPath)
                    .then(reg => console.log('‚úÖ Service Worker registrado:', swPath))
                    .catch(err => console.log('‚ö†Ô∏è Service Worker n√£o dispon√≠vel:', err.message));
            });
        }
        
        // Iniciar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
